'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

exports.default = createRequestLogger;

var _testcafeHammerhead = require('testcafe-hammerhead');

var _hook = require('./hook');

var _hook2 = _interopRequireDefault(_hook);

var _useragent = require('useragent');

var _testRunTracker = require('../test-run-tracker');

var _testRunTracker2 = _interopRequireDefault(_testRunTracker);

var _reExecutablePromise = require('../../utils/re-executable-promise');

var _reExecutablePromise2 = _interopRequireDefault(_reExecutablePromise);

var _runtime = require('../../errors/runtime');

var _types = require('../../errors/types');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_OPTIONS = {
    logRequestHeaders: false,
    logRequestBody: false,
    stringifyRequestBody: false,
    logResponseHeaders: false,
    logResponseBody: false,
    stringifyResponseBody: false
};

class RequestLoggerImplementation extends _hook2.default {
    constructor(requestFilterRuleInit, options) {
        options = (0, _assign2.default)({}, DEFAULT_OPTIONS, options);
        RequestLoggerImplementation._assertLogOptions(options);

        const configureResponseEventOptions = new _testcafeHammerhead.ConfigureResponseEventOptions(options.logResponseHeaders, options.logResponseBody);

        super(requestFilterRuleInit, configureResponseEventOptions);

        this.options = options;

        this._internalRequests = {};
    }

    static _assertLogOptions(logOptions) {
        if (!logOptions.logRequestBody && logOptions.stringifyRequestBody) throw new _runtime.APIError('RequestLogger', _types.RUNTIME_ERRORS.requestHookConfigureAPIError, 'RequestLogger', 'Cannot stringify the request body because it is not logged. Specify { logRequestBody: true } in log options.');

        if (!logOptions.logResponseBody && logOptions.stringifyResponseBody) throw new _runtime.APIError('RequestLogger', _types.RUNTIME_ERRORS.requestHookConfigureAPIError, 'RequestLogger', 'Cannot stringify the response body because it is not logged. Specify { logResponseBody: true } in log options.');
    }

    onRequest(event) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const userAgent = (0, _useragent.parse)(event._requestInfo.userAgent).toString();

            const loggedReq = {
                id: event._requestInfo.requestId,
                testRunId: event._requestInfo.sessionId,
                userAgent,
                request: {
                    url: event._requestInfo.url,
                    method: event._requestInfo.method
                }
            };

            if (_this.options.logRequestHeaders) loggedReq.request.headers = (0, _assign2.default)({}, event._requestInfo.headers);

            if (_this.options.logRequestBody) loggedReq.request.body = _this.options.stringifyRequestBody ? event._requestInfo.body.toString() : event._requestInfo.body;

            _this._internalRequests[loggedReq.id] = loggedReq;
        })();
    }

    onResponse(event) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const loggerReq = _this2._internalRequests[event.requestId];

            // NOTE: If the 'clear' method is called during a long running request,
            // we should not save a response part - request part has been already removed.
            if (!loggerReq) return;

            loggerReq.response = {};
            loggerReq.response.statusCode = event.statusCode;

            if (_this2.options.logResponseHeaders) loggerReq.response.headers = (0, _assign2.default)({}, event.headers);

            if (_this2.options.logResponseBody) {
                loggerReq.response.body = _this2.options.stringifyResponseBody && event.body ? event.body.toString() : event.body;
            }
        })();
    }

    _prepareInternalRequestInfo() {
        const testRun = _testRunTracker2.default.resolveContextTestRun();
        let preparedRequests = (0, _values2.default)(this._internalRequests);

        if (testRun) preparedRequests = preparedRequests.filter(r => r.testRunId === testRun.id);

        return preparedRequests;
    }

    _getCompletedRequests() {
        return this._prepareInternalRequestInfo().filter(r => r.response);
    }

    // API
    contains(predicate) {
        var _this3 = this;

        return _reExecutablePromise2.default.fromFn((0, _asyncToGenerator3.default)(function* () {
            return !!_this3._getCompletedRequests().find(predicate);
        }));
    }

    count(predicate) {
        var _this4 = this;

        return _reExecutablePromise2.default.fromFn((0, _asyncToGenerator3.default)(function* () {
            return _this4._getCompletedRequests().filter(predicate).length;
        }));
    }

    clear() {
        const testRun = _testRunTracker2.default.resolveContextTestRun();

        if (testRun) {
            (0, _keys2.default)(this._internalRequests).forEach(id => {
                if (this._internalRequests[id].testRunId === testRun.id) delete this._internalRequests[id];
            });
        } else this._internalRequests = {};
    }

    get requests() {
        return this._prepareInternalRequestInfo();
    }
}

function createRequestLogger(requestFilterRuleInit, logOptions) {
    return new RequestLoggerImplementation(requestFilterRuleInit, logOptions);
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcGkvcmVxdWVzdC1ob29rcy9yZXF1ZXN0LWxvZ2dlci5qcyJdLCJuYW1lcyI6WyJjcmVhdGVSZXF1ZXN0TG9nZ2VyIiwiREVGQVVMVF9PUFRJT05TIiwibG9nUmVxdWVzdEhlYWRlcnMiLCJsb2dSZXF1ZXN0Qm9keSIsInN0cmluZ2lmeVJlcXVlc3RCb2R5IiwibG9nUmVzcG9uc2VIZWFkZXJzIiwibG9nUmVzcG9uc2VCb2R5Iiwic3RyaW5naWZ5UmVzcG9uc2VCb2R5IiwiUmVxdWVzdExvZ2dlckltcGxlbWVudGF0aW9uIiwiUmVxdWVzdEhvb2siLCJjb25zdHJ1Y3RvciIsInJlcXVlc3RGaWx0ZXJSdWxlSW5pdCIsIm9wdGlvbnMiLCJfYXNzZXJ0TG9nT3B0aW9ucyIsImNvbmZpZ3VyZVJlc3BvbnNlRXZlbnRPcHRpb25zIiwiQ29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMiLCJfaW50ZXJuYWxSZXF1ZXN0cyIsImxvZ09wdGlvbnMiLCJBUElFcnJvciIsIlJVTlRJTUVfRVJST1JTIiwicmVxdWVzdEhvb2tDb25maWd1cmVBUElFcnJvciIsIm9uUmVxdWVzdCIsImV2ZW50IiwidXNlckFnZW50IiwiX3JlcXVlc3RJbmZvIiwidG9TdHJpbmciLCJsb2dnZWRSZXEiLCJpZCIsInJlcXVlc3RJZCIsInRlc3RSdW5JZCIsInNlc3Npb25JZCIsInJlcXVlc3QiLCJ1cmwiLCJtZXRob2QiLCJoZWFkZXJzIiwiYm9keSIsIm9uUmVzcG9uc2UiLCJsb2dnZXJSZXEiLCJyZXNwb25zZSIsInN0YXR1c0NvZGUiLCJfcHJlcGFyZUludGVybmFsUmVxdWVzdEluZm8iLCJ0ZXN0UnVuIiwidGVzdFJ1blRyYWNrZXIiLCJyZXNvbHZlQ29udGV4dFRlc3RSdW4iLCJwcmVwYXJlZFJlcXVlc3RzIiwiZmlsdGVyIiwiciIsIl9nZXRDb21wbGV0ZWRSZXF1ZXN0cyIsImNvbnRhaW5zIiwicHJlZGljYXRlIiwiUmVFeGVjdXRhYmxlUHJvbWlzZSIs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QTdCLENBQW9DSSxTQUFwQyxFQUErQ0ssTUFBdEQ7QUFDSCxTQUZNLEVBQVA7QUFHSDs7QUFFREMsWUFBUztBQUNMLGNBQU1kLFVBQVVDLHlCQUFlQyxxQkFBZixFQUFoQjs7QUFFQSxZQUFJRixPQUFKLEVBQWE7QUFDVCxnQ0FBWSxLQUFLekIsaUJBQWpCLEVBQW9Dd0MsT0FBcEMsQ0FBNEM3QixNQUFNO0FBQzlDLG9CQUFJLEtBQUtYLGlCQUFMLENBQXVCVyxFQUF2QixFQUEyQkUsU0FBM0IsS0FBeUNZLFFBQVFkLEVBQXJELEVBQ0ksT0FBTyxLQUFLWCxpQkFBTCxDQUF1QlcsRUFBdkIsQ0FBUDtBQUNQLGFBSEQ7QUFJSCxTQUxELE1BT0ksS0FBS1gsaUJBQUwsR0FBeUIsRUFBekI7QUFDUDs7QUFFRCxRQUFJeUMsUUFBSixHQUFnQjtBQUNaLGVBQU8sS0FBS2pCLDJCQUFMLEVBQVA7QUFDSDtBQTNHaUQ7O0FBOEd2QyxTQUFTeEMsbUJBQVQsQ0FBOEJXLHFCQUE5QixFQUFxRE0sVUFBckQsRUFBaUU7QUFDNUUsV0FBTyxJQUFJVCwyQkFBSixDQUFnQ0cscUJBQWhDLEVBQXVETSxVQUF2RCxDQUFQO0FBQ0giLCJmaWxlIjoiYXBpL3JlcXVlc3QtaG9va3MvcmVxdWVzdC1sb2dnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25maWd1cmVSZXNwb25zZUV2ZW50T3B0aW9ucyB9IGZyb20gJ3Rlc3RjYWZlLWhhbW1lcmhlYWQnO1xuaW1wb3J0IFJlcXVlc3RIb29rIGZyb20gJy4vaG9vayc7XG5pbXBvcnQgeyBwYXJzZSBhcyBwYXJzZVVzZXJBZ2VudCB9IGZyb20gJ3VzZXJhZ2VudCc7XG5pbXBvcnQgdGVzdFJ1blRyYWNrZXIgZnJvbSAnLi4vdGVzdC1ydW4tdHJhY2tlcic7XG5pbXBvcnQgUmVFeGVjdXRhYmxlUHJvbWlzZSBmcm9tICcuLi8uLi91dGlscy9yZS1leGVjdXRhYmxlLXByb21pc2UnO1xuaW1wb3J0IHsgQVBJRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBSVU5USU1FX0VSUk9SUyB9IGZyb20gJy4uLy4uL2Vycm9ycy90eXBlcyc7XG5cbmNvbnN0IERFRkFVTFRfT1BUSU9OUyA9IHtcbiAgICBsb2dSZXF1ZXN0SGVhZGVyczogICAgIGZhbHNlLFxuICAgIGxvZ1JlcXVlc3RCb2R5OiAgICAgICAgZmFsc2UsXG4gICAgc3RyaW5naWZ5UmVxdWVzdEJvZHk6ICBmYWxzZSxcbiAgICBsb2dSZXNwb25zZUhlYWRlcnM6ICAgIGZhbHNlLFxuICAgIGxvZ1Jlc3BvbnNlQm9keTogICAgICAgZmFsc2UsXG4gICAgc3RyaW5naWZ5UmVzcG9uc2VCb2R5OiBmYWxzZVxufTtcblxuY2xhc3MgUmVxdWVzdExvZ2dlckltcGxlbWVudGF0aW9uIGV4dGVuZHMgUmVxdWVzdEhvb2sge1xuICAgIGNvbnN0cnVjdG9yIChyZXF1ZXN0RmlsdGVyUnVsZUluaXQsIG9wdGlvbnMpIHtcbiAgICAgICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfT1BUSU9OUywgb3B0aW9ucyk7XG4gICAgICAgIFJlcXVlc3RMb2dnZXJJbXBsZW1lbnRhdGlvbi5fYXNzZXJ0TG9nT3B0aW9ucyhvcHRpb25zKTtcblxuICAgICAgICBjb25zdCBjb25maWd1cmVSZXNwb25zZUV2ZW50T3B0aW9ucyA9IG5ldyBDb25maWd1cmVSZXNwb25zZUV2ZW50T3B0aW9ucyhvcHRpb25zLmxvZ1Jlc3BvbnNlSGVhZGVycywgb3B0aW9ucy5sb2dSZXNwb25zZUJvZHkpO1xuXG4gICAgICAgIHN1cGVyKHJlcXVlc3RGaWx0ZXJSdWxlSW5pdCwgY29uZmlndXJlUmVzcG9uc2VFdmVudE9wdGlvbnMpO1xuXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG5cbiAgICAgICAgdGhpcy5faW50ZXJuYWxSZXF1ZXN0cyA9IHt9O1xuICAgIH1cblxuICAgIHN0YXRpYyBfYXNzZXJ0TG9nT3B0aW9ucyAobG9nT3B0aW9ucykge1xuICAgICAgICBpZiAoIWxvZ09wdGlvbnMubG9nUmVxdWVzdEJvZHkgJiYgbG9nT3B0aW9ucy5zdHJpbmdpZnlSZXF1ZXN0Qm9keSlcbiAgICAgICAgICAgIHRocm93IG5ldyBBUElFcnJvcignUmVxdWVzdExvZ2dlcicsIFJVTlRJTUVfRVJST1JTLnJlcXVlc3RIb29rQ29uZmlndXJlQVBJRXJyb3IsICdSZXF1ZXN0TG9nZ2VyJywgJ0Nhbm5vdCBzdHJpbmdpZnkgdGhlIHJlcXVlc3QgYm9keSBiZWNhdXNlIGl0IGlzIG5vdCBsb2dnZWQuIFNwZWNpZnkgeyBsb2dSZXF1ZXN0Qm9keTogdHJ1ZSB9IGluIGxvZyBvcHRpb25zLicpO1xuXG4gICAgICAgIGlmICghbG9nT3B0aW9ucy5sb2dSZXNwb25zZUJvZHkgJiYgbG9nT3B0aW9ucy5zdHJpbmdpZnlSZXNwb25zZUJvZHkpXG4gICAgICAgICAgICB0aHJvdyBuZXcgQVBJRXJyb3IoJ1JlcXVlc3RMb2dnZXInLCBSVU5USU1FX0VSUk9SUy5yZXF1ZXN0SG9va0NvbmZpZ3VyZUFQSUVycm9yLCAnUmVxdWVzdExvZ2dlcicsICdDYW5ub3Qgc3RyaW5naWZ5IHRoZSByZXNwb25zZSBib2R5IGJlY2F1c2UgaXQgaXMgbm90IGxvZ2dlZC4gU3BlY2lmeSB7IGxvZ1Jlc3BvbnNlQm9keTogdHJ1ZSB9IGluIGxvZyBvcHRpb25zLicpO1xuICAgIH1cblxuICAgIGFzeW5jIG9uUmVxdWVzdCAoZXZlbnQpIHtcbiAgICAgICAgY29uc3QgdXNlckFnZW50ID0gcGFyc2VVc2VyQWdlbnQoZXZlbnQuX3JlcXVlc3RJbmZvLnVzZXJBZ2VudCkudG9TdHJpbmcoKTtcblxuICAgICAgICBjb25zdCBsb2dnZWRSZXEgPSB7XG4gICAgICAgICAgICBpZDogICAgICAgIGV2ZW50Ll9yZXF1ZXN0SW5mby5yZXF1ZXN0SWQsXG4gICAgICAgICAgICB0ZXN0UnVuSWQ6IGV2ZW50Ll9yZXF1ZXN0SW5mby5zZXNzaW9uSWQsXG4gICAgICAgICAgICB1c2VyQWdlbnQsXG4gICAgICAgICAgICByZXF1ZXN0OiAgIHtcbiAgICAgICAgICAgICAgICB1cmw6ICAgIGV2ZW50Ll9yZXF1ZXN0SW5mby51cmwsXG4gICAgICAgICAgICAgICAgbWV0aG9kOiBldmVudC5fcmVxdWVzdEluZm8ubWV0aG9kLFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nUmVxdWVzdEhlYWRlcnMpXG4gICAgICAgICAgICBsb2dnZWRSZXEucmVxdWVzdC5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgZXZlbnQuX3JlcXVlc3RJbmZvLmhlYWRlcnMpO1xuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nUmVxdWVzdEJvZHkpXG4gICAgICAgICAgICBsb2dnZWRSZXEucmVxdWVzdC5ib2R5ID0gdGhpcy5vcHRpb25zLnN0cmluZ2lmeVJlcXVlc3RCb2R5ID8gZXZlbnQuX3JlcXVlc3RJbmZvLmJvZHkudG9TdHJpbmcoKSA6IGV2ZW50Ll9yZXF1ZXN0SW5mby5ib2R5O1xuXG4gICAgICAgIHRoaXMuX2ludGVybmFsUmVxdWVzdHNbbG9nZ2VkUmVxLmlkXSA9IGxvZ2dlZFJlcTtcbiAgICB9XG5cbiAgICBhc3luYyBvblJlc3BvbnNlIChldmVudCkge1xuICAgICAgICBjb25zdCBsb2dnZXJSZXEgPSB0aGlzLl9pbnRlcm5hbFJlcXVlc3RzW2V2ZW50LnJlcXVlc3RJZF07XG5cbiAgICAgICAgLy8gTk9URTogSWYgdGhlICdjbGVhcicgbWV0aG9kIGlzIGNhbGxlZCBkdXJpbmcgYSBsb25nIHJ1bm5pbmcgcmVxdWVzdCxcbiAgICAgICAgLy8gd2Ugc2hvdWxkIG5vdCBzYXZlIGEgcmVzcG9uc2UgcGFydCAtIHJlcXVlc3QgcGFydCBoYXMgYmVlbiBhbHJlYWR5IHJlbW92ZWQuXG4gICAgICAgIGlmICghbG9nZ2VyUmVxKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGxvZ2dlclJlcS5yZXNwb25zZSAgICAgICAgICAgID0ge307XG4gICAgICAgIGxvZ2dlclJlcS5yZXNwb25zZS5zdGF0dXNDb2RlID0gZXZlbnQuc3RhdHVzQ29kZTtcblxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLmxvZ1Jlc3BvbnNlSGVhZGVycylcbiAgICAgICAgICAgIGxvZ2dlclJlcS5yZXNwb25zZS5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgZXZlbnQuaGVhZGVycyk7XG5cbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dSZXNwb25zZUJvZHkpIHtcbiAgICAgICAgICAgIGxvZ2dlclJlcS5yZXNwb25zZS5ib2R5ID0gdGhpcy5vcHRpb25zLnN0cmluZ2lmeVJlc3BvbnNlQm9keSAmJiBldmVudC5ib2R5XG4gICAgICAgICAgICAgICAgPyBldmVudC5ib2R5LnRvU3RyaW5nKClcbiAgICAgICAgICAgICAgICA6IGV2ZW50LmJvZHk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcHJlcGFyZUludGVybmFsUmVxdWVzdEluZm8gKCkge1xuICAgICAgICBjb25zdCB0ZXN0UnVuICAgICAgICA9IHRlc3RSdW5UcmFja2VyLnJlc29sdmVDb250ZXh0VGVzdFJ1bigpO1xuICAgICAgICBsZXQgcHJlcGFyZWRSZXF1ZXN0cyA9IE9iamVjdC52YWx1ZXModGhpcy5faW50ZXJuYWxSZXF1ZXN0cyk7XG5cbiAgICAgICAgaWYgKHRlc3RSdW4pXG4gICAgICAgICAgICBwcmVwYXJlZFJlcXVlc3RzID0gcHJlcGFyZWRSZXF1ZXN0cy5maWx0ZXIociA9PiByLnRlc3RSdW5JZCA9PT0gdGVzdFJ1bi5pZCk7XG5cbiAgICAgICAgcmV0dXJuIHByZXBhcmVkUmVxdWVzdHM7XG4gICAgfVxuXG4gICAgX2dldENvbXBsZXRlZFJlcXVlc3RzICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZXBhcmVJbnRlcm5hbFJlcXVlc3RJbmZvKCkuZmlsdGVyKHIgPT4gci5yZXNwb25zZSk7XG4gICAgfVxuXG4gICAgLy8gQVBJXG4gICAgY29udGFpbnMgKHByZWRpY2F0ZSkge1xuICAgICAgICByZXR1cm4gUmVFeGVjdXRhYmxlUHJvbWlzZS5mcm9tRm4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuICEhdGhpcy5fZ2V0Q29tcGxldGVkUmVxdWVzdHMoKS5maW5kKHByZWRpY2F0ZSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvdW50IChwcmVkaWNhdGUpIHtcbiAgICAgICAgcmV0dXJuIFJlRXhlY3V0YWJsZVByb21pc2UuZnJvbUZuKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9nZXRDb21wbGV0ZWRSZXF1ZXN0cygpLmZpbHRlcihwcmVkaWNhdGUpLmxlbmd0aDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgY2xlYXIgKCkge1xuICAgICAgICBjb25zdCB0ZXN0UnVuID0gdGVzdFJ1blRyYWNrZXIucmVzb2x2ZUNvbnRleHRUZXN0UnVuKCk7XG5cbiAgICAgICAgaWYgKHRlc3RSdW4pIHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKHRoaXMuX2ludGVybmFsUmVxdWVzdHMpLmZvckVhY2goaWQgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9pbnRlcm5hbFJlcXVlc3RzW2lkXS50ZXN0UnVuSWQgPT09IHRlc3RSdW4uaWQpXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbnRlcm5hbFJlcXVlc3RzW2lkXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUmVxdWVzdHMgPSB7fTtcbiAgICB9XG5cbiAgICBnZXQgcmVxdWVzdHMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fcHJlcGFyZUludGVybmFsUmVxdWVzdEluZm8oKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNyZWF0ZVJlcXVlc3RMb2dnZXIgKHJlcXVlc3RGaWx0ZXJSdWxlSW5pdCwgbG9nT3B0aW9ucykge1xuICAgIHJldHVybiBuZXcgUmVxdWVzdExvZ2dlckltcGxlbWVudGF0aW9uKHJlcXVlc3RGaWx0ZXJSdWxlSW5pdCwgbG9nT3B0aW9ucyk7XG59XG5cbiJdfQ==
