'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _events = require('events');

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _mustache = require('mustache');

var _mustache2 = _interopRequireDefault(_mustache);

var _lodash = require('lodash');

var _useragent = require('useragent');

var _readFileRelative = require('read-file-relative');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _nanoid = require('nanoid');

var _nanoid2 = _interopRequireDefault(_nanoid);

var _command = require('./command');

var _command2 = _interopRequireDefault(_command);

var _status = require('./status');

var _status2 = _interopRequireDefault(_status);

var _runtime = require('../../errors/runtime');

var _types = require('../../errors/types');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const IDLE_PAGE_TEMPLATE = (0, _readFileRelative.readSync)('../../client/browser/idle-page/index.html.mustache');
const connections = {};

class BrowserConnection extends _events.EventEmitter {
    constructor(gateway, browserInfo, permanent) {
        super();

        this.HEARTBEAT_TIMEOUT = 2 * 60 * 1000;
        this.BROWSER_RESTART_TIMEOUT = 60 * 1000;

        this.id = BrowserConnection._generateId();
        this.jobQueue = [];
        this.initScriptsQueue = [];
        this.browserConnectionGateway = gateway;
        this.errorSuppressed = false;
        this.testRunAborted = false;

        this.browserInfo = browserInfo;
        this.browserInfo.userAgent = '';
        this.browserInfo.userAgentProviderMetaInfo = '';

        this.provider = browserInfo.provider;

        this.permanent = permanent;
        this.closing = false;
        this.closed = false;
        this.ready = false;
        this.opened = false;
        this.idle = true;
        this.heartbeatTimeout = null;
        this.pendingTestRunUrl = null;

        this.url = `${gateway.domain}/browser/connect/${this.id}`;
        this.idleUrl = `${gateway.domain}/browser/idle/${this.id}`;
        this.forcedIdleUrl = `${gateway.domain}/browser/idle-forced/${this.id}`;
        this.initScriptUrl = `${gateway.domain}/browser/init-script/${this.id}`;

        this.heartbeatRelativeUrl = `/browser/heartbeat/${this.id}`;
        this.statusRelativeUrl = `/browser/status/${this.id}`;
        this.statusDoneRelativeUrl = `/browser/status-done/${this.id}`;

        this.heartbeatUrl = `${gateway.domain}${this.heartbeatRelativeUrl}`;
        this.statusUrl = `${gateway.domain}${this.statusRelativeUrl}`;
        this.statusDoneUrl = `${gateway.domain}${this.statusDoneRelativeUrl}`;

        this.on('error', () => {
            this._forceIdle();
            this.close();
        });

        connections[this.id] = this;

        this.browserConnectionGateway.startServingConnection(this);

        process.nextTick(() => this._runBrowser());
    }

    static _generateId() {
        return (0, _nanoid2.default)(7);
    }

    _runBrowser() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            try {
                yield _this.provider.openBrowser(_this.id, _this.url, _this.browserInfo.browserName);

                if (!_this.ready) yield (0, _promisifyEvent2.default)(_this, 'ready');

                _this.opened = true;
                _this.emit('opened');
            } catch (err) {
                _this.emit('error', new _runtime.GeneralError(_types.RUNTIME_ERRORS.unableToOpenBrowser, _this.browserInfo.providerName + ':' + _this.browserInfo.browserName, err.stack));
            }
        })();
    }

    _closeBrowser() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this2.idle) yield (0, _promisifyEvent2.default)(_this2, 'idle');

            try {
                yield _this2.provider.closeBrowser(_this2.id);
            } catch (err) {
                // NOTE: A warning would be really nice here, but it can't be done while log is stored in a task.
            }
        })();
    }

    _forceIdle() {
        if (!this.idle) {
            this.switchingToIdle = false;
            this.idle = true;
            this.emit('idle');
        }
    }

    _createBrowserDisconnectedError() {
        return new _runtime.GeneralError(_types.RUNTIME_ERRORS.browserDisconnected, this.userAgent);
    }

    _waitForHeartbeat() {
        this.heartbeatTimeout = setTimeout(() => {
            const err = this._createBrowserDisconnectedError();

            this.opened = false;
            this.errorSuppressed = false;
            this.testRunAborted = true;

            this.emit('disconnected', err);

            if (!this.errorSuppressed) this.emit('error', err);
        }, this.HEARTBEAT_TIMEOUT);
    }

    _getTestRunUrl(needPopNext) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (needPopNext || !_this3.pendingTestRunUrl) _this3.pendingTestRunUrl = yield _this3._popNextTestRunUrl();

            return _this3.pendingTestRunUrl;
        })();
    }

    _popNextTestRunUrl() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            while (_this4.hasQueuedJobs && !_this4.currentJob.hasQueuedTestRuns) _this4.jobQueue.shift();

            return _this4.hasQueuedJobs ? yield _this4.currentJob.popNextTestRunUrl(_this4) : null;
        })();
    }

    static getById(id) {
        return connections[id] || null;
    }

    restartBrowser() {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this5.ready = false;

            _this5._forceIdle();

            let resolveTimeout = null;
            let isTimeoutExpired = false;
            let timeout = null;

            const restartPromise = _this5._closeBrowser().then(function () {
                return _this5._runBrowser();
            });

            const timeoutPromise = new _pinkie2.default(function (resolve) {
                resolveTimeout = resolve;

                timeout = setTimeout(function () {
                    isTimeoutExpired = true;

                    resolve();
                }, _this5.BROWSER_RESTART_TIMEOUT);
            });

            _pinkie2.default.race([restartPromise, timeoutPromise]).then(function () {
                clearTimeout(timeout);

                if (isTimeoutExpired) _this5.emit('error', _this5._createBrowserDisconnectedError());else resolveTimeout();
            });
        })();
    }

    suppressError() {
        this.errorSuppressed = true;
    }

    addWarning(...args) {
        if (this.currentJob) this.currentJob.warningLog.addWarning(...args);
    }

    setProviderMetaInfo(str) {
        this.browserInfo.userAgentProviderMetaInfo = str;
    }

    get userAgent() {
        let userAgent = this.browserInfo.userAgent;

        if (this.browserInfo.userAgentProviderMetaInfo) userAgent += ` (${this.browserInfo.userAgentProviderMetaInfo})`;

        return userAgent;
    }

    get hasQueuedJobs() {
        return !!this.jobQueue.length;
    }

    get currentJob() {
        return this.jobQueue[0];
    }

    // API
    runInitScript(code) {
        return new _pinkie2.default(resolve => this.initScriptsQueue.push({ code, resolve }));
    }

    addJob(job) {
        this.jobQueue.push(job);
    }

    removeJob(job) {
        (0, _lodash.pull)(this.jobQueue, job);
    }

    close() {
        if (this.closed || this.closing) return;

        this.closing = true;

        this._closeBrowser().then(() => {
            this.browserConnectionGateway.stopServingConnection(this);
            clearTimeout(this.heartbeatTimeout);

            delete connections[this.id];

            this.ready = false;
            this.closed = true;

            this.emit('closed');
        });
    }

    establish(userAgent) {
        this.ready = true;

        const parsedUserAgent = (0, _useragent.parse)(userAgent);

        this.browserInfo.userAgent = parsedUserAgent.toString();
        this.browserInfo.fullUserAgent = userAgent;
        this.browserInfo.parsedUserAgent = parsedUserAgent;

        this._waitForHeartbeat();
        this.emit('ready');
    }

    heartbeat() {
        clearTimeout(this.heartbeatTimeout);
        this._waitForHeartbeat();

        return {
            code: this.closing ? _status2.default.closing : _status2.default.ok,
            url: this.closing ? this.idleUrl : ''
        };
    }

    renderIdlePage() {
        return _mustache2.default.render(IDLE_PAGE_TEMPLATE, {
            userAgent: this.userAgent,
            statusUrl: this.statusUrl,
            heartbeatUrl: this.heartbeatUrl,
            initScriptUrl: this.initScriptUrl,
            retryTestPages: !!this.browserConnectionGateway.retryTestPages
        });
    }

    getInitScript() {
        const initScriptPromise = this.initScriptsQueue[0];

        return { code: initScriptPromise ? initScriptPromise.code : null };
    }

    handleInitScriptResult(data) {
        const initScriptPromise = this.initScriptsQueue.shift();

        if (initScriptPromise) initScriptPromise.resolve(JSON.parse(data));
    }

    isHeadlessBrowser() {
        return this.provider.isHeadlessBrowser(this.id);
    }

    reportJobResult(status, data) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this6.provider.reportJobResult(_this6.id, status, data);
        })();
    }

    getStatus(isTestDone) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this7.idle && !isTestDone) {
                _this7.idle = true;
                _this7.emit('idle');
            }

            if (_this7.opened) {
                const testRunUrl = yield _this7._getTestRunUrl(isTestDone || _this7.testRunAborted);

                _this7.testRunAborted = false;

                if (testRunUrl) {
                    _this7.idle = false;
                    return { cmd: _command2.default.run, url: testRunUrl };
                }
            }

            return { cmd: _command2.default.idle, url: _this7.idleUrl };
        })();
    }
}
exports.default = BrowserConnection;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2Nvbm5lY3Rpb24vaW5kZXguanMiXSwibmFtZXMiOlsiSURMRV9QQUdFX1RFTVBMQVRFIiwiY29ubmVjdGlvbnMiLCJCcm93c2VyQ29ubmVjdGlvbiIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwiZ2F0ZXdheSIsImJyb3dzZXJJbmZvIiwicGVybWFuZW50IiwiSEVBUlRCRUFUX1RJTUVPVVQiLCJCUk9XU0VSX1JFU1RBUlRfVElNRU9VVCIsImlkIiwiX2dlbmVyYXRlSWQiLCJqb2JRdWV1ZSIsImluaXRTY3JpcHRzUXVldWUiLCJicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkiLCJlcnJvclN1cHByZXNzZWQiLCJ0ZXN0UnVuQWJvcnRlZCIsInVzZXJBZ2VudCIsInVzZXJBZ2VudFByb3ZpZGVyTWV0YUluZm8iLCJwcm92aWRlciIsImNsb3NpbmciLCJjbG9zZWQiLCJyZWFkeSIsIm9wZW5lZCIsImlkbGUiLCJoZWFydGJlYXRUaW1lb3V0IiwicGVuZGluZ1Rlc3RSdW5VcmwiLCJ1cmwiLCJkb21haW4iLCJpZGxlVXJsIiwiZm9yY2VkSWRsZVVybCIsImluaXRTY3JpcHRVcmwiLCJoZWFydGJlYXRSZWxhdGl2ZVVybCIsInN0YXR1c1JlbGF0aXZlVXJsIiwic3RhdHVzRG9uZVJlbGF0aXZlVXJsIiwiaGVhcnRiZWF0VXJsIiwic3RhdHVzVXJsIiwic3RhdHVzRG9uZVVybCIsIm9uIiwiX2ZvcmNlSWRsZSIsImNsb3NlIiwic3RhcnRTZXJ2aW5nQ29ubmVjdGlvbiIsInByb2Nlc3MiLCJuZXh0VGljayIsIl9ydW5Ccm93c2VyIiwib3BlbkJyb3dzZXIiLCJicm93c2VyTmFtZSIsImVtaXQiLCJlcnIiLCJHZW5lcmFsRXJyb3IiLCJSVU5USU1FX0VSUk9SUyIsInVuYWJsZVRvT3BlbkJyb3dzZXIiLCJwcm92aWRlck5hbWUiLCJzdGFjayIsIl9jbG9zZUJyb3dzZXIiLCJjbG9zZUJyb3dzZXIiLCJzd2l0Y2hpbmdUb0lkbGUiLCJfY3JlYXRlQnJvd3NlckRpc2Nvbm5lY3RlZEVycm9yIiwiYnJvd3NlckRpc2Nvbm5lY3RlZCIsIl93YWl0Rm9ySGVhcnRiZWF0Iiwic2V0VGltZW91dCIsIl9nZXRUZXN0UnVuVXJsIiwibmVlZFBvcE5leHQiLCJfcG9wTmV4dFRlc3RSdW5VcmwiLCJoYXNRdWV1ZWRKb2JzIiwiY3VycmVudEpvYiIsImhhc1F1ZXVlZFRlc3RSdW5zIiwic2hpZnQiLCJwb3BOZXh0VGVzdFJ1blVybCIsImdldEJ5SWQiLCJyZXN0YXJ0QnJvd3NlciIsInJlc29sdmVUaW1lb3V0IiwiaXNUaW1lb3V0RXhwaXJlZCIsInRpbWVvdXQiLCJyZXN0YXJ0UHJvbWlzZSIsInRoZW4iLCJ0aW1lb3V0UHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmFjZSIsImNsZWFyVGltZW91dCIsInN1cHByZXNzRXJyb3IiLCJhZGRXYXJuaW5nIiwiYXJncyIsIndhcm5pbmdMb2ciLCJzZXRQcm92aWRlck1ldGFJbmZvIiwic3RyIiwibGVuZ3RoIiwicnVuSW5pdFNjcmlwdCIsImNvZGUiLCJwdXNoIiwiYWRkSm9iIiwiam9iIiwicmVtb3ZlSm9iIiwic3RvcFNlcnZpbmdDb25uZWN0aW9uIiwiZXN0YWJsaXNoIiwicGFyc2VkVXNlckFnZW50IiwidG9TdHJpbmciLCJmdWxsVXNlckFnZW50IiwiaGVhcnRiZWF0IiwiU1RBVFVTIiwib2siLCJyZW5kZXJJZGxlUGFnZSIsIk11c3RhY2hlIiwicmVuZGVyIiwicmV0cnlUZXN0UGFnZXMiLCJnZXRJbml0U2NyaXB0IiwiaW5pdFNjcmlwdFByb21pc2UiLCJoYW5kbGVJbml0U2NyaXB0UmVzdWx0IiwiZGF0YSIsIkpTT04iLCJwYXJzZSIsImlzSGVhZGxlc3NCcm93c2VyIiwicmVwb3J0Sm9iUmVzdWx0Iiwic3RhdHVzIiwiZ2V0U3RhdHVzIiwiaXNUZXN0RG9uZSIsInRlc3RSdW5VcmwiLCJjbWQiLCJDT01NQU5EIiwicnVuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFB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QjtBQUNqQixlQUFPLEtBQUs3RixRQUFMLENBQWM2RixpQkFBZCxDQUFnQyxLQUFLdEcsRUFBckMsQ0FBUDtBQUNIOztBQUVLdUcsbUJBQU4sQ0FBdUJDLE1BQXZCLEVBQStCTCxJQUEvQixFQUFxQztBQUFBOztBQUFBO0FBQ2pDLGtCQUFNLE9BQUsxRixRQUFMLENBQWM4RixlQUFkLENBQThCLE9BQUt2RyxFQUFuQyxFQUF1Q3dHLE1BQXZDLEVBQStDTCxJQUEvQyxDQUFOO0FBRGlDO0FBRXBDOztBQUVLTSxhQUFOLENBQWlCQyxVQUFqQixFQUE2QjtBQUFBOztBQUFBO0FBQ3pCLGdCQUFJLENBQUMsT0FBSzVGLElBQU4sSUFBYyxDQUFDNEYsVUFBbkIsRUFBK0I7QUFDM0IsdUJBQUs1RixJQUFMLEdBQVksSUFBWjtBQUNBLHVCQUFLdUIsSUFBTCxDQUFVLE1BQVY7QUFDSDs7QUFFRCxnQkFBSSxPQUFLeEIsTUFBVCxFQUFpQjtBQUNiLHNCQUFNOEYsYUFBYSxNQUFNLE9BQUt4RCxjQUFMLENBQW9CdUQsY0FBYyxPQUFLcEcsY0FBdkMsQ0FBekI7O0FBRUEsdUJBQUtBLGNBQUwsR0FBc0IsS0FBdEI7O0FBRUEsb0JBQUlxRyxVQUFKLEVBQWdCO0FBQ1osMkJBQUs3RixJQUFMLEdBQVksS0FBWjtBQUNBLDJCQUFPLEVBQUU4RixLQUFLQyxrQkFBUUMsR0FBZixFQUFvQjdGLEtBQUswRixVQUF6QixFQUFQO0FBQ0g7QUFDSjs7QUFFRCxtQkFBTyxFQUFFQyxLQUFLQyxrQkFBUS9GLElBQWYsRUFBcUJHLEtBQUssT0FBS0UsT0FBL0IsRUFBUDtBQWpCeUI7QUFrQjVCO0FBL1N1RDtrQkFBdkMzQixpQiIsImZpbGUiOiJicm93c2VyL2Nvbm5lY3Rpb24vaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCBNdXN0YWNoZSBmcm9tICdtdXN0YWNoZSc7XG5pbXBvcnQgeyBwdWxsIGFzIHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBwYXJzZSBhcyBwYXJzZVVzZXJBZ2VudCB9IGZyb20gJ3VzZXJhZ2VudCc7XG5pbXBvcnQgeyByZWFkU3luYyBhcyByZWFkIH0gZnJvbSAncmVhZC1maWxlLXJlbGF0aXZlJztcbmltcG9ydCBwcm9taXNpZnlFdmVudCBmcm9tICdwcm9taXNpZnktZXZlbnQnO1xuaW1wb3J0IG5hbm9pZCBmcm9tICduYW5vaWQnO1xuaW1wb3J0IENPTU1BTkQgZnJvbSAnLi9jb21tYW5kJztcbmltcG9ydCBTVEFUVVMgZnJvbSAnLi9zdGF0dXMnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuXG5jb25zdCBJRExFX1BBR0VfVEVNUExBVEUgPSByZWFkKCcuLi8uLi9jbGllbnQvYnJvd3Nlci9pZGxlLXBhZ2UvaW5kZXguaHRtbC5tdXN0YWNoZScpO1xuY29uc3QgY29ubmVjdGlvbnMgICAgICAgID0ge307XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQnJvd3NlckNvbm5lY3Rpb24gZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICAgIGNvbnN0cnVjdG9yIChnYXRld2F5LCBicm93c2VySW5mbywgcGVybWFuZW50KSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5IRUFSVEJFQVRfVElNRU9VVCAgICAgICA9IDIgKiA2MCAqIDEwMDA7XG4gICAgICAgIHRoaXMuQlJPV1NFUl9SRVNUQVJUX1RJTUVPVVQgPSA2MCAqIDEwMDA7XG5cbiAgICAgICAgdGhpcy5pZCAgICAgICAgICAgICAgICAgICAgICAgPSBCcm93c2VyQ29ubmVjdGlvbi5fZ2VuZXJhdGVJZCgpO1xuICAgICAgICB0aGlzLmpvYlF1ZXVlICAgICAgICAgICAgICAgICA9IFtdO1xuICAgICAgICB0aGlzLmluaXRTY3JpcHRzUXVldWUgICAgICAgICA9IFtdO1xuICAgICAgICB0aGlzLmJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSA9IGdhdGV3YXk7XG4gICAgICAgIHRoaXMuZXJyb3JTdXBwcmVzc2VkICAgICAgICAgID0gZmFsc2U7XG4gICAgICAgIHRoaXMudGVzdFJ1bkFib3J0ZWQgICAgICAgICAgID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5icm93c2VySW5mbyAgICAgICAgICAgICAgICAgICAgICAgICAgID0gYnJvd3NlckluZm87XG4gICAgICAgIHRoaXMuYnJvd3NlckluZm8udXNlckFnZW50ICAgICAgICAgICAgICAgICA9ICcnO1xuICAgICAgICB0aGlzLmJyb3dzZXJJbmZvLnVzZXJBZ2VudFByb3ZpZGVyTWV0YUluZm8gPSAnJztcblxuICAgICAgICB0aGlzLnByb3ZpZGVyID0gYnJvd3NlckluZm8ucHJvdmlkZXI7XG5cbiAgICAgICAgdGhpcy5wZXJtYW5lbnQgICAgICAgICA9IHBlcm1hbmVudDtcbiAgICAgICAgdGhpcy5jbG9zaW5nICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNsb3NlZCAgICAgICAgICAgID0gZmFsc2U7XG4gICAgICAgIHRoaXMucmVhZHkgICAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5vcGVuZWQgICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLmlkbGUgICAgICAgICAgICAgID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5oZWFydGJlYXRUaW1lb3V0ICA9IG51bGw7XG4gICAgICAgIHRoaXMucGVuZGluZ1Rlc3RSdW5VcmwgPSBudWxsO1xuXG4gICAgICAgIHRoaXMudXJsICAgICAgICAgICA9IGAke2dhdGV3YXkuZG9tYWlufS9icm93c2VyL2Nvbm5lY3QvJHt0aGlzLmlkfWA7XG4gICAgICAgIHRoaXMuaWRsZVVybCAgICAgICA9IGAke2dhdGV3YXkuZG9tYWlufS9icm93c2VyL2lkbGUvJHt0aGlzLmlkfWA7XG4gICAgICAgIHRoaXMuZm9yY2VkSWRsZVVybCA9IGAke2dhdGV3YXkuZG9tYWlufS9icm93c2VyL2lkbGUtZm9yY2VkLyR7dGhpcy5pZH1gO1xuICAgICAgICB0aGlzLmluaXRTY3JpcHRVcmwgPSBgJHtnYXRld2F5LmRvbWFpbn0vYnJvd3Nlci9pbml0LXNjcmlwdC8ke3RoaXMuaWR9YDtcblxuICAgICAgICB0aGlzLmhlYXJ0YmVhdFJlbGF0aXZlVXJsICA9IGAvYnJvd3Nlci9oZWFydGJlYXQvJHt0aGlzLmlkfWA7XG4gICAgICAgIHRoaXMuc3RhdHVzUmVsYXRpdmVVcmwgICAgID0gYC9icm93c2VyL3N0YXR1cy8ke3RoaXMuaWR9YDtcbiAgICAgICAgdGhpcy5zdGF0dXNEb25lUmVsYXRpdmVVcmwgPSBgL2Jyb3dzZXIvc3RhdHVzLWRvbmUvJHt0aGlzLmlkfWA7XG5cbiAgICAgICAgdGhpcy5oZWFydGJlYXRVcmwgID0gYCR7Z2F0ZXdheS5kb21haW59JHt0aGlzLmhlYXJ0YmVhdFJlbGF0aXZlVXJsfWA7XG4gICAgICAgIHRoaXMuc3RhdHVzVXJsICAgICA9IGAke2dhdGV3YXkuZG9tYWlufSR7dGhpcy5zdGF0dXNSZWxhdGl2ZVVybH1gO1xuICAgICAgICB0aGlzLnN0YXR1c0RvbmVVcmwgPSBgJHtnYXRld2F5LmRvbWFpbn0ke3RoaXMuc3RhdHVzRG9uZVJlbGF0aXZlVXJsfWA7XG5cbiAgICAgICAgdGhpcy5vbignZXJyb3InLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9mb3JjZUlkbGUoKTtcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29ubmVjdGlvbnNbdGhpcy5pZF0gPSB0aGlzO1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5LnN0YXJ0U2VydmluZ0Nvbm5lY3Rpb24odGhpcyk7XG5cbiAgICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB0aGlzLl9ydW5Ccm93c2VyKCkpO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZ2VuZXJhdGVJZCAoKSB7XG4gICAgICAgIHJldHVybiBuYW5vaWQoNyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3J1bkJyb3dzZXIgKCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlci5vcGVuQnJvd3Nlcih0aGlzLmlkLCB0aGlzLnVybCwgdGhpcy5icm93c2VySW5mby5icm93c2VyTmFtZSk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5yZWFkeSlcbiAgICAgICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLCAncmVhZHknKTtcblxuICAgICAgICAgICAgdGhpcy5vcGVuZWQgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdvcGVuZWQnKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgbmV3IEdlbmVyYWxFcnJvcihcbiAgICAgICAgICAgICAgICBSVU5USU1FX0VSUk9SUy51bmFibGVUb09wZW5Ccm93c2VyLFxuICAgICAgICAgICAgICAgIHRoaXMuYnJvd3NlckluZm8ucHJvdmlkZXJOYW1lICsgJzonICsgdGhpcy5icm93c2VySW5mby5icm93c2VyTmFtZSxcbiAgICAgICAgICAgICAgICBlcnIuc3RhY2tcbiAgICAgICAgICAgICkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX2Nsb3NlQnJvd3NlciAoKSB7XG4gICAgICAgIGlmICghdGhpcy5pZGxlKVxuICAgICAgICAgICAgYXdhaXQgcHJvbWlzaWZ5RXZlbnQodGhpcywgJ2lkbGUnKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5wcm92aWRlci5jbG9zZUJyb3dzZXIodGhpcy5pZCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgLy8gTk9URTogQSB3YXJuaW5nIHdvdWxkIGJlIHJlYWxseSBuaWNlIGhlcmUsIGJ1dCBpdCBjYW4ndCBiZSBkb25lIHdoaWxlIGxvZyBpcyBzdG9yZWQgaW4gYSB0YXNrLlxuICAgICAgICB9XG4gICAgfVxuXG4gICAgX2ZvcmNlSWRsZSAoKSB7XG4gICAgICAgIGlmICghdGhpcy5pZGxlKSB7XG4gICAgICAgICAgICB0aGlzLnN3aXRjaGluZ1RvSWRsZSA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5pZGxlICAgICAgICAgICAgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdpZGxlJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfY3JlYXRlQnJvd3NlckRpc2Nvbm5lY3RlZEVycm9yICgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuYnJvd3NlckRpc2Nvbm5lY3RlZCwgdGhpcy51c2VyQWdlbnQpO1xuICAgIH1cblxuICAgIF93YWl0Rm9ySGVhcnRiZWF0ICgpIHtcbiAgICAgICAgdGhpcy5oZWFydGJlYXRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlcnIgPSB0aGlzLl9jcmVhdGVCcm93c2VyRGlzY29ubmVjdGVkRXJyb3IoKTtcblxuICAgICAgICAgICAgdGhpcy5vcGVuZWQgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuZXJyb3JTdXBwcmVzc2VkID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLnRlc3RSdW5BYm9ydGVkICA9IHRydWU7XG5cbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZGlzY29ubmVjdGVkJywgZXJyKTtcblxuICAgICAgICAgICAgaWYgKCF0aGlzLmVycm9yU3VwcHJlc3NlZClcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKTtcblxuICAgICAgICB9LCB0aGlzLkhFQVJUQkVBVF9USU1FT1VUKTtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0VGVzdFJ1blVybCAobmVlZFBvcE5leHQpIHtcbiAgICAgICAgaWYgKG5lZWRQb3BOZXh0IHx8ICF0aGlzLnBlbmRpbmdUZXN0UnVuVXJsKVxuICAgICAgICAgICAgdGhpcy5wZW5kaW5nVGVzdFJ1blVybCA9IGF3YWl0IHRoaXMuX3BvcE5leHRUZXN0UnVuVXJsKCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMucGVuZGluZ1Rlc3RSdW5Vcmw7XG4gICAgfVxuXG4gICAgYXN5bmMgX3BvcE5leHRUZXN0UnVuVXJsICgpIHtcbiAgICAgICAgd2hpbGUgKHRoaXMuaGFzUXVldWVkSm9icyAmJiAhdGhpcy5jdXJyZW50Sm9iLmhhc1F1ZXVlZFRlc3RSdW5zKVxuICAgICAgICAgICAgdGhpcy5qb2JRdWV1ZS5zaGlmdCgpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmhhc1F1ZXVlZEpvYnMgPyBhd2FpdCB0aGlzLmN1cnJlbnRKb2IucG9wTmV4dFRlc3RSdW5VcmwodGhpcykgOiBudWxsO1xuICAgIH1cblxuICAgIHN0YXRpYyBnZXRCeUlkIChpZCkge1xuICAgICAgICByZXR1cm4gY29ubmVjdGlvbnNbaWRdIHx8IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVzdGFydEJyb3dzZXIgKCkge1xuICAgICAgICB0aGlzLnJlYWR5ID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5fZm9yY2VJZGxlKCk7XG5cbiAgICAgICAgbGV0IHJlc29sdmVUaW1lb3V0ICAgPSBudWxsO1xuICAgICAgICBsZXQgaXNUaW1lb3V0RXhwaXJlZCA9IGZhbHNlO1xuICAgICAgICBsZXQgdGltZW91dCAgICAgICAgICA9IG51bGw7XG5cbiAgICAgICAgY29uc3QgcmVzdGFydFByb21pc2UgPSB0aGlzLl9jbG9zZUJyb3dzZXIoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fcnVuQnJvd3NlcigpKTtcblxuICAgICAgICBjb25zdCB0aW1lb3V0UHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZVRpbWVvdXQgPSByZXNvbHZlO1xuXG4gICAgICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaXNUaW1lb3V0RXhwaXJlZCA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICB9LCB0aGlzLkJST1dTRVJfUkVTVEFSVF9USU1FT1VUKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgUHJvbWlzZS5yYWNlKFsgcmVzdGFydFByb21pc2UsIHRpbWVvdXRQcm9taXNlIF0pXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGlzVGltZW91dEV4cGlyZWQpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCB0aGlzLl9jcmVhdGVCcm93c2VyRGlzY29ubmVjdGVkRXJyb3IoKSk7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlVGltZW91dCgpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3VwcHJlc3NFcnJvciAoKSB7XG4gICAgICAgIHRoaXMuZXJyb3JTdXBwcmVzc2VkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBhZGRXYXJuaW5nICguLi5hcmdzKSB7XG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnRKb2IpXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRKb2Iud2FybmluZ0xvZy5hZGRXYXJuaW5nKC4uLmFyZ3MpO1xuICAgIH1cblxuICAgIHNldFByb3ZpZGVyTWV0YUluZm8gKHN0cikge1xuICAgICAgICB0aGlzLmJyb3dzZXJJbmZvLnVzZXJBZ2VudFByb3ZpZGVyTWV0YUluZm8gPSBzdHI7XG4gICAgfVxuXG4gICAgZ2V0IHVzZXJBZ2VudCAoKSB7XG4gICAgICAgIGxldCB1c2VyQWdlbnQgPSB0aGlzLmJyb3dzZXJJbmZvLnVzZXJBZ2VudDtcblxuICAgICAgICBpZiAodGhpcy5icm93c2VySW5mby51c2VyQWdlbnRQcm92aWRlck1ldGFJbmZvKVxuICAgICAgICAgICAgdXNlckFnZW50ICs9IGAgKCR7dGhpcy5icm93c2VySW5mby51c2VyQWdlbnRQcm92aWRlck1ldGFJbmZvfSlgO1xuXG4gICAgICAgIHJldHVybiB1c2VyQWdlbnQ7XG4gICAgfVxuXG4gICAgZ2V0IGhhc1F1ZXVlZEpvYnMgKCkge1xuICAgICAgICByZXR1cm4gISF0aGlzLmpvYlF1ZXVlLmxlbmd0aDtcbiAgICB9XG5cbiAgICBnZXQgY3VycmVudEpvYiAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmpvYlF1ZXVlWzBdO1xuICAgIH1cblxuICAgIC8vIEFQSVxuICAgIHJ1bkluaXRTY3JpcHQgKGNvZGUpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdGhpcy5pbml0U2NyaXB0c1F1ZXVlLnB1c2goeyBjb2RlLCByZXNvbHZlIH0pKTtcbiAgICB9XG5cbiAgICBhZGRKb2IgKGpvYikge1xuICAgICAgICB0aGlzLmpvYlF1ZXVlLnB1c2goam9iKTtcbiAgICB9XG5cbiAgICByZW1vdmVKb2IgKGpvYikge1xuICAgICAgICByZW1vdmUodGhpcy5qb2JRdWV1ZSwgam9iKTtcbiAgICB9XG5cbiAgICBjbG9zZSAoKSB7XG4gICAgICAgIGlmICh0aGlzLmNsb3NlZCB8fCB0aGlzLmNsb3NpbmcpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5jbG9zaW5nID0gdHJ1ZTtcblxuICAgICAgICB0aGlzLl9jbG9zZUJyb3dzZXIoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5LnN0b3BTZXJ2aW5nQ29ubmVjdGlvbih0aGlzKTtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5oZWFydGJlYXRUaW1lb3V0KTtcblxuICAgICAgICAgICAgICAgIGRlbGV0ZSBjb25uZWN0aW9uc1t0aGlzLmlkXTtcblxuICAgICAgICAgICAgICAgIHRoaXMucmVhZHkgID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGhpcy5jbG9zZWQgPSB0cnVlO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdjbG9zZWQnKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGVzdGFibGlzaCAodXNlckFnZW50KSB7XG4gICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuXG4gICAgICAgIGNvbnN0IHBhcnNlZFVzZXJBZ2VudCA9IHBhcnNlVXNlckFnZW50KHVzZXJBZ2VudCk7XG5cbiAgICAgICAgdGhpcy5icm93c2VySW5mby51c2VyQWdlbnQgICAgICAgPSBwYXJzZWRVc2VyQWdlbnQudG9TdHJpbmcoKTtcbiAgICAgICAgdGhpcy5icm93c2VySW5mby5mdWxsVXNlckFnZW50ICAgPSB1c2VyQWdlbnQ7XG4gICAgICAgIHRoaXMuYnJvd3NlckluZm8ucGFyc2VkVXNlckFnZW50ID0gcGFyc2VkVXNlckFnZW50O1xuXG4gICAgICAgIHRoaXMuX3dhaXRGb3JIZWFydGJlYXQoKTtcbiAgICAgICAgdGhpcy5lbWl0KCdyZWFkeScpO1xuICAgIH1cblxuICAgIGhlYXJ0YmVhdCAoKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmhlYXJ0YmVhdFRpbWVvdXQpO1xuICAgICAgICB0aGlzLl93YWl0Rm9ySGVhcnRiZWF0KCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvZGU6IHRoaXMuY2xvc2luZyA/IFNUQVRVUy5jbG9zaW5nIDogU1RBVFVTLm9rLFxuICAgICAgICAgICAgdXJsOiAgdGhpcy5jbG9zaW5nID8gdGhpcy5pZGxlVXJsIDogJydcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICByZW5kZXJJZGxlUGFnZSAoKSB7XG4gICAgICAgIHJldHVybiBNdXN0YWNoZS5yZW5kZXIoSURMRV9QQUdFX1RFTVBMQVRFLCB7XG4gICAgICAgICAgICB1c2VyQWdlbnQ6ICAgICAgdGhpcy51c2VyQWdlbnQsXG4gICAgICAgICAgICBzdGF0dXNVcmw6ICAgICAgdGhpcy5zdGF0dXNVcmwsXG4gICAgICAgICAgICBoZWFydGJlYXRVcmw6ICAgdGhpcy5oZWFydGJlYXRVcmwsXG4gICAgICAgICAgICBpbml0U2NyaXB0VXJsOiAgdGhpcy5pbml0U2NyaXB0VXJsLFxuICAgICAgICAgICAgcmV0cnlUZXN0UGFnZXM6ICEhdGhpcy5icm93c2VyQ29ubmVjdGlvbkdhdGV3YXkucmV0cnlUZXN0UGFnZXNcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0SW5pdFNjcmlwdCAoKSB7XG4gICAgICAgIGNvbnN0IGluaXRTY3JpcHRQcm9taXNlID0gdGhpcy5pbml0U2NyaXB0c1F1ZXVlWzBdO1xuXG4gICAgICAgIHJldHVybiB7IGNvZGU6IGluaXRTY3JpcHRQcm9taXNlID8gaW5pdFNjcmlwdFByb21pc2UuY29kZSA6IG51bGwgfTtcbiAgICB9XG5cbiAgICBoYW5kbGVJbml0U2NyaXB0UmVzdWx0IChkYXRhKSB7XG4gICAgICAgIGNvbnN0IGluaXRTY3JpcHRQcm9taXNlID0gdGhpcy5pbml0U2NyaXB0c1F1ZXVlLnNoaWZ0KCk7XG5cbiAgICAgICAgaWYgKGluaXRTY3JpcHRQcm9taXNlKVxuICAgICAgICAgICAgaW5pdFNjcmlwdFByb21pc2UucmVzb2x2ZShKU09OLnBhcnNlKGRhdGEpKTtcbiAgICB9XG5cbiAgICBpc0hlYWRsZXNzQnJvd3NlciAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyLmlzSGVhZGxlc3NCcm93c2VyKHRoaXMuaWQpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlcG9ydEpvYlJlc3VsdCAoc3RhdHVzLCBkYXRhKSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXIucmVwb3J0Sm9iUmVzdWx0KHRoaXMuaWQsIHN0YXR1cywgZGF0YSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0U3RhdHVzIChpc1Rlc3REb25lKSB7XG4gICAgICAgIGlmICghdGhpcy5pZGxlICYmICFpc1Rlc3REb25lKSB7XG4gICAgICAgICAgICB0aGlzLmlkbGUgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5lbWl0KCdpZGxlJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5vcGVuZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHRlc3RSdW5VcmwgPSBhd2FpdCB0aGlzLl9nZXRUZXN0UnVuVXJsKGlzVGVzdERvbmUgfHwgdGhpcy50ZXN0UnVuQWJvcnRlZCk7XG5cbiAgICAgICAgICAgIHRoaXMudGVzdFJ1bkFib3J0ZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgaWYgKHRlc3RSdW5VcmwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmlkbGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjbWQ6IENPTU1BTkQucnVuLCB1cmw6IHRlc3RSdW5VcmwgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7IGNtZDogQ09NTUFORC5pZGxlLCB1cmw6IHRoaXMuaWRsZVVybCB9O1xuICAgIH1cbn1cbiJdfQ==
