'use strict';

exports.__esModule = true;
exports.resizeWindow = exports.updateMobileViewportSize = exports.closeTab = exports.createClient = exports.getScreenshotData = undefined;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let getActiveTab = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (cdpPort, browserId) {
        const tabs = yield _chromeRemoteInterface2.default.listTabs({ port: cdpPort });
        const tab = tabs.filter(function (t) {
            return t.type === 'page' && t.url.indexOf(browserId) > -1;
        })[0];

        return tab;
    });

    return function getActiveTab(_x, _x2) {
        return _ref.apply(this, arguments);
    };
})();

let setEmulationBounds = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* ({ client, config, viewportSize, emulatedDevicePixelRatio }) {
        yield client.Emulation.setDeviceMetricsOverride({
            width: viewportSize.width,
            height: viewportSize.height,
            deviceScaleFactor: emulatedDevicePixelRatio,
            mobile: config.mobile,
            fitWindow: false
        });

        yield client.Emulation.setVisibleSize({ width: viewportSize.width, height: viewportSize.height });
    });

    return function setEmulationBounds(_x3) {
        return _ref2.apply(this, arguments);
    };
})();

let setEmulation = (() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const client = runtimeInfo.client,
              config = runtimeInfo.config;


        if (config.userAgent !== void 0) yield client.Network.setUserAgentOverride({ userAgent: config.userAgent });

        if (config.touch !== void 0) {
            const touchConfig = {
                enabled: config.touch,
                configuration: config.mobile ? 'mobile' : 'desktop',
                maxTouchPoints: 1
            };

            if (client.Emulation.setEmitTouchEventsForMouse) yield client.Emulation.setEmitTouchEventsForMouse(touchConfig);

            if (client.Emulation.setTouchEmulationEnabled) yield client.Emulation.setTouchEmulationEnabled(touchConfig);
        }

        yield resizeWindow({ width: config.width, height: config.height }, runtimeInfo);
    });

    return function setEmulation(_x4) {
        return _ref3.apply(this, arguments);
    };
})();

let getScreenshotData = exports.getScreenshotData = (() => {
    var _ref4 = (0, _asyncToGenerator3.default)(function* ({ client }) {
        const screenshotData = yield client.Page.captureScreenshot();

        return Buffer.from(screenshotData.data, 'base64');
    });

    return function getScreenshotData(_x5) {
        return _ref4.apply(this, arguments);
    };
})();

let createClient = exports.createClient = (() => {
    var _ref5 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const browserId = runtimeInfo.browserId,
              config = runtimeInfo.config,
              cdpPort = runtimeInfo.cdpPort;


        let tab = null;
        let client = null;

        try {
            tab = yield getActiveTab(cdpPort, browserId);

            if (!tab) return;

            client = yield (0, _chromeRemoteInterface2.default)({ target: tab, port: cdpPort });
        } catch (e) {
            return;
        }

        runtimeInfo.tab = tab;
        runtimeInfo.client = client;

        yield client.Page.enable();
        yield client.Network.enable();
        yield client.Runtime.enable();

        const devicePixelRatioQueryResult = yield client.Runtime.evaluate({ expression: 'window.devicePixelRatio' });

        runtimeInfo.originalDevicePixelRatio = devicePixelRatioQueryResult.result.value;
        runtimeInfo.emulatedDevicePixelRatio = config.scaleFactor || runtimeInfo.originalDevicePixelRatio;

        if (config.emulation) yield setEmulation(runtimeInfo);
    });

    return function createClient(_x6) {
        return _ref5.apply(this, arguments);
    };
})();

let closeTab = exports.closeTab = (() => {
    var _ref6 = (0, _asyncToGenerator3.default)(function* ({ tab, cdpPort }) {
        yield _chromeRemoteInterface2.default.closeTab({ id: tab.id, port: cdpPort });
    });

    return function closeTab(_x7) {
        return _ref6.apply(this, arguments);
    };
})();

let updateMobileViewportSize = exports.updateMobileViewportSize = (() => {
    var _ref7 = (0, _asyncToGenerator3.default)(function* (runtimeInfo) {
        const windowDimensionsQueryResult = yield runtimeInfo.client.Runtime.evaluate({
            expression: `(${_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT})()`,
            returnByValue: true
        });

        const windowDimensions = windowDimensionsQueryResult.result.value;

        runtimeInfo.viewportSize.width = windowDimensions.outerWidth;
        runtimeInfo.viewportSize.height = windowDimensions.outerHeight;
    });

    return function updateMobileViewportSize(_x8) {
        return _ref7.apply(this, arguments);
    };
})();

let resizeWindow = exports.resizeWindow = (() => {
    var _ref8 = (0, _asyncToGenerator3.default)(function* (newDimensions, runtimeInfo) {
        const browserId = runtimeInfo.browserId,
              config = runtimeInfo.config,
              viewportSize = runtimeInfo.viewportSize,
              providerMethods = runtimeInfo.providerMethods;


        const currentWidth = viewportSize.width;
        const currentHeight = viewportSize.height;
        const newWidth = newDimensions.width || currentWidth;
        const newHeight = newDimensions.height || currentHeight;

        if (!config.headless) yield providerMethods.resizeLocalBrowserWindow(browserId, newWidth, newHeight, currentWidth, currentHeight);

        viewportSize.width = newWidth;
        viewportSize.height = newHeight;

        if (config.emulation) yield setEmulationBounds(runtimeInfo);
    });

    return function resizeWindow(_x9, _x10) {
        return _ref8.apply(this, arguments);
    };
})();

exports.isHeadlessTab = isHeadlessTab;

var _chromeRemoteInterface = require('chrome-remote-interface');

var _chromeRemoteInterface2 = _interopRequireDefault(_chromeRemoteInterface);

var _clientFunctions = require('../../../utils/client-functions');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isHeadlessTab({ tab, config }) {
    return tab && config.headless;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvY2RwLmpzIl0sIm5hbWVzIjpbImNkcFBvcnQiLCJicm93c2VySWQiLCJ0YWJzIiwicmVtb3RlQ2hyb21lIiwibGlzdFRhYnMiLCJwb3J0IiwidGFiIiwiZmlsdGVyIiwidCIsInR5cGUiLCJ1cmwiLCJpbmRleE9mIiwiZ2V0QWN0aXZlVGFiIiwiY2xpZW50IiwiY29uZmlnIiwidmlld3BvcnRTaXplIiwiZW11bGF0ZWREZXZpY2VQaXhlbFJhdGlvIiwiRW11bGF0aW9uIiwic2V0RGV2aWNlTWV0cmljc092ZXJyaWRlIiwid2lkdGgiLCJoZWlnaHQiLCJkZXZpY2VTY2FsZUZhY3RvciIsIm1vYmlsZSIsImZpdFdpbmRvdyIsInNldFZpc2libGVTaXplIiwic2V0RW11bGF0aW9uQm91bmRzIiwicnVudGltZUluZm8iLCJ1c2VyQWdlbnQiLCJOZXR3b3JrIiwic2V0VXNlckFnZW50T3ZlcnJpZGUiLCJ0b3VjaCIsInRvdWNoQ29uZmlnIiwiZW5hYmxlZCIsImNvbmZpZ3VyYXRpb24iLCJtYXhUb3VjaFBvaW50cyIsInNldEVtaXRUb3VjaEV2ZW50c0Zvck1vdXNlIiwic2V0VG91Y2hFbXVsYXRpb25FbmFibGVkIiwicmVzaXplV2luZG93Iiwic2V0RW11bGF0aW9uIiwic2NyZWVuc2hvdERhdGEiLCJQYWdlIiwiY2FwdHVyZVNjcmVlbnNob3QiLCJCdWZmZXIiLCJmcm9tIiwiZGF0YSIsImdldFNjcmVlbnNob3REYXRhIiwidGFyZ2V0IiwiZSIsImVuYWJsZSIsIlJ1bnRpbWUiLCJkZXZpY2VQaXhlbFJhdGlvUXVlcnlSZXN1bHQiLCJldmFsdWF0ZSIsImV4cHJlc3Npb24iLCJvcmlnaW5hbERldmljZVBpeGVsUmF0aW8iLCJyZXN1bHQiLCJ2YWx1ZSIsInNjYWxlRmFjdG9yIiwiZW11bGF0aW9uIiwiY3JlYXRlQ2xpZW50IiwiY2xvc2VUYWIiLCJpZCIsIndpbmRvd0RpbWVuc2lvbnNRdWVyeVJlc3VsdCIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsInJldHVybkJ5VmFsdWUiLCJ3aW5kb3dEaW1lbnNpb25zIiwib3V0ZXJXaWR0aCIsIm91dGVySGVpZ2h0IiwidXBkYXRlTW9iaWxlVmlld3BvcnRTaXplIiwibmV3RGltZW5zaW9ucyIsInByb3ZpZGVyTWV0aG9kcyIsImN1cnJlbnRXaWR0aCIsImN1cnJlbnRIZWlnaHQiLCJuZXdXaWR0aCIsIm5ld0hlaWdodCIsImhlYWRsZXNzIiwicmVzaXplTG9jYWxCcm93c2VyV2luZG93IiwiaXNIZWFkbGVzc1RhYiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OzsrQ0FJQSxXQUE2QkEsT0FBN0IsRUFBc0NDLFNBQXRDLEVBQWlEO0FBQzdDLGNBQU1DLE9BQU8sTUFBTUMsZ0NBQWFDLFFBQWIsQ0FBc0IsRUFBRUMsTUFBTUwsT0FBUixFQUF0QixDQUFuQjtBQUNBLGNBQU1NLE1BQU9KLEtBQUtLLE1BQUwsQ0FBWTtBQUFBLG1CQUFLQyxFQUFFQyxJQUFGLEtBQVcsTUFBWCxJQUFxQkQsRUFBRUUsR0FBRixDQUFNQyxPQUFOLENBQWNWLFNBQWQsSUFBMkIsQ0FBQyxDQUF0RDtBQUFBLFNBQVosRUFBcUUsQ0FBckUsQ0FBYjs7QUFFQSxlQUFPSyxHQUFQO0FBQ0gsSzs7b0JBTGNNLFk7Ozs7OztnREFPZixXQUFtQyxFQUFFQyxNQUFGLEVBQVVDLE1BQVYsRUFBa0JDLFlBQWxCLEVBQWdDQyx3QkFBaEMsRUFBbkMsRUFBK0Y7QUFDM0YsY0FBTUgsT0FBT0ksU0FBUCxDQUFpQkMsd0JBQWpCLENBQTBDO0FBQzVDQyxtQkFBbUJKLGFBQWFJLEtBRFk7QUFFNUNDLG9CQUFtQkwsYUFBYUssTUFGWTtBQUc1Q0MsK0JBQW1CTCx3QkFIeUI7QUFJNUNNLG9CQUFtQlIsT0FBT1EsTUFKa0I7QUFLNUNDLHVCQUFtQjtBQUx5QixTQUExQyxDQUFOOztBQVFBLGNBQU1WLE9BQU9JLFNBQVAsQ0FBaUJP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d0JtRCxhQUE5Qzs7QUFFQSxZQUFJLENBQUN6RCxPQUFPNEQsUUFBWixFQUNJLE1BQU1MLGdCQUFnQk0sd0JBQWhCLENBQXlDMUUsU0FBekMsRUFBb0R1RSxRQUFwRCxFQUE4REMsU0FBOUQsRUFBeUVILFlBQXpFLEVBQXVGQyxhQUF2RixDQUFOOztBQUVKeEQscUJBQWFJLEtBQWIsR0FBc0JxRCxRQUF0QjtBQUNBekQscUJBQWFLLE1BQWIsR0FBc0JxRCxTQUF0Qjs7QUFFQSxZQUFJM0QsT0FBTzJDLFNBQVgsRUFDSSxNQUFNaEMsbUJBQW1CQyxXQUFuQixDQUFOO0FBQ1AsSzs7b0JBaEJxQlcsWTs7Ozs7UUFwQk51QyxhLEdBQUFBLGE7O0FBdEZoQjs7OztBQUNBOzs7O0FBcUZPLFNBQVNBLGFBQVQsQ0FBd0IsRUFBRXRFLEdBQUYsRUFBT1EsTUFBUCxFQUF4QixFQUF5QztBQUM1QyxXQUFPUixPQUFPUSxPQUFPNEQsUUFBckI7QUFDSCIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvY2RwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlbW90ZUNocm9tZSBmcm9tICdjaHJvbWUtcmVtb3RlLWludGVyZmFjZSc7XG5pbXBvcnQgeyBHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQgfSBmcm9tICcuLi8uLi8uLi91dGlscy9jbGllbnQtZnVuY3Rpb25zJztcblxuXG5hc3luYyBmdW5jdGlvbiBnZXRBY3RpdmVUYWIgKGNkcFBvcnQsIGJyb3dzZXJJZCkge1xuICAgIGNvbnN0IHRhYnMgPSBhd2FpdCByZW1vdGVDaHJvbWUubGlzdFRhYnMoeyBwb3J0OiBjZHBQb3J0IH0pO1xuICAgIGNvbnN0IHRhYiAgPSB0YWJzLmZpbHRlcih0ID0+IHQudHlwZSA9PT0gJ3BhZ2UnICYmIHQudXJsLmluZGV4T2YoYnJvd3NlcklkKSA+IC0xKVswXTtcblxuICAgIHJldHVybiB0YWI7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldEVtdWxhdGlvbkJvdW5kcyAoeyBjbGllbnQsIGNvbmZpZywgdmlld3BvcnRTaXplLCBlbXVsYXRlZERldmljZVBpeGVsUmF0aW8gfSkge1xuICAgIGF3YWl0IGNsaWVudC5FbXVsYXRpb24uc2V0RGV2aWNlTWV0cmljc092ZXJyaWRlKHtcbiAgICAgICAgd2lkdGg6ICAgICAgICAgICAgIHZpZXdwb3J0U2l6ZS53aWR0aCxcbiAgICAgICAgaGVpZ2h0OiAgICAgICAgICAgIHZpZXdwb3J0U2l6ZS5oZWlnaHQsXG4gICAgICAgIGRldmljZVNjYWxlRmFjdG9yOiBlbXVsYXRlZERldmljZVBpeGVsUmF0aW8sXG4gICAgICAgIG1vYmlsZTogICAgICAgICAgICBjb25maWcubW9iaWxlLFxuICAgICAgICBmaXRXaW5kb3c6ICAgICAgICAgZmFsc2VcbiAgICB9KTtcblxuICAgIGF3YWl0IGNsaWVudC5FbXVsYXRpb24uc2V0VmlzaWJsZVNpemUoeyB3aWR0aDogdmlld3BvcnRTaXplLndpZHRoLCBoZWlnaHQ6IHZpZXdwb3J0U2l6ZS5oZWlnaHQgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldEVtdWxhdGlvbiAocnVudGltZUluZm8pIHtcbiAgICBjb25zdCB7IGNsaWVudCwgY29uZmlnIH0gPSBydW50aW1lSW5mbztcblxuICAgIGlmIChjb25maWcudXNlckFnZW50ICE9PSB2b2lkIDApXG4gICAgICAgIGF3YWl0IGNsaWVudC5OZXR3b3JrLnNldFVzZXJBZ2VudE92ZXJyaWRlKHsgdXNlckFnZW50OiBjb25maWcudXNlckFnZW50IH0pO1xuXG4gICAgaWYgKGNvbmZpZy50b3VjaCAhPT0gdm9pZCAwKSB7XG4gICAgICAgIGNvbnN0IHRvdWNoQ29uZmlnID0ge1xuICAgICAgICAgICAgZW5hYmxlZDogICAgICAgIGNvbmZpZy50b3VjaCxcbiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb246ICBjb25maWcubW9iaWxlID8gJ21vYmlsZScgOiAnZGVza3RvcCcsXG4gICAgICAgICAgICBtYXhUb3VjaFBvaW50czogMVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChjbGllbnQuRW11bGF0aW9uLnNldEVtaXRUb3VjaEV2ZW50c0Zvck1vdXNlKVxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRFbWl0VG91Y2hFdmVudHNGb3JNb3VzZSh0b3VjaENvbmZpZyk7XG5cbiAgICAgICAgaWYgKGNsaWVudC5FbXVsYXRpb24uc2V0VG91Y2hFbXVsYXRpb25FbmFibGVkKVxuICAgICAgICAgICAgYXdhaXQgY2xpZW50LkVtdWxhdGlvbi5zZXRUb3VjaEVtdWxhdGlvbkVuYWJsZWQodG91Y2hDb25maWcpO1xuICAgIH1cblxuICAgIGF3YWl0IHJlc2l6ZVdpbmRvdyh7IHdpZHRoOiBjb25maWcud2lkdGgsIGhlaWdodDogY29uZmlnLmhlaWdodCB9LCBydW50aW1lSW5mbyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTY3JlZW5zaG90RGF0YSAoeyBjbGllbnQgfSkge1xuICAgIGNvbnN0IHNjcmVlbnNob3REYXRhID0gYXdhaXQgY2xpZW50LlBhZ2UuY2FwdHVyZVNjcmVlbnNob3QoKTtcblxuICAgIHJldHVybiBCdWZmZXIuZnJvbShzY3JlZW5zaG90RGF0YS5kYXRhLCAnYmFzZTY0Jyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVDbGllbnQgKHJ1bnRpbWVJbmZvKSB7XG4gICAgY29uc3QgeyBicm93c2VySWQsIGNvbmZpZywgY2RwUG9ydCB9ID0gcnVudGltZUluZm87XG5cbiAgICBsZXQgdGFiICAgID0gbnVsbDtcbiAgICBsZXQgY2xpZW50ID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICAgIHRhYiA9IGF3YWl0IGdldEFjdGl2ZVRhYihjZHBQb3J0LCBicm93c2VySWQpO1xuXG4gICAgICAgIGlmICghdGFiKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNsaWVudCA9IGF3YWl0IHJlbW90ZUNocm9tZSh7IHRhcmdldDogdGFiLCBwb3J0OiBjZHBQb3J0IH0pO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcnVudGltZUluZm8udGFiICAgID0gdGFiO1xuICAgIHJ1bnRpbWVJbmZvLmNsaWVudCA9IGNsaWVudDtcblxuICAgIGF3YWl0IGNsaWVudC5QYWdlLmVuYWJsZSgpO1xuICAgIGF3YWl0IGNsaWVudC5OZXR3b3JrLmVuYWJsZSgpO1xuICAgIGF3YWl0IGNsaWVudC5SdW50aW1lLmVuYWJsZSgpO1xuXG4gICAgY29uc3QgZGV2aWNlUGl4ZWxSYXRpb1F1ZXJ5UmVzdWx0ID0gYXdhaXQgY2xpZW50LlJ1bnRpbWUuZXZhbHVhdGUoeyBleHByZXNzaW9uOiAnd2luZG93LmRldmljZVBpeGVsUmF0aW8nIH0pO1xuXG4gICAgcnVudGltZUluZm8ub3JpZ2luYWxEZXZpY2VQaXhlbFJhdGlvID0gZGV2aWNlUGl4ZWxSYXRpb1F1ZXJ5UmVzdWx0LnJlc3VsdC52YWx1ZTtcbiAgICBydW50aW1lSW5mby5lbXVsYXRlZERldmljZVBpeGVsUmF0aW8gPSBjb25maWcuc2NhbGVGYWN0b3IgfHwgcnVudGltZUluZm8ub3JpZ2luYWxEZXZpY2VQaXhlbFJhdGlvO1xuXG4gICAgaWYgKGNvbmZpZy5lbXVsYXRpb24pXG4gICAgICAgIGF3YWl0IHNldEVtdWxhdGlvbihydW50aW1lSW5mbyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0hlYWRsZXNzVGFiICh7IHRhYiwgY29uZmlnIH0pIHtcbiAgICByZXR1cm4gdGFiICYmIGNvbmZpZy5oZWFkbGVzcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNsb3NlVGFiICh7IHRhYiwgY2RwUG9ydCB9KSB7XG4gICAgYXdhaXQgcmVtb3RlQ2hyb21lLmNsb3NlVGFiKHsgaWQ6IHRhYi5pZCwgcG9ydDogY2RwUG9ydCB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZU1vYmlsZVZpZXdwb3J0U2l6ZSAocnVudGltZUluZm8pIHtcbiAgICBjb25zdCB3aW5kb3dEaW1lbnNpb25zUXVlcnlSZXN1bHQgPSBhd2FpdCBydW50aW1lSW5mby5jbGllbnQuUnVudGltZS5ldmFsdWF0ZSh7XG4gICAgICAgIGV4cHJlc3Npb246ICAgIGAoJHtHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFR9KSgpYCxcbiAgICAgICAgcmV0dXJuQnlWYWx1ZTogdHJ1ZVxuICAgIH0pO1xuXG4gICAgY29uc3Qgd2luZG93RGltZW5zaW9ucyA9IHdpbmRvd0RpbWVuc2lvbnNRdWVyeVJlc3VsdC5yZXN1bHQudmFsdWU7XG5cbiAgICBydW50aW1lSW5mby52aWV3cG9ydFNpemUud2lkdGggID0gd2luZG93RGltZW5zaW9ucy5vdXRlcldpZHRoO1xuICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS5oZWlnaHQgPSB3aW5kb3dEaW1lbnNpb25zLm91dGVySGVpZ2h0O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzaXplV2luZG93IChuZXdEaW1lbnNpb25zLCBydW50aW1lSW5mbykge1xuICAgIGNvbnN0IHsgYnJvd3NlcklkLCBjb25maWcsIHZpZXdwb3J0U2l6ZSwgcHJvdmlkZXJNZXRob2RzIH0gPSBydW50aW1lSW5mbztcblxuICAgIGNvbnN0IGN1cnJlbnRXaWR0aCAgPSB2aWV3cG9ydFNpemUud2lkdGg7XG4gICAgY29uc3QgY3VycmVudEhlaWdodCA9IHZpZXdwb3J0U2l6ZS5oZWlnaHQ7XG4gICAgY29uc3QgbmV3V2lkdGggICAgICA9IG5ld0RpbWVuc2lvbnMud2lkdGggfHwgY3VycmVudFdpZHRoO1xuICAgIGNvbnN0IG5ld0hlaWdodCAgICAgPSBuZXdEaW1lbnNpb25zLmhlaWdodCB8fCBjdXJyZW50SGVpZ2h0O1xuXG4gICAgaWYgKCFjb25maWcuaGVhZGxlc3MpXG4gICAgICAgIGF3YWl0IHByb3ZpZGVyTWV0aG9kcy5yZXNpemVMb2NhbEJyb3dzZXJXaW5kb3coYnJvd3NlcklkLCBuZXdXaWR0aCwgbmV3SGVpZ2h0LCBjdXJyZW50V2lkdGgsIGN1cnJlbnRIZWlnaHQpO1xuXG4gICAgdmlld3BvcnRTaXplLndpZHRoICA9IG5ld1dpZHRoO1xuICAgIHZpZXdwb3J0U2l6ZS5oZWlnaHQgPSBuZXdIZWlnaHQ7XG5cbiAgICBpZiAoY29uZmlnLmVtdWxhdGlvbilcbiAgICAgICAgYXdhaXQgc2V0RW11bGF0aW9uQm91bmRzKHJ1bnRpbWVJbmZvKTtcbn1cbiJdfQ==
