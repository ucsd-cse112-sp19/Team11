'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _isNan = require('babel-runtime/core-js/number/is-nan');

var _isNan2 = _interopRequireDefault(_isNan);

exports.default = function (configString) {
    if (!configCache[configString]) configCache[configString] = getNewConfig(configString);

    return configCache[configString];
};

var _chromeEmulatedDevicesList = require('chrome-emulated-devices-list');

var _chromeEmulatedDevicesList2 = _interopRequireDefault(_chromeEmulatedDevicesList);

var _lodash = require('lodash');

var _argumentParsing = require('../../../utils/argument-parsing');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const HEADLESS_DEFAULT_WIDTH = 1280;
const HEADLESS_DEFAULT_HEIGHT = 800;

const AVAILABLE_MODES = ['userProfile', 'headless', 'emulation'];

const configCache = {};

function parseUserArgs(userArgs) {
    const parsedArgs = {
        headless: false,
        userDataDir: false,
        windowSize: false
    };

    const splittedArgs = userArgs.split(' ').filter(arg => !!arg);

    splittedArgs.forEach(arg => {
        const keyValuePair = arg.split('=');
        const key = (0, _lodash.camelCase)(keyValuePair[0]);

        parsedArgs[key] = parsedArgs[key] !== void 0;
    });

    return parsedArgs;
}

function parseModes(modesStr, userArgs) {
    const parsed = (0, _argumentParsing.splitEscaped)(modesStr, ':');
    const path = (0, _argumentParsing.getPathFromParsedModes)(parsed, AVAILABLE_MODES);
    const detectedModes = (0, _argumentParsing.getModes)(parsed, AVAILABLE_MODES);
    let optionsString = '';

    if (parsed.length) optionsString = parsed.shift();

    while (parsed.length) optionsString += ':' + parsed.shift();

    const userProfile = detectedModes.userProfile || userArgs.userDataDir;
    const headless = detectedModes.headless || userArgs.headless;
    const emulation = detectedModes.emulation || headless;

    const modes = {
        path,
        userProfile,
        headless,
        emulation
    };

    return { modes, optionsString };
}

function simplifyDeviceName(deviceName) {
    return deviceName.replace(/\s/g, '').toLowerCase();
}

function findDevice(deviceName) {
    const simpleName = simplifyDeviceName(deviceName);

    return _chromeEmulatedDevicesList2.default.filter(device => simplifyDeviceName(device.title).indexOf(simpleName) >= 0)[0];
}

function getDeviceBasedOptions(deviceName, orientation) {
    if (!deviceName) return {};

    const deviceData = findDevice(deviceName);

    if (!deviceData) return {};

    const mobile = deviceData.capabilities.indexOf('mobile') >= 0;

    if (!orientation) orientation = mobile ? 'vertical' : 'horizontal';

    return {
        mobile: mobile,
        orientation: orientation,
        touch: deviceData.capabilities.indexOf('touch') >= 0,
        width: deviceData.screen[orientation].width,
        height: deviceData.screen[orientation].height,
        scaleFactor: deviceData.screen['device-pixel-ratio'],
        userAgent: deviceData['user-agent']
    };
}

function parseOptions(str, useDefaultDimensions) {
    const parsed = (0, _argumentParsing.splitEscaped)(str, ';');

    const baseOptions = {
        width: useDefaultDimensions ? HEADLESS_DEFAULT_WIDTH : 0,
        height: useDefaultDimensions ? HEADLESS_DEFAULT_HEIGHT : 0,
        scaleFactor: 0,
        mobile: false,
        cdpPort: (0, _argumentParsing.findMatch)(parsed, /^cdpPort=(.*)/)
    };

    const deviceName = (0, _argumentParsing.findMatch)(parsed, /^device=(.*)/);
    const orientation = (0, _argumentParsing.findMatch)(parsed, /^orientation=(.*)/);
    const deviceBasedOptions = getDeviceBasedOptions(deviceName, orientation);

    let specifiedDeviceOptions = {
        orientation: orientation,
        touch: (0, _argumentParsing.hasMatch)(parsed, /^touch=/) ? (0, _argumentParsing.isMatchTrue)(parsed, /^touch=(.*)/) : void 0,
        mobile: (0, _argumentParsing.isMatchTrue)(parsed, /^mobile=(.*)/),
        width: Number((0, _argumentParsing.findMatch)(parsed, /^width=(.*)/) || NaN),
        height: Number((0, _argumentParsing.findMatch)(parsed, /^height=(.*)/) || NaN),
        scaleFactor: Number((0, _argumentParsing.findMatch)(parsed, /^scaleFactor=(.*)/) || NaN),
        userAgent: (0, _argumentParsing.findMatch)(parsed, /^userAgent=(.*)/)
    };

    specifiedDeviceOptions = (0, _lodash.pickBy)(specifiedDeviceOptions, optionValue => {
        return optionValue !== void 0 && optionValue !== '' && !(0, _isNan2.default)(optionValue);
    });

    return (0, _assign2.default)(baseOptions, deviceBasedOptions, specifiedDeviceOptions);
}

function getNewConfig(configString) {
    var _parseConfig = (0, _argumentParsing.parseConfig)(configString);

    const userArgs = _parseConfig.userArgs,
          modesString = _parseConfig.modesString;

    const parsedUserArgs = parseUserArgs(userArgs);

    var _parseModes = parseModes(modesString, parsedUserArgs);

    const modes = _parseModes.modes,
          optionsString = _parseModes.optionsString;

    const useDefaultDimensions = modes.headless && !parsedUserArgs.windowSize;
    const options = parseOptions(optionsString, useDefaultDimensions);

    return (0, _assign2.default)({ userArgs }, modes, options);
}

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvY29uZmlnLmpzIl0sIm5hbWVzIjpbImNvbmZpZ1N0cmluZyIsImNvbmZpZ0NhY2hlIiwiZ2V0TmV3Q29uZmlnIiwiSEVBRExFU1NfREVGQVVMVF9XSURUSCIsIkhFQURMRVNTX0RFRkFVTFRfSEVJR0hUIiwiQVZBSUxBQkxFX01PREVTIiwicGFyc2VVc2VyQXJncyIsInVzZXJBcmdzIiwicGFyc2VkQXJncyIsImhlYWRsZXNzIiwidXNlckRhdGFEaXIiLCJ3aW5kb3dTaXplIiwic3BsaXR0ZWRBcmdzIiwic3BsaXQiLCJmaWx0ZXIiLCJhcmciLCJmb3JFYWNoIiwia2V5VmFsdWVQYWlyIiwia2V5IiwicGFyc2VNb2RlcyIsIm1vZGVzU3RyIiwicGFyc2VkIiwicGF0aCIsImRldGVjdGVkTW9kZXMiLCJvcHRpb25zU3RyaW5nIiwibGVuZ3RoIiwic2hpZnQiLCJ1c2VyUHJvZmlsZSIsImVtdWxhdGlvbiIsIm1vZGVzIiwic2ltcGxpZnlEZXZpY2VOYW1lIiwiZGV2aWNlTmFtZSIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsImZpbmREZXZpY2UiLCJzaW1wbGVOYW1lIiwiZW11bGF0ZWREZXZpY2VzIiwiZGV2aWNlIiwidGl0bGUiLCJpbmRleE9mIiwiZ2V0RGV2aWNlQmFzZWRPcHRpb25zIiwib3JpZW50YXRpb24iLCJkZXZpY2VEYXRhIiwibW9iaWxlIiwiY2FwYWJpbGl0aWVzIiwidG91Y2giLCJ3aWR0aCIsInNjcmVlbiIsImhlaWdodCIsInNjYWxlRmFjdG9yIiwidXNlckFnZW50IiwicGFyc2VPcHRpb25zIiwic3RyIiwidXNlRGVmYXVsdERpbWVuc2lvbnMiLCJiYXNlT3B0aW9ucyIsImNkcFBvcnQiLCJkZXZpY2VCYXNlZE9wdGlvbnMiLCJzcGVjaWZpZWREZXZpY2VPcHRpb25zIiwiTnVtYmVyIiwiTmFOIiwib3B0aW9uVmFsdWUi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O0FBQ0EsVUFBTW9ELFVBQTRCWixhQUFhM0IsYUFBYixFQUE0QjZCLG9CQUE1QixDQUFsQzs7QUFFQSxXQUFPLHNCQUFjLEVBQUU5QyxRQUFGLEVBQWQsRUFBNEJzQixLQUE1QixFQUFtQ2tDLE9BQW5DLENBQVA7QUFDSCIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvY29uZmlnLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGVtdWxhdGVkRGV2aWNlcyBmcm9tICdjaHJvbWUtZW11bGF0ZWQtZGV2aWNlcy1saXN0JztcbmltcG9ydCB7IHBpY2tCeSBhcyBmaWx0ZXJQcm9wZXJ0aWVzLCBjYW1lbENhc2UgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtcbiAgICBoYXNNYXRjaCwgZmluZE1hdGNoLCBpc01hdGNoVHJ1ZSwgZ2V0TW9kZXMsIHNwbGl0RXNjYXBlZCwgZ2V0UGF0aEZyb21QYXJzZWRNb2RlcywgcGFyc2VDb25maWdcbn0gZnJvbSAnLi4vLi4vLi4vdXRpbHMvYXJndW1lbnQtcGFyc2luZyc7XG5cblxuY29uc3QgSEVBRExFU1NfREVGQVVMVF9XSURUSCAgPSAxMjgwO1xuY29uc3QgSEVBRExFU1NfREVGQVVMVF9IRUlHSFQgPSA4MDA7XG5cbmNvbnN0IEFWQUlMQUJMRV9NT0RFUyA9IFsndXNlclByb2ZpbGUnLCAnaGVhZGxlc3MnLCAnZW11bGF0aW9uJ107XG5cbmNvbnN0IGNvbmZpZ0NhY2hlID0ge307XG5cbmZ1bmN0aW9uIHBhcnNlVXNlckFyZ3MgKHVzZXJBcmdzKSB7XG4gICAgY29uc3QgcGFyc2VkQXJncyA9IHtcbiAgICAgICAgaGVhZGxlc3M6ICAgIGZhbHNlLFxuICAgICAgICB1c2VyRGF0YURpcjogZmFsc2UsXG4gICAgICAgIHdpbmRvd1NpemU6ICBmYWxzZVxuICAgIH07XG5cbiAgICBjb25zdCBzcGxpdHRlZEFyZ3MgPSB1c2VyQXJncy5zcGxpdCgnICcpLmZpbHRlcihhcmcgPT4gISFhcmcpO1xuXG4gICAgc3BsaXR0ZWRBcmdzLmZvckVhY2goYXJnID0+IHtcbiAgICAgICAgY29uc3Qga2V5VmFsdWVQYWlyID0gYXJnLnNwbGl0KCc9Jyk7XG4gICAgICAgIGNvbnN0IGtleSAgICAgICAgICA9IGNhbWVsQ2FzZShrZXlWYWx1ZVBhaXJbMF0pO1xuXG4gICAgICAgIHBhcnNlZEFyZ3Nba2V5XSA9IHBhcnNlZEFyZ3Nba2V5XSAhPT0gdm9pZCAwO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBhcnNlZEFyZ3M7XG59XG5cbmZ1bmN0aW9uIHBhcnNlTW9kZXMgKG1vZGVzU3RyLCB1c2VyQXJncykge1xuICAgIGNvbnN0IHBhcnNlZCAgICAgICAgPSBzcGxpdEVzY2FwZWQobW9kZXNTdHIsICc6Jyk7XG4gICAgY29uc3QgcGF0aCAgICAgICAgICA9IGdldFBhdGhGcm9tUGFyc2VkTW9kZXMocGFyc2VkLCBBVkFJTEFCTEVfTU9ERVMpO1xuICAgIGNvbnN0IGRldGVjdGVkTW9kZXMgPSBnZXRNb2RlcyhwYXJzZWQsIEFWQUlMQUJMRV9NT0RFUyk7XG4gICAgbGV0IG9wdGlvbnNTdHJpbmcgPSAnJztcblxuICAgIGlmIChwYXJzZWQubGVuZ3RoKVxuICAgICAgICBvcHRpb25zU3RyaW5nID0gcGFyc2VkLnNoaWZ0KCk7XG5cbiAgICB3aGlsZSAocGFyc2VkLmxlbmd0aClcbiAgICAgICAgb3B0aW9uc1N0cmluZyArPSAnOicgKyBwYXJzZWQuc2hpZnQoKTtcblxuICAgIGNvbnN0IHVzZXJQcm9maWxlID0gZGV0ZWN0ZWRNb2Rlcy51c2VyUHJvZmlsZSB8fCB1c2VyQXJncy51c2VyRGF0YURpcjtcbiAgICBjb25zdCBoZWFkbGVzcyAgICA9IGRldGVjdGVkTW9kZXMuaGVhZGxlc3MgfHwgdXNlckFyZ3MuaGVhZGxlc3M7XG4gICAgY29uc3QgZW11bGF0aW9uICAgPSBkZXRlY3RlZE1vZGVzLmVtdWxhdGlvbiB8fCBoZWFkbGVzcztcblxuICAgIGNvbnN0IG1vZGVzID0ge1xuICAgICAgICBwYXRoLFxuICAgICAgICB1c2VyUHJvZmlsZSxcbiAgICAgICAgaGVhZGxlc3MsXG4gICAgICAgIGVtdWxhdGlvblxuICAgIH07XG5cbiAgICByZXR1cm4geyBtb2Rlcywgb3B0aW9uc1N0cmluZyB9O1xufVxuXG5mdW5jdGlvbiBzaW1wbGlmeURldmljZU5hbWUgKGRldmljZU5hbWUpIHtcbiAgICByZXR1cm4gZGV2aWNlTmFtZS5yZXBsYWNlKC9cXHMvZywgJycpLnRvTG93ZXJDYXNlKCk7XG59XG5cbmZ1bmN0aW9uIGZpbmREZXZpY2UgKGRldmljZU5hbWUpIHtcbiAgICBjb25zdCBzaW1wbGVOYW1lID0gc2ltcGxpZnlEZXZpY2VOYW1lKGRldmljZU5hbWUpO1xuXG4gICAgcmV0dXJuIGVtdWxhdGVkRGV2aWNlcy5maWx0ZXIoZGV2aWNlID0+IHNpbXBsaWZ5RGV2aWNlTmFtZShkZXZpY2UudGl0bGUpLmluZGV4T2Yoc2ltcGxlTmFtZSkgPj0gMClbMF07XG59XG5cbmZ1bmN0aW9uIGdldERldmljZUJhc2VkT3B0aW9ucyAoZGV2aWNlTmFtZSwgb3JpZW50YXRpb24pIHtcbiAgICBpZiAoIWRldmljZU5hbWUpXG4gICAgICAgIHJldHVybiB7fTtcblxuICAgIGNvbnN0IGRldmljZURhdGEgPSBmaW5kRGV2aWNlKGRldmljZU5hbWUpO1xuXG4gICAgaWYgKCFkZXZpY2VEYXRhKVxuICAgICAgICByZXR1cm4ge307XG5cbiAgICBjb25zdCBtb2JpbGUgPSBkZXZpY2VEYXRhLmNhcGFiaWxpdGllcy5pbmRleE9mKCdtb2JpbGUnKSA+PSAwO1xuXG4gICAgaWYgKCFvcmllbnRhdGlvbilcbiAgICAgICAgb3JpZW50YXRpb24gPSBtb2JpbGUgPyAndmVydGljYWwnIDogJ2hvcml6b250YWwnO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgbW9iaWxlOiAgICAgIG1vYmlsZSxcbiAgICAgICAgb3JpZW50YXRpb246IG9yaWVudGF0aW9uLFxuICAgICAgICB0b3VjaDogICAgICAgZGV2aWNlRGF0YS5jYXBhYmlsaXRpZXMuaW5kZXhPZigndG91Y2gnKSA+PSAwLFxuICAgICAgICB3aWR0aDogICAgICAgZGV2aWNlRGF0YS5zY3JlZW5bb3JpZW50YXRpb25dLndpZHRoLFxuICAgICAgICBoZWlnaHQ6ICAgICAgZGV2aWNlRGF0YS5zY3JlZW5bb3JpZW50YXRpb25dLmhlaWdodCxcbiAgICAgICAgc2NhbGVGYWN0b3I6IGRldmljZURhdGEuc2NyZWVuWydkZXZpY2UtcGl4ZWwtcmF0aW8nXSxcbiAgICAgICAgdXNlckFnZW50OiAgIGRldmljZURhdGFbJ3VzZXItYWdlbnQnXSxcbiAgICB9O1xufVxuXG5mdW5jdGlvbiBwYXJzZU9wdGlvbnMgKHN0ciwgdXNlRGVmYXVsdERpbWVuc2lvbnMpIHtcbiAgICBjb25zdCBwYXJzZWQgPSBzcGxpdEVzY2FwZWQoc3RyLCAnOycpO1xuXG4gICAgY29uc3QgYmFzZU9wdGlvbnMgPSB7XG4gICAgICAgIHdpZHRoOiAgICAgICB1c2VEZWZhdWx0RGltZW5zaW9ucyA/IEhFQURMRVNTX0RFRkFVTFRfV0lEVEggOiAwLFxuICAgICAgICBoZWlnaHQ6ICAgICAgdXNlRGVmYXVsdERpbWVuc2lvbnMgPyBIRUFETEVTU19ERUZBVUxUX0hFSUdIVCA6IDAsXG4gICAgICAgIHNjYWxlRmFjdG9yOiAwLFxuICAgICAgICBtb2JpbGU6ICAgICAgZmFsc2UsXG4gICAgICAgIGNkcFBvcnQ6ICAgICBmaW5kTWF0Y2gocGFyc2VkLCAvXmNkcFBvcnQ9KC4qKS8pXG4gICAgfTtcblxuICAgIGNvbnN0IGRldmljZU5hbWUgICAgICAgICA9IGZpbmRNYXRjaChwYXJzZWQsIC9eZGV2aWNlPSguKikvKTtcbiAgICBjb25zdCBvcmllbnRhdGlvbiAgICAgICAgPSBmaW5kTWF0Y2gocGFyc2VkLCAvXm9yaWVudGF0aW9uPSguKikvKTtcbiAgICBjb25zdCBkZXZpY2VCYXNlZE9wdGlvbnMgPSBnZXREZXZpY2VCYXNlZE9wdGlvbnMoZGV2aWNlTmFtZSwgb3JpZW50YXRpb24pO1xuXG4gICAgbGV0IHNwZWNpZmllZERldmljZU9wdGlvbnMgPSB7XG4gICAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbixcbiAgICAgICAgdG91Y2g6ICAgICAgIGhhc01hdGNoKHBhcnNlZCwgL150b3VjaD0vKSA/IGlzTWF0Y2hUcnVlKHBhcnNlZCwgL150b3VjaD0oLiopLykgOiB2b2lkIDAsXG4gICAgICAgIG1vYmlsZTogICAgICBpc01hdGNoVHJ1ZShwYXJzZWQsIC9ebW9iaWxlPSguKikvKSxcbiAgICAgICAgd2lkdGg6ICAgICAgIE51bWJlcihmaW5kTWF0Y2gocGFyc2VkLCAvXndpZHRoPSguKikvKSB8fCBOYU4pLFxuICAgICAgICBoZWlnaHQ6ICAgICAgTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9eaGVpZ2h0PSguKikvKSB8fCBOYU4pLFxuICAgICAgICBzY2FsZUZhY3RvcjogTnVtYmVyKGZpbmRNYXRjaChwYXJzZWQsIC9ec2NhbGVGYWN0b3I9KC4qKS8pIHx8IE5hTiksXG4gICAgICAgIHVzZXJBZ2VudDogICBmaW5kTWF0Y2gocGFyc2VkLCAvXnVzZXJBZ2VudD0oLiopLylcbiAgICB9O1xuXG4gICAgc3BlY2lmaWVkRGV2aWNlT3B0aW9ucyA9IGZpbHRlclByb3BlcnRpZXMoc3BlY2lmaWVkRGV2aWNlT3B0aW9ucywgb3B0aW9uVmFsdWUgPT4ge1xuICAgICAgICByZXR1cm4gb3B0aW9uVmFsdWUgIT09IHZvaWQgMCAmJiBvcHRpb25WYWx1ZSAhPT0gJycgJiYgIU51bWJlci5pc05hTihvcHRpb25WYWx1ZSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihiYXNlT3B0aW9ucywgZGV2aWNlQmFzZWRPcHRpb25zLCBzcGVjaWZpZWREZXZpY2VPcHRpb25zKTtcbn1cblxuXG5mdW5jdGlvbiBnZXROZXdDb25maWcgKGNvbmZpZ1N0cmluZykge1xuICAgIGNvbnN0IHsgdXNlckFyZ3MsIG1vZGVzU3RyaW5nIH0gPSBwYXJzZUNvbmZpZyhjb25maWdTdHJpbmcpO1xuICAgIGNvbnN0IHBhcnNlZFVzZXJBcmdzICAgICAgICAgICAgPSBwYXJzZVVzZXJBcmdzKHVzZXJBcmdzKTtcbiAgICBjb25zdCB7IG1vZGVzLCBvcHRpb25zU3RyaW5nIH0gID0gcGFyc2VNb2Rlcyhtb2Rlc1N0cmluZywgcGFyc2VkVXNlckFyZ3MpO1xuICAgIGNvbnN0IHVzZURlZmF1bHREaW1lbnNpb25zICAgICAgPSBtb2Rlcy5oZWFkbGVzcyAmJiAhcGFyc2VkVXNlckFyZ3Mud2luZG93U2l6ZTtcbiAgICBjb25zdCBvcHRpb25zICAgICAgICAgICAgICAgICAgID0gcGFyc2VPcHRpb25zKG9wdGlvbnNTdHJpbmcsIHVzZURlZmF1bHREaW1lbnNpb25zKTtcblxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHsgdXNlckFyZ3MgfSwgbW9kZXMsIG9wdGlvbnMpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAoY29uZmlnU3RyaW5nKSB7XG4gICAgaWYgKCFjb25maWdDYWNoZVtjb25maWdTdHJpbmddKVxuICAgICAgICBjb25maWdDYWNoZVtjb25maWdTdHJpbmddID0gZ2V0TmV3Q29uZmlnKGNvbmZpZ1N0cmluZyk7XG5cbiAgICByZXR1cm4gY29uZmlnQ2FjaGVbY29uZmlnU3RyaW5nXTtcbn1cbiJdfQ==
