'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _url = require('url');

var _base = require('../base');

var _base2 = _interopRequireDefault(_base);

var _runtimeInfo = require('./runtime-info');

var _runtimeInfo2 = _interopRequireDefault(_runtimeInfo);

var _config = require('./config');

var _config2 = _interopRequireDefault(_config);

var _localChrome = require('./local-chrome');

var _cdp = require('./cdp');

var cdp = _interopRequireWildcard(_cdp);

var _clientFunctions = require('../../../utils/client-functions');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const MIN_AVAILABLE_DIMENSION = 50;

exports.default = (0, _extends3.default)({}, _base2.default, {

    _getConfig(name) {
        return (0, _config2.default)(name);
    },

    _getBrowserProtocolClient() {
        return cdp;
    },

    openBrowser(browserId, pageUrl, configString) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = yield (0, _runtimeInfo2.default)((0, _url.parse)(pageUrl).hostname, configString);

            runtimeInfo.browserName = _this._getBrowserName();
            runtimeInfo.browserId = browserId;

            runtimeInfo.providerMethods = {
                resizeLocalBrowserWindow: function resizeLocalBrowserWindow(...args) {
                    return _this.resizeLocalBrowserWindow(...args);
                }
            };

            yield (0, _localChrome.start)(pageUrl, runtimeInfo);

            yield _this.waitForConnectionReady(browserId);

            runtimeInfo.viewportSize = yield _this.runInitScript(browserId, _clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            yield cdp.createClient(runtimeInfo);

            _this.openedBrowsers[browserId] = runtimeInfo;

            yield _this._ensureWindowIsExpanded(browserId, runtimeInfo.viewportSize);
        })();
    },

    closeBrowser(browserId) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this2.openedBrowsers[browserId];

            if (cdp.isHeadlessTab(runtimeInfo)) yield cdp.closeTab(runtimeInfo);else yield _this2.closeLocalBrowser(browserId);

            if (_osFamily2.default.mac || runtimeInfo.config.headless) yield (0, _localChrome.stop)(runtimeInfo);

            if (runtimeInfo.tempProfileDir) yield runtimeInfo.tempProfileDir.dispose();

            delete _this2.openedBrowsers[browserId];
        })();
    },

    resizeWindow(browserId, width, height, currentWidth, currentHeight) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const runtimeInfo = _this3.openedBrowsers[browserId];

            if (runtimeInfo.config.mobile) yield cdp.updateMobileViewportSize(runtimeInfo);else {
                runtimeInfo.viewportSize.width = currentWidth;
                runtimeInfo.viewportSize.height = currentHeight;
            }

            yield cdp.resizeWindow({ width, height }, runtimeInfo);
        })();
    },

    getVideoFrameData(browserId) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield cdp.getScreenshotData(_this4.openedBrowsers[browserId]);
        })();
    },

    hasCustomActionForBrowser(browserId) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var _openedBrowsers$brows = _this5.openedBrowsers[browserId];
            const config = _openedBrowsers$brows.config,
                  client = _openedBrowsers$brows.client;


            return {
                hasCloseBrowser: true,
                hasResizeWindow: !!client && (config.emulation || config.headless),
                hasMaximizeWindow: !!client && config.headless,
                hasTakeScreenshot: !!client,
                hasChromelessScreenshots: !!client,
                hasGetVideoFrameData: !!client,
                hasCanResizeWindowToDimensions: false
            };
        })();
    },

    _ensureWindowIsExpanded(browserId, { height, width, availableHeight, availableWidth, outerWidth, outerHeight }) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (height < MIN_AVAILABLE_DIMENSION || width < MIN_AVAILABLE_DIMENSION) {
                const newHeight = Math.max(availableHeight, MIN_AVAILABLE_DIMENSION);
                const newWidth = Math.max(Math.floor(availableWidth / 2), MIN_AVAILABLE_DIMENSION);

                yield _this6.resizeWindow(browserId, newWidth, newHeight, outerWidth, outerHeight);
            }
        })();
    }
});
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvaW5kZXguanMiXSwibmFtZXMiOlsiY2RwIiwiTUlOX0FWQUlMQUJMRV9ESU1FTlNJT04iLCJkZWRpY2F0ZWRQcm92aWRlckJhc2UiLCJfZ2V0Q29uZmlnIiwibmFtZSIsIl9nZXRCcm93c2VyUHJvdG9jb2xDbGllbnQiLCJvcGVuQnJvd3NlciIsImJyb3dzZXJJZCIsInBhZ2VVcmwiLCJjb25maWdTdHJpbmciLCJydW50aW1lSW5mbyIsImhvc3RuYW1lIiwiYnJvd3Nlck5hbWUiLCJfZ2V0QnJvd3Nlck5hbWUiLCJwcm92aWRlck1ldGhvZHMiLCJyZXNpemVMb2NhbEJyb3dzZXJXaW5kb3ciLCJhcmdzIiwid2FpdEZvckNvbm5lY3Rpb25SZWFkeSIsInZpZXdwb3J0U2l6ZSIsInJ1bkluaXRTY3JpcHQiLCJHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQiLCJjcmVhdGVDbGllbnQiLCJvcGVuZWRCcm93c2VycyIsIl9lbnN1cmVXaW5kb3dJc0V4cGFuZGVkIiwiY2xvc2VCcm93c2VyIiwiaXNIZWFkbGVzc1RhYiIsImNsb3NlVGFiIiwiY2xvc2VMb2NhbEJyb3dzZXIiLCJPUyIsIm1hYyIsImNvbmZpZyIsImhlYWRsZXNzIiwidGVtcFByb2ZpbGVEaXIiLCJkaXNwb3NlIiwicmVzaXplV2luZG93Iiwid2lkdGgiLCJoZWlnaHQiLCJjdXJyZW50V2lkdGgiLCJjdXJyZW50SGVpZ2h0IiwibW9iaWxlIiwidXBkYXRlTW9iaWxlVmlld3BvcnRTaXplIiwiZ2V0VmlkZW9GcmFtZURhdGEiLCJnZXRTY3JlZW5zaG90RGF0YSIsImhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIiLCJjbGllbnQiLCJoYXNDbG9zZUJyb3dzZXIiLCJoYXNSZXNpemVXaW5kb3ciLCJlbXVsYXRpb24iLCJoYXNNYXhpbWl6ZVdpbmRvdyIsImhhc1Rha2VTY3JlZW5zaG90IiwiaGFzQ2hyb21lbGVzc1NjcmVlbnNob3RzIiwiaGFzR2V0VmlkZW9GcmFtZURhdGEiLCJoYXNDYW5SZXNpemVXaW5kb3dUb0RpbWVuc2lvbnMiLCJhdmFpbGFibGVIZWlnaHQiLCJhdmFpbGFibGVXaWR0aCIsIm91dGVyV2lkdGgiLCJvdXRlckhlaWdodCIsIm5ld0hlaWdodCIsIk1hdGgiLCJtYXgiLCJuZXdXaWR0aCIsImZsb29yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztJQUFZQSxHOztBQUNaOzs7Ozs7QUFHQSxNQUFNQywwQkFBMEIsRUFBaEM7OzZDQUdPQyxjOztBQUVIQyxlQUFZQyxJQUFaLEVBQWtCO0FBQ2QsZUFBTyxzQkFBVUEsSUFBVixDQUFQO0FBQ0gsSzs7QUFFREMsZ0NBQTZCO0FBQ3pCLGVBQU9MLEdBQVA7QUFDSCxLOztBQUVLTSxlQUFOLENBQW1CQyxTQUFuQixFQUE4QkMsT0FBOUIsRUFBdUNDLFlBQXZDLEVBQXFEO0FBQUE7O0FBQUE7QUFDakQsa0JBQU1DLGNBQWMsTUFBTSwyQkFBZSxnQkFBU0YsT0FBVCxFQUFrQkcsUUFBakMsRUFBMkNGLFlBQTNDLENBQTFCOztBQUVBQyx3QkFBWUUsV0FBWixHQUEwQixNQUFLQyxlQUFMLEVBQTFCO0FBQ0FILHdCQUFZSCxTQUFaLEdBQTBCQSxTQUExQjs7QUFFQUcsd0JBQVlJLGVBQVosR0FBOEI7QUFDMUJDLDBDQUEwQixrQ0FBQyxHQUFHQyxJQUFKO0FBQUEsMkJBQWEsTUFBS0Qsd0JBQUwsQ0FBOEIsR0FBR0MsSUFBakMsQ0FBYjtBQUFBO0FBREEsYUFBOUI7O0FBSUEsa0JBQU0sd0JBQWlCUixPQUFqQixFQUEwQkUsV0FBMUIsQ0FBTjs7QUFFQSxrQkFBTSxNQUFLTyxzQkFBTCxDQUE0QlYsU0FBNUIsQ0FBTjs7QUFFQUcsd0JBQVlRLFlBQVosR0FBMkIsTUFBTSxNQUFLQyxhQUFMLENBQW1CWixTQUFuQixFQUE4QmEs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LHNCQUFNd0QsWUFBWUMsS0FBS0MsR0FBTCxDQUFTTixlQUFULEVBQTBCcEQsdUJBQTFCLENBQWxCO0FBQ0Esc0JBQU0yRCxXQUFZRixLQUFLQyxHQUFMLENBQVNELEtBQUtHLEtBQUwsQ0FBV1AsaUJBQWlCLENBQTVCLENBQVQsRUFBeUNyRCx1QkFBekMsQ0FBbEI7O0FBRUEsc0JBQU0sT0FBS2lDLFlBQUwsQ0FBa0IzQixTQUFsQixFQUE2QnFELFFBQTdCLEVBQXVDSCxTQUF2QyxFQUFrREYsVUFBbEQsRUFBOERDLFdBQTlELENBQU47QUFDSDtBQU5rSDtBQU90SCIsImZpbGUiOiJicm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9jaHJvbWUvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT1MgZnJvbSAnb3MtZmFtaWx5JztcbmltcG9ydCB7IHBhcnNlIGFzIHBhcnNlVXJsIH0gZnJvbSAndXJsJztcbmltcG9ydCBkZWRpY2F0ZWRQcm92aWRlckJhc2UgZnJvbSAnLi4vYmFzZSc7XG5pbXBvcnQgZ2V0UnVudGltZUluZm8gZnJvbSAnLi9ydW50aW1lLWluZm8nO1xuaW1wb3J0IGdldENvbmZpZyBmcm9tICcuL2NvbmZpZyc7XG5pbXBvcnQgeyBzdGFydCBhcyBzdGFydExvY2FsQ2hyb21lLCBzdG9wIGFzIHN0b3BMb2NhbENocm9tZSB9IGZyb20gJy4vbG9jYWwtY2hyb21lJztcbmltcG9ydCAqIGFzIGNkcCBmcm9tICcuL2NkcCc7XG5pbXBvcnQgeyBHRVRfV0lORE9XX0RJTUVOU0lPTlNfSU5GT19TQ1JJUFQgfSBmcm9tICcuLi8uLi8uLi91dGlscy9jbGllbnQtZnVuY3Rpb25zJztcblxuXG5jb25zdCBNSU5fQVZBSUxBQkxFX0RJTUVOU0lPTiA9IDUwO1xuXG5leHBvcnQgZGVmYXVsdCB7XG4gICAgLi4uZGVkaWNhdGVkUHJvdmlkZXJCYXNlLFxuXG4gICAgX2dldENvbmZpZyAobmFtZSkge1xuICAgICAgICByZXR1cm4gZ2V0Q29uZmlnKG5hbWUpO1xuICAgIH0sXG5cbiAgICBfZ2V0QnJvd3NlclByb3RvY29sQ2xpZW50ICgpIHtcbiAgICAgICAgcmV0dXJuIGNkcDtcbiAgICB9LFxuXG4gICAgYXN5bmMgb3BlbkJyb3dzZXIgKGJyb3dzZXJJZCwgcGFnZVVybCwgY29uZmlnU3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHJ1bnRpbWVJbmZvID0gYXdhaXQgZ2V0UnVudGltZUluZm8ocGFyc2VVcmwocGFnZVVybCkuaG9zdG5hbWUsIGNvbmZpZ1N0cmluZyk7XG5cbiAgICAgICAgcnVudGltZUluZm8uYnJvd3Nlck5hbWUgPSB0aGlzLl9nZXRCcm93c2VyTmFtZSgpO1xuICAgICAgICBydW50aW1lSW5mby5icm93c2VySWQgICA9IGJyb3dzZXJJZDtcblxuICAgICAgICBydW50aW1lSW5mby5wcm92aWRlck1ldGhvZHMgPSB7XG4gICAgICAgICAgICByZXNpemVMb2NhbEJyb3dzZXJXaW5kb3c6ICguLi5hcmdzKSA9PiB0aGlzLnJlc2l6ZUxvY2FsQnJvd3NlcldpbmRvdyguLi5hcmdzKVxuICAgICAgICB9O1xuXG4gICAgICAgIGF3YWl0IHN0YXJ0TG9jYWxDaHJvbWUocGFnZVVybCwgcnVudGltZUluZm8pO1xuXG4gICAgICAgIGF3YWl0IHRoaXMud2FpdEZvckNvbm5lY3Rpb25SZWFkeShicm93c2VySWQpO1xuXG4gICAgICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZSA9IGF3YWl0IHRoaXMucnVuSW5pdFNjcmlwdChicm93c2VySWQsIEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCk7XG5cbiAgICAgICAgYXdhaXQgY2RwLmNyZWF0ZUNsaWVudChydW50aW1lSW5mbyk7XG5cbiAgICAgICAgdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdID0gcnVudGltZUluZm87XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fZW5zdXJlV2luZG93SXNFeHBhbmRlZChicm93c2VySWQsIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZSk7XG4gICAgfSxcblxuICAgIGFzeW5jIGNsb3NlQnJvd3NlciAoYnJvd3NlcklkKSB7XG4gICAgICAgIGNvbnN0IHJ1bnRpbWVJbmZvID0gdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdO1xuXG4gICAgICAgIGlmIChjZHAuaXNIZWFkbGVzc1RhYihydW50aW1lSW5mbykpXG4gICAgICAgICAgICBhd2FpdCBjZHAuY2xvc2VUYWIocnVudGltZUluZm8pO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNsb3NlTG9jYWxCcm93c2VyKGJyb3dzZXJJZCk7XG5cbiAgICAgICAgaWYgKE9TLm1hYyB8fCBydW50aW1lSW5mby5jb25maWcuaGVhZGxlc3MpXG4gICAgICAgICAgICBhd2FpdCBzdG9wTG9jYWxDaHJvbWUocnVudGltZUluZm8pO1xuXG4gICAgICAgIGlmIChydW50aW1lSW5mby50ZW1wUHJvZmlsZURpcilcbiAgICAgICAgICAgIGF3YWl0IHJ1bnRpbWVJbmZvLnRlbXBQcm9maWxlRGlyLmRpc3Bvc2UoKTtcblxuICAgICAgICBkZWxldGUgdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdO1xuICAgIH0sXG5cbiAgICBhc3luYyByZXNpemVXaW5kb3cgKGJyb3dzZXJJZCwgd2lkdGgsIGhlaWdodCwgY3VycmVudFdpZHRoLCBjdXJyZW50SGVpZ2h0KSB7XG4gICAgICAgIGNvbnN0IHJ1bnRpbWVJbmZvID0gdGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdO1xuXG4gICAgICAgIGlmIChydW50aW1lSW5mby5jb25maWcubW9iaWxlKVxuICAgICAgICAgICAgYXdhaXQgY2RwLnVwZGF0ZU1vYmlsZVZpZXdwb3J0U2l6ZShydW50aW1lSW5mbyk7XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcnVudGltZUluZm8udmlld3BvcnRTaXplLndpZHRoICA9IGN1cnJlbnRXaWR0aDtcbiAgICAgICAgICAgIHJ1bnRpbWVJbmZvLnZpZXdwb3J0U2l6ZS5oZWlnaHQgPSBjdXJyZW50SGVpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgY2RwLnJlc2l6ZVdpbmRvdyh7IHdpZHRoLCBoZWlnaHQgfSwgcnVudGltZUluZm8pO1xuICAgIH0sXG5cbiAgICBhc3luYyBnZXRWaWRlb0ZyYW1lRGF0YSAoYnJvd3NlcklkKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBjZHAuZ2V0U2NyZWVuc2hvdERhdGEodGhpcy5vcGVuZWRCcm93c2Vyc1ticm93c2VySWRdKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgaGFzQ3VzdG9tQWN0aW9uRm9yQnJvd3NlciAoYnJvd3NlcklkKSB7XG4gICAgICAgIGNvbnN0IHsgY29uZmlnLCBjbGllbnQgfSA9IHRoaXMub3BlbmVkQnJvd3NlcnNbYnJvd3NlcklkXTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaGFzQ2xvc2VCcm93c2VyOiAgICAgICAgICAgICAgICB0cnVlLFxuICAgICAgICAgICAgaGFzUmVzaXplV2luZG93OiAgICAgICAgICAgICAgICAhIWNsaWVudCAmJiAoY29uZmlnLmVtdWxhdGlvbiB8fCBjb25maWcuaGVhZGxlc3MpLFxuICAgICAgICAgICAgaGFzTWF4aW1pemVXaW5kb3c6ICAgICAgICAgICAgICAhIWNsaWVudCAmJiBjb25maWcuaGVhZGxlc3MsXG4gICAgICAgICAgICBoYXNUYWtlU2NyZWVuc2hvdDogICAgICAgICAgICAgICEhY2xpZW50LFxuICAgICAgICAgICAgaGFzQ2hyb21lbGVzc1NjcmVlbnNob3RzOiAgICAgICAhIWNsaWVudCxcbiAgICAgICAgICAgIGhhc0dldFZpZGVvRnJhbWVEYXRhOiAgICAgICAgICAgISFjbGllbnQsXG4gICAgICAgICAgICBoYXNDYW5SZXNpemVXaW5kb3dUb0RpbWVuc2lvbnM6IGZhbHNlXG4gICAgICAgIH07XG4gICAgfSxcblxuICAgIGFzeW5jIF9lbnN1cmVXaW5kb3dJc0V4cGFuZGVkIChicm93c2VySWQsIHsgaGVpZ2h0LCB3aWR0aCwgYXZhaWxhYmxlSGVpZ2h0LCBhdmFpbGFibGVXaWR0aCwgb3V0ZXJXaWR0aCwgb3V0ZXJIZWlnaHQgfSkge1xuICAgICAgICBpZiAoaGVpZ2h0IDwgTUlOX0FWQUlMQUJMRV9ESU1FTlNJT04gfHwgd2lkdGggPCBNSU5fQVZBSUxBQkxFX0RJTUVOU0lPTikge1xuICAgICAgICAgICAgY29uc3QgbmV3SGVpZ2h0ID0gTWF0aC5tYXgoYXZhaWxhYmxlSGVpZ2h0LCBNSU5fQVZBSUxBQkxFX0RJTUVOU0lPTik7XG4gICAgICAgICAgICBjb25zdCBuZXdXaWR0aCAgPSBNYXRoLm1heChNYXRoLmZsb29yKGF2YWlsYWJsZVdpZHRoIC8gMiksIE1JTl9BVkFJTEFCTEVfRElNRU5TSU9OKTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZXNpemVXaW5kb3coYnJvd3NlcklkLCBuZXdXaWR0aCwgbmV3SGVpZ2h0LCBvdXRlcldpZHRoLCBvdXRlckhlaWdodCk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuIl19
