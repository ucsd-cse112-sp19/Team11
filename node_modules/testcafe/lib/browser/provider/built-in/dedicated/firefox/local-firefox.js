'use strict';

exports.__esModule = true;
exports.stop = exports.start = undefined;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let start = exports.start = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (pageUrl, runtimeInfo) {
        const browserName = runtimeInfo.browserName,
              config = runtimeInfo.config;


        const firefoxInfo = yield _testcafeBrowserTools2.default.getBrowserInfo(config.path || browserName);
        const firefoxOpenParameters = (0, _assign2.default)({}, firefoxInfo);

        if (_osFamily2.default.mac && !config.userProfile) correctOpenParametersForMac(firefoxOpenParameters);

        firefoxOpenParameters.cmd = buildFirefoxArgs(config, firefoxOpenParameters.cmd, runtimeInfo, runtimeInfo.newInstance);

        yield browserStarter.startBrowser(firefoxOpenParameters, pageUrl);
    });

    return function start(_x, _x2) {
        return _ref.apply(this, arguments);
    };
})();

let stop = exports.stop = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* ({ browserId }) {
        yield (0, _process.killBrowserProcess)(browserId);
    });

    return function stop(_x3) {
        return _ref2.apply(this, arguments);
    };
})();

var _osFamily = require('os-family');

var _osFamily2 = _interopRequireDefault(_osFamily);

var _testcafeBrowserTools = require('testcafe-browser-tools');

var _testcafeBrowserTools2 = _interopRequireDefault(_testcafeBrowserTools);

var _process = require('../../../../../utils/process');

var _browserStarter = require('../../../utils/browser-starter');

var _browserStarter2 = _interopRequireDefault(_browserStarter);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const browserStarter = new _browserStarter2.default();

function correctOpenParametersForMac(parameters) {
    parameters.macOpenCmdTemplate = parameters.macOpenCmdTemplate.replace('open', 'open -n').replace(' {{{pageUrl}}}', '');

    parameters.macOpenCmdTemplate += ' {{{pageUrl}}}';
}

function buildFirefoxArgs(config, platformArgs, { marionettePort, tempProfileDir }) {
    return [].concat(marionettePort ? ['-marionette'] : [], !config.userProfile ? ['-no-remote', '-new-instance', `-profile "${tempProfileDir.path}"`] : [], config.headless ? ['-headless'] : [], config.userArgs ? [config.userArgs] : [], platformArgs ? [platformArgs] : []).join(' ');
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9maXJlZm94L2xvY2FsLWZpcmVmb3guanMiXSwibmFtZXMiOlsicGFnZVVybCIsInJ1bnRpbWVJbmZvIiwiYnJvd3Nlck5hbWUiLCJjb25maWciLCJmaXJlZm94SW5mbyIsImJyb3dzZXJUb29scyIsImdldEJyb3dzZXJJbmZvIiwicGF0aCIsImZpcmVmb3hPcGVuUGFyYW1ldGVycyIsIk9TIiwibWFjIiwidXNlclByb2ZpbGUiLCJjb3JyZWN0T3BlblBhcmFtZXRlcnNGb3JNYWMiLCJjbWQiLCJidWlsZEZpcmVmb3hBcmdzIiwibmV3SW5zdGFuY2UiLCJicm93c2VyU3RhcnRlciIsInN0YXJ0QnJvd3NlciIsInN0YXJ0IiwiYnJvd3NlcklkIiwic3RvcCIsIkJyb3dzZXJTdGFydGVyIiwicGFyYW1ldGVycyIsIm1hY09wZW5DbWRUZW1wbGF0ZSIsInJlcGxhY2UiLCJwbGF0Zm9ybUFyZ3MiLCJtYXJpb25ldHRlUG9ydCIsInRlbXBQcm9maWxlRGlyIiwiY29uY2F0IiwiaGVhZGxlc3MiLCJ1c2VyQXJncyIsImpvaW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OytDQTRCTyxXQUFzQkEsT0FBdEIsRUFBK0JDLFdBQS9CLEVBQTRDO0FBQUEsY0FDdkNDLFdBRHVDLEdBQ2ZELFdBRGUsQ0FDdkNDLFdBRHVDO0FBQUEsY0FDMUJDLE1BRDBCLEdBQ2ZGLFdBRGUsQ0FDMUJFLE1BRDBCOzs7QUFHL0MsY0FBTUMsY0FBd0IsTUFBTUMsK0JBQWFDLGNBQWIsQ0FBNEJILE9BQU9JLElBQVAsSUFBZUwsV0FBM0MsQ0FBcEM7QUFDQSxjQUFNTSx3QkFBd0Isc0JBQWMsRUFBZCxFQUFrQkosV0FBbEIsQ0FBOUI7O0FBRUEsWUFBSUssbUJBQUdDLEdBQUgsSUFBVSxDQUFDUCxPQUFPUSxXQUF0QixFQUNJQyw0QkFBNEJKLHFCQUE1Qjs7QUFFSkEsOEJBQXNCSyxHQUF0QixHQUE0QkMsaUJBQWlCWCxNQUFqQixFQUF5Qkssc0JBQXNCSyxHQUEvQyxFQUFvRFosV0FBcEQsRUFBaUVBLFlBQVljLFdBQTdFLENBQTVCOztBQUVBLGNBQU1DLGVBQWVDLFlBQWYsQ0FBNEJULHFCQUE1QixFQUFtRFIsT0FBbkQsQ0FBTjtBQUNILEs7O29CQVpxQmtCLEs7Ozs7OztnREFjZixXQUFxQixFQUFFQyxTQUFGLEVBQXJCLEVBQW9DO0FBQ3ZDLGNBQU0saUNBQW1CQSxTQUFuQixDQUFOO0FBQ0gsSzs7b0JBRnFCQyxJOzs7OztBQTFDdEI7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFHQSxNQUFNSixpQkFBaUIsSUFBSUssd0JBQUosRUFBdkI7O0FBRUEsU0FBU1QsMkJBQVQsQ0FBc0NVLFVBQXRDLEVBQWtEO0FBQzlDQSxlQUFXQyxrQkFBWCxHQUFnQ0QsV0FBV0Msa0JBQVgsQ0FDM0JDLE9BRDJCLENBQ25CLE1BRG1CLEVBQ1gsU0FEVyxFQUUzQkEsT0FGMkIsQ0FFbkIsZ0JBRm1CLEVBRUQsRUFGQyxDQUFoQzs7QUFJQUYsZUFBV0Msa0JBQVgsSUFBaUMsZ0JBQWpDO0FBQ0g7O0FBRUQsU0FBU1QsZ0JBQVQsQ0FBMkJYLE1BQTNCLEVBQW1Dc0IsWUFBbkMsRUFBaUQsRUFBRUMsY0FBRixFQUFrQkMsY0FBbEIsRUFBakQsRUFBcUY7QUFDakYsV0FBTyxHQUNGQyxNQURFLENBRUNGLGlCQUFpQixDQUFDLGFBQUQsQ0FBakIsR0FBbUMsRUFGcEMsRUFHQyxDQUFDdkIsT0FBT1EsV0FBUixHQUFzQixDQUFDLFlBQUQsRUFBZSxlQUFmLEVBQWlDLGFBQVlnQixlQUFlcEIsSUFBSyxHQUFqRSxDQUF0QixHQUE2RixFQUg5RixFQUlDSixPQUFPMEIsUUFBUCxHQUFrQixDQUFDLFdBQUQsQ0FBbEIsR0FBa0MsRUFKbkMsRUFLQzFCLE9BQU8yQixRQUFQLEdBQWtCLENBQUMzQixPQUFPMkIsUUFBUixDQUFsQixHQUFzQyxFQUx2QyxFQU1DTCxlQUFlLENBQUNBLFlBQUQsQ0FBZixHQUFnQyxFQU5qQyxFQVFGTSxJQVJFLENBUUcsR0FSSCxDQUFQO0FBU0giLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9idWlsdC1pbi9kZWRpY2F0ZWQvZmlyZWZveC9sb2NhbC1maXJlZm94LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE9TIGZyb20gJ29zLWZhbWlseSc7XG5pbXBvcnQgYnJvd3NlclRvb2xzIGZyb20gJ3Rlc3RjYWZlLWJyb3dzZXItdG9vbHMnO1xuaW1wb3J0IHsga2lsbEJyb3dzZXJQcm9jZXNzIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vdXRpbHMvcHJvY2Vzcyc7XG5pbXBvcnQgQnJvd3NlclN0YXJ0ZXIgZnJvbSAnLi4vLi4vLi4vdXRpbHMvYnJvd3Nlci1zdGFydGVyJztcblxuXG5jb25zdCBicm93c2VyU3RhcnRlciA9IG5ldyBCcm93c2VyU3RhcnRlcigpO1xuXG5mdW5jdGlvbiBjb3JyZWN0T3BlblBhcmFtZXRlcnNGb3JNYWMgKHBhcmFtZXRlcnMpIHtcbiAgICBwYXJhbWV0ZXJzLm1hY09wZW5DbWRUZW1wbGF0ZSA9IHBhcmFtZXRlcnMubWFjT3BlbkNtZFRlbXBsYXRlXG4gICAgICAgIC5yZXBsYWNlKCdvcGVuJywgJ29wZW4gLW4nKVxuICAgICAgICAucmVwbGFjZSgnIHt7e3BhZ2VVcmx9fX0nLCAnJyk7XG5cbiAgICBwYXJhbWV0ZXJzLm1hY09wZW5DbWRUZW1wbGF0ZSArPSAnIHt7e3BhZ2VVcmx9fX0nO1xufVxuXG5mdW5jdGlvbiBidWlsZEZpcmVmb3hBcmdzIChjb25maWcsIHBsYXRmb3JtQXJncywgeyBtYXJpb25ldHRlUG9ydCwgdGVtcFByb2ZpbGVEaXIgfSkge1xuICAgIHJldHVybiBbXVxuICAgICAgICAuY29uY2F0KFxuICAgICAgICAgICAgbWFyaW9uZXR0ZVBvcnQgPyBbJy1tYXJpb25ldHRlJ10gOiBbXSxcbiAgICAgICAgICAgICFjb25maWcudXNlclByb2ZpbGUgPyBbJy1uby1yZW1vdGUnLCAnLW5ldy1pbnN0YW5jZScsIGAtcHJvZmlsZSBcIiR7dGVtcFByb2ZpbGVEaXIucGF0aH1cImBdIDogW10sXG4gICAgICAgICAgICBjb25maWcuaGVhZGxlc3MgPyBbJy1oZWFkbGVzcyddIDogW10sXG4gICAgICAgICAgICBjb25maWcudXNlckFyZ3MgPyBbY29uZmlnLnVzZXJBcmdzXSA6IFtdLFxuICAgICAgICAgICAgcGxhdGZvcm1BcmdzID8gW3BsYXRmb3JtQXJnc10gOiBbXVxuICAgICAgICApXG4gICAgICAgIC5qb2luKCcgJyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzdGFydCAocGFnZVVybCwgcnVudGltZUluZm8pIHtcbiAgICBjb25zdCB7IGJyb3dzZXJOYW1lLCBjb25maWcgfSA9IHJ1bnRpbWVJbmZvO1xuXG4gICAgY29uc3QgZmlyZWZveEluZm8gICAgICAgICAgID0gYXdhaXQgYnJvd3NlclRvb2xzLmdldEJyb3dzZXJJbmZvKGNvbmZpZy5wYXRoIHx8IGJyb3dzZXJOYW1lKTtcbiAgICBjb25zdCBmaXJlZm94T3BlblBhcmFtZXRlcnMgPSBPYmplY3QuYXNzaWduKHt9LCBmaXJlZm94SW5mbyk7XG5cbiAgICBpZiAoT1MubWFjICYmICFjb25maWcudXNlclByb2ZpbGUpXG4gICAgICAgIGNvcnJlY3RPcGVuUGFyYW1ldGVyc0Zvck1hYyhmaXJlZm94T3BlblBhcmFtZXRlcnMpO1xuXG4gICAgZmlyZWZveE9wZW5QYXJhbWV0ZXJzLmNtZCA9IGJ1aWxkRmlyZWZveEFyZ3MoY29uZmlnLCBmaXJlZm94T3BlblBhcmFtZXRlcnMuY21kLCBydW50aW1lSW5mbywgcnVudGltZUluZm8ubmV3SW5zdGFuY2UpO1xuXG4gICAgYXdhaXQgYnJvd3NlclN0YXJ0ZXIuc3RhcnRCcm93c2VyKGZpcmVmb3hPcGVuUGFyYW1ldGVycywgcGFnZVVybCk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzdG9wICh7IGJyb3dzZXJJZCB9KSB7XG4gICAgYXdhaXQga2lsbEJyb3dzZXJQcm9jZXNzKGJyb3dzZXJJZCk7XG59XG4iXX0=
