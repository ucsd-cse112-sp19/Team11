'use strict';

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _net = require('net');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _delay = require('../../../../../../utils/delay');

var _delay2 = _interopRequireDefault(_delay);

var _clientFunctions = require('../../../../utils/client-functions');

var _commands = require('./commands');

var _commands2 = _interopRequireDefault(_commands);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CONNECTION_TIMEOUT = 30000;
const CONNECTION_RETRY_DELAY = 300;
const MAX_RESIZE_RETRY_COUNT = 2;
const HEADER_SEPARATOR = ':';

module.exports = class MarionetteClient {
    constructor(port = 2828, host = '127.0.0.1') {
        this.currentPacketNumber = 1;
        this.events = new _events2.default();
        this.port = port;
        this.host = host;
        this.socket = new _net.Socket();
        this.buffer = Buffer.alloc(0);
        this.getPacketPromise = _pinkie2.default.resolve();
        this.sendPacketPromise = _pinkie2.default.resolve();

        this.protocolInfo = {
            applicationType: '',
            marionetteProtocol: ''
        };

        this.sessionInfo = null;
    }

    _attemptToConnect(port, host) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this.socket.connect(port, host);

            const connectionPromise = _pinkie2.default.race([(0, _promisifyEvent2.default)(_this.socket, 'connect'), (0, _promisifyEvent2.default)(_this.socket, 'error')]);

            return yield connectionPromise.then(function () {
                return true;
            }).catch(function () {
                _this.socket.removeAllListeners('connect');
                return (0, _delay2.default)(CONNECTION_RETRY_DELAY);
            });
        })();
    }

    _connectSocket(port, host) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const connectionStartTime = Date.now();

            let connected = yield _this2._attemptToConnect(port, host);

            while (!connected && Date.now() - connectionStartTime < CONNECTION_TIMEOUT) connected = yield _this2._attemptToConnect(port, host);

            if (!connected) throw new Error('Unable to connect');

            _this2.socket.on('data', function (data) {
                return _this2._handleNewData(data);
            });
        })();
    }

    _writeSocket(message) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this3.socket.write(message)) yield (0, _promisifyEvent2.default)(_this3.socket, 'drain');
        })();
    }

    _handleNewData(data) {
        if (!data) return;

        this.buffer = Buffer.concat([this.buffer, data]);

        this.events.emit('new-data');
    }

    _getPacket() {
        var _this4 = this;

        this.getPacketPromise = this.getPacketPromise.then((0, _asyncToGenerator3.default)(function* () {
            let headerEndIndex = _this4.buffer.indexOf(HEADER_SEPARATOR);

            while (headerEndIndex < 0) {
                yield (0, _promisifyEvent2.default)(_this4.events, 'new-data');

                headerEndIndex = _this4.buffer.indexOf(HEADER_SEPARATOR);
            }

            const packet = {
                length: NaN,
                body: null
            };

            packet.length = parseInt(_this4.buffer.toString('utf8', 0, headerEndIndex), 10) || 0;

            const bodyStartIndex = headerEndIndex + HEADER_SEPARATOR.length;
            const bodyEndIndex = bodyStartIndex + packet.length;

            if (packet.length) {
                while (_this4.buffer.length < bodyEndIndex) yield (0, _promisifyEvent2.default)(_this4.events, 'new-data');

                packet.body = JSON.parse(_this4.buffer.toString('utf8', bodyStartIndex, bodyEndIndex));
            }

            _this4.buffer = _this4.buffer.slice(bodyEndIndex);

            return packet;
        }));

        return this.getPacketPromise;
    }

    _sendPacket(payload) {
        var _this5 = this;

        this.sendPacketPromise = this.sendPacketPromise.then((0, _asyncToGenerator3.default)(function* () {
            const body = [0, _this5.currentPacketNumber++, payload.command, payload.parameters];
            const serialized = (0, _stringify2.default)(body);
            const message = Buffer.byteLength(serialized, 'utf8') + HEADER_SEPARATOR + serialized;

            _this5._writeSocket(message);
        }));

        return this.sendPacketPromise;
    }

    _throwMarionetteError(error) {
        throw new Error(`${error.error}${error.message ? ': ' + error.message : ''}`);
    }

    _getResponse(packet) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const packetNumber = _this6.currentPacketNumber;

            yield _this6._sendPacket(packet);

            let responsePacket = yield _this6._getPacket();

            while (!responsePacket.body || responsePacket.body[1] !== packetNumber) responsePacket = yield _this6._getPacket();

            if (responsePacket.body[2]) _this6._throwMarionetteError(responsePacket.body[2]);

            return responsePacket.body[3];
        })();
    }

    _getScreenshotRawData() {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this7._getResponse({ command: _commands2.default.takeScreenshot });
        })();
    }

    connect() {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this8._connectSocket(_this8.port, _this8.host);

            const infoPacket = yield _this8._getPacket();

            _this8.protocolInfo = {
                applicationType: infoPacket.body.applicationType,
                marionetteProtocol: infoPacket.body.marionetteProtocol
            };

            _this8.sessionInfo = yield _this8._getResponse({ command: _commands2.default.newSession });
        })();
    }

    dispose() {
        this.socket.end();
        this.buffer = null;
    }

    executeScript(code) {
        var _this9 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            return yield _this9._getResponse({
                command: _commands2.default.executeScript,
                parameters: { script: `return (${code})()` }
            });
        })();
    }

    getScreenshotData() {
        var _this10 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const frameData = yield _this10._getScreenshotRawData();

            return Buffer.from(frameData.value, 'base64');
        })();
    }

    setWindowSize(width, height) {
        var _this11 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            var _ref3 = yield _this11.executeScript(_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

            let pageRect = _ref3.value;

            let attemptCounter = 0;

            while (attemptCounter++ < MAX_RESIZE_RETRY_COUNT && (pageRect.width !== width || pageRect.height !== height)) {
                const currentRect = yield _this11._getResponse({ command: _commands2.default.getWindowRect });

                yield _this11._getResponse({
                    command: _commands2.default.setWindowRect,

                    parameters: {
                        x: currentRect.x,
                        y: currentRect.y,
                        width: width + (currentRect.width - pageRect.width),
                        height: height + (currentRect.height - pageRect.height)
                    }
                });

                var _ref4 = yield _this11.executeScript(_clientFunctions.GET_WINDOW_DIMENSIONS_INFO_SCRIPT);

                pageRect = _ref4.value;
            }
        })();
    }

    quit() {
        var _this12 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this12._getResponse({ command: _commands2.default.quit });
        })();
    }
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL2J1aWx0LWluL2RlZGljYXRlZC9maXJlZm94L21hcmlvbmV0dGUtY2xpZW50L2luZGV4LmpzIl0sIm5hbWVzIjpbIkNPTk5FQ1RJT05fVElNRU9VVCIsIkNPTk5FQ1RJT05fUkVUUllfREVMQVkiLCJNQVhfUkVTSVpFX1JFVFJZX0NPVU5UIiwiSEVBREVSX1NFUEFSQVRPUiIsIm1vZHVsZSIsImV4cG9ydHMiLCJNYXJpb25ldHRlQ2xpZW50IiwiY29uc3RydWN0b3IiLCJwb3J0IiwiaG9zdCIsImN1cnJlbnRQYWNrZXROdW1iZXIiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJzb2NrZXQiLCJTb2NrZXQiLCJidWZmZXIiLCJCdWZmZXIiLCJhbGxvYyIsImdldFBhY2tldFByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNlbmRQYWNrZXRQcm9taXNlIiwicHJvdG9jb2xJbmZvIiwiYXBwbGljYXRpb25UeXBlIiwibWFyaW9uZXR0ZVByb3RvY29sIiwic2Vzc2lvbkluZm8iLCJfYXR0ZW1wdFRvQ29ubmVjdCIsImNvbm5lY3QiLCJjb25uZWN0aW9uUHJvbWlzZSIsInJhY2UiLCJ0aGVuIiwiY2F0Y2giLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJfY29ubmVjdFNvY2tldCIsImNvbm5lY3Rpb25TdGFydFRpbWUiLCJEYXRlIiwibm93IiwiY29ubmVjdGVkIiwiRXJyb3IiLCJvbiIsIl9oYW5kbGVOZXdEYXRhIiwiZGF0YSIsIl93cml0ZVNvY2tldCIsIm1lc3NhZ2UiLCJ3cml0ZSIsImNvbmNhdCIsImVtaXQiLCJfZ2V0UGFja2V0IiwiaGVhZGVyRW5kSW5kZXgiLCJpbmRleE9mIiwicGFja2V0IiwibGVuZ3RoIiwiTmFOIiwiYm9keSIsInBhcnNlSW50IiwidG9TdHJpbmciLCJib2R5U3RhcnRJbmRleCIsImJvZHlFbmRJbmRleCIsIkpTT04iLCJwYXJzZSIsInNsaWNlIiwiX3NlbmRQYWNrZXQiLCJwYXlsb2FkIiwiY29tbWFuZCIsInBhcmFtZXRlcnMiLCJzZXJpYWxpemVkIiwiYnl0ZUxlbmd0aCIsIl90aHJvd01hcmlvbmV0dGVFcnJvciIsImVycm9yIiwiX2dldFJlc3BvbnNlIiwicGFja2V0TnVtYmVyIiwicmVzcG9uc2VQYWNrZXQiLCJfZ2V0U2NyZWVuc2hvdFJhd0RhdGEiLCJDT01NQU5EUyIsInRha2VTY3JlZW5zaG90IiwiaW5mb1BhY2tldCIsIm5ld1Nlc3Npb24iLCJkaXNwb3NlIiwiZW5kIiwiZXhlY3V0ZVNjcmlwdCIsImNvZGUiLCJzY3JpcHQiLCJnZXRTY3JlZW5zaG90RGF0YSIsImZyYW1lRGF0YSIsImZyb20iLCJ2YWx1ZSIsInNldFdpbmRvd1NpemUiLCJ3aWR0aCIsImhlaWdodCIsIkdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCIsInBhZ2VSZWN0IiwiYXR0ZW1wdENvdW50ZXIiLCJjdXJyZW50UmVjdCIsImdldFdpbmRvd1JlY3QiLCJzZXRXaW5kb3dSZWN0IiwieCIsInkiLCJxdWl0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7Ozs7O0FBR0EsTUFBTUEscUJBQXlCLEtBQS9CO0FBQ0EsTUFBTUMseUJBQXlCLEdBQS9CO0FBQ0EsTUFBTUMseUJBQXlCLENBQS9CO0FBQ0EsTUFBTUMsbUJBQXlCLEdBQS9COztBQUVBQyxPQUFPQyxPQUFQLEdBQWlCLE1BQU1DLGdCQUFOLENBQXVCO0FBQ3BDQyxnQkFBYUMsT0FBTyxJQUFwQixFQUEwQkMsT0FBTyxXQUFqQyxFQUE4QztBQUMxQyxhQUFLQyxtQkFBTCxHQUEyQixDQUEzQjtBQUNBLGFBQUtDLE1BQUwsR0FBMkIsSUFBSUMsZ0JBQUosRUFBM0I7QUFDQSxhQUFLSixJQUFMLEdBQTJCQSxJQUEzQjtBQUNBLGFBQUtDLElBQUwsR0FBMkJBLElBQTNCO0FBQ0EsYUFBS0ksTUFBTCxHQUEyQixJQUFJQyxXQUFKLEVBQTNCO0FBQ0EsYUFBS0MsTUFBTCxHQUEyQkMsT0FBT0MsS0FBUCxDQUFhLENBQWIsQ0FBM0I7QUFDQSxhQUFLQyxnQkFBTCxHQUEyQkMsaUJBQVFDLE9BQVIsRUFBM0I7QUFDQSxhQUFLQyxpQkFBTCxHQUEyQkYsaUJBQVFDLE9BQVIsRUFBM0I7O0FBRUEsYUFBS0UsWUFBTCxHQUFvQjtBQUNoQkMsNkJBQW9CLEVBREo7QUFFaEJDLGdDQUFvQjtBQUZKLFNBQXBCOztBQUtBLGFBQUtDLFdBQUwsR0FBbUIsSUFBbkI7QUFDSDs7QUFFS0MscUJBQU4sQ0FBeUJsQixJQUF6QixFQUErQkMsSUFBL0IsRUFBcUM7QUFBQTs7QUFBQTtBQUNqQyxrQkFBS0ksTUFBTCxDQUFZYyxPQUFaLENBQW9CbkIsSUFBcEIsRUFBMEJDLElBQTFCOztBQUVBLGtCQUFNbUIsb0JBQW9CVCxpQkFBUVUsSUFBUixDQUFhLENBQ25DLDhCQUFlLE1BQUtoQixNQUFwQixFQUE0QixTQUE1QixDQURtQyxFQUVuQyw4QkFBZSxNQUFLQSxNQUFwQixFQUE0QixPQUE1QixDQUZtQyxDQUFiLENBQTFCOztBQUtBLG1CQUFPLE1BQU1lLGtCQUNSRSxJQURRLENBQ0g7QUFBQSx1QkFBTSxJQUFOO0FBQUEsYUFERyxFQUVSQyxLQUZRLENBRUYsWUFBTTtBQUNULHNCQUFLbEIsTUFBTCxDQUFZbUIsa0JBQVosQ0FBK0IsU0FBL0I7QUFDQSx1QkFBTyxxQkFBTS9CLHNCQUFOLENBQVA7QUFDSCxhQUxRLENBQWI7QUFSaUM7QUFjcEM7O0FBRUtnQyxrQkFBTixDQUFzQnpCLElBQXRCLEVBQTRCQyxJQUE1QixFQUFrQztBQUFBOztBQUFBO0FBQzlCLGtCQUFNeUIsc0JBQXNCQyxLQUFLQyxHQUFMLEVBQTVCOztBQUVBLGdCQUFJQyxZQUFZLE1BQU0sT0FBS1gsaUJBQUwsQ0FBdUJsQixJQUF2QixFQUE2QkMsSUFBN0IsQ0FBdEI7O0FBRUEsbUJBQU8sQ0FBQzRCLFNBQUQsSUFBY0YsS0FBS0MsR0FBTCxLQUFhRixtQkFBYixHQUFtQ2xDLGtCQUF4RCxFQUNJcUMsWUFBWSxNQUFNLE9BQUtYLGlCQUFMLENBQXVCbEIsSUFBdkIsRUFBNkJDLElBQTdCLENBQWxCOztBQUVKLGdCQUFJLENBQUM0QixTQUFMLEVBQ0ksTUFBTSxJQUFJQyxLQUFKLENBQVUsbUJBQVYsQ0FBTjs7QUFFSixtQkFBS3pCLE1BQUwsQ0FBWTBCLEVBQVosQ0FBZSxNQUFmLEVBQXVCO0FBQUEsdUJBQVEsT0FBS0MsY0FBTCxDQUFvQkMsSUFBcEIsQ0FBUjtBQUFBLGFBQXZCO0FBWDhCO0FBWWpDOztBQUVLQyxnQkFBTixDQUFvQkMsT0FBcEIsRUFBNkI7QUFBQTs7QUFBQTtBQUN6QixnQkFBSSxDQUFDLE9BQUs5QixNQUFMLENBQVkrQixLQUFaLENBQWtCRCxPQUFsQixDQUFMLEVBQ0ksTUFBTSw4QkFBZSxPQUFLOUIsTUFBcEIsRUFBNEIsT0FBNUIsQ0FBTjtBQUZxQjtBQUc1Qjs7QUFFRDJCLG1CQUFnQkMsSUFBaEIsRUFBc0I7QUFDbEIsWUFBSSxDQUFDQSxJQUFMLEVBQ0k7O0FBRUosYUFBSzFCLE1BQUwsR0FBY0MsT0FBTzZCLE1BQVAsQ0FBYyxDQUFDLEtBQUs5QixNQUFOLEVBQWMwQixJQUFkLENBQWQsQ0FBZDs7QUFFQSxhQUFLOUIsTUFBTCxDQUFZbUMsSUFBWixDQUFpQixVQUFqQjtBQUNIOztBQUVEQyxpQkFBYztBQUFBOztBQUNWLGFBQUs3QixnQkFBTCxHQUF3QixLQUFLQSxnQkFBTCxDQUFzQlksSUFBdEIsaUNBQTJCLGFBQVk7QUFDM0QsZ0JBQUlrQixpQkFBaUIsT0FBS2pDLE1BQUwsQ0FBWWtDLE9BQVosQ0FBb0I5QyxnQkFBcEIsQ0FBckI7O0FBRUEsbUJBQU82QyxpQkFBaUIsQ0FBeEIsRUFBMkI7QUFDdkIsc0JBQU0sOEJBQWUsT0FBS3JDLE1BQXBCLEVBQTRCLFVBQTVCLENBQU47O0FBRUFxQyxpQ0FBaUIsT0FBS2pDLE1BQUwsQ0FBWWtDLE9BQVosQ0FBb0I5QyxnQkFBcEIsQ0FBakI7QUFDSDs7QUFFRCxrQkFBTStDLFNBQVM7QUFDWEMsd0JBQVFDLEdBREc7QUFFWEMsc0JBQVE7QUFGRyxhQUFmOztBQUtBSCxtQkFBT0MsTUFBUCxHQUFnQkcsU0FBUyxPQUFLdkMsTUFBTCxDQUFZd0MsUUFBWixDQUFxQixNQUFyQixFQUE2QixDQUE3QixFQUFnQ1AsY0FBaEMsQ0FBVCxFQUEwRCxFQUExRCxLQUFpRSxDQUFqRjs7QUFFQSxrQkFBTVEsaUJBQWlCUixpQkFBaUI3QyxpQkFBaUJnRCxNQUF6RDtBQUNBLGtCQUFNTSxlQUFpQkQsaUJBQWlCTixPQUFPQyxNQUEvQzs7QUFFQSxnQkFBSUQsT0FBT0MsTUFBWCxFQUFtQjtBQUNmLHVCQUFPLE9BQUtwQyxNQUFMLENBQVlvQyxNQUFaLEdBQXFCTSxZQUE1QixFQUNJLE1BQU0sOEJBQWUsT0FBSzlDLE1BQXBCLEVBQTRCLFVBQTVCLENBQU47O0FBRUp1Qyx1QkFBT0csSUFBUCxHQUFjSyxLQUFLQyxLQUFMLENBQVcsT0FBSzVDLE1BQUwsQ0FBWXdDLFFBQVosQ0FBcUIsTUFBckIsRUFBNkJDLGNBQTdCLEVBQTZDQyxZQUE3QyxDQUFYLENBQWQ7QUFDSDs7QUFFRCxtQkFBSzFDLE1BQUwsR0FBYyxPQUFLQSxNQUFMLENBQVk2QyxLQUFaLENBQWtCSCxZQUFsQixDQUFkOztBQUVBLG1CQUFPUCxNQUFQO0FBQ0gsU0E3QnVCLEVBQXhCOztBQStCQSxlQUFPLEtBQUtoQyxnQkFBWjtBQUNIOztBQUVEMkMsZ0JBQWFDLE9BQWIsRUFBc0I7QUFBQTs7QUFDbEIsYUFBS3pDLGlCQUFMLEdBQXlCLEtBQUtBLGlCQUFMLENBQXVCUyxJQUF2QixpQ0FBNEIsYUFBWTtBQUM3RCxrQkFBTXVCLE9BQWEsQ0FBQyxDQUFELEVBQUksT0FBSzNDLG1CQUFMLEVBQUosRUFBZ0NvRCxRQUFRQyxPQUF4QyxFQUFpREQsUUFBUUUsVUFBekQsQ0FBbkI7QUFDQSxrQkFBTUMsYUFBYSx5QkFBZVosSUFBZixDQUFuQjtBQUNBLGtCQUFNVixVQUFhM0IsT0FBT2tELFVBQVAsQ0FBa0JELFVBQWxCLEVBQThCLE1BQTlCLElBQXdDOUQsZ0JBQXhDLEdBQTJEOEQsVUFBOUU7O0FBRUEsbUJBQUt2QixZQUFMLENBQWtCQyxPQUFsQjtBQUNILFNBTndCLEVBQXpCOztBQVFBLGVBQU8sS0FBS3RCLGlCQUFaO0FBQ0g7O0FBRUQ4QywwQkFBdUJDLEtBQXZCLEVBQThCO0FBQzFCLGNBQU0sSUFBSTlCLEtBQUosQ0FBVyxHQUFFOEIsTUFBTUEsS0FBTSxHQUFFQSxNQUFNekIsT0FBTixHQUFnQixPQUFPeUIsTUFBTXpCLE9BQTdCLEdBQXVDLEVBQUcsRUFBckUsQ0FBTjtBQUNIOztBQUVLMEIsZ0JBQU4sQ0FBb0JuQixNQUFwQixFQUE0QjtBQUFBOztBQUFBO0FBQ3hCLGtCQUFNb0IsZUFBZSxPQUFLNUQsbUJBQTFCOztBQUVBLGtCQUFNLE9BQUttRCxXQUFMLENBQWlCWCxNQUFqQixDQUFOOztBQUVBLGdCQUFJcUIsaUJBQWlCLE1BQU0sT0FBS3hCLFVBQUwsRUFBM0I7O0FBRUEsbUJBQU8sQ0FBQ3dCLGVBQWVsQixJQUFoQixJQUF3QmtCLGVBQWVsQixJQUFmLENBQW9CLENBQXBCLE1BQTJCaUIsWUFBMUQsRUFDSUMsaUJBQWlCLE1BQU0sT0FBS3hCLFVBQUwsRUFBdkI7O0FBRUosZ0JBQUl3QixlQUFlbEIsSUFBZixDQUFvQixDQUFwQixDQUFKLEVBQ0ksT0FBS2MscUJBQUwsQ0FBMkJJLGVBQWVsQixJQUFmLENBQW9CLENBQXBCLENBQTNCOztBQUVKLG1CQUFPa0IsZUFBZWxCLElBQWYsQ0FBb0IsQ0FBcEIsQ0FBUDtBQWJ3QjtBQWMzQjs7QUFFS21CLHlCQUFOLEdBQStCO0FBQUE7O0FBQUE7QUFDM0IsbUJBQU8sTUFBTSxPQUFLSCxZQUFMLENBQWtCLEVBQUVOLFNBQVNVLG1CQUFTQyxjQUFwQixFQUFsQixDQUFiO0FBRDJCO0FBRTlCOztBQUVLL0MsV0FBTixHQUFpQjtBQUFBOztBQUFBO0FBQ2Isa0JBQU0sT0FBS00sY0FBTCxDQUFvQixPQUFLekIsSUFBekIsRUFBK0IsT0FBS0MsSUFBcEMsQ0FBTjs7QUFFQSxrQkFBTWtFLGFBQWEsTUFBTSxPQUFLNUIsVUFBTCxFQUF6Qjs7QUFFQSxtQkFBS3pCLFlBQUwsR0FBb0I7QUFDaEJDLGlDQUFvQm9ELFdBQVd0QixJQUFYLENBQWdCOUIsZUFEcEI7QUFFaEJDLG9DQUFvQm1ELFdBQVd0QixJQUFYLENBQWdCN0I7QUFGcEIsYUFBcEI7O0FBS0EsbUJBQUtDLFdBQUwsR0FBbUIsTUFBTSxPQUFLNEMsWUFBTCxDQUFrQixFQUFFTixTQUFTVSxtQkFBU0csVUFBcEIsRUFBbEIsQ0FBekI7QUFWYTtBQVdoQjs7QUFFREMsY0FBVztBQUNQLGFBQUtoRSxNQUFMLENBQVlpRSxHQUFaO0FBQ0EsYUFBSy9ELE1BQUwsR0FBYyxJQUFkO0FBQ0g7O0FBRUtnRSxpQkFBTixDQUFxQkMsSUFBckIsRUFBMkI7QUFBQTs7QUFBQTtBQUN2QixtQkFBTyxNQUFNLE9BQUtYLFlBQUwsQ0FBa0I7QUFDM0JOLHlCQUFZVSxtQkFBU00sYUFETTtBQUUzQmYsNEJBQVksRUFBRWlCLFFBQVMsV0FBVUQsSUFBSyxLQUExQjtBQUZlLGFBQWxCLENBQWI7QUFEdUI7QUFLMUI7O0FBRUtFLHFCQUFOLEdBQTJCO0FBQUE7O0FBQUE7QUFDdkIsa0JBQU1DLFlBQVksTUFBTSxRQUFLWCxxQkFBTCxFQUF4Qjs7QUFFQSxtQkFBT3hELE9BQU9vRSxJQUFQLENBQVlELFVBQVVFLEtBQXRCLEVBQTZCLFFBQTdCLENBQVA7QUFIdUI7QUFJMUI7O0FBRUtDLGlCQUFOLENBQXFCQyxLQUFyQixFQUE0QkMsTUFBNUIsRUFBb0M7QUFBQTs7QUFBQTtBQUFBLHdCQUNOLE1BQU0sUUFBS1QsYUFBTCxDQUFtQlUsa0RBQW5CLENBREE7O0FBQUEsZ0JBQ25CQyxRQURtQixTQUMxQkwsS0FEMEI7O0FBRWhDLGdCQUFJTSxpQkFBc0IsQ0FBMUI7O0FBRUEsbUJBQU9BLG1CQUFtQnpGLHNCQUFuQixLQUE4Q3dGLFNBQVNILEtBQVQsS0FBbUJBLEtBQW5CLElBQTRCRyxTQUFTRixNQUFULEtBQW9CQSxNQUE5RixDQUFQLEVBQThHO0FBQzFHLHNCQUFNSSxjQUFjLE1BQU0sUUFBS3ZCLFlBQUwsQ0FBa0IsRUFBRU4sU0FBU1UsbUJBQVNvQixhQUFwQixFQUFsQixDQUExQjs7QUFFQSxzQkFBTSxRQUFLeEIsWUFBTCxDQUFrQjtBQUNwQk4sNkJBQVNVLG1CQUFTcUIsYUFERTs7QUFHcEI5QixnQ0FBWTtBQUNSK0IsMkJBQVFILFlBQVlHLENBRFo7QUFFUkMsMkJBQVFKLFlBQVlJLENBRlo7QUFHUlQsK0JBQVFBLFNBQVNLLFlBQVlMLEtBQVosR0FBb0JHLFNBQVNILEtBQXRDLENBSEE7QUFJUkMsZ0NBQVFBLFVBQVVJLFlBQVlKLE1BQVosR0FBcUJFLFNBQVNGLE1BQXhDO0FBSkE7QUFIUSxpQkFBbEIsQ0FBTjs7QUFIMEcsNEJBY25GLE1BQU0sUUFBS1QsYUFBTCxDQUFtQlUsa0RBQW5CLENBZDZFOztBQWNoR0Msd0JBZGdHLFNBY3ZHTCxLQWR1RztBQWU3RztBQW5CK0I7QUFvQm5DOztBQUVLWSxRQUFOLEdBQWM7QUFBQTs7QUFBQTtBQUNWLGtCQUFNLFFBQUs1QixZQUFMLENBQWtCLEVBQUVOLFNBQVNVLG1CQUFTd0IsSUFBcEIsRUFBbEIsQ0FBTjtBQURVO0FBRWI7QUE3TG1DLENBQXhDIiwiZmlsZSI6ImJyb3dzZXIvcHJvdmlkZXIvYnVpbHQtaW4vZGVkaWNhdGVkL2ZpcmVmb3gvbWFyaW9uZXR0ZS1jbGllbnQvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAnbmV0JztcbmltcG9ydCBwcm9taXNpZnlFdmVudCBmcm9tICdwcm9taXNpZnktZXZlbnQnO1xuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IGRlbGF5IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3V0aWxzL2RlbGF5JztcbmltcG9ydCB7IEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCB9IGZyb20gJy4uLy4uLy4uLy4uL3V0aWxzL2NsaWVudC1mdW5jdGlvbnMnO1xuaW1wb3J0IENPTU1BTkRTIGZyb20gJy4vY29tbWFuZHMnO1xuXG5cbmNvbnN0IENPTk5FQ1RJT05fVElNRU9VVCAgICAgPSAzMDAwMDtcbmNvbnN0IENPTk5FQ1RJT05fUkVUUllfREVMQVkgPSAzMDA7XG5jb25zdCBNQVhfUkVTSVpFX1JFVFJZX0NPVU5UID0gMjtcbmNvbnN0IEhFQURFUl9TRVBBUkFUT1IgICAgICAgPSAnOic7XG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgTWFyaW9uZXR0ZUNsaWVudCB7XG4gICAgY29uc3RydWN0b3IgKHBvcnQgPSAyODI4LCBob3N0ID0gJzEyNy4wLjAuMScpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50UGFja2V0TnVtYmVyID0gMTtcbiAgICAgICAgdGhpcy5ldmVudHMgICAgICAgICAgICAgID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgICAgICB0aGlzLnBvcnQgICAgICAgICAgICAgICAgPSBwb3J0O1xuICAgICAgICB0aGlzLmhvc3QgICAgICAgICAgICAgICAgPSBob3N0O1xuICAgICAgICB0aGlzLnNvY2tldCAgICAgICAgICAgICAgPSBuZXcgU29ja2V0KCk7XG4gICAgICAgIHRoaXMuYnVmZmVyICAgICAgICAgICAgICA9IEJ1ZmZlci5hbGxvYygwKTtcbiAgICAgICAgdGhpcy5nZXRQYWNrZXRQcm9taXNlICAgID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuc2VuZFBhY2tldFByb21pc2UgICA9IFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIHRoaXMucHJvdG9jb2xJbmZvID0ge1xuICAgICAgICAgICAgYXBwbGljYXRpb25UeXBlOiAgICAnJyxcbiAgICAgICAgICAgIG1hcmlvbmV0dGVQcm90b2NvbDogJycsXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uSW5mbyA9IG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgX2F0dGVtcHRUb0Nvbm5lY3QgKHBvcnQsIGhvc3QpIHtcbiAgICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdChwb3J0LCBob3N0KTtcblxuICAgICAgICBjb25zdCBjb25uZWN0aW9uUHJvbWlzZSA9IFByb21pc2UucmFjZShbXG4gICAgICAgICAgICBwcm9taXNpZnlFdmVudCh0aGlzLnNvY2tldCwgJ2Nvbm5lY3QnKSxcbiAgICAgICAgICAgIHByb21pc2lmeUV2ZW50KHRoaXMuc29ja2V0LCAnZXJyb3InKVxuICAgICAgICBdKTtcblxuICAgICAgICByZXR1cm4gYXdhaXQgY29ubmVjdGlvblByb21pc2VcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHRydWUpXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc29ja2V0LnJlbW92ZUFsbExpc3RlbmVycygnY29ubmVjdCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBkZWxheShDT05ORUNUSU9OX1JFVFJZX0RFTEFZKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIF9jb25uZWN0U29ja2V0IChwb3J0LCBob3N0KSB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgICAgIGxldCBjb25uZWN0ZWQgPSBhd2FpdCB0aGlzLl9hdHRlbXB0VG9Db25uZWN0KHBvcnQsIGhvc3QpO1xuXG4gICAgICAgIHdoaWxlICghY29ubmVjdGVkICYmIERhdGUubm93KCkgLSBjb25uZWN0aW9uU3RhcnRUaW1lIDwgQ09OTkVDVElPTl9USU1FT1VUKVxuICAgICAgICAgICAgY29ubmVjdGVkID0gYXdhaXQgdGhpcy5fYXR0ZW1wdFRvQ29ubmVjdChwb3J0LCBob3N0KTtcblxuICAgICAgICBpZiAoIWNvbm5lY3RlZClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGNvbm5lY3QnKTtcblxuICAgICAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIGRhdGEgPT4gdGhpcy5faGFuZGxlTmV3RGF0YShkYXRhKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3dyaXRlU29ja2V0IChtZXNzYWdlKSB7XG4gICAgICAgIGlmICghdGhpcy5zb2NrZXQud3JpdGUobWVzc2FnZSkpXG4gICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLnNvY2tldCwgJ2RyYWluJyk7XG4gICAgfVxuXG4gICAgX2hhbmRsZU5ld0RhdGEgKGRhdGEpIHtcbiAgICAgICAgaWYgKCFkYXRhKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuYnVmZmVyID0gQnVmZmVyLmNvbmNhdChbdGhpcy5idWZmZXIsIGRhdGFdKTtcblxuICAgICAgICB0aGlzLmV2ZW50cy5lbWl0KCduZXctZGF0YScpO1xuICAgIH1cblxuICAgIF9nZXRQYWNrZXQgKCkge1xuICAgICAgICB0aGlzLmdldFBhY2tldFByb21pc2UgPSB0aGlzLmdldFBhY2tldFByb21pc2UudGhlbihhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgaGVhZGVyRW5kSW5kZXggPSB0aGlzLmJ1ZmZlci5pbmRleE9mKEhFQURFUl9TRVBBUkFUT1IpO1xuXG4gICAgICAgICAgICB3aGlsZSAoaGVhZGVyRW5kSW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgcHJvbWlzaWZ5RXZlbnQodGhpcy5ldmVudHMsICduZXctZGF0YScpO1xuXG4gICAgICAgICAgICAgICAgaGVhZGVyRW5kSW5kZXggPSB0aGlzLmJ1ZmZlci5pbmRleE9mKEhFQURFUl9TRVBBUkFUT1IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBwYWNrZXQgPSB7XG4gICAgICAgICAgICAgICAgbGVuZ3RoOiBOYU4sXG4gICAgICAgICAgICAgICAgYm9keTogICBudWxsXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBwYWNrZXQubGVuZ3RoID0gcGFyc2VJbnQodGhpcy5idWZmZXIudG9TdHJpbmcoJ3V0ZjgnLCAwLCBoZWFkZXJFbmRJbmRleCksIDEwKSB8fCAwO1xuXG4gICAgICAgICAgICBjb25zdCBib2R5U3RhcnRJbmRleCA9IGhlYWRlckVuZEluZGV4ICsgSEVBREVSX1NFUEFSQVRPUi5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBib2R5RW5kSW5kZXggICA9IGJvZHlTdGFydEluZGV4ICsgcGFja2V0Lmxlbmd0aDtcblxuICAgICAgICAgICAgaWYgKHBhY2tldC5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB3aGlsZSAodGhpcy5idWZmZXIubGVuZ3RoIDwgYm9keUVuZEluZGV4KVxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBwcm9taXNpZnlFdmVudCh0aGlzLmV2ZW50cywgJ25ldy1kYXRhJyk7XG5cbiAgICAgICAgICAgICAgICBwYWNrZXQuYm9keSA9IEpTT04ucGFyc2UodGhpcy5idWZmZXIudG9TdHJpbmcoJ3V0ZjgnLCBib2R5U3RhcnRJbmRleCwgYm9keUVuZEluZGV4KSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuYnVmZmVyID0gdGhpcy5idWZmZXIuc2xpY2UoYm9keUVuZEluZGV4KTtcblxuICAgICAgICAgICAgcmV0dXJuIHBhY2tldDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFja2V0UHJvbWlzZTtcbiAgICB9XG5cbiAgICBfc2VuZFBhY2tldCAocGF5bG9hZCkge1xuICAgICAgICB0aGlzLnNlbmRQYWNrZXRQcm9taXNlID0gdGhpcy5zZW5kUGFja2V0UHJvbWlzZS50aGVuKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGJvZHkgICAgICAgPSBbMCwgdGhpcy5jdXJyZW50UGFja2V0TnVtYmVyKyssIHBheWxvYWQuY29tbWFuZCwgcGF5bG9hZC5wYXJhbWV0ZXJzXTtcbiAgICAgICAgICAgIGNvbnN0IHNlcmlhbGl6ZWQgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgICAgPSBCdWZmZXIuYnl0ZUxlbmd0aChzZXJpYWxpemVkLCAndXRmOCcpICsgSEVBREVSX1NFUEFSQVRPUiArIHNlcmlhbGl6ZWQ7XG5cbiAgICAgICAgICAgIHRoaXMuX3dyaXRlU29ja2V0KG1lc3NhZ2UpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5zZW5kUGFja2V0UHJvbWlzZTtcbiAgICB9XG5cbiAgICBfdGhyb3dNYXJpb25ldHRlRXJyb3IgKGVycm9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtlcnJvci5lcnJvcn0ke2Vycm9yLm1lc3NhZ2UgPyAnOiAnICsgZXJyb3IubWVzc2FnZSA6ICcnfWApO1xuICAgIH1cblxuICAgIGFzeW5jIF9nZXRSZXNwb25zZSAocGFja2V0KSB7XG4gICAgICAgIGNvbnN0IHBhY2tldE51bWJlciA9IHRoaXMuY3VycmVudFBhY2tldE51bWJlcjtcblxuICAgICAgICBhd2FpdCB0aGlzLl9zZW5kUGFja2V0KHBhY2tldCk7XG5cbiAgICAgICAgbGV0IHJlc3BvbnNlUGFja2V0ID0gYXdhaXQgdGhpcy5fZ2V0UGFja2V0KCk7XG5cbiAgICAgICAgd2hpbGUgKCFyZXNwb25zZVBhY2tldC5ib2R5IHx8IHJlc3BvbnNlUGFja2V0LmJvZHlbMV0gIT09IHBhY2tldE51bWJlcilcbiAgICAgICAgICAgIHJlc3BvbnNlUGFja2V0ID0gYXdhaXQgdGhpcy5fZ2V0UGFja2V0KCk7XG5cbiAgICAgICAgaWYgKHJlc3BvbnNlUGFja2V0LmJvZHlbMl0pXG4gICAgICAgICAgICB0aGlzLl90aHJvd01hcmlvbmV0dGVFcnJvcihyZXNwb25zZVBhY2tldC5ib2R5WzJdKTtcblxuICAgICAgICByZXR1cm4gcmVzcG9uc2VQYWNrZXQuYm9keVszXTtcbiAgICB9XG5cbiAgICBhc3luYyBfZ2V0U2NyZWVuc2hvdFJhd0RhdGEgKCkge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiBDT01NQU5EUy50YWtlU2NyZWVuc2hvdCB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjb25uZWN0ICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fY29ubmVjdFNvY2tldCh0aGlzLnBvcnQsIHRoaXMuaG9zdCk7XG5cbiAgICAgICAgY29uc3QgaW5mb1BhY2tldCA9IGF3YWl0IHRoaXMuX2dldFBhY2tldCgpO1xuXG4gICAgICAgIHRoaXMucHJvdG9jb2xJbmZvID0ge1xuICAgICAgICAgICAgYXBwbGljYXRpb25UeXBlOiAgICBpbmZvUGFja2V0LmJvZHkuYXBwbGljYXRpb25UeXBlLFxuICAgICAgICAgICAgbWFyaW9uZXR0ZVByb3RvY29sOiBpbmZvUGFja2V0LmJvZHkubWFyaW9uZXR0ZVByb3RvY29sXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uSW5mbyA9IGF3YWl0IHRoaXMuX2dldFJlc3BvbnNlKHsgY29tbWFuZDogQ09NTUFORFMubmV3U2Vzc2lvbiB9KTtcbiAgICB9XG5cbiAgICBkaXNwb3NlICgpIHtcbiAgICAgICAgdGhpcy5zb2NrZXQuZW5kKCk7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gbnVsbDtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlU2NyaXB0IChjb2RlKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7XG4gICAgICAgICAgICBjb21tYW5kOiAgICBDT01NQU5EUy5leGVjdXRlU2NyaXB0LFxuICAgICAgICAgICAgcGFyYW1ldGVyczogeyBzY3JpcHQ6IGByZXR1cm4gKCR7Y29kZX0pKClgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0U2NyZWVuc2hvdERhdGEgKCkge1xuICAgICAgICBjb25zdCBmcmFtZURhdGEgPSBhd2FpdCB0aGlzLl9nZXRTY3JlZW5zaG90UmF3RGF0YSgpO1xuXG4gICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShmcmFtZURhdGEudmFsdWUsICdiYXNlNjQnKTtcbiAgICB9XG5cbiAgICBhc3luYyBzZXRXaW5kb3dTaXplICh3aWR0aCwgaGVpZ2h0KSB7XG4gICAgICAgIGxldCB7IHZhbHVlOiBwYWdlUmVjdCB9ID0gYXdhaXQgdGhpcy5leGVjdXRlU2NyaXB0KEdFVF9XSU5ET1dfRElNRU5TSU9OU19JTkZPX1NDUklQVCk7XG4gICAgICAgIGxldCBhdHRlbXB0Q291bnRlciAgICAgID0gMDtcblxuICAgICAgICB3aGlsZSAoYXR0ZW1wdENvdW50ZXIrKyA8IE1BWF9SRVNJWkVfUkVUUllfQ09VTlQgJiYgKHBhZ2VSZWN0LndpZHRoICE9PSB3aWR0aCB8fCBwYWdlUmVjdC5oZWlnaHQgIT09IGhlaWdodCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSZWN0ID0gYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiBDT01NQU5EUy5nZXRXaW5kb3dSZWN0IH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9nZXRSZXNwb25zZSh7XG4gICAgICAgICAgICAgICAgY29tbWFuZDogQ09NTUFORFMuc2V0V2luZG93UmVjdCxcblxuICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgeDogICAgICBjdXJyZW50UmVjdC54LFxuICAgICAgICAgICAgICAgICAgICB5OiAgICAgIGN1cnJlbnRSZWN0LnksXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiAgd2lkdGggKyAoY3VycmVudFJlY3Qud2lkdGggLSBwYWdlUmVjdC53aWR0aCksXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0ICsgKGN1cnJlbnRSZWN0LmhlaWdodCAtIHBhZ2VSZWN0LmhlaWdodClcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgKHsgdmFsdWU6IHBhZ2VSZWN0IH0gPSBhd2FpdCB0aGlzLmV4ZWN1dGVTY3JpcHQoR0VUX1dJTkRPV19ESU1FTlNJT05TX0lORk9fU0NSSVBUKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBxdWl0ICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fZ2V0UmVzcG9uc2UoeyBjb21tYW5kOiBDT01NQU5EUy5xdWl0IH0pO1xuICAgIH1cbn07XG5cbiJdfQ==
