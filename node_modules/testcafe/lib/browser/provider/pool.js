'use strict';

exports.__esModule = true;

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _builtIn = require('./built-in');

var _builtIn2 = _interopRequireDefault(_builtIn);

var _pluginHost = require('./plugin-host');

var _pluginHost2 = _interopRequireDefault(_pluginHost);

var _parseProviderName = require('./parse-provider-name');

var _parseProviderName2 = _interopRequireDefault(_parseProviderName);

var _ = require('./');

var _2 = _interopRequireDefault(_);

var _connection = require('../connection');

var _connection2 = _interopRequireDefault(_connection);

var _runtime = require('../../errors/runtime');

var _types = require('../../errors/types');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BROWSER_PROVIDER_RE = /^([^:\s]+):?(.*)?$/;

exports.default = {
    providersCache: {},

    _handlePathAndCmd(alias) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const browserName = (0, _stringify2.default)(alias);
            const providerName = 'path';
            const provider = yield _this.getProvider(providerName);

            return { provider, providerName, browserName };
        })();
    },

    _parseAliasString(alias) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const providerRegExpMatch = BROWSER_PROVIDER_RE.exec(alias);

            if (!providerRegExpMatch) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotFindBrowser, alias);

            let providerName = providerRegExpMatch[1];
            let browserName = providerRegExpMatch[2] || '';

            let provider = yield _this2.getProvider(providerName);

            if (!provider && providerRegExpMatch[2]) provider = yield _this2.getProvider(providerName + ':');

            if (!provider) {
                providerName = 'locally-installed';
                provider = yield _this2.getProvider(providerName);
                browserName = providerRegExpMatch[1] || '';
            }

            return { provider, providerName, browserName };
        })();
    },

    _parseAlias(alias) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (alias.browserName && alias.providerName && alias.provider) return alias;

            if (alias && alias.path) return _this3._handlePathAndCmd(alias);

            if (typeof alias === 'string') return _this3._parseAliasString(alias);

            throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotFindBrowser, alias);
        })();
    },

    _getInfoForAllBrowserNames(provider, providerName) {
        return (0, _asyncToGenerator3.default)(function* () {
            const allBrowserNames = provider.isMultiBrowser ? yield provider.getBrowserList() : [];

            if (!allBrowserNames.length) return { provider, providerName, browserName: '' };

            return allBrowserNames.map(function (browserName) {
                return { provider, providerName, browserName };
            });
        })();
    },

    _getProviderModule(providerName, moduleName) {
        try {
            const providerObject = require(moduleName);

            this.addProvider(providerName, providerObject);
            return this._getProviderFromCache(providerName);
        } catch (e) {
            return null;
        }
    },

    _getProviderFromCache(providerName) {
        return this.providersCache[providerName] || null;
    },

    _getBuiltinProvider(providerName) {
        const providerObject = _builtIn2.default[providerName];

        if (!providerObject) return null;

        this.addProvider(providerName, providerObject);

        return this._getProviderFromCache(providerName);
    },

    getBrowserInfo(alias) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (alias instanceof _connection2.default) return alias;

            const browserInfo = yield _this4._parseAlias(alias);

            const provider = browserInfo.provider,
                  providerName = browserInfo.providerName,
                  browserName = browserInfo.browserName;


            if (browserName === 'all') return yield _this4._getInfoForAllBrowserNames(provider, providerName);

            if (!(yield provider.isValidBrowserName(browserName))) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotFindBrowser, alias);

            return (0, _extends3.default)({ alias }, browserInfo);
        })();
    },

    addProvider(providerName, providerObject) {
        providerName = (0, _parseProviderName2.default)(providerName).providerName;

        this.providersCache[providerName] = new _2.default(new _pluginHost2.default(providerObject, providerName));
    },

    removeProvider(providerName) {
        providerName = (0, _parseProviderName2.default)(providerName).providerName;

        delete this.providersCache[providerName];
    },

    getProvider(providerName) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const parsedProviderName = (0, _parseProviderName2.default)(providerName);
            const moduleName = parsedProviderName.moduleName;

            providerName = parsedProviderName.providerName;

            const provider = _this5._getProviderFromCache(providerName) || _this5._getProviderModule(providerName, moduleName) || _this5._getBuiltinProvider(providerName);

            if (provider) yield _this5.providersCache[providerName].init();

            return provider;
        })();
    },

    dispose() {
        return _pinkie2.default.all((0, _values2.default)(this.providersCache).map(item => item.dispose()));
    }
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL3Byb3ZpZGVyL3Bvb2wuanMiXSwibmFtZXMiOlsiQlJPV1NFUl9QUk9WSURFUl9SRSIsInByb3ZpZGVyc0NhY2hlIiwiX2hhbmRsZVBhdGhBbmRDbWQiLCJhbGlhcyIsImJyb3dzZXJOYW1lIiwicHJvdmlkZXJOYW1lIiwicHJvdmlkZXIiLCJnZXRQcm92aWRlciIsIl9wYXJzZUFsaWFzU3RyaW5nIiwicHJvdmlkZXJSZWdFeHBNYXRjaCIsImV4ZWMiLCJHZW5lcmFsRXJyb3IiLCJSVU5USU1FX0VSUk9SUyIsImNhbm5vdEZpbmRCcm93c2VyIiwiX3BhcnNlQWxpYXMiLCJwYXRoIiwiX2dldEluZm9Gb3JBbGxCcm93c2VyTmFtZXMiLCJhbGxCcm93c2VyTmFtZXMiLCJpc011bHRpQnJvd3NlciIsImdldEJyb3dzZXJMaXN0IiwibGVuZ3RoIiwibWFwIiwiX2dldFByb3ZpZGVyTW9kdWxlIiwibW9kdWxlTmFtZSIsInByb3ZpZGVyT2JqZWN0IiwicmVxdWlyZSIsImFkZFByb3ZpZGVyIiwiX2dldFByb3ZpZGVyRnJvbUNhY2hlIiwiZSIsIl9nZXRCdWlsdGluUHJvdmlkZXIiLCJCVUlMVF9JTl9QUk9WSURFUlMiLCJnZXRCcm93c2VySW5mbyIsIkJyb3dzZXJDb25uZWN0aW9uIiwiYnJvd3NlckluZm8iLCJpc1ZhbGlkQnJvd3Nlck5hbWUiLCJCcm93c2VyUHJvdmlkZXIiLCJCcm93c2VyUHJvdmlkZXJQbHVnaW5Ib3N0IiwicmVtb3ZlUHJvdmlkZXIiLCJwYXJzZWRQcm92aWRlck5hbWUiLCJpbml0IiwiZGlzcG9zZSIsIlByb21pc2UiLCJhbGwiLCJpdGVtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsc0JBQXNCLG9CQUE1Qjs7a0JBRWU7QUFDWEMsb0JBQWdCLEVBREw7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QkksWUFBcEIsSUFBb0MsSUFBSThCLFVBQUosQ0FDaEMsSUFBSUMsb0JBQUosQ0FBOEJaLGNBQTlCLEVBQThDbkIsWUFBOUMsQ0FEZ0MsQ0FBcEM7QUFHSCxLQTdHVTs7QUErR1hnQyxtQkFBZ0JoQyxZQUFoQixFQUE4QjtBQUMxQkEsdUJBQWUsaUNBQWtCQSxZQUFsQixFQUFnQ0EsWUFBL0M7O0FBRUEsZUFBTyxLQUFLSixjQUFMLENBQW9CSSxZQUFwQixDQUFQO0FBQ0gsS0FuSFU7O0FBcUhMRSxlQUFOLENBQW1CRixZQUFuQixFQUFpQztBQUFBOztBQUFBO0FBQzdCLGtCQUFNaUMscUJBQXFCLGlDQUFrQmpDLFlBQWxCLENBQTNCO0FBQ0Esa0JBQU1rQixhQUFxQmUsbUJBQW1CZixVQUE5Qzs7QUFFQWxCLDJCQUFlaUMsbUJBQW1CakMsWUFBbEM7O0FBRUEsa0JBQU1DLFdBQVcsT0FBS3FCLHFCQUFMLENBQTJCdEIsWUFBM0IsS0FDRixPQUFLaUIsa0JBQUwsQ0FBd0JqQixZQUF4QixFQUFzQ2tCLFVBQXRDLENBREUsSUFFRixPQUFLTSxtQkFBTCxDQUF5QnhCLFlBQXpCLENBRmY7O0FBSUEsZ0JBQUlDLFFBQUosRUFDSSxNQUFNLE9BQUtMLGNBQUwsQ0FBb0JJLFlBQXBCLEVBQWtDa0MsSUFBbEMsRUFBTjs7QUFFSixtQkFBT2pDLFFBQVA7QUFiNkI7QUFjaEMsS0FuSVU7O0FBcUlYa0MsY0FBVztBQUNQLGVBQU9DLGlCQUFRQyxHQUFSLENBQVksc0JBQWMsS0FBS3pDLGNBQW5CLEVBQW1Db0IsR0FBbkMsQ0FBdUNzQixRQUFRQSxLQUFLSCxPQUFMLEVBQS9DLENBQVosQ0FBUDtBQUNIO0FBdklVLEMiLCJmaWxlIjoiYnJvd3Nlci9wcm92aWRlci9wb29sLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCBCVUlMVF9JTl9QUk9WSURFUlMgZnJvbSAnLi9idWlsdC1pbic7XG5pbXBvcnQgQnJvd3NlclByb3ZpZGVyUGx1Z2luSG9zdCBmcm9tICcuL3BsdWdpbi1ob3N0JztcbmltcG9ydCBwYXJzZVByb3ZpZGVyTmFtZSBmcm9tICcuL3BhcnNlLXByb3ZpZGVyLW5hbWUnO1xuaW1wb3J0IEJyb3dzZXJQcm92aWRlciBmcm9tICcuLyc7XG5pbXBvcnQgQnJvd3NlckNvbm5lY3Rpb24gZnJvbSAnLi4vY29ubmVjdGlvbic7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBSVU5USU1FX0VSUk9SUyB9IGZyb20gJy4uLy4uL2Vycm9ycy90eXBlcyc7XG5cbmNvbnN0IEJST1dTRVJfUFJPVklERVJfUkUgPSAvXihbXjpcXHNdKyk6PyguKik/JC87XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgICBwcm92aWRlcnNDYWNoZToge30sXG5cbiAgICBhc3luYyBfaGFuZGxlUGF0aEFuZENtZCAoYWxpYXMpIHtcbiAgICAgICAgY29uc3QgYnJvd3Nlck5hbWUgID0gSlNPTi5zdHJpbmdpZnkoYWxpYXMpO1xuICAgICAgICBjb25zdCBwcm92aWRlck5hbWUgPSAncGF0aCc7XG4gICAgICAgIGNvbnN0IHByb3ZpZGVyICAgICA9IGF3YWl0IHRoaXMuZ2V0UHJvdmlkZXIocHJvdmlkZXJOYW1lKTtcblxuICAgICAgICByZXR1cm4geyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSB9O1xuICAgIH0sXG5cbiAgICBhc3luYyBfcGFyc2VBbGlhc1N0cmluZyAoYWxpYXMpIHtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJSZWdFeHBNYXRjaCA9IEJST1dTRVJfUFJPVklERVJfUkUuZXhlYyhhbGlhcyk7XG5cbiAgICAgICAgaWYgKCFwcm92aWRlclJlZ0V4cE1hdGNoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5jYW5ub3RGaW5kQnJvd3NlciwgYWxpYXMpO1xuXG4gICAgICAgIGxldCBwcm92aWRlck5hbWUgPSBwcm92aWRlclJlZ0V4cE1hdGNoWzFdO1xuICAgICAgICBsZXQgYnJvd3Nlck5hbWUgID0gcHJvdmlkZXJSZWdFeHBNYXRjaFsyXSB8fCAnJztcblxuICAgICAgICBsZXQgcHJvdmlkZXIgPSBhd2FpdCB0aGlzLmdldFByb3ZpZGVyKHByb3ZpZGVyTmFtZSk7XG5cbiAgICAgICAgaWYgKCFwcm92aWRlciAmJiBwcm92aWRlclJlZ0V4cE1hdGNoWzJdKVxuICAgICAgICAgICAgcHJvdmlkZXIgPSBhd2FpdCB0aGlzLmdldFByb3ZpZGVyKHByb3ZpZGVyTmFtZSArICc6Jyk7XG5cbiAgICAgICAgaWYgKCFwcm92aWRlcikge1xuICAgICAgICAgICAgcHJvdmlkZXJOYW1lID0gJ2xvY2FsbHktaW5zdGFsbGVkJztcbiAgICAgICAgICAgIHByb3ZpZGVyICAgICA9IGF3YWl0IHRoaXMuZ2V0UHJvdmlkZXIocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgICAgIGJyb3dzZXJOYW1lICA9IHByb3ZpZGVyUmVnRXhwTWF0Y2hbMV0gfHwgJyc7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4geyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSB9O1xuICAgIH0sXG5cbiAgICBhc3luYyBfcGFyc2VBbGlhcyAoYWxpYXMpIHtcbiAgICAgICAgaWYgKGFsaWFzLmJyb3dzZXJOYW1lICYmIGFsaWFzLnByb3ZpZGVyTmFtZSAmJiBhbGlhcy5wcm92aWRlcilcbiAgICAgICAgICAgIHJldHVybiBhbGlhcztcblxuICAgICAgICBpZiAoYWxpYXMgJiYgYWxpYXMucGF0aClcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVQYXRoQW5kQ21kKGFsaWFzKTtcblxuICAgICAgICBpZiAodHlwZW9mIGFsaWFzID09PSAnc3RyaW5nJylcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9wYXJzZUFsaWFzU3RyaW5nKGFsaWFzKTtcblxuICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNhbm5vdEZpbmRCcm93c2VyLCBhbGlhcyk7XG4gICAgfSxcblxuICAgIGFzeW5jIF9nZXRJbmZvRm9yQWxsQnJvd3Nlck5hbWVzIChwcm92aWRlciwgcHJvdmlkZXJOYW1lKSB7XG4gICAgICAgIGNvbnN0IGFsbEJyb3dzZXJOYW1lcyA9IHByb3ZpZGVyLmlzTXVsdGlCcm93c2VyID9cbiAgICAgICAgICAgIGF3YWl0IHByb3ZpZGVyLmdldEJyb3dzZXJMaXN0KCkgOlxuICAgICAgICAgICAgW107XG5cbiAgICAgICAgaWYgKCFhbGxCcm93c2VyTmFtZXMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuIHsgcHJvdmlkZXIsIHByb3ZpZGVyTmFtZSwgYnJvd3Nlck5hbWU6ICcnIH07XG5cbiAgICAgICAgcmV0dXJuIGFsbEJyb3dzZXJOYW1lc1xuICAgICAgICAgICAgLm1hcChicm93c2VyTmFtZSA9PiAoeyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSB9KSk7XG4gICAgfSxcblxuICAgIF9nZXRQcm92aWRlck1vZHVsZSAocHJvdmlkZXJOYW1lLCBtb2R1bGVOYW1lKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBwcm92aWRlck9iamVjdCA9IHJlcXVpcmUobW9kdWxlTmFtZSk7XG5cbiAgICAgICAgICAgIHRoaXMuYWRkUHJvdmlkZXIocHJvdmlkZXJOYW1lLCBwcm92aWRlck9iamVjdCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fZ2V0UHJvdmlkZXJGcm9tQ2FjaGUocHJvdmlkZXJOYW1lKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgX2dldFByb3ZpZGVyRnJvbUNhY2hlIChwcm92aWRlck5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXJzQ2FjaGVbcHJvdmlkZXJOYW1lXSB8fCBudWxsO1xuICAgIH0sXG5cbiAgICBfZ2V0QnVpbHRpblByb3ZpZGVyIChwcm92aWRlck5hbWUpIHtcbiAgICAgICAgY29uc3QgcHJvdmlkZXJPYmplY3QgPSBCVUlMVF9JTl9QUk9WSURFUlNbcHJvdmlkZXJOYW1lXTtcblxuICAgICAgICBpZiAoIXByb3ZpZGVyT2JqZWN0KVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgdGhpcy5hZGRQcm92aWRlcihwcm92aWRlck5hbWUsIHByb3ZpZGVyT2JqZWN0KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0UHJvdmlkZXJGcm9tQ2FjaGUocHJvdmlkZXJOYW1lKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZ2V0QnJvd3NlckluZm8gKGFsaWFzKSB7XG4gICAgICAgIGlmIChhbGlhcyBpbnN0YW5jZW9mIEJyb3dzZXJDb25uZWN0aW9uKVxuICAgICAgICAgICAgcmV0dXJuIGFsaWFzO1xuXG4gICAgICAgIGNvbnN0IGJyb3dzZXJJbmZvID0gYXdhaXQgdGhpcy5fcGFyc2VBbGlhcyhhbGlhcyk7XG5cbiAgICAgICAgY29uc3QgeyBwcm92aWRlciwgcHJvdmlkZXJOYW1lLCBicm93c2VyTmFtZSB9ID0gYnJvd3NlckluZm87XG5cbiAgICAgICAgaWYgKGJyb3dzZXJOYW1lID09PSAnYWxsJylcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXRJbmZvRm9yQWxsQnJvd3Nlck5hbWVzKHByb3ZpZGVyLCBwcm92aWRlck5hbWUpO1xuXG4gICAgICAgIGlmICghYXdhaXQgcHJvdmlkZXIuaXNWYWxpZEJyb3dzZXJOYW1lKGJyb3dzZXJOYW1lKSlcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2Fubm90RmluZEJyb3dzZXIsIGFsaWFzKTtcblxuICAgICAgICByZXR1cm4geyBhbGlhcywgLi4uYnJvd3NlckluZm8gfTtcbiAgICB9LFxuXG4gICAgYWRkUHJvdmlkZXIgKHByb3ZpZGVyTmFtZSwgcHJvdmlkZXJPYmplY3QpIHtcbiAgICAgICAgcHJvdmlkZXJOYW1lID0gcGFyc2VQcm92aWRlck5hbWUocHJvdmlkZXJOYW1lKS5wcm92aWRlck5hbWU7XG5cbiAgICAgICAgdGhpcy5wcm92aWRlcnNDYWNoZVtwcm92aWRlck5hbWVdID0gbmV3IEJyb3dzZXJQcm92aWRlcihcbiAgICAgICAgICAgIG5ldyBCcm93c2VyUHJvdmlkZXJQbHVnaW5Ib3N0KHByb3ZpZGVyT2JqZWN0LCBwcm92aWRlck5hbWUpXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIHJlbW92ZVByb3ZpZGVyIChwcm92aWRlck5hbWUpIHtcbiAgICAgICAgcHJvdmlkZXJOYW1lID0gcGFyc2VQcm92aWRlck5hbWUocHJvdmlkZXJOYW1lKS5wcm92aWRlck5hbWU7XG5cbiAgICAgICAgZGVsZXRlIHRoaXMucHJvdmlkZXJzQ2FjaGVbcHJvdmlkZXJOYW1lXTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZ2V0UHJvdmlkZXIgKHByb3ZpZGVyTmFtZSkge1xuICAgICAgICBjb25zdCBwYXJzZWRQcm92aWRlck5hbWUgPSBwYXJzZVByb3ZpZGVyTmFtZShwcm92aWRlck5hbWUpO1xuICAgICAgICBjb25zdCBtb2R1bGVOYW1lICAgICAgICAgPSBwYXJzZWRQcm92aWRlck5hbWUubW9kdWxlTmFtZTtcblxuICAgICAgICBwcm92aWRlck5hbWUgPSBwYXJzZWRQcm92aWRlck5hbWUucHJvdmlkZXJOYW1lO1xuXG4gICAgICAgIGNvbnN0IHByb3ZpZGVyID0gdGhpcy5fZ2V0UHJvdmlkZXJGcm9tQ2FjaGUocHJvdmlkZXJOYW1lKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRQcm92aWRlck1vZHVsZShwcm92aWRlck5hbWUsIG1vZHVsZU5hbWUpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldEJ1aWx0aW5Qcm92aWRlcihwcm92aWRlck5hbWUpO1xuXG4gICAgICAgIGlmIChwcm92aWRlcilcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXJzQ2FjaGVbcHJvdmlkZXJOYW1lXS5pbml0KCk7XG5cbiAgICAgICAgcmV0dXJuIHByb3ZpZGVyO1xuICAgIH0sXG5cbiAgICBkaXNwb3NlICgpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKE9iamVjdC52YWx1ZXModGhpcy5wcm92aWRlcnNDYWNoZSkubWFwKGl0ZW0gPT4gaXRlbS5kaXNwb3NlKCkpKTtcbiAgICB9XG59O1xuIl19
