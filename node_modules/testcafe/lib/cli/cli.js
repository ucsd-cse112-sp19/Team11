'use strict';

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let runTests = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (argParser) {
        const opts = argParser.opts;
        const port1 = opts.ports && opts.ports[0];
        const port2 = opts.ports && opts.ports[1];
        const proxy = opts.proxy;
        const proxyBypass = opts.proxyBypass;

        _log2.default.showSpinner();

        const testCafe = yield (0, _2.default)(opts.hostname, port1, port2, opts.ssl, opts.dev);

        const correctedBrowsersAndSources = yield (0, _correctBrowsersAndSources2.default)(argParser, testCafe.configuration);
        const automatedBrowsers = correctedBrowsersAndSources.browsers;
        const remoteBrowsers = yield (0, _remotesWizard2.default)(testCafe, argParser.remoteCount, opts.qrCode);
        const browsers = automatedBrowsers.concat(remoteBrowsers);
        const sources = correctedBrowsersAndSources.sources;

        const runner = opts.live ? testCafe.createLiveModeRunner() : testCafe.createRunner();

        let failed = 0;

        runner.isCli = true;

        runner.useProxy(proxy, proxyBypass).src(sources).browsers(browsers).reporter(argParser.opts.reporter).concurrency(argParser.opts.concurrency).filter(argParser.filter).video(opts.video, opts.videoOptions, opts.videoEncodingOptions).screenshots(opts.screenshots, opts.screenshotsOnFails, opts.screenshotPathPattern).startApp(opts.app, opts.appInitDelay);

        runner.once('done-bootstrapping', function () {
            return _log2.default.hideSpinner();
        });

        try {
            failed = yield runner.run(opts);

            if (shouldShowMarketingMessage(runner.reporterPlugings)) yield marketing.showMessageWithLinkToTestCafeStudio();
        } finally {
            showMessageOnExit = false;
            yield testCafe.close();
        }

        exit(failed);
    });

    return function runTests(_x) {
        return _ref.apply(this, arguments);
    };
})();

let listBrowsers = (() => {
    var _ref2 = (0, _asyncToGenerator3.default)(function* (providerName = 'locally-installed') {
        const provider = yield browserProviderPool.getProvider(providerName);

        if (!provider) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.browserProviderNotFound, providerName);

        if (provider.isMultiBrowser) {
            const browserNames = yield provider.getBrowserList();

            yield browserProviderPool.dispose();

            if (providerName === 'locally-installed') console.log(browserNames.join('\n'));else console.log(browserNames.map(function (browserName) {
                return `"${providerName}:${browserName}"`;
            }).join('\n'));
        } else console.log(`"${providerName}"`);

        exit(0);
    });

    return function listBrowsers() {
        return _ref2.apply(this, arguments);
    };
})();

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _runtime = require('../errors/runtime');

var _types = require('../errors/types');

var _argumentParser = require('./argument-parser');

var _argumentParser2 = _interopRequireDefault(_argumentParser);

var _terminationHandler = require('./termination-handler');

var _terminationHandler2 = _interopRequireDefault(_terminationHandler);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

var _remotesWizard = require('./remotes-wizard');

var _remotesWizard2 = _interopRequireDefault(_remotesWizard);

var _correctBrowsersAndSources = require('./correct-browsers-and-sources');

var _correctBrowsersAndSources2 = _interopRequireDefault(_correctBrowsersAndSources);

var _ = require('../');

var _2 = _interopRequireDefault(_);

var _marketing = require('../marketing');

var marketing = _interopRequireWildcard(_marketing);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// NOTE: Load the provider pool lazily to reduce startup time
const lazyRequire = require('import-lazy')(require);
const browserProviderPool = lazyRequire('../browser/provider/pool');

const NOT_PARSABLE_REPORTERS = ['spec', 'list', 'minimal'];

let showMessageOnExit = true;
let exitMessageShown = false;
let exiting = false;

function exitHandler(terminationLevel) {
    if (showMessageOnExit && !exitMessageShown) {
        exitMessageShown = true;

        _log2.default.write('Stopping TestCafe...');

        process.on('exit', () => _log2.default.hideSpinner(true));
    }

    if (exiting || terminationLevel < 2) return;

    exiting = true;

    exit(0);
}

function exit(code) {
    _log2.default.hideSpinner(true);

    // NOTE: give a process time to flush the output.
    // It's necessary in some environments.
    setTimeout(() => process.exit(code), 0);
}

function error(err) {
    _log2.default.hideSpinner();

    let message = null;

    if (err instanceof _runtime.GeneralError) message = err.message;else if (err instanceof _runtime.APIError) message = err.coloredStack;else message = err.stack;

    _log2.default.write(_chalk2.default.red('ERROR ') + message + '\n');
    _log2.default.write(_chalk2.default.gray('Type "testcafe -h" for help.'));

    exit(1);
}

function shouldShowMarketingMessage(reporterPlugings) {
    const stdoutReporterPlugin = reporterPlugings.find(plugin => plugin.outStream === process.stdout || !plugin.outStream);

    return stdoutReporterPlugin && NOT_PARSABLE_REPORTERS.includes(stdoutReporterPlugin.plugin.name);
}

(() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* () {
        const terminationHandler = new _terminationHandler2.default();

        terminationHandler.on(_terminationHandler2.default.TERMINATION_LEVEL_INCREASED_EVENT, exitHandler);

        try {
            const argParser = new _argumentParser2.default();

            yield argParser.parse(process.argv);

            if (argParser.opts.listBrowsers) yield listBrowsers(argParser.opts.providerName);else yield runTests(argParser);
        } catch (err) {
            showMessageOnExit = false;
            error(err);
        }
    });

    function cli() {
        return _ref3.apply(this, arguments);
    }

    return cli;
})()();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvY2xpLmpzIl0sIm5hbWVzIjpbImFyZ1BhcnNlciIsIm9wdHMiLCJwb3J0MSIsInBvcnRzIiwicG9ydDIiLCJwcm94eSIsInByb3h5QnlwYXNzIiwibG9nIiwic2hvd1NwaW5uZXIiLCJ0ZXN0Q2FmZSIsImhvc3RuYW1lIiwic3NsIiwiZGV2IiwiY29ycmVjdGVkQnJvd3NlcnNBbmRTb3VyY2VzIiwiY29uZmlndXJhdGlvbiIsImF1dG9tYXRlZEJyb3dzZXJzIiwiYnJvd3NlcnMiLCJyZW1vdGVCcm93c2VycyIsInJlbW90ZUNvdW50IiwicXJDb2RlIiwiY29uY2F0Iiwic291cmNlcyIsInJ1bm5lciIsImxpdmUiLCJjcmVhdGVMaXZlTW9kZVJ1bm5lciIsImNyZWF0ZVJ1bm5lciIsImZhaWxlZCIsImlzQ2xpIiwidXNlUHJveHkiLCJzcmMiLCJyZXBvcnRlciIsImNvbmN1cnJlbmN5IiwiZmlsdGVyIiwidmlkZW8iLCJ2aWRlb09wdGlvbnMiLCJ2aWRlb0VuY29kaW5nT3B0aW9ucyIsInNjcmVlbnNob3RzIiwic2NyZWVuc2hvdHNPbkZhaWxzIiwic2NyZWVuc2hvdFBhdGhQYXR0ZXJuIiwic3RhcnRBcHAiLCJhcHAiLCJhcHBJbml0RGVsYXkiLCJvbmNlIiwiaGlkZVNwaW5uZXIiLCJydW4iLCJzaG91bGRTaG93TWFya2V0aW5nTWVzc2FnZSIsInJlcG9ydGVyUGx1Z2luZ3MiLCJtYXJrZXRpbmciLCJzaG93TWVzc2FnZVdpdGhMaW5rVG9UZXN0Q2FmZVN0dWRpbyIsInNob3dNZXNzYWdlT25FeGl0IiwiY2xvc2UiLCJleGl0IiwicnVuVGVzdHMiLCJwcm92aWRlck5hbWUiLCJwcm92aWRlciIsImJyb3dzZXJQcm92aWRlclBvb2wiLCJnZXRQcm92aWRlciIsIkdlbmVyYWxFcnJvciIsIlJVTlRJTUVfRVJST1JTIiwiYnJvd3NlclByb3ZpZGVyTm90Rm91bmQiLCJpc011bHRpQnJvd3NlciIsImJyb3dzZXJOYW1lcyIsImdldEJyb3dzZXJMaXN0IiwiZGlzcG9zZSIsImNvbnNvbGUiLCJqb2luIiwibWFwIiwiYnJvd3Nlck5hbWUiLCJsaXN0QnJvd3NlcnMiLCJsYXp5UmVxdWlyZSIsInJlcXVpcmUiLCJOT1RfUEFSU0FCTEVfUkVQT1JURVJTIiwiZXhpdE1lc3NhZ2VTaG93biIsImV4aXRpbmciLCJleGl0SGFuZGxlciIsInRlcm1pbmF0aW9uTGV2ZWwiLCJ3cml0ZSIsInByb2Nlc3MiLCJvbiIsImNvZGUiLCJzZXRUaW1lb3V0IiwiZXJyb3IiLCJlcnIiLCJtZXNzYWdlIiwiQVBJRXJyb3IiLCJjb2xvcmVkU3RhY2siLCJzdGFjayIsImNoYWxrIiwicmVkIiwiZ3JheSIsInN0ZG91dFJlcG9ydGVyUGx1Z2luIiwiZmluZCIsInBsdWdpbiIsIm91dFN0cmVhbSIsInN0ZG91dCIsImluY2x1ZGVzIiwibmFtZSIsInRlcm1pbmF0aW9uSGFuZGxlciIsIlRlcm1pbmF0aW9uSGFuZGxlciIsIlRFUk1JTkFUSU9OX0xFVkVMX0lOQ1JFQVNFRF9FVkVOVCIsIkNsaUFyZ3VtZW50UGFyc2VyIiwicGFyc2UiLCJhcmd2IiwiY2xpIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OytDQXdFQSxXQUF5QkEsU0FBekIsRUFBb0M7QUFDaEMsY0FBTUMsT0FBb0JELFVBQVVDLElBQXBDO0FBQ0EsY0FBTUMsUUFBb0JELEtBQUtFLEtBQUwsSUFBY0YsS0FBS0UsS0FBTCxDQUFXLENBQVgsQ0FBeEM7QUFDQSxjQUFNQyxRQUFvQkgsS0FBS0UsS0FBTCxJQUFjRixLQUFLRSxLQUFMLENBQVcsQ0FBWCxDQUF4QztBQUNBLGNBQU1FLFFBQW9CSixLQUFLSSxLQUEvQjtBQUNBLGNBQU1DLGNBQW9CTCxLQUFLSyxXQUEvQjs7QUFFQUMsc0JBQUlDLFdBQUo7O0FBRUEsY0FBTUMsV0FBVyxNQUFNLGdCQUFlUixLQUFLUyxRQUFwQixFQUE4QlIsS0FBOUIsRUFBcUNFLEtBQXJDLEVBQTRDSCxLQUFLVSxHQUFqRCxFQUFzRFYsS0FBS1csR0FBM0QsQ0FBdkI7O0FBRUEs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O0FBQ0E1RSxrQkFBSXFFLEtBQUosQ0FBVVcsZ0JBQU1FLElBQU4sQ0FBVyw4QkFBWCxDQUFWOztBQUVBdEMsU0FBSyxDQUFMO0FBQ0g7O0FBRUQsU0FBU04sMEJBQVQsQ0FBcUNDLGdCQUFyQyxFQUF1RDtBQUNuRCxVQUFNNEMsdUJBQXVCNUMsaUJBQWlCNkMsSUFBakIsQ0FBc0JDLFVBQVVBLE9BQU9DLFNBQVAsS0FBcUJoQixRQUFRaUIsTUFBN0IsSUFBdUMsQ0FBQ0YsT0FBT0MsU0FBL0UsQ0FBN0I7O0FBRUEsV0FBT0gsd0JBQXdCbkIsdUJBQXVCd0IsUUFBdkIsQ0FBZ0NMLHFCQUFxQkUsTUFBckIsQ0FBNEJJLElBQTVELENBQS9CO0FBQ0g7O0FBMkVEO0FBQUEsZ0RBQUMsYUFBc0I7QUFDbkIsY0FBTUMscUJBQXFCLElBQUlDLDRCQUFKLEVBQTNCOztBQUVBRCwyQkFBbUJuQixFQUFuQixDQUFzQm9CLDZCQUFtQkMsaUNBQXpDLEVBQTRFekIsV0FBNUU7O0FBRUEsWUFBSTtBQUNBLGtCQUFNMUUsWUFBWSxJQUFJb0csd0JBQUosRUFBbEI7O0FBRUEsa0JBQU1wRyxVQUFVcUcsS0FBVixDQUFnQnhCLFFBQVF5QixJQUF4QixDQUFOOztBQUVBLGdCQUFJdEcsVUFBVUMsSUFBVixDQUFlbUUsWUFBbkIsRUFDSSxNQUFNQSxhQUFhcEUsVUFBVUMsSUFBVixDQUFlb0QsWUFBNUIsQ0FBTixDQURKLEtBR0ksTUFBTUQsU0FBU3BELFNBQVQsQ0FBTjtBQUNQLFNBVEQsQ0FVQSxPQUFPa0YsR0FBUCxFQUFZO0FBQ1JqQyxnQ0FBb0IsS0FBcEI7QUFDQWdDLGtCQUFNQyxHQUFOO0FBQ0g7QUFDSixLQW5CRDs7QUFBQSxhQUFnQnFCLEdBQWhCO0FBQUE7QUFBQTs7QUFBQSxXQUFnQkEsR0FBaEI7QUFBQSIsImZpbGUiOiJjbGkvY2xpLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCB7IEdlbmVyYWxFcnJvciwgQVBJRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBSVU5USU1FX0VSUk9SUyB9IGZyb20gJy4uL2Vycm9ycy90eXBlcyc7XG5pbXBvcnQgQ2xpQXJndW1lbnRQYXJzZXIgZnJvbSAnLi9hcmd1bWVudC1wYXJzZXInO1xuaW1wb3J0IFRlcm1pbmF0aW9uSGFuZGxlciBmcm9tICcuL3Rlcm1pbmF0aW9uLWhhbmRsZXInO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZyc7XG5pbXBvcnQgcmVtb3Rlc1dpemFyZCBmcm9tICcuL3JlbW90ZXMtd2l6YXJkJztcbmltcG9ydCBjb3JyZWN0QnJvd3NlcnNBbmRTb3VyY2VzIGZyb20gJy4vY29ycmVjdC1icm93c2Vycy1hbmQtc291cmNlcyc7XG5pbXBvcnQgY3JlYXRlVGVzdENhZmUgZnJvbSAnLi4vJztcbmltcG9ydCAqIGFzIG1hcmtldGluZyBmcm9tICcuLi9tYXJrZXRpbmcnO1xuXG4vLyBOT1RFOiBMb2FkIHRoZSBwcm92aWRlciBwb29sIGxhemlseSB0byByZWR1Y2Ugc3RhcnR1cCB0aW1lXG5jb25zdCBsYXp5UmVxdWlyZSAgICAgICAgID0gcmVxdWlyZSgnaW1wb3J0LWxhenknKShyZXF1aXJlKTtcbmNvbnN0IGJyb3dzZXJQcm92aWRlclBvb2wgPSBsYXp5UmVxdWlyZSgnLi4vYnJvd3Nlci9wcm92aWRlci9wb29sJyk7XG5cbmNvbnN0IE5PVF9QQVJTQUJMRV9SRVBPUlRFUlMgPSBbJ3NwZWMnLCAnbGlzdCcsICdtaW5pbWFsJ107XG5cbmxldCBzaG93TWVzc2FnZU9uRXhpdCA9IHRydWU7XG5sZXQgZXhpdE1lc3NhZ2VTaG93biAgPSBmYWxzZTtcbmxldCBleGl0aW5nICAgICAgICAgICA9IGZhbHNlO1xuXG5mdW5jdGlvbiBleGl0SGFuZGxlciAodGVybWluYXRpb25MZXZlbCkge1xuICAgIGlmIChzaG93TWVzc2FnZU9uRXhpdCAmJiAhZXhpdE1lc3NhZ2VTaG93bikge1xuICAgICAgICBleGl0TWVzc2FnZVNob3duID0gdHJ1ZTtcblxuICAgICAgICBsb2cud3JpdGUoJ1N0b3BwaW5nIFRlc3RDYWZlLi4uJyk7XG5cbiAgICAgICAgcHJvY2Vzcy5vbignZXhpdCcsICgpID0+IGxvZy5oaWRlU3Bpbm5lcih0cnVlKSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXRpbmcgfHwgdGVybWluYXRpb25MZXZlbCA8IDIpXG4gICAgICAgIHJldHVybjtcblxuICAgIGV4aXRpbmcgPSB0cnVlO1xuXG4gICAgZXhpdCgwKTtcbn1cblxuZnVuY3Rpb24gZXhpdCAoY29kZSkge1xuICAgIGxvZy5oaWRlU3Bpbm5lcih0cnVlKTtcblxuICAgIC8vIE5PVEU6IGdpdmUgYSBwcm9jZXNzIHRpbWUgdG8gZmx1c2ggdGhlIG91dHB1dC5cbiAgICAvLyBJdCdzIG5lY2Vzc2FyeSBpbiBzb21lIGVudmlyb25tZW50cy5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHByb2Nlc3MuZXhpdChjb2RlKSwgMCk7XG59XG5cbmZ1bmN0aW9uIGVycm9yIChlcnIpIHtcbiAgICBsb2cuaGlkZVNwaW5uZXIoKTtcblxuICAgIGxldCBtZXNzYWdlID0gbnVsbDtcblxuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBHZW5lcmFsRXJyb3IpXG4gICAgICAgIG1lc3NhZ2UgPSBlcnIubWVzc2FnZTtcblxuICAgIGVsc2UgaWYgKGVyciBpbnN0YW5jZW9mIEFQSUVycm9yKVxuICAgICAgICBtZXNzYWdlID0gZXJyLmNvbG9yZWRTdGFjaztcblxuICAgIGVsc2VcbiAgICAgICAgbWVzc2FnZSA9IGVyci5zdGFjaztcblxuICAgIGxvZy53cml0ZShjaGFsay5yZWQoJ0VSUk9SICcpICsgbWVzc2FnZSArICdcXG4nKTtcbiAgICBsb2cud3JpdGUoY2hhbGsuZ3JheSgnVHlwZSBcInRlc3RjYWZlIC1oXCIgZm9yIGhlbHAuJykpO1xuXG4gICAgZXhpdCgxKTtcbn1cblxuZnVuY3Rpb24gc2hvdWxkU2hvd01hcmtldGluZ01lc3NhZ2UgKHJlcG9ydGVyUGx1Z2luZ3MpIHtcbiAgICBjb25zdCBzdGRvdXRSZXBvcnRlclBsdWdpbiA9IHJlcG9ydGVyUGx1Z2luZ3MuZmluZChwbHVnaW4gPT4gcGx1Z2luLm91dFN0cmVhbSA9PT0gcHJvY2Vzcy5zdGRvdXQgfHwgIXBsdWdpbi5vdXRTdHJlYW0pO1xuXG4gICAgcmV0dXJuIHN0ZG91dFJlcG9ydGVyUGx1Z2luICYmIE5PVF9QQVJTQUJMRV9SRVBPUlRFUlMuaW5jbHVkZXMoc3Rkb3V0UmVwb3J0ZXJQbHVnaW4ucGx1Z2luLm5hbWUpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5UZXN0cyAoYXJnUGFyc2VyKSB7XG4gICAgY29uc3Qgb3B0cyAgICAgICAgICAgICAgPSBhcmdQYXJzZXIub3B0cztcbiAgICBjb25zdCBwb3J0MSAgICAgICAgICAgICA9IG9wdHMucG9ydHMgJiYgb3B0cy5wb3J0c1swXTtcbiAgICBjb25zdCBwb3J0MiAgICAgICAgICAgICA9IG9wdHMucG9ydHMgJiYgb3B0cy5wb3J0c1sxXTtcbiAgICBjb25zdCBwcm94eSAgICAgICAgICAgICA9IG9wdHMucHJveHk7XG4gICAgY29uc3QgcHJveHlCeXBhc3MgICAgICAgPSBvcHRzLnByb3h5QnlwYXNzO1xuXG4gICAgbG9nLnNob3dTcGlubmVyKCk7XG5cbiAgICBjb25zdCB0ZXN0Q2FmZSA9IGF3YWl0IGNyZWF0ZVRlc3RDYWZlKG9wdHMuaG9zdG5hbWUsIHBvcnQxLCBwb3J0Miwgb3B0cy5zc2wsIG9wdHMuZGV2KTtcblxuICAgIGNvbnN0IGNvcnJlY3RlZEJyb3dzZXJzQW5kU291cmNlcyA9IGF3YWl0IGNvcnJlY3RCcm93c2Vyc0FuZFNvdXJjZXMoYXJnUGFyc2VyLCB0ZXN0Q2FmZS5jb25maWd1cmF0aW9uKTtcbiAgICBjb25zdCBhdXRvbWF0ZWRCcm93c2VycyAgICAgICAgICAgPSBjb3JyZWN0ZWRCcm93c2Vyc0FuZFNvdXJjZXMuYnJvd3NlcnM7XG4gICAgY29uc3QgcmVtb3RlQnJvd3NlcnMgICAgICAgICAgICAgID0gYXdhaXQgcmVtb3Rlc1dpemFyZCh0ZXN0Q2FmZSwgYXJnUGFyc2VyLnJlbW90ZUNvdW50LCBvcHRzLnFyQ29kZSk7XG4gICAgY29uc3QgYnJvd3NlcnMgICAgICAgICAgICAgICAgICAgID0gYXV0b21hdGVkQnJvd3NlcnMuY29uY2F0KHJlbW90ZUJyb3dzZXJzKTtcbiAgICBjb25zdCBzb3VyY2VzICAgICAgICAgICAgICAgICAgICAgPSBjb3JyZWN0ZWRCcm93c2Vyc0FuZFNvdXJjZXMuc291cmNlcztcblxuICAgIGNvbnN0IHJ1bm5lciA9IG9wdHMubGl2ZSA/IHRlc3RDYWZlLmNyZWF0ZUxpdmVNb2RlUnVubmVyKCkgOiB0ZXN0Q2FmZS5jcmVhdGVSdW5uZXIoKTtcblxuICAgIGxldCBmYWlsZWQgPSAwO1xuXG4gICAgcnVubmVyLmlzQ2xpID0gdHJ1ZTtcblxuICAgIHJ1bm5lclxuICAgICAgICAudXNlUHJveHkocHJveHksIHByb3h5QnlwYXNzKVxuICAgICAgICAuc3JjKHNvdXJjZXMpXG4gICAgICAgIC5icm93c2Vycyhicm93c2VycylcbiAgICAgICAgLnJlcG9ydGVyKGFyZ1BhcnNlci5vcHRzLnJlcG9ydGVyKVxuICAgICAgICAuY29uY3VycmVuY3koYXJnUGFyc2VyLm9wdHMuY29uY3VycmVuY3kpXG4gICAgICAgIC5maWx0ZXIoYXJnUGFyc2VyLmZpbHRlcilcbiAgICAgICAgLnZpZGVvKG9wdHMudmlkZW8sIG9wdHMudmlkZW9PcHRpb25zLCBvcHRzLnZpZGVvRW5jb2RpbmdPcHRpb25zKVxuICAgICAgICAuc2NyZWVuc2hvdHMob3B0cy5zY3JlZW5zaG90cywgb3B0cy5zY3JlZW5zaG90c09uRmFpbHMsIG9wdHMuc2NyZWVuc2hvdFBhdGhQYXR0ZXJuKVxuICAgICAgICAuc3RhcnRBcHAob3B0cy5hcHAsIG9wdHMuYXBwSW5pdERlbGF5KTtcblxuICAgIHJ1bm5lci5vbmNlKCdkb25lLWJvb3RzdHJhcHBpbmcnLCAoKSA9PiBsb2cuaGlkZVNwaW5uZXIoKSk7XG5cbiAgICB0cnkge1xuICAgICAgICBmYWlsZWQgPSBhd2FpdCBydW5uZXIucnVuKG9wdHMpO1xuXG4gICAgICAgIGlmIChzaG91bGRTaG93TWFya2V0aW5nTWVzc2FnZShydW5uZXIucmVwb3J0ZXJQbHVnaW5ncykpXG4gICAgICAgICAgICBhd2FpdCBtYXJrZXRpbmcuc2hvd01lc3NhZ2VXaXRoTGlua1RvVGVzdENhZmVTdHVkaW8oKTtcbiAgICB9XG5cbiAgICBmaW5hbGx5IHtcbiAgICAgICAgc2hvd01lc3NhZ2VPbkV4aXQgPSBmYWxzZTtcbiAgICAgICAgYXdhaXQgdGVzdENhZmUuY2xvc2UoKTtcbiAgICB9XG5cbiAgICBleGl0KGZhaWxlZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxpc3RCcm93c2VycyAocHJvdmlkZXJOYW1lID0gJ2xvY2FsbHktaW5zdGFsbGVkJykge1xuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgYnJvd3NlclByb3ZpZGVyUG9vbC5nZXRQcm92aWRlcihwcm92aWRlck5hbWUpO1xuXG4gICAgaWYgKCFwcm92aWRlcilcbiAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5icm93c2VyUHJvdmlkZXJOb3RGb3VuZCwgcHJvdmlkZXJOYW1lKTtcblxuICAgIGlmIChwcm92aWRlci5pc011bHRpQnJvd3Nlcikge1xuICAgICAgICBjb25zdCBicm93c2VyTmFtZXMgPSBhd2FpdCBwcm92aWRlci5nZXRCcm93c2VyTGlzdCgpO1xuXG4gICAgICAgIGF3YWl0IGJyb3dzZXJQcm92aWRlclBvb2wuZGlzcG9zZSgpO1xuXG4gICAgICAgIGlmIChwcm92aWRlck5hbWUgPT09ICdsb2NhbGx5LWluc3RhbGxlZCcpXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhicm93c2VyTmFtZXMuam9pbignXFxuJykpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhicm93c2VyTmFtZXMubWFwKGJyb3dzZXJOYW1lID0+IGBcIiR7cHJvdmlkZXJOYW1lfToke2Jyb3dzZXJOYW1lfVwiYCkuam9pbignXFxuJykpO1xuICAgIH1cbiAgICBlbHNlXG4gICAgICAgIGNvbnNvbGUubG9nKGBcIiR7cHJvdmlkZXJOYW1lfVwiYCk7XG5cbiAgICBleGl0KDApO1xufVxuXG4oYXN5bmMgZnVuY3Rpb24gY2xpICgpIHtcbiAgICBjb25zdCB0ZXJtaW5hdGlvbkhhbmRsZXIgPSBuZXcgVGVybWluYXRpb25IYW5kbGVyKCk7XG5cbiAgICB0ZXJtaW5hdGlvbkhhbmRsZXIub24oVGVybWluYXRpb25IYW5kbGVyLlRFUk1JTkFUSU9OX0xFVkVMX0lOQ1JFQVNFRF9FVkVOVCwgZXhpdEhhbmRsZXIpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYXJnUGFyc2VyID0gbmV3IENsaUFyZ3VtZW50UGFyc2VyKCk7XG5cbiAgICAgICAgYXdhaXQgYXJnUGFyc2VyLnBhcnNlKHByb2Nlc3MuYXJndik7XG5cbiAgICAgICAgaWYgKGFyZ1BhcnNlci5vcHRzLmxpc3RCcm93c2VycylcbiAgICAgICAgICAgIGF3YWl0IGxpc3RCcm93c2VycyhhcmdQYXJzZXIub3B0cy5wcm92aWRlck5hbWUpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBhd2FpdCBydW5UZXN0cyhhcmdQYXJzZXIpO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHNob3dNZXNzYWdlT25FeGl0ID0gZmFsc2U7XG4gICAgICAgIGVycm9yKGVycik7XG4gICAgfVxufSkoKTtcblxuIl19
