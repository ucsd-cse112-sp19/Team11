'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _qrcodeTerminal = require('qrcode-terminal');

var _qrcodeTerminal2 = _interopRequireDefault(_qrcodeTerminal);

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _log = require('./log');

var _log2 = _interopRequireDefault(_log);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _dedent = require('dedent');

var _dedent2 = _interopRequireDefault(_dedent);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (testCafe, remoteCount, showQRCode) {
        const connectionPromises = [];

        if (remoteCount) {
            _log2.default.hideSpinner();

            const description = (0, _dedent2.default)(`
            Connecting ${remoteCount} remote browser(s)...
            Navigate to the following URL from each remote browser.
        `);

            _log2.default.write(description);

            if (showQRCode) _log2.default.write('You can either enter the URL or scan the QR-code.');

            const connectionUrl = testCafe.browserConnectionGateway.connectUrl;

            _log2.default.write(`Connect URL: ${_chalk2.default.underline.blue(connectionUrl)}`);

            if (showQRCode) _qrcodeTerminal2.default.generate(connectionUrl);

            for (let i = 0; i < remoteCount; i++) {
                connectionPromises.push(testCafe.createBrowserConnection().then(function (bc) {
                    return (0, _promisifyEvent2.default)(bc, 'ready').then(function () {
                        return bc;
                    });
                }).then(function (bc) {
                    _log2.default.write(`${_chalk2.default.green('CONNECTED')} ${bc.userAgent}`);
                    return bc;
                }));
            }

            _log2.default.showSpinner();
        }

        return yield _pinkie2.default.all(connectionPromises);
    });

    return function (_x, _x2, _x3) {
        return _ref.apply(this, arguments);
    };
})();

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGkvcmVtb3Rlcy13aXphcmQuanMiXSwibmFtZXMiOlsidGVzdENhZmUiLCJyZW1vdGVDb3VudCIsInNob3dRUkNvZGUiLCJjb25uZWN0aW9uUHJvbWlzZXMiLCJsb2ciLCJoaWRlU3Bpbm5lciIsImRlc2NyaXB0aW9uIiwid3JpdGUiLCJjb25uZWN0aW9uVXJsIiwiYnJvd3NlckNvbm5lY3Rpb25HYXRld2F5IiwiY29ubmVjdFVybCIsImNoYWxrIiwidW5kZXJsaW5lIiwiYmx1ZSIsInFyY29kZSIsImdlbmVyYXRlIiwiaSIsInB1c2giLCJjcmVhdGVCcm93c2VyQ29ubmVjdGlvbiIsInRoZW4iLCJiYyIsImdyZWVuIiwidXNlckFnZW50Iiwic2hvd1NwaW5uZXIiLCJQcm9taXNlIiwiYWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7OzsrQ0FHZSxXQUFnQkEsUUFBaEIsRUFBMEJDLFdBQTFCLEVBQXVDQyxVQUF2QyxFQUFtRDtBQUM5RCxjQUFNQyxxQkFBcUIsRUFBM0I7O0FBRUEsWUFBSUYsV0FBSixFQUFpQjtBQUNiRywwQkFBSUMsV0FBSjs7QUFFQSxrQkFBTUMsY0FBYyxzQkFBUTt5QkFDWEwsV0FBWTs7U0FEVCxDQUFwQjs7QUFLQUcsMEJBQUlHLEtBQUosQ0FBVUQsV0FBVjs7QUFFQSxnQkFBSUosVUFBSixFQUNJRSxjQUFJRyxLQUFKLENBQVUsbURBQVY7O0FBRUosa0JBQU1DLGdCQUFnQlIsU0FBU1Msd0JBQVQsQ0FBa0NDLFVBQXhEOztBQUVBTiwwQkFBSUcsS0FBSixDQUFXLGdCQUFlSSxnQkFBTUMsU0FBTixDQUFnQkMsSUFBaEIsQ0FBcUJMLGFBQXJCLENBQW9DLEVBQTlEOztBQUVBLGdCQUFJTixVQUFKLEVBQ0lZLHlCQUFPQyxRQUFQLENBQWdCUCxhQUFoQjs7QUFFSixpQkFBSyxJQUFJUSxJQUFJLENBQWIsRUFBZ0JBLElBQUlmLFdBQXBCLEVBQWlDZSxHQUFqQyxFQUFzQztBQUNsQ2IsbUNBQW1CYyxJQUFuQixDQUF3QmpCLFNBQ25Ca0IsdUJBRG1CLEdBRW5CQyxJQUZtQixDQUVkO0FBQUEsMkJBQU0sOEJBQWVDLEVBQWYsRUFBbUIsT0FBbkIsRUFBNEJELElBQTVCLENBQWlDO0FBQUEsK0JBQU1DLEVBQU47QUFBQSxxQkFBakMsQ0FBTjtBQUFBLGlCQUZjLEVBR25CRCxJQUhtQixDQUdkLGNBQU07QUFDUmYsa0NBQUlHLEtBQUosQ0FBVyxHQUFFSSxnQkFBTVUsS0FBTixDQUFZLFdBQVosQ0FBeUIsSUFBR0QsR0FBR0UsU0FBVSxFQUF0RDtBQUNBLDJCQUFPRixFQUFQO0FBQ0gsaUJBTm1CLENBQXhCO0FBUUg7O0FBRURoQiwwQkFBSW1CLFdBQUo7QUFDSDs7QUFFRCxlQUFPLE1BQU1DLGlCQUFRQyxHQUFSLENBQVl0QixrQkFBWixDQUFiO0FBQ0gsSyIsImZpbGUiOiJjbGkvcmVtb3Rlcy13aXphcmQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IHFyY29kZSBmcm9tICdxcmNvZGUtdGVybWluYWwnO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2cnO1xuaW1wb3J0IHByb21pc2lmeUV2ZW50IGZyb20gJ3Byb21pc2lmeS1ldmVudCc7XG5pbXBvcnQgZGVkZW50IGZyb20gJ2RlZGVudCc7XG5cblxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gKHRlc3RDYWZlLCByZW1vdGVDb3VudCwgc2hvd1FSQ29kZSkge1xuICAgIGNvbnN0IGNvbm5lY3Rpb25Qcm9taXNlcyA9IFtdO1xuXG4gICAgaWYgKHJlbW90ZUNvdW50KSB7XG4gICAgICAgIGxvZy5oaWRlU3Bpbm5lcigpO1xuXG4gICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gZGVkZW50KGBcbiAgICAgICAgICAgIENvbm5lY3RpbmcgJHtyZW1vdGVDb3VudH0gcmVtb3RlIGJyb3dzZXIocykuLi5cbiAgICAgICAgICAgIE5hdmlnYXRlIHRvIHRoZSBmb2xsb3dpbmcgVVJMIGZyb20gZWFjaCByZW1vdGUgYnJvd3Nlci5cbiAgICAgICAgYCk7XG5cbiAgICAgICAgbG9nLndyaXRlKGRlc2NyaXB0aW9uKTtcblxuICAgICAgICBpZiAoc2hvd1FSQ29kZSlcbiAgICAgICAgICAgIGxvZy53cml0ZSgnWW91IGNhbiBlaXRoZXIgZW50ZXIgdGhlIFVSTCBvciBzY2FuIHRoZSBRUi1jb2RlLicpO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25VcmwgPSB0ZXN0Q2FmZS5icm93c2VyQ29ubmVjdGlvbkdhdGV3YXkuY29ubmVjdFVybDtcblxuICAgICAgICBsb2cud3JpdGUoYENvbm5lY3QgVVJMOiAke2NoYWxrLnVuZGVybGluZS5ibHVlKGNvbm5lY3Rpb25VcmwpfWApO1xuXG4gICAgICAgIGlmIChzaG93UVJDb2RlKVxuICAgICAgICAgICAgcXJjb2RlLmdlbmVyYXRlKGNvbm5lY3Rpb25VcmwpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVtb3RlQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgY29ubmVjdGlvblByb21pc2VzLnB1c2godGVzdENhZmVcbiAgICAgICAgICAgICAgICAuY3JlYXRlQnJvd3NlckNvbm5lY3Rpb24oKVxuICAgICAgICAgICAgICAgIC50aGVuKGJjID0+IHByb21pc2lmeUV2ZW50KGJjLCAncmVhZHknKS50aGVuKCgpID0+IGJjKSlcbiAgICAgICAgICAgICAgICAudGhlbihiYyA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy53cml0ZShgJHtjaGFsay5ncmVlbignQ09OTkVDVEVEJyl9ICR7YmMudXNlckFnZW50fWApO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmM7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICBsb2cuc2hvd1NwaW5uZXIoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwoY29ubmVjdGlvblByb21pc2VzKTtcbn1cbiJdfQ==
