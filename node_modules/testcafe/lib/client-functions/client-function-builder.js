'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _lodash = require('lodash');

var _testRunTracker = require('../api/test-run-tracker');

var _testRunTracker2 = _interopRequireDefault(_testRunTracker);

var _builderSymbol = require('./builder-symbol');

var _builderSymbol2 = _interopRequireDefault(_builderSymbol);

var _replicator = require('./replicator');

var _observation = require('../test-run/commands/observation');

var _compileClientFunction = require('../compiler/compile-client-function');

var _compileClientFunction2 = _interopRequireDefault(_compileClientFunction);

var _runtime = require('../errors/runtime');

var _typeAssertions = require('../errors/runtime/type-assertions');

var _types = require('../errors/types');

var _getCallsite = require('../errors/get-callsite');

var _reExecutablePromise = require('../utils/re-executable-promise');

var _reExecutablePromise2 = _interopRequireDefault(_reExecutablePromise);

var _markerSymbol = require('../test-run/marker-symbol');

var _markerSymbol2 = _interopRequireDefault(_markerSymbol);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEFAULT_EXECUTION_CALLSITE_NAME = '__$$clientFunction$$';

class ClientFunctionBuilder {
    constructor(fn, options, callsiteNames = {}) {
        this.callsiteNames = {
            instantiation: callsiteNames.instantiation,
            execution: callsiteNames.execution || DEFAULT_EXECUTION_CALLSITE_NAME
        };

        if ((0, _lodash.isNil)(options)) options = {};

        this._validateOptions(options);

        this.fn = fn;
        this.options = options;
        this.compiledFnCode = this._getCompiledFnCode();

        if (!this.compiledFnCode) throw this._createInvalidFnTypeError();

        this.replicator = (0, _replicator.createReplicator)(this._getReplicatorTransforms());
    }

    _decorateFunction(clientFn) {
        clientFn[_builderSymbol2.default] = this;

        clientFn.with = options => {
            if (typeof options === 'object') options = (0, _lodash.assign)({}, this.options, options);

            const builder = new this.constructor(this.fn, options, {
                instantiation: 'with',
                execution: this.callsiteNames.execution
            });

            return builder.getFunction();
        };
    }

    getBoundTestRun() {
        // NOTE: `boundTestRun` can be either TestController or TestRun instance.
        if (this.options.boundTestRun) return this.options.boundTestRun.testRun || this.options.boundTestRun;

        return null;
    }

    _getTestRun() {
        return this.getBoundTestRun() || _testRunTracker2.default.resolveContextTestRun();
    }

    getFunction() {
        const builder = this;

        const clientFn = function __$$clientFunction$$() {
            const testRun = builder._getTestRun();
            const callsite = (0, _getCallsite.getCallsiteForMethod)(builder.callsiteNames.execution);
            const args = [];

            // OPTIMIZATION: don't leak `arguments` object.
            for (let i = 0; i < arguments.length; i++) args.push(arguments[i]);

            return builder._executeCommand(args, testRun, callsite);
        };

        this._decorateFunction(clientFn);

        return clientFn;
    }

    getCommand(args) {
        const encodedArgs = this.replicator.encode(args);
        const encodedDependencies = this.replicator.encode(this.getFunctionDependencies());

        return this._createTestRunCommand(encodedArgs, encodedDependencies);
    }

    // Overridable methods
    getFunctionDependencies() {
        return this.options.dependencies || {};
    }

    _createTestRunCommand(encodedArgs, encodedDependencies) {
        return new _observation.ExecuteClientFunctionCommand({
            instantiationCallsiteName: this.callsiteNames.instantiation,
            fnCode: this.compiledFnCode,
            args: encodedArgs,
            dependencies: encodedDependencies
        }, this._getTestRun());
    }

    _getCompiledFnCode() {
        if (typeof this.fn === 'function') return (0, _compileClientFunction2.default)(this.fn.toString(), this.options.dependencies, this.callsiteNames.instantiation, this.callsiteNames.instantiation);

        return null;
    }

    _createInvalidFnTypeError() {
        return new _runtime.ClientFunctionAPIError(this.callsiteNames.instantiation, this.callsiteNames.instantiation, _types.RUNTIME_ERRORS.clientFunctionCodeIsNotAFunction, typeof this.fn);
    }

    _executeCommand(args, testRun, callsite) {
        var _this = this;

        // NOTE: should be kept outside of lazy promise to preserve
        // correct callsite in case of replicator error.
        const command = this.getCommand(args);

        return _reExecutablePromise2.default.fromFn((0, _asyncToGenerator3.default)(function* () {
            if (!testRun) {
                const err = new _runtime.ClientFunctionAPIError(_this.callsiteNames.execution, _this.callsiteNames.instantiation, _types.RUNTIME_ERRORS.clientFunctionCannotResolveTestRun);

                // NOTE: force callsite here, because more likely it will
                // be impossible to resolve it by method name from a lazy promise.
                err.callsite = callsite;

                throw err;
            }

            const result = yield testRun.executeCommand(command, callsite);

            return _this._processResult(result, args);
        }));
    }

    _processResult(result) {
        return this.replicator.decode(result);
    }

    _validateOptions(options) {
        (0, _typeAssertions.assertType)(_typeAssertions.is.nonNullObject, this.callsiteNames.instantiation, '"options" argument', options);

        if (!(0, _lodash.isNil)(options.boundTestRun)) {
            // NOTE: `boundTestRun` can be either TestController or TestRun instance.
            const boundTestRun = options.boundTestRun.testRun || options.boundTestRun;

            if (!boundTestRun[_markerSymbol2.default]) throw new _runtime.APIError(this.callsiteNames.instantiation, _types.RUNTIME_ERRORS.invalidClientFunctionTestRunBinding);
        }

        if (!(0, _lodash.isNil)(options.dependencies)) (0, _typeAssertions.assertType)(_typeAssertions.is.nonNullObject, this.callsiteNames.instantiation, '"dependencies" option', options.dependencies);
    }

    _getReplicatorTransforms() {
        return [new _replicator.FunctionTransform(this.callsiteNames)];
    }
}
exports.default = ClientFunctionBuilder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQtZnVuY3Rpb25zL2NsaWVudC1mdW5jdGlvbi1idWlsZGVyLmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfRVhFQ1VUSU9OX0NBTExTSVRFX05BTUUiLCJDbGllbnRGdW5jdGlvbkJ1aWxkZXIiLCJjb25zdHJ1Y3RvciIsImZuIiwib3B0aW9ucyIsImNhbGxzaXRlTmFtZXMiLCJpbnN0YW50aWF0aW9uIiwiZXhlY3V0aW9uIiwiX3ZhbGlkYXRlT3B0aW9ucyIsImNvbXBpbGVkRm5Db2RlIiwiX2dldENvbXBpbGVkRm5Db2RlIiwiX2NyZWF0ZUludmFsaWRGblR5cGVFcnJvciIsInJlcGxpY2F0b3IiLCJfZ2V0UmVwbGljYXRvclRyYW5zZm9ybXMiLCJfZGVjb3JhdGVGdW5jdGlvbiIsImNsaWVudEZuIiwiZnVuY3Rpb25CdWlsZGVyU3ltYm9sIiwid2l0aCIsImJ1aWxkZXIiLCJnZXRGdW5jdGlvbiIsImdldEJvdW5kVGVzdFJ1biIsImJvdW5kVGVzdFJ1biIsInRlc3RSdW4iLCJfZ2V0VGVzdFJ1biIsInRlc3RSdW5UcmFja2VyIiwicmVzb2x2ZUNvbnRleHRUZXN0UnVuIiwiX18kJGNsaWVudEZ1bmN0aW9uJCQiLCJjYWxsc2l0ZSIsImFyZ3MiLCJpIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwicHVzaCIsIl9leGVjdXRlQ29tbWFuZCIsImdldENvbW1hbmQiLCJlbmNvZGVkQXJncyIsImVuY29kZSIsImVuY29kZWREZXBlbmRlbmNpZXMiLCJnZXRGdW5jdGlvbkRlcGVuZGVuY2llcyIsIl9jcmVhdGVUZXN0UnVuQ29tbWFuZCIsImRlcGVuZGVuY2llcyIsIkV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQiLCJpbnN0YW50aWF0aW9uQ2FsbHNpdGVOYW1lIiwiZm5Db2RlIiwidG9TdHJpbmciLCJDbGllbnRGdW5jdGlvbkFQSUVycm9yIiwiUlVOVElNRV9FUlJPUlMiLCJjbGllbnRGdW5jdGlvbkNvZGVJc05vdEFGdW5jdGlvbiIsImNvbW1hbmQiLCJSZUV4ZWN1dGFibGVQcm9taXNlIiwiZnJvbUZuIiwiZXJyIiwiY2xpZW50RnVuY3Rpb25DYW5ub3RSZXNvbHZlVGVzdFJ1biIsInJlc3VsdCIsImV4ZWN1dGVDb21tYW5kIiwiX3Byb2Nlc3NSZXN1bHQiLCJkZWNvZGUiLCJpcyIsIm5vbk51bGxPYmplY3QiLCJ0ZXN0UnVuTWFya2VyIiwiQVBJRXJyb3IiLCJpbnZhbGlkQ2xpZW50RnVuY3Rpb25UZXN0UnVuQmluZGluZyIsIkZ1bmN0aW9uVHJhbnNmb3JtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGtDQUFrQyxzQkFBeEM7O0FBRWUsTUFBTUMscUJBQU4sQ0FBNEI7QUFDdkNDLGdCQUFhQyxFQUFiLEVBQWlCQyxPQUFqQixFQUEwQkMsZ0JBQWdCLEVBQTFDLEVBQThDO0FBQzFDLGFBQUtBLGFBQUwsR0FBcUI7QUFDakJDLDJCQUFlRCxjQUFjQyxhQURaO0FBRWpCQyx1QkFBZUYsY0FBY0UsU0FBZCxJQUEyQlA7QUFGekIsU0FBckI7O0FBS0EsWUFBSSxtQkFBa0JJLE9BQWxCLENBQUosRUFDSUEsVUFBVSxFQUFWOztBQUVKLGFBQUtJLGdCQUFMLENBQXNCSixPQUF0Qjs7QUFFQSxhQUFLRCxFQUFMLEdBQXNCQSxFQUF0QjtBQUNBLGFBQUtDLE9BQUwsR0FBc0JBLE9BQXRCO0FBQ0EsYUFBS0ssY0FBTCxHQUFzQixLQUFLQyxrQkFBTCxFQUF0Qjs7QUFFQSxZQUFJLENBQUMsS0FBS0QsY0FBVixFQUNJLE1BQU0sS0FBS0UseUJBQUwsRUFBTjs7QUFFSixhQUFLQyxVQUFMLEdBQWtCLGtDQUFpQixLQUFLQyx3QkFBTCxFQUFqQixDQUFsQjtBQUNIOztBQUVEQyxzQkFBbUJDLFFBQW5CLEVBQTZCO0FBQ3pCQSxpQkFBU0MsdUJBQVQsSUFBa0MsSUFBbEM7O0FBRUFE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LElBQUlDLGlCQUFKLENBQWEsS0FBS3ZELGFBQUwsQ0FBbUJDLGFBQWhDLEVBQStDd0Msc0JBQWVlLG1DQUE5RCxDQUFOO0FBQ1A7O0FBRUQsWUFBSSxDQUFDLG1CQUFrQnpELFFBQVFvQyxZQUExQixDQUFMLEVBQ0ksZ0NBQVdpQixtQkFBR0MsYUFBZCxFQUE2QixLQUFLckQsYUFBTCxDQUFtQkMsYUFBaEQsRUFBK0QsdUJBQS9ELEVBQXdGRixRQUFRb0MsWUFBaEc7QUFDUDs7QUFFRDNCLCtCQUE0QjtBQUN4QixlQUFPLENBQ0gsSUFBSWlELDZCQUFKLENBQXNCLEtBQUt6RCxhQUEzQixDQURHLENBQVA7QUFHSDtBQXBKc0M7a0JBQXRCSixxQiIsImZpbGUiOiJjbGllbnQtZnVuY3Rpb25zL2NsaWVudC1mdW5jdGlvbi1idWlsZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNOaWwgYXMgaXNOdWxsT3JVbmRlZmluZWQsIGFzc2lnbiB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdGVzdFJ1blRyYWNrZXIgZnJvbSAnLi4vYXBpL3Rlc3QtcnVuLXRyYWNrZXInO1xuaW1wb3J0IGZ1bmN0aW9uQnVpbGRlclN5bWJvbCBmcm9tICcuL2J1aWxkZXItc3ltYm9sJztcbmltcG9ydCB7IGNyZWF0ZVJlcGxpY2F0b3IsIEZ1bmN0aW9uVHJhbnNmb3JtIH0gZnJvbSAnLi9yZXBsaWNhdG9yJztcbmltcG9ydCB7IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQgfSBmcm9tICcuLi90ZXN0LXJ1bi9jb21tYW5kcy9vYnNlcnZhdGlvbic7XG5pbXBvcnQgY29tcGlsZUNsaWVudEZ1bmN0aW9uIGZyb20gJy4uL2NvbXBpbGVyL2NvbXBpbGUtY2xpZW50LWZ1bmN0aW9uJztcbmltcG9ydCB7IEFQSUVycm9yLCBDbGllbnRGdW5jdGlvbkFQSUVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgYXNzZXJ0VHlwZSwgaXMgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZS90eXBlLWFzc2VydGlvbnMnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgZ2V0Q2FsbHNpdGVGb3JNZXRob2QgfSBmcm9tICcuLi9lcnJvcnMvZ2V0LWNhbGxzaXRlJztcbmltcG9ydCBSZUV4ZWN1dGFibGVQcm9taXNlIGZyb20gJy4uL3V0aWxzL3JlLWV4ZWN1dGFibGUtcHJvbWlzZSc7XG5pbXBvcnQgdGVzdFJ1bk1hcmtlciBmcm9tICcuLi90ZXN0LXJ1bi9tYXJrZXItc3ltYm9sJztcblxuY29uc3QgREVGQVVMVF9FWEVDVVRJT05fQ0FMTFNJVEVfTkFNRSA9ICdfXyQkY2xpZW50RnVuY3Rpb24kJCc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENsaWVudEZ1bmN0aW9uQnVpbGRlciB7XG4gICAgY29uc3RydWN0b3IgKGZuLCBvcHRpb25zLCBjYWxsc2l0ZU5hbWVzID0ge30pIHtcbiAgICAgICAgdGhpcy5jYWxsc2l0ZU5hbWVzID0ge1xuICAgICAgICAgICAgaW5zdGFudGlhdGlvbjogY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLFxuICAgICAgICAgICAgZXhlY3V0aW9uOiAgICAgY2FsbHNpdGVOYW1lcy5leGVjdXRpb24gfHwgREVGQVVMVF9FWEVDVVRJT05fQ0FMTFNJVEVfTkFNRVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChpc051bGxPclVuZGVmaW5lZChvcHRpb25zKSlcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7fTtcblxuICAgICAgICB0aGlzLl92YWxpZGF0ZU9wdGlvbnMob3B0aW9ucyk7XG5cbiAgICAgICAgdGhpcy5mbiAgICAgICAgICAgICA9IGZuO1xuICAgICAgICB0aGlzLm9wdGlvbnMgICAgICAgID0gb3B0aW9ucztcbiAgICAgICAgdGhpcy5jb21waWxlZEZuQ29kZSA9IHRoaXMuX2dldENvbXBpbGVkRm5Db2RlKCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmNvbXBpbGVkRm5Db2RlKVxuICAgICAgICAgICAgdGhyb3cgdGhpcy5fY3JlYXRlSW52YWxpZEZuVHlwZUVycm9yKCk7XG5cbiAgICAgICAgdGhpcy5yZXBsaWNhdG9yID0gY3JlYXRlUmVwbGljYXRvcih0aGlzLl9nZXRSZXBsaWNhdG9yVHJhbnNmb3JtcygpKTtcbiAgICB9XG5cbiAgICBfZGVjb3JhdGVGdW5jdGlvbiAoY2xpZW50Rm4pIHtcbiAgICAgICAgY2xpZW50Rm5bZnVuY3Rpb25CdWlsZGVyU3ltYm9sXSA9IHRoaXM7XG5cbiAgICAgICAgY2xpZW50Rm4ud2l0aCA9IG9wdGlvbnMgPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnb2JqZWN0JylcbiAgICAgICAgICAgICAgICBvcHRpb25zID0gYXNzaWduKHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMpO1xuXG4gICAgICAgICAgICBjb25zdCBidWlsZGVyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5mbiwgb3B0aW9ucywge1xuICAgICAgICAgICAgICAgIGluc3RhbnRpYXRpb246ICd3aXRoJyxcbiAgICAgICAgICAgICAgICBleGVjdXRpb246ICAgICB0aGlzLmNhbGxzaXRlTmFtZXMuZXhlY3V0aW9uXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcmV0dXJuIGJ1aWxkZXIuZ2V0RnVuY3Rpb24oKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXRCb3VuZFRlc3RSdW4gKCkge1xuICAgICAgICAvLyBOT1RFOiBgYm91bmRUZXN0UnVuYCBjYW4gYmUgZWl0aGVyIFRlc3RDb250cm9sbGVyIG9yIFRlc3RSdW4gaW5zdGFuY2UuXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYm91bmRUZXN0UnVuKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5ib3VuZFRlc3RSdW4udGVzdFJ1biB8fCB0aGlzLm9wdGlvbnMuYm91bmRUZXN0UnVuO1xuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIF9nZXRUZXN0UnVuICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Qm91bmRUZXN0UnVuKCkgfHwgdGVzdFJ1blRyYWNrZXIucmVzb2x2ZUNvbnRleHRUZXN0UnVuKCk7XG4gICAgfVxuXG4gICAgZ2V0RnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zdCBidWlsZGVyID0gdGhpcztcblxuICAgICAgICBjb25zdCBjbGllbnRGbiA9IGZ1bmN0aW9uIF9fJCRjbGllbnRGdW5jdGlvbiQkICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHRlc3RSdW4gID0gYnVpbGRlci5fZ2V0VGVzdFJ1bigpO1xuICAgICAgICAgICAgY29uc3QgY2FsbHNpdGUgPSBnZXRDYWxsc2l0ZUZvck1ldGhvZChidWlsZGVyLmNhbGxzaXRlTmFtZXMuZXhlY3V0aW9uKTtcbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgICAgID0gW107XG5cbiAgICAgICAgICAgIC8vIE9QVElNSVpBVElPTjogZG9uJ3QgbGVhayBgYXJndW1lbnRzYCBvYmplY3QuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKylcbiAgICAgICAgICAgICAgICBhcmdzLnB1c2goYXJndW1lbnRzW2ldKTtcblxuICAgICAgICAgICAgcmV0dXJuIGJ1aWxkZXIuX2V4ZWN1dGVDb21tYW5kKGFyZ3MsIHRlc3RSdW4sIGNhbGxzaXRlKTtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLl9kZWNvcmF0ZUZ1bmN0aW9uKGNsaWVudEZuKTtcblxuICAgICAgICByZXR1cm4gY2xpZW50Rm47XG4gICAgfVxuXG4gICAgZ2V0Q29tbWFuZCAoYXJncykge1xuICAgICAgICBjb25zdCBlbmNvZGVkQXJncyAgICAgICAgID0gdGhpcy5yZXBsaWNhdG9yLmVuY29kZShhcmdzKTtcbiAgICAgICAgY29uc3QgZW5jb2RlZERlcGVuZGVuY2llcyA9IHRoaXMucmVwbGljYXRvci5lbmNvZGUodGhpcy5nZXRGdW5jdGlvbkRlcGVuZGVuY2llcygpKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fY3JlYXRlVGVzdFJ1bkNvbW1hbmQoZW5jb2RlZEFyZ3MsIGVuY29kZWREZXBlbmRlbmNpZXMpO1xuICAgIH1cblxuXG4gICAgLy8gT3ZlcnJpZGFibGUgbWV0aG9kc1xuICAgIGdldEZ1bmN0aW9uRGVwZW5kZW5jaWVzICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5kZXBlbmRlbmNpZXMgfHwge307XG4gICAgfVxuXG4gICAgX2NyZWF0ZVRlc3RSdW5Db21tYW5kIChlbmNvZGVkQXJncywgZW5jb2RlZERlcGVuZGVuY2llcykge1xuICAgICAgICByZXR1cm4gbmV3IEV4ZWN1dGVDbGllbnRGdW5jdGlvbkNvbW1hbmQoe1xuICAgICAgICAgICAgaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZTogdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sXG4gICAgICAgICAgICBmbkNvZGU6ICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBpbGVkRm5Db2RlLFxuICAgICAgICAgICAgYXJnczogICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZEFyZ3MsXG4gICAgICAgICAgICBkZXBlbmRlbmNpZXM6ICAgICAgICAgICAgICBlbmNvZGVkRGVwZW5kZW5jaWVzXG4gICAgICAgIH0sIHRoaXMuX2dldFRlc3RSdW4oKSk7XG4gICAgfVxuXG4gICAgX2dldENvbXBpbGVkRm5Db2RlICgpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmZuID09PSAnZnVuY3Rpb24nKVxuICAgICAgICAgICAgcmV0dXJuIGNvbXBpbGVDbGllbnRGdW5jdGlvbih0aGlzLmZuLnRvU3RyaW5nKCksIHRoaXMub3B0aW9ucy5kZXBlbmRlbmNpZXMsIHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCB0aGlzLmNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbik7XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgX2NyZWF0ZUludmFsaWRGblR5cGVFcnJvciAoKSB7XG4gICAgICAgIHJldHVybiBuZXcgQ2xpZW50RnVuY3Rpb25BUElFcnJvcih0aGlzLmNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbiwgdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sIFJVTlRJTUVfRVJST1JTLmNsaWVudEZ1bmN0aW9uQ29kZUlzTm90QUZ1bmN0aW9uLCB0eXBlb2YgdGhpcy5mbik7XG4gICAgfVxuXG4gICAgX2V4ZWN1dGVDb21tYW5kIChhcmdzLCB0ZXN0UnVuLCBjYWxsc2l0ZSkge1xuICAgICAgICAvLyBOT1RFOiBzaG91bGQgYmUga2VwdCBvdXRzaWRlIG9mIGxhenkgcHJvbWlzZSB0byBwcmVzZXJ2ZVxuICAgICAgICAvLyBjb3JyZWN0IGNhbGxzaXRlIGluIGNhc2Ugb2YgcmVwbGljYXRvciBlcnJvci5cbiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuZ2V0Q29tbWFuZChhcmdzKTtcblxuICAgICAgICByZXR1cm4gUmVFeGVjdXRhYmxlUHJvbWlzZS5mcm9tRm4oYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKCF0ZXN0UnVuKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZXJyID0gbmV3IENsaWVudEZ1bmN0aW9uQVBJRXJyb3IodGhpcy5jYWxsc2l0ZU5hbWVzLmV4ZWN1dGlvbiwgdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sIFJVTlRJTUVfRVJST1JTLmNsaWVudEZ1bmN0aW9uQ2Fubm90UmVzb2x2ZVRlc3RSdW4pO1xuXG4gICAgICAgICAgICAgICAgLy8gTk9URTogZm9yY2UgY2FsbHNpdGUgaGVyZSwgYmVjYXVzZSBtb3JlIGxpa2VseSBpdCB3aWxsXG4gICAgICAgICAgICAgICAgLy8gYmUgaW1wb3NzaWJsZSB0byByZXNvbHZlIGl0IGJ5IG1ldGhvZCBuYW1lIGZyb20gYSBsYXp5IHByb21pc2UuXG4gICAgICAgICAgICAgICAgZXJyLmNhbGxzaXRlID0gY2FsbHNpdGU7XG5cbiAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQoY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fcHJvY2Vzc1Jlc3VsdChyZXN1bHQsIGFyZ3MpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcHJvY2Vzc1Jlc3VsdCAocmVzdWx0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlcGxpY2F0b3IuZGVjb2RlKHJlc3VsdCk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlT3B0aW9ucyAob3B0aW9ucykge1xuICAgICAgICBhc3NlcnRUeXBlKGlzLm5vbk51bGxPYmplY3QsIHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCAnXCJvcHRpb25zXCIgYXJndW1lbnQnLCBvcHRpb25zKTtcblxuICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKG9wdGlvbnMuYm91bmRUZXN0UnVuKSkge1xuICAgICAgICAgICAgLy8gTk9URTogYGJvdW5kVGVzdFJ1bmAgY2FuIGJlIGVpdGhlciBUZXN0Q29udHJvbGxlciBvciBUZXN0UnVuIGluc3RhbmNlLlxuICAgICAgICAgICAgY29uc3QgYm91bmRUZXN0UnVuID0gb3B0aW9ucy5ib3VuZFRlc3RSdW4udGVzdFJ1biB8fCBvcHRpb25zLmJvdW5kVGVzdFJ1bjtcblxuICAgICAgICAgICAgaWYgKCFib3VuZFRlc3RSdW5bdGVzdFJ1bk1hcmtlcl0pXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEFQSUVycm9yKHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCBSVU5USU1FX0VSUk9SUy5pbnZhbGlkQ2xpZW50RnVuY3Rpb25UZXN0UnVuQmluZGluZyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKG9wdGlvbnMuZGVwZW5kZW5jaWVzKSlcbiAgICAgICAgICAgIGFzc2VydFR5cGUoaXMubm9uTnVsbE9iamVjdCwgdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sICdcImRlcGVuZGVuY2llc1wiIG9wdGlvbicsIG9wdGlvbnMuZGVwZW5kZW5jaWVzKTtcbiAgICB9XG5cbiAgICBfZ2V0UmVwbGljYXRvclRyYW5zZm9ybXMgKCkge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgbmV3IEZ1bmN0aW9uVHJhbnNmb3JtKHRoaXMuY2FsbHNpdGVOYW1lcylcbiAgICAgICAgXTtcbiAgICB9XG59XG4iXX0=
