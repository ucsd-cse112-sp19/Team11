'use strict';

exports.__esModule = true;

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _lodash = require('lodash');

var _dedent = require('dedent');

var _dedent2 = _interopRequireDefault(_dedent);

var _clientFunctionBuilder = require('../client-function-builder');

var _clientFunctionBuilder2 = _interopRequireDefault(_clientFunctionBuilder);

var _replicator = require('../replicator');

var _runtime = require('../../errors/runtime');

var _builderSymbol = require('../builder-symbol');

var _builderSymbol2 = _interopRequireDefault(_builderSymbol);

var _types = require('../../errors/types');

var _typeAssertions = require('../../errors/runtime/type-assertions');

var _observation = require('../../test-run/commands/observation');

var _defineLazyProperty = require('../../utils/define-lazy-property');

var _defineLazyProperty2 = _interopRequireDefault(_defineLazyProperty);

var _addApi = require('./add-api');

var _createSnapshotMethods = require('./create-snapshot-methods');

var _createSnapshotMethods2 = _interopRequireDefault(_createSnapshotMethods);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class SelectorBuilder extends _clientFunctionBuilder2.default {
    constructor(fn, options, callsiteNames) {
        const apiFn = options && options.apiFn;
        const builderFromSelector = fn && fn[_builderSymbol2.default];
        const builderFromPromiseOrSnapshot = fn && fn.selector && fn.selector[_builderSymbol2.default];
        let builder = builderFromSelector || builderFromPromiseOrSnapshot;

        builder = builder instanceof SelectorBuilder ? builder : null;

        if (builder) {
            fn = builder.fn;

            if (options === void 0 || typeof options === 'object') options = (0, _lodash.merge)({}, builder.options, options, { sourceSelectorBuilder: builder });
        }

        super(fn, options, callsiteNames);

        if (!this.options.apiFnChain) {
            const fnType = typeof this.fn;
            let item = fnType === 'string' ? `'${this.fn}'` : `[${fnType}]`;

            item = `Selector(${item})`;
            this.options.apiFn = item;
            this.options.apiFnChain = [item];
        }

        if (apiFn) this.options.apiFnChain.push(apiFn);

        this.options.apiFnID = this.options.apiFnChain.length - 1;
    }

    _getCompiledFnCode() {
        // OPTIMIZATION: if selector was produced from another selector and
        // it has same dependencies as source selector, then we can
        // avoid recompilation and just re-use already compiled code.
        const hasSameDependenciesAsSourceSelector = this.options.sourceSelectorBuilder && this.options.sourceSelectorBuilder.options.dependencies === this.options.dependencies;

        if (hasSameDependenciesAsSourceSelector) return this.options.sourceSelectorBuilder.compiledFnCode;

        const code = typeof this.fn === 'string' ? `(function(){return document.querySelectorAll(${(0, _stringify2.default)(this.fn)});});` : super._getCompiledFnCode();

        if (code) {
            return (0, _dedent2.default)(`(function(){
                    var __f$=${code};
                    return function(){
                        var args           = __dependencies$.boundArgs || arguments;
                        var selectorFilter = window['%testCafeSelectorFilter%'];
                        
                        var nodes = __f$.apply(this, args);
                        nodes     = selectorFilter.cast(nodes);
                        
                        if (!nodes.length && !selectorFilter.error)
                            selectorFilter.error = __dependencies$.apiInfo.apiFnID;

                        return selectorFilter.filter(nodes, __dependencies$.filterOptions, __dependencies$.apiInfo);
                    };
                 })();`);
        }

        return null;
    }

    _createInvalidFnTypeError() {
        return new _runtime.ClientFunctionAPIError(this.callsiteNames.instantiation, this.callsiteNames.instantiation, _types.RUNTIME_ERRORS.selectorInitializedWithWrongType, typeof this.fn);
    }

    _executeCommand(args, testRun, callsite) {
        const resultPromise = super._executeCommand(args, testRun, callsite);

        this._addBoundArgsSelectorGetter(resultPromise, args);

        // OPTIMIZATION: use buffer function as selector not to trigger lazy property ahead of time
        (0, _addApi.addAPI)(resultPromise, () => resultPromise.selector, SelectorBuilder, this.options.customDOMProperties, this.options.customMethods);

        return resultPromise;
    }

    _getSourceSelectorBuilderApiFnID() {
        let selectorAncestor = this;

        while (selectorAncestor.options.sourceSelectorBuilder) selectorAncestor = selectorAncestor.options.sourceSelectorBuilder;

        return selectorAncestor.options.apiFnID;
    }

    getFunctionDependencies() {
        const dependencies = super.getFunctionDependencies();

        var _options = this.options;
        const filterVisible = _options.filterVisible,
              filterHidden = _options.filterHidden,
              counterMode = _options.counterMode,
              collectionMode = _options.collectionMode,
              index = _options.index,
              customDOMProperties = _options.customDOMProperties,
              customMethods = _options.customMethods,
              apiFnChain = _options.apiFnChain,
              boundArgs = _options.boundArgs;


        return (0, _lodash.merge)({}, dependencies, {
            filterOptions: {
                filterVisible,
                filterHidden,
                counterMode,
                collectionMode,
                index: (0, _lodash.isNil)(index) ? null : index
            },
            apiInfo: {
                apiFnChain,
                apiFnID: this._getSourceSelectorBuilderApiFnID()
            },
            boundArgs,
            customDOMProperties,
            customMethods
        });
    }

    _createTestRunCommand(encodedArgs, encodedDependencies) {
        return new _observation.ExecuteSelectorCommand({
            instantiationCallsiteName: this.callsiteNames.instantiation,
            fnCode: this.compiledFnCode,
            args: encodedArgs,
            dependencies: encodedDependencies,
            needError: this.options.needError,
            apiFnChain: this.options.apiFnChain,
            visibilityCheck: !!this.options.visibilityCheck,
            timeout: this.options.timeout
        });
    }

    _validateOptions(options) {
        super._validateOptions(options);

        if (!(0, _lodash.isNil)(options.visibilityCheck)) (0, _typeAssertions.assertType)(_typeAssertions.is.boolean, this.callsiteNames.instantiation, '"visibilityCheck" option', options.visibilityCheck);

        if (!(0, _lodash.isNil)(options.timeout)) (0, _typeAssertions.assertType)(_typeAssertions.is.nonNegativeNumber, this.callsiteNames.instantiation, '"timeout" option', options.timeout);
    }

    _getReplicatorTransforms() {
        const transforms = super._getReplicatorTransforms();

        transforms.push(new _replicator.SelectorNodeTransform());

        return transforms;
    }

    _addBoundArgsSelectorGetter(obj, selectorArgs) {
        (0, _defineLazyProperty2.default)(obj, 'selector', () => {
            const builder = new SelectorBuilder(this.getFunction(), { boundArgs: selectorArgs });

            return builder.getFunction();
        });
    }

    _decorateFunction(selectorFn) {
        super._decorateFunction(selectorFn);

        (0, _addApi.addAPI)(selectorFn, () => selectorFn, SelectorBuilder, this.options.customDOMProperties, this.options.customMethods);
    }

    _processResult(result, selectorArgs) {
        const snapshot = super._processResult(result, selectorArgs);

        if (snapshot && !this.options.counterMode) {
            this._addBoundArgsSelectorGetter(snapshot, selectorArgs);
            (0, _createSnapshotMethods2.default)(snapshot);

            if (this.options.customMethods) (0, _addApi.addCustomMethods)(snapshot, () => snapshot.selector, SelectorBuilder, this.options.customMethods);
        }

        return snapshot;
    }
}
exports.default = SelectorBuilder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGllbnQtZnVuY3Rpb25zL3NlbGVjdG9ycy9zZWxlY3Rvci1idWlsZGVyLmpzIl0sIm5hbWVzIjpbIlNlbGVjdG9yQnVpbGRlciIsIkNsaWVudEZ1bmN0aW9uQnVpbGRlciIsImNvbnN0cnVjdG9yIiwiZm4iLCJvcHRpb25zIiwiY2FsbHNpdGVOYW1lcyIsImFwaUZuIiwiYnVpbGRlckZyb21TZWxlY3RvciIsImZ1bmN0aW9uQnVpbGRlclN5bWJvbCIsImJ1aWxkZXJGcm9tUHJvbWlzZU9yU25hcHNob3QiLCJzZWxlY3RvciIsImJ1aWxkZXIiLCJzb3VyY2VTZWxlY3RvckJ1aWxkZXIiLCJhcGlGbkNoYWluIiwiZm5UeXBlIiwiaXRlbSIsInB1c2giLCJhcGlGbklEIiwibGVuZ3RoIiwiX2dldENvbXBpbGVkRm5Db2RlIiwiaGFzU2FtZURlcGVuZGVuY2llc0FzU291cmNlU2VsZWN0b3IiLCJkZXBlbmRlbmNpZXMiLCJjb21waWxlZEZuQ29kZSIsImNvZGUiLCJfY3JlYXRlSW52YWxpZEZuVHlwZUVycm9yIiwiQ2xpZW50RnVuY3Rpb25BUElFcnJvciIsImluc3RhbnRpYXRpb24iLCJSVU5USU1FX0VSUk9SUyIsInNlbGVjdG9ySW5pdGlhbGl6ZWRXaXRoV3JvbmdUeXBlIiwiX2V4ZWN1dGVDb21tYW5kIiwiYXJncyIsInRlc3RSdW4iLCJjYWxsc2l0ZSIsInJlc3VsdFByb21pc2UiLCJfYWRkQm91bmRBcmdzU2VsZWN0b3JHZXR0ZXIiLCJjdXN0b21ET01Qcm9wZXJ0aWVzIiwiY3VzdG9tTWV0aG9kcyIsIl9nZXRTb3VyY2VTZWxlY3RvckJ1aWxkZXJBcGlGbklEIiwic2VsZWN0b3JBbmNlc3RvciIsImdldEZ1bmN0aW9uRGVwZW5kZW5jaWVzIiwiZmlsdGVyVmlzaWJsZSIsImZpbHRlckhpZGRlbiIsImNvdW50ZXJNb2RlIiwiY29sbGVjdGlvbk1vZGUiLCJpbmRleCIsImJvdW5kQXJncyIsImZpbHRlck9wdGlvbnMiLCJhcGlJbmZvIiwiX2NyZWF0ZVRlc3RSdW5Db21tYW5kIiwiZW5jb2RlZEFyZ3MiLCJlbmNvZGVkRGVwZW5kZW5jaWVzIiwiRXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCIsImluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUiLCJmbkNvZGUiLCJuZWVkRXJyb3IiLCJ2aXNpYmlsaXR5Q2hlY2siLCJ0aW1lb3V0IiwiX3ZhbGlkYXRlT3B0aW9ucyIsImlzIiwiYm9vbGVhbiIsIm5vbk5lZ2F0aXZlTnVtYmVyIiwiX2dldFJlcGxpY2F0b3JUcmFuc2Zvcm1zIiwidHJhbnNmb3JtcyIsIlNlbGVjdG9yTm9kZVRyYW5zZm9ybSIsIm9iaiIsInNlbGVjdG9yQXJncyIsImdldEZ1bmN0aW9uIiwiX2RlY29yYXRlRnVuY3Rpb24iLCJzZWxlY3RvckZuIiwiX3Byb2Nlc3NSZXN1bHQiLCJyZXN1bHQiLCJzbmFwc2hvdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOzs7Ozs7QUFFZSxNQUFNQSxlQUFOLFNBQThCQywrQkFBOUIsQ0FBb0Q7QUFDL0RDLGdCQUFhQyxFQUFiLEVBQWlCQyxPQUFqQixFQUEwQkMsYUFBMUIsRUFBeUM7QUFDckMsY0FBTUMsUUFBK0JGLFdBQVdBLFFBQVFFLEtBQXhEO0FBQ0EsY0FBTUMsc0JBQStCSixNQUFNQSxHQUFHSyx1QkFBSCxDQUEzQztBQUNBLGNBQU1DLCtCQUErQk4sTUFBTUEsR0FBR08sUUFBVCxJQUFxQlAsR0FBR08sUUFBSCxDQUFZRix1QkFBWixDQUExRDtBQUNBLFlBQUlHLFVBQWlDSix1QkFBdUJFLDRCQUE1RDs7QUFFQUUsa0JBQVVBLG1CQUFtQlgsZUFBbkIsR0FBcUNXLE9BQXJDLEdBQStDLElBQXpEOztBQUVBLFlBQUlBLE9BQUosRUFBYTtBQUNUUixpQkFBS1EsUUFBUVIsRUFBYjs7QUFFQSxnQkFBSUMsWUFBWSxLQUFLLENBQWpCLElBQXNC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cUJDLE1BQXJCLEVBQTZCTCxZQUE3QixDQUFqQjs7QUFFQSxZQUFJTSxZQUFZLENBQUMsS0FBS25FLE9BQUwsQ0FBYXNDLFdBQTlCLEVBQTJDO0FBQ3ZDLGlCQUFLUiwyQkFBTCxDQUFpQ3FDLFFBQWpDLEVBQTJDTixZQUEzQztBQUNBLGlEQUFzQk0sUUFBdEI7O0FBRUEsZ0JBQUksS0FBS25FLE9BQUwsQ0FBYWdDLGFBQWpCLEVBQ0ksOEJBQWlCbUMsUUFBakIsRUFBMkIsTUFBTUEsU0FBUzdELFFBQTFDLEVBQW9EVixlQUFwRCxFQUFxRSxLQUFLSSxPQUFMLENBQWFnQyxhQUFsRjtBQUNQOztBQUVELGVBQU9tQyxRQUFQO0FBQ0g7QUF6TDhEO2tCQUE5Q3ZFLGUiLCJmaWxlIjoiY2xpZW50LWZ1bmN0aW9ucy9zZWxlY3RvcnMvc2VsZWN0b3ItYnVpbGRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzTmlsIGFzIGlzTnVsbE9yVW5kZWZpbmVkLCBtZXJnZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgZGVkZW50IGZyb20gJ2RlZGVudCc7XG5pbXBvcnQgQ2xpZW50RnVuY3Rpb25CdWlsZGVyIGZyb20gJy4uL2NsaWVudC1mdW5jdGlvbi1idWlsZGVyJztcbmltcG9ydCB7IFNlbGVjdG9yTm9kZVRyYW5zZm9ybSB9IGZyb20gJy4uL3JlcGxpY2F0b3InO1xuaW1wb3J0IHsgQ2xpZW50RnVuY3Rpb25BUElFcnJvciB9IGZyb20gJy4uLy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCBmdW5jdGlvbkJ1aWxkZXJTeW1ib2wgZnJvbSAnLi4vYnVpbGRlci1zeW1ib2wnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi8uLi9lcnJvcnMvdHlwZXMnO1xuaW1wb3J0IHsgYXNzZXJ0VHlwZSwgaXMgfSBmcm9tICcuLi8uLi9lcnJvcnMvcnVudGltZS90eXBlLWFzc2VydGlvbnMnO1xuaW1wb3J0IHsgRXhlY3V0ZVNlbGVjdG9yQ29tbWFuZCB9IGZyb20gJy4uLy4uL3Rlc3QtcnVuL2NvbW1hbmRzL29ic2VydmF0aW9uJztcbmltcG9ydCBkZWZpbmVMYXp5UHJvcGVydHkgZnJvbSAnLi4vLi4vdXRpbHMvZGVmaW5lLWxhenktcHJvcGVydHknO1xuaW1wb3J0IHsgYWRkQVBJLCBhZGRDdXN0b21NZXRob2RzIH0gZnJvbSAnLi9hZGQtYXBpJztcbmltcG9ydCBjcmVhdGVTbmFwc2hvdE1ldGhvZHMgZnJvbSAnLi9jcmVhdGUtc25hcHNob3QtbWV0aG9kcyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNlbGVjdG9yQnVpbGRlciBleHRlbmRzIENsaWVudEZ1bmN0aW9uQnVpbGRlciB7XG4gICAgY29uc3RydWN0b3IgKGZuLCBvcHRpb25zLCBjYWxsc2l0ZU5hbWVzKSB7XG4gICAgICAgIGNvbnN0IGFwaUZuICAgICAgICAgICAgICAgICAgICAgICAgPSBvcHRpb25zICYmIG9wdGlvbnMuYXBpRm47XG4gICAgICAgIGNvbnN0IGJ1aWxkZXJGcm9tU2VsZWN0b3IgICAgICAgICAgPSBmbiAmJiBmbltmdW5jdGlvbkJ1aWxkZXJTeW1ib2xdO1xuICAgICAgICBjb25zdCBidWlsZGVyRnJvbVByb21pc2VPclNuYXBzaG90ID0gZm4gJiYgZm4uc2VsZWN0b3IgJiYgZm4uc2VsZWN0b3JbZnVuY3Rpb25CdWlsZGVyU3ltYm9sXTtcbiAgICAgICAgbGV0IGJ1aWxkZXIgICAgICAgICAgICAgICAgICAgICAgICA9IGJ1aWxkZXJGcm9tU2VsZWN0b3IgfHwgYnVpbGRlckZyb21Qcm9taXNlT3JTbmFwc2hvdDtcblxuICAgICAgICBidWlsZGVyID0gYnVpbGRlciBpbnN0YW5jZW9mIFNlbGVjdG9yQnVpbGRlciA/IGJ1aWxkZXIgOiBudWxsO1xuXG4gICAgICAgIGlmIChidWlsZGVyKSB7XG4gICAgICAgICAgICBmbiA9IGJ1aWxkZXIuZm47XG5cbiAgICAgICAgICAgIGlmIChvcHRpb25zID09PSB2b2lkIDAgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnKVxuICAgICAgICAgICAgICAgIG9wdGlvbnMgPSBtZXJnZSh7fSwgYnVpbGRlci5vcHRpb25zLCBvcHRpb25zLCB7IHNvdXJjZVNlbGVjdG9yQnVpbGRlcjogYnVpbGRlciB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHN1cGVyKGZuLCBvcHRpb25zLCBjYWxsc2l0ZU5hbWVzKTtcblxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5hcGlGbkNoYWluKSB7XG4gICAgICAgICAgICBjb25zdCBmblR5cGUgPSB0eXBlb2YgdGhpcy5mbjtcbiAgICAgICAgICAgIGxldCBpdGVtICAgICA9IGZuVHlwZSA9PT0gJ3N0cmluZycgPyBgJyR7dGhpcy5mbn0nYCA6IGBbJHtmblR5cGV9XWA7XG5cbiAgICAgICAgICAgIGl0ZW0gICAgICAgICAgICAgICAgICAgID0gYFNlbGVjdG9yKCR7aXRlbX0pYDtcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hcGlGbiAgICAgID0gaXRlbTtcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5hcGlGbkNoYWluID0gW2l0ZW1dO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGFwaUZuKVxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLmFwaUZuQ2hhaW4ucHVzaChhcGlGbik7XG5cbiAgICAgICAgdGhpcy5vcHRpb25zLmFwaUZuSUQgPSB0aGlzLm9wdGlvbnMuYXBpRm5DaGFpbi5sZW5ndGggLSAxO1xuICAgIH1cblxuICAgIF9nZXRDb21waWxlZEZuQ29kZSAoKSB7XG4gICAgICAgIC8vIE9QVElNSVpBVElPTjogaWYgc2VsZWN0b3Igd2FzIHByb2R1Y2VkIGZyb20gYW5vdGhlciBzZWxlY3RvciBhbmRcbiAgICAgICAgLy8gaXQgaGFzIHNhbWUgZGVwZW5kZW5jaWVzIGFzIHNvdXJjZSBzZWxlY3RvciwgdGhlbiB3ZSBjYW5cbiAgICAgICAgLy8gYXZvaWQgcmVjb21waWxhdGlvbiBhbmQganVzdCByZS11c2UgYWxyZWFkeSBjb21waWxlZCBjb2RlLlxuICAgICAgICBjb25zdCBoYXNTYW1lRGVwZW5kZW5jaWVzQXNTb3VyY2VTZWxlY3RvciA9IHRoaXMub3B0aW9ucy5zb3VyY2VTZWxlY3RvckJ1aWxkZXIgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuc291cmNlU2VsZWN0b3JCdWlsZGVyLm9wdGlvbnMuZGVwZW5kZW5jaWVzID09PVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5kZXBlbmRlbmNpZXM7XG5cbiAgICAgICAgaWYgKGhhc1NhbWVEZXBlbmRlbmNpZXNBc1NvdXJjZVNlbGVjdG9yKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5zb3VyY2VTZWxlY3RvckJ1aWxkZXIuY29tcGlsZWRGbkNvZGU7XG5cbiAgICAgICAgY29uc3QgY29kZSA9IHR5cGVvZiB0aGlzLmZuID09PSAnc3RyaW5nJyA/XG4gICAgICAgICAgICBgKGZ1bmN0aW9uKCl7cmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJHtKU09OLnN0cmluZ2lmeSh0aGlzLmZuKX0pO30pO2AgOlxuICAgICAgICAgICAgc3VwZXIuX2dldENvbXBpbGVkRm5Db2RlKCk7XG5cbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBkZWRlbnQoXG4gICAgICAgICAgICAgICAgYChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICB2YXIgX19mJD0ke2NvZGV9O1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhcmdzICAgICAgICAgICA9IF9fZGVwZW5kZW5jaWVzJC5ib3VuZEFyZ3MgfHwgYXJndW1lbnRzO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdG9yRmlsdGVyID0gd2luZG93WycldGVzdENhZmVTZWxlY3RvckZpbHRlciUnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vZGVzID0gX19mJC5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzICAgICA9IHNlbGVjdG9yRmlsdGVyLmNhc3Qobm9kZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vZGVzLmxlbmd0aCAmJiAhc2VsZWN0b3JGaWx0ZXIuZXJyb3IpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3JGaWx0ZXIuZXJyb3IgPSBfX2RlcGVuZGVuY2llcyQuYXBpSW5mby5hcGlGbklEO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZWN0b3JGaWx0ZXIuZmlsdGVyKG5vZGVzLCBfX2RlcGVuZGVuY2llcyQuZmlsdGVyT3B0aW9ucywgX19kZXBlbmRlbmNpZXMkLmFwaUluZm8pO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICB9KSgpO2BcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBfY3JlYXRlSW52YWxpZEZuVHlwZUVycm9yICgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBDbGllbnRGdW5jdGlvbkFQSUVycm9yKHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLCB0aGlzLmNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbiwgUlVOVElNRV9FUlJPUlMuc2VsZWN0b3JJbml0aWFsaXplZFdpdGhXcm9uZ1R5cGUsIHR5cGVvZiB0aGlzLmZuKTtcbiAgICB9XG5cbiAgICBfZXhlY3V0ZUNvbW1hbmQgKGFyZ3MsIHRlc3RSdW4sIGNhbGxzaXRlKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdFByb21pc2UgPSBzdXBlci5fZXhlY3V0ZUNvbW1hbmQoYXJncywgdGVzdFJ1biwgY2FsbHNpdGUpO1xuXG4gICAgICAgIHRoaXMuX2FkZEJvdW5kQXJnc1NlbGVjdG9yR2V0dGVyKHJlc3VsdFByb21pc2UsIGFyZ3MpO1xuXG4gICAgICAgIC8vIE9QVElNSVpBVElPTjogdXNlIGJ1ZmZlciBmdW5jdGlvbiBhcyBzZWxlY3RvciBub3QgdG8gdHJpZ2dlciBsYXp5IHByb3BlcnR5IGFoZWFkIG9mIHRpbWVcbiAgICAgICAgYWRkQVBJKHJlc3VsdFByb21pc2UsICgpID0+IHJlc3VsdFByb21pc2Uuc2VsZWN0b3IsIFNlbGVjdG9yQnVpbGRlciwgdGhpcy5vcHRpb25zLmN1c3RvbURPTVByb3BlcnRpZXMsIHRoaXMub3B0aW9ucy5jdXN0b21NZXRob2RzKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0UHJvbWlzZTtcbiAgICB9XG5cbiAgICBfZ2V0U291cmNlU2VsZWN0b3JCdWlsZGVyQXBpRm5JRCAoKSB7XG4gICAgICAgIGxldCBzZWxlY3RvckFuY2VzdG9yID0gdGhpcztcblxuICAgICAgICB3aGlsZSAoc2VsZWN0b3JBbmNlc3Rvci5vcHRpb25zLnNvdXJjZVNlbGVjdG9yQnVpbGRlcilcbiAgICAgICAgICAgIHNlbGVjdG9yQW5jZXN0b3IgPSBzZWxlY3RvckFuY2VzdG9yLm9wdGlvbnMuc291cmNlU2VsZWN0b3JCdWlsZGVyO1xuXG4gICAgICAgIHJldHVybiBzZWxlY3RvckFuY2VzdG9yLm9wdGlvbnMuYXBpRm5JRDtcbiAgICB9XG5cbiAgICBnZXRGdW5jdGlvbkRlcGVuZGVuY2llcyAoKSB7XG4gICAgICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IHN1cGVyLmdldEZ1bmN0aW9uRGVwZW5kZW5jaWVzKCk7XG5cbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgZmlsdGVyVmlzaWJsZSxcbiAgICAgICAgICAgIGZpbHRlckhpZGRlbixcbiAgICAgICAgICAgIGNvdW50ZXJNb2RlLFxuICAgICAgICAgICAgY29sbGVjdGlvbk1vZGUsXG4gICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgIGN1c3RvbURPTVByb3BlcnRpZXMsXG4gICAgICAgICAgICBjdXN0b21NZXRob2RzLFxuICAgICAgICAgICAgYXBpRm5DaGFpbixcbiAgICAgICAgICAgIGJvdW5kQXJnc1xuICAgICAgICB9ID0gdGhpcy5vcHRpb25zO1xuXG4gICAgICAgIHJldHVybiBtZXJnZSh7fSwgZGVwZW5kZW5jaWVzLCB7XG4gICAgICAgICAgICBmaWx0ZXJPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgZmlsdGVyVmlzaWJsZSxcbiAgICAgICAgICAgICAgICBmaWx0ZXJIaWRkZW4sXG4gICAgICAgICAgICAgICAgY291bnRlck1vZGUsXG4gICAgICAgICAgICAgICAgY29sbGVjdGlvbk1vZGUsXG4gICAgICAgICAgICAgICAgaW5kZXg6IGlzTnVsbE9yVW5kZWZpbmVkKGluZGV4KSA/IG51bGwgOiBpbmRleFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFwaUluZm86IHtcbiAgICAgICAgICAgICAgICBhcGlGbkNoYWluLFxuICAgICAgICAgICAgICAgIGFwaUZuSUQ6IHRoaXMuX2dldFNvdXJjZVNlbGVjdG9yQnVpbGRlckFwaUZuSUQoKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvdW5kQXJncyxcbiAgICAgICAgICAgIGN1c3RvbURPTVByb3BlcnRpZXMsXG4gICAgICAgICAgICBjdXN0b21NZXRob2RzXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9jcmVhdGVUZXN0UnVuQ29tbWFuZCAoZW5jb2RlZEFyZ3MsIGVuY29kZWREZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBFeGVjdXRlU2VsZWN0b3JDb21tYW5kKHtcbiAgICAgICAgICAgIGluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWU6IHRoaXMuY2FsbHNpdGVOYW1lcy5pbnN0YW50aWF0aW9uLFxuICAgICAgICAgICAgZm5Db2RlOiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21waWxlZEZuQ29kZSxcbiAgICAgICAgICAgIGFyZ3M6ICAgICAgICAgICAgICAgICAgICAgIGVuY29kZWRBcmdzLFxuICAgICAgICAgICAgZGVwZW5kZW5jaWVzOiAgICAgICAgICAgICAgZW5jb2RlZERlcGVuZGVuY2llcyxcbiAgICAgICAgICAgIG5lZWRFcnJvcjogICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5uZWVkRXJyb3IsXG4gICAgICAgICAgICBhcGlGbkNoYWluOiAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuYXBpRm5DaGFpbixcbiAgICAgICAgICAgIHZpc2liaWxpdHlDaGVjazogICAgICAgICAgICEhdGhpcy5vcHRpb25zLnZpc2liaWxpdHlDaGVjayxcbiAgICAgICAgICAgIHRpbWVvdXQ6ICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy50aW1lb3V0XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZU9wdGlvbnMgKG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIuX3ZhbGlkYXRlT3B0aW9ucyhvcHRpb25zKTtcblxuICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKG9wdGlvbnMudmlzaWJpbGl0eUNoZWNrKSlcbiAgICAgICAgICAgIGFzc2VydFR5cGUoaXMuYm9vbGVhbiwgdGhpcy5jYWxsc2l0ZU5hbWVzLmluc3RhbnRpYXRpb24sICdcInZpc2liaWxpdHlDaGVja1wiIG9wdGlvbicsIG9wdGlvbnMudmlzaWJpbGl0eUNoZWNrKTtcblxuICAgICAgICBpZiAoIWlzTnVsbE9yVW5kZWZpbmVkKG9wdGlvbnMudGltZW91dCkpXG4gICAgICAgICAgICBhc3NlcnRUeXBlKGlzLm5vbk5lZ2F0aXZlTnVtYmVyLCB0aGlzLmNhbGxzaXRlTmFtZXMuaW5zdGFudGlhdGlvbiwgJ1widGltZW91dFwiIG9wdGlvbicsIG9wdGlvbnMudGltZW91dCk7XG4gICAgfVxuXG4gICAgX2dldFJlcGxpY2F0b3JUcmFuc2Zvcm1zICgpIHtcbiAgICAgICAgY29uc3QgdHJhbnNmb3JtcyA9IHN1cGVyLl9nZXRSZXBsaWNhdG9yVHJhbnNmb3JtcygpO1xuXG4gICAgICAgIHRyYW5zZm9ybXMucHVzaChuZXcgU2VsZWN0b3JOb2RlVHJhbnNmb3JtKCkpO1xuXG4gICAgICAgIHJldHVybiB0cmFuc2Zvcm1zO1xuICAgIH1cblxuICAgIF9hZGRCb3VuZEFyZ3NTZWxlY3RvckdldHRlciAob2JqLCBzZWxlY3RvckFyZ3MpIHtcbiAgICAgICAgZGVmaW5lTGF6eVByb3BlcnR5KG9iaiwgJ3NlbGVjdG9yJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgYnVpbGRlciA9IG5ldyBTZWxlY3RvckJ1aWxkZXIodGhpcy5nZXRGdW5jdGlvbigpLCB7IGJvdW5kQXJnczogc2VsZWN0b3JBcmdzIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gYnVpbGRlci5nZXRGdW5jdGlvbigpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZGVjb3JhdGVGdW5jdGlvbiAoc2VsZWN0b3JGbikge1xuICAgICAgICBzdXBlci5fZGVjb3JhdGVGdW5jdGlvbihzZWxlY3RvckZuKTtcblxuICAgICAgICBhZGRBUEkoc2VsZWN0b3JGbiwgKCkgPT4gc2VsZWN0b3JGbiwgU2VsZWN0b3JCdWlsZGVyLCB0aGlzLm9wdGlvbnMuY3VzdG9tRE9NUHJvcGVydGllcywgdGhpcy5vcHRpb25zLmN1c3RvbU1ldGhvZHMpO1xuICAgIH1cblxuICAgIF9wcm9jZXNzUmVzdWx0IChyZXN1bHQsIHNlbGVjdG9yQXJncykge1xuICAgICAgICBjb25zdCBzbmFwc2hvdCA9IHN1cGVyLl9wcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2VsZWN0b3JBcmdzKTtcblxuICAgICAgICBpZiAoc25hcHNob3QgJiYgIXRoaXMub3B0aW9ucy5jb3VudGVyTW9kZSkge1xuICAgICAgICAgICAgdGhpcy5fYWRkQm91bmRBcmdzU2VsZWN0b3JHZXR0ZXIoc25hcHNob3QsIHNlbGVjdG9yQXJncyk7XG4gICAgICAgICAgICBjcmVhdGVTbmFwc2hvdE1ldGhvZHMoc25hcHNob3QpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmN1c3RvbU1ldGhvZHMpXG4gICAgICAgICAgICAgICAgYWRkQ3VzdG9tTWV0aG9kcyhzbmFwc2hvdCwgKCkgPT4gc25hcHNob3Quc2VsZWN0b3IsIFNlbGVjdG9yQnVpbGRlciwgdGhpcy5vcHRpb25zLmN1c3RvbU1ldGhvZHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHNuYXBzaG90O1xuICAgIH1cbn1cblxuIl19
