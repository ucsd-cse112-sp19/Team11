'use strict';

exports.__esModule = true;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

exports.default = compileClientFunction;

var _testcafeHammerhead = require('testcafe-hammerhead');

var _testcafeHammerhead2 = _interopRequireDefault(_testcafeHammerhead);

var _asyncToGenerator = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator2 = _interopRequireDefault(_asyncToGenerator);

var _lodash = require('lodash');

var _loadBabelLibs3 = require('./load-babel-libs');

var _loadBabelLibs4 = _interopRequireDefault(_loadBabelLibs3);

var _runtime = require('../errors/runtime');

var _types = require('../errors/types');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ANONYMOUS_FN_RE = /^function\s*\*?\s*\(/;
const ES6_OBJ_METHOD_NAME_RE = /^(\S+?)\s*\(/;
const USE_STRICT_RE = /^('|")use strict('|");?/;
const TRAILING_SEMICOLON_RE = /;\s*$/;
const REGENERATOR_FOOTPRINTS_RE = /(_index\d+\.default|_regenerator\d+\.default|regeneratorRuntime)\.wrap\(function _callee\$\(_context\)/;
const ASYNC_TO_GENERATOR_OUTPUT_CODE = (0, _asyncToGenerator2.default)(_lodash.noop).toString();

const babelArtifactPolyfills = {
    'Promise': {
        re: /_promise(\d+)\.default/,
        getCode: match => `var _promise${match[1]} = { default: Promise };`,
        removeMatchingCode: false
    },

    'Object.keys()': {
        re: /_keys(\d+)\.default/,
        getCode: match => `var _keys${match[1]} = { default: Object.keys };`,
        removeMatchingCode: false
    },

    'JSON.stringify()': {
        re: /_stringify(\d+)\.default/,
        getCode: match => `var _stringify${match[1]} = { default: JSON.stringify };`,
        removeMatchingCode: false
    }
};

function getBabelOptions() {
    var _loadBabelLibs = (0, _loadBabelLibs4.default)();

    const presetFallback = _loadBabelLibs.presetFallback,
          transformForOfAsArray = _loadBabelLibs.transformForOfAsArray;


    return {
        presets: [{ plugins: [transformForOfAsArray] }, presetFallback],
        sourceMaps: false,
        retainLines: true,
        ast: false,
        babelrc: false,
        highlightCode: false
    };
}

function downgradeES(fnCode) {
    var _loadBabelLibs2 = (0, _loadBabelLibs4.default)();

    const babel = _loadBabelLibs2.babel;


    const opts = getBabelOptions();
    const compiled = babel.transform(fnCode, opts);

    return compiled.code.replace(USE_STRICT_RE, '').trim();
}

function addBabelArtifactsPolyfills(fnCode, dependenciesDefinition) {
    let modifiedFnCode = fnCode;

    const polyfills = (0, _values2.default)(babelArtifactPolyfills).reduce((polyfillsCode, polyfill) => {
        const match = fnCode.match(polyfill.re);

        if (match) {
            if (polyfill.removeMatchingCode) modifiedFnCode = modifiedFnCode.replace(polyfill.re, '');

            return polyfillsCode + polyfill.getCode(match);
        }

        return polyfillsCode;
    }, '');

    return `(function(){${dependenciesDefinition}${polyfills} return ${modifiedFnCode}})();`;
}

function getDependenciesDefinition(dependencies) {
    return (0, _keys2.default)(dependencies).reduce((code, name) => {
        return code + `var ${name}=__dependencies$['${name}'];`;
    }, '');
}

function makeFnCodeSuitableForParsing(fnCode) {
    // NOTE: 'function() {}' -> '(function() {})'
    if (ANONYMOUS_FN_RE.test(fnCode)) return `(${fnCode})`;

    // NOTE: 'myFn () {}' -> 'function myFn() {}'
    const match = fnCode.match(ES6_OBJ_METHOD_NAME_RE);

    if (match && match[1] !== 'function') return `function ${fnCode}`;

    return fnCode;
}

function compileClientFunction(fnCode, dependencies, instantiationCallsiteName, compilationCallsiteName) {
    if (fnCode === ASYNC_TO_GENERATOR_OUTPUT_CODE) throw new _runtime.ClientFunctionAPIError(compilationCallsiteName, instantiationCallsiteName, _types.RUNTIME_ERRORS.regeneratorInClientFunctionCode);

    fnCode = makeFnCodeSuitableForParsing(fnCode);

    // NOTE: we need to recompile ES6 code for the browser if we are on newer versions of Node.
    fnCode = downgradeES(fnCode);
    fnCode = _testcafeHammerhead2.default.processScript(fnCode, false);

    // NOTE: check compiled code for regenerator injection: we have either generator
    // recompiled in Node.js 4+ for client or async function declared in function code.
    if (REGENERATOR_FOOTPRINTS_RE.test(fnCode)) throw new _runtime.ClientFunctionAPIError(compilationCallsiteName, instantiationCallsiteName, _types.RUNTIME_ERRORS.regeneratorInClientFunctionCode);

    if (!TRAILING_SEMICOLON_RE.test(fnCode)) fnCode += ';';

    const dependenciesDefinition = dependencies ? getDependenciesDefinition(dependencies) : '';

    return addBabelArtifactsPolyfills(fnCode, dependenciesDefinition);
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21waWxlci9jb21waWxlLWNsaWVudC1mdW5jdGlvbi5qcyJdLCJuYW1lcyI6WyJjb21waWxlQ2xpZW50RnVuY3Rpb24iLCJBTk9OWU1PVVNfRk5fUkUiLCJFUzZfT0JKX01FVEhPRF9OQU1FX1JFIiwiVVNFX1NUUklDVF9SRSIsIlRSQUlMSU5HX1NFTUlDT0xPTl9SRSIsIlJFR0VORVJBVE9SX0ZPT1RQUklOVFNfUkUiLCJBU1lOQ19UT19HRU5FUkFUT1JfT1VUUFVUX0NPREUiLCJub29wIiwidG9TdHJpbmciLCJiYWJlbEFydGlmYWN0UG9seWZpbGxzIiwicmUiLCJnZXRDb2RlIiwibWF0Y2giLCJyZW1vdmVNYXRjaGluZ0NvZGUiLCJnZXRCYWJlbE9wdGlvbnMiLCJwcmVzZXRGYWxsYmFjayIsInRyYW5zZm9ybUZvck9mQXNBcnJheSIsInByZXNldHMiLCJwbHVnaW5zIiwic291cmNlTWFwcyIsInJldGFpbkxpbmVzIiwiYXN0IiwiYmFiZWxyYyIsImhpZ2hsaWdodENvZGUiLCJkb3duZ3JhZGVFUyIsImZuQ29kZSIsImJhYmVsIiwib3B0cyIsImNvbXBpbGVkIiwidHJhbnNmb3JtIiwiY29kZSIsInJlcGxhY2UiLCJ0cmltIiwiYWRkQmFiZWxBcnRpZmFjdHNQb2x5ZmlsbHMiLCJkZXBlbmRlbmNpZXNEZWZpbml0aW9uIiwibW9kaWZpZWRGbkNvZGUiLCJwb2x5ZmlsbHMiLCJyZWR1Y2UiLCJwb2x5ZmlsbHNDb2RlIiwicG9seWZpbGwiLCJnZXREZXBlbmRlbmNpZXNEZWZpbml0aW9uIiwiZGVwZW5kZW5jaWVzIiwibmFtZSIsIm1ha2VGbkNvZGVTdWl0YWJsZUZvclBhcnNpbmciLCJ0ZXN0IiwiaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSIsImNvbXBpbGF0aW9uQ2FsbHNpdGVOYW1lIiwiQ2xpZW50RnVuY3Rpb25BUElFcnJvciIsIlJVTlRJTUVfRVJST1JTIiwicmVnZW5lcmF0b3JJbkNsaWVudEZ1bmN0aW9uQ29kZSIsImhh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cGlsZXIvY29tcGlsZS1jbGllbnQtZnVuY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaGFtbWVyaGVhZCBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcbmltcG9ydCBhc3luY1RvR2VuZXJhdG9yIGZyb20gJ2JhYmVsLXJ1bnRpbWUvaGVscGVycy9hc3luY1RvR2VuZXJhdG9yJztcbmltcG9ydCB7IG5vb3AgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvYWRCYWJlbExpYnMgZnJvbSAnLi9sb2FkLWJhYmVsLWxpYnMnO1xuaW1wb3J0IHsgQ2xpZW50RnVuY3Rpb25BUElFcnJvciB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lJztcbmltcG9ydCB7IFJVTlRJTUVfRVJST1JTIH0gZnJvbSAnLi4vZXJyb3JzL3R5cGVzJztcblxuY29uc3QgQU5PTllNT1VTX0ZOX1JFICAgICAgICAgICAgICAgID0gL15mdW5jdGlvblxccypcXCo/XFxzKlxcKC87XG5jb25zdCBFUzZfT0JKX01FVEhPRF9OQU1FX1JFICAgICAgICAgPSAvXihcXFMrPylcXHMqXFwoLztcbmNvbnN0IFVTRV9TVFJJQ1RfUkUgICAgICAgICAgICAgICAgICA9IC9eKCd8XCIpdXNlIHN0cmljdCgnfFwiKTs/LztcbmNvbnN0IFRSQUlMSU5HX1NFTUlDT0xPTl9SRSAgICAgICAgICA9IC87XFxzKiQvO1xuY29uc3QgUkVHRU5FUkFUT1JfRk9PVFBSSU5UU19SRSAgICAgID0gLyhfaW5kZXhcXGQrXFwuZGVmYXVsdHxfcmVnZW5lcmF0b3JcXGQrXFwuZGVmYXVsdHxyZWdlbmVyYXRvclJ1bnRpbWUpXFwud3JhcFxcKGZ1bmN0aW9uIF9jYWxsZWVcXCRcXChfY29udGV4dFxcKS87XG5jb25zdCBBU1lOQ19UT19HRU5FUkFUT1JfT1VUUFVUX0NPREUgPSBhc3luY1RvR2VuZXJhdG9yKG5vb3ApLnRvU3RyaW5nKCk7XG5cbmNvbnN0IGJhYmVsQXJ0aWZhY3RQb2x5ZmlsbHMgPSB7XG4gICAgJ1Byb21pc2UnOiB7XG4gICAgICAgIHJlOiAgICAgICAgICAgICAgICAgL19wcm9taXNlKFxcZCspXFwuZGVmYXVsdC8sXG4gICAgICAgIGdldENvZGU6ICAgICAgICAgICAgbWF0Y2ggPT4gYHZhciBfcHJvbWlzZSR7bWF0Y2hbMV19ID0geyBkZWZhdWx0OiBQcm9taXNlIH07YCxcbiAgICAgICAgcmVtb3ZlTWF0Y2hpbmdDb2RlOiBmYWxzZVxuICAgIH0sXG5cbiAgICAnT2JqZWN0LmtleXMoKSc6IHtcbiAgICAgICAgcmU6ICAgICAgICAgICAgICAgICAvX2tleXMoXFxkKylcXC5kZWZhdWx0LyxcbiAgICAgICAgZ2V0Q29kZTogICAgICAgICAgICBtYXRjaCA9PiBgdmFyIF9rZXlzJHttYXRjaFsxXX0gPSB7IGRlZmF1bHQ6IE9iamVjdC5rZXlzIH07YCxcbiAgICAgICAgcmVtb3ZlTWF0Y2hpbmdDb2RlOiBmYWxzZVxuICAgIH0sXG5cbiAgICAnSlNPTi5zdHJpbmdpZnkoKSc6IHtcbiAgICAgICAgcmU6ICAgICAgICAgICAgICAgICAvX3N0cmluZ2lmeShcXGQrKVxcLmRlZmF1bHQvLFxuICAgICAgICBnZXRDb2RlOiAgICAgICAgICAgIG1hdGNoID0+IGB2YXIgX3N0cmluZ2lmeSR7bWF0Y2hbMV19ID0geyBkZWZhdWx0OiBKU09OLnN0cmluZ2lmeSB9O2AsXG4gICAgICAgIHJlbW92ZU1hdGNoaW5nQ29kZTogZmFsc2VcbiAgICB9XG59O1xuXG5cbmZ1bmN0aW9uIGdldEJhYmVsT3B0aW9ucyAoKSB7XG4gICAgY29uc3QgeyBwcmVzZXRGYWxsYmFjaywgdHJhbnNmb3JtRm9yT2ZBc0FycmF5IH0gPSBsb2FkQmFiZWxMaWJzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBwcmVzZXRzOiAgICAgICBbeyBwbHVnaW5zOiBbdHJhbnNmb3JtRm9yT2ZBc0FycmF5XSB9LCBwcmVzZXRGYWxsYmFja10sXG4gICAgICAgIHNvdXJjZU1hcHM6ICAgIGZhbHNlLFxuICAgICAgICByZXRhaW5MaW5lczogICB0cnVlLFxuICAgICAgICBhc3Q6ICAgICAgICAgICBmYWxzZSxcbiAgICAgICAgYmFiZWxyYzogICAgICAgZmFsc2UsXG4gICAgICAgIGhpZ2hsaWdodENvZGU6IGZhbHNlXG4gICAgfTtcbn1cblxuZnVuY3Rpb24gZG93bmdyYWRlRVMgKGZuQ29kZSkge1xuICAgIGNvbnN0IHsgYmFiZWwgfSA9IGxvYWRCYWJlbExpYnMoKTtcblxuICAgIGNvbnN0IG9wdHMgICAgID0gZ2V0QmFiZWxPcHRpb25zKCk7XG4gICAgY29uc3QgY29tcGlsZWQgPSBiYWJlbC50cmFuc2Zvcm0oZm5Db2RlLCBvcHRzKTtcblxuICAgIHJldHVybiBjb21waWxlZC5jb2RlXG4gICAgICAgIC5yZXBsYWNlKFVTRV9TVFJJQ1RfUkUsICcnKVxuICAgICAgICAudHJpbSgpO1xufVxuXG5mdW5jdGlvbiBhZGRCYWJlbEFydGlmYWN0c1BvbHlmaWxscyAoZm5Db2RlLCBkZXBlbmRlbmNpZXNEZWZpbml0aW9uKSB7XG4gICAgbGV0IG1vZGlmaWVkRm5Db2RlID0gZm5Db2RlO1xuXG4gICAgY29uc3QgcG9seWZpbGxzID0gT2JqZWN0XG4gICAgICAgIC52YWx1ZXMoYmFiZWxBcnRpZmFjdFBvbHlmaWxscylcbiAgICAgICAgLnJlZHVjZSgocG9seWZpbGxzQ29kZSwgcG9seWZpbGwpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gZm5Db2RlLm1hdGNoKHBvbHlmaWxsLnJlKTtcblxuICAgICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBvbHlmaWxsLnJlbW92ZU1hdGNoaW5nQ29kZSlcbiAgICAgICAgICAgICAgICAgICAgbW9kaWZpZWRGbkNvZGUgPSBtb2RpZmllZEZuQ29kZS5yZXBsYWNlKHBvbHlmaWxsLnJlLCAnJyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gcG9seWZpbGxzQ29kZSArIHBvbHlmaWxsLmdldENvZGUobWF0Y2gpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gcG9seWZpbGxzQ29kZTtcbiAgICAgICAgfSwgJycpO1xuXG4gICAgcmV0dXJuIGAoZnVuY3Rpb24oKXske2RlcGVuZGVuY2llc0RlZmluaXRpb259JHtwb2x5ZmlsbHN9IHJldHVybiAke21vZGlmaWVkRm5Db2RlfX0pKCk7YDtcbn1cblxuZnVuY3Rpb24gZ2V0RGVwZW5kZW5jaWVzRGVmaW5pdGlvbiAoZGVwZW5kZW5jaWVzKSB7XG4gICAgcmV0dXJuIE9iamVjdFxuICAgICAgICAua2V5cyhkZXBlbmRlbmNpZXMpXG4gICAgICAgIC5yZWR1Y2UoKGNvZGUsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBjb2RlICsgYHZhciAke25hbWV9PV9fZGVwZW5kZW5jaWVzJFsnJHtuYW1lfSddO2A7XG4gICAgICAgIH0sICcnKTtcbn1cblxuZnVuY3Rpb24gbWFrZUZuQ29kZVN1aXRhYmxlRm9yUGFyc2luZyAoZm5Db2RlKSB7XG4gICAgLy8gTk9URTogJ2Z1bmN0aW9uKCkge30nIC0+ICcoZnVuY3Rpb24oKSB7fSknXG4gICAgaWYgKEFOT05ZTU9VU19GTl9SRS50ZXN0KGZuQ29kZSkpXG4gICAgICAgIHJldHVybiBgKCR7Zm5Db2RlfSlgO1xuXG4gICAgLy8gTk9URTogJ215Rm4gKCkge30nIC0+ICdmdW5jdGlvbiBteUZuKCkge30nXG4gICAgY29uc3QgbWF0Y2ggPSBmbkNvZGUubWF0Y2goRVM2X09CSl9NRVRIT0RfTkFNRV9SRSk7XG5cbiAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0gIT09ICdmdW5jdGlvbicpXG4gICAgICAgIHJldHVybiBgZnVuY3Rpb24gJHtmbkNvZGV9YDtcblxuICAgIHJldHVybiBmbkNvZGU7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNvbXBpbGVDbGllbnRGdW5jdGlvbiAoZm5Db2RlLCBkZXBlbmRlbmNpZXMsIGluc3RhbnRpYXRpb25DYWxsc2l0ZU5hbWUsIGNvbXBpbGF0aW9uQ2FsbHNpdGVOYW1lKSB7XG4gICAgaWYgKGZuQ29kZSA9PT0gQVNZTkNfVE9fR0VORVJBVE9SX09VVFBVVF9DT0RFKVxuICAgICAgICB0aHJvdyBuZXcgQ2xpZW50RnVuY3Rpb25BUElFcnJvcihjb21waWxhdGlvbkNhbGxzaXRlTmFtZSwgaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgUlVOVElNRV9FUlJPUlMucmVnZW5lcmF0b3JJbkNsaWVudEZ1bmN0aW9uQ29kZSk7XG5cbiAgICBmbkNvZGUgPSBtYWtlRm5Db2RlU3VpdGFibGVGb3JQYXJzaW5nKGZuQ29kZSk7XG5cbiAgICAvLyBOT1RFOiB3ZSBuZWVkIHRvIHJlY29tcGlsZSBFUzYgY29kZSBmb3IgdGhlIGJyb3dzZXIgaWYgd2UgYXJlIG9uIG5ld2VyIHZlcnNpb25zIG9mIE5vZGUuXG4gICAgZm5Db2RlID0gZG93bmdyYWRlRVMoZm5Db2RlKTtcbiAgICBmbkNvZGUgPSBoYW1tZXJoZWFkLnByb2Nlc3NTY3JpcHQoZm5Db2RlLCBmYWxzZSk7XG5cbiAgICAvLyBOT1RFOiBjaGVjayBjb21waWxlZCBjb2RlIGZvciByZWdlbmVyYXRvciBpbmplY3Rpb246IHdlIGhhdmUgZWl0aGVyIGdlbmVyYXRvclxuICAgIC8vIHJlY29tcGlsZWQgaW4gTm9kZS5qcyA0KyBmb3IgY2xpZW50IG9yIGFzeW5jIGZ1bmN0aW9uIGRlY2xhcmVkIGluIGZ1bmN0aW9uIGNvZGUuXG4gICAgaWYgKFJFR0VORVJBVE9SX0ZPT1RQUklOVFNfUkUudGVzdChmbkNvZGUpKVxuICAgICAgICB0aHJvdyBuZXcgQ2xpZW50RnVuY3Rpb25BUElFcnJvcihjb21waWxhdGlvbkNhbGxzaXRlTmFtZSwgaW5zdGFudGlhdGlvbkNhbGxzaXRlTmFtZSwgUlVOVElNRV9FUlJPUlMucmVnZW5lcmF0b3JJbkNsaWVudEZ1bmN0aW9uQ29kZSk7XG5cbiAgICBpZiAoIVRSQUlMSU5HX1NFTUlDT0xPTl9SRS50ZXN0KGZuQ29kZSkpXG4gICAgICAgIGZuQ29kZSArPSAnOyc7XG5cbiAgICBjb25zdCBkZXBlbmRlbmNpZXNEZWZpbml0aW9uID0gZGVwZW5kZW5jaWVzID8gZ2V0RGVwZW5kZW5jaWVzRGVmaW5pdGlvbihkZXBlbmRlbmNpZXMpIDogJyc7XG5cbiAgICByZXR1cm4gYWRkQmFiZWxBcnRpZmFjdHNQb2x5ZmlsbHMoZm5Db2RlLCBkZXBlbmRlbmNpZXNEZWZpbml0aW9uKTtcbn1cbiJdfQ==
