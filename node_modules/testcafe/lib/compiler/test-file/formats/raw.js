'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _base = require('../base');

var _base2 = _interopRequireDefault(_base);

var _runtime = require('../../../errors/runtime');

var _types = require('../../../errors/types');

var _testFile = require('../../../api/structure/test-file');

var _testFile2 = _interopRequireDefault(_testFile);

var _fixture = require('../../../api/structure/fixture');

var _fixture2 = _interopRequireDefault(_fixture);

var _test = require('../../../api/structure/test');

var _test2 = _interopRequireDefault(_test);

var _fromObject = require('../../../test-run/commands/from-object');

var _fromObject2 = _interopRequireDefault(_fromObject);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class RawTestFileCompiler extends _base2.default {
    static _createTestFn(commands) {
        return (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* (t) {
                for (let i = 0; i < commands.length; i++) {
                    const callsite = commands[i] && commands[i].callsite;
                    let command = null;

                    try {
                        command = (0, _fromObject2.default)(commands[i], t.testRun);

                        yield t.testRun.executeCommand(command, callsite);
                    } catch (err) {
                        err.callsite = callsite;
                        throw err;
                    }
                }
            });

            return function (_x) {
                return _ref.apply(this, arguments);
            };
        })();
    }

    static _assignCommonTestingUnitProperties(src, dest) {
        if (src.pageUrl) dest.page(src.pageUrl);

        if (src.authCredentials) dest.httpAuth(src.authCredentials);

        /* eslint-disable no-unused-expressions */
        if (src.only) dest.only;

        if (src.skip) dest.skip;

        if (src.disablePageReloads) dest.disablePageReloads;

        if (src.enablePageReloads) dest.enablePageReloads;
        /* eslint-enable no-unused-expressions */
    }

    static _addTest(testFile, src) {
        const test = new _test2.default(testFile);

        test(src.name, RawTestFileCompiler._createTestFn(src.commands));

        RawTestFileCompiler._assignCommonTestingUnitProperties(src, test);

        if (src.beforeCommands) test.before(RawTestFileCompiler._createTestFn(src.beforeCommands));

        if (src.afterCommands) test.after(RawTestFileCompiler._createTestFn(src.afterCommands));

        return test;
    }

    static _addFixture(testFile, src) {
        const fixture = new _fixture2.default(testFile);

        fixture(src.name);

        RawTestFileCompiler._assignCommonTestingUnitProperties(src, fixture);

        if (src.beforeEachCommands) fixture.beforeEach(RawTestFileCompiler._createTestFn(src.beforeEachCommands));

        if (src.afterEachCommands) fixture.afterEach(RawTestFileCompiler._createTestFn(src.afterEachCommands));

        src.tests.forEach(testSrc => RawTestFileCompiler._addTest(testFile, testSrc));
    }

    _hasTests() {
        return true;
    }

    getSupportedExtension() {
        return '.testcafe';
    }

    compile(code, filename) {
        const testFile = new _testFile2.default(filename);

        let data = null;

        try {
            data = JSON.parse(code);

            data.fixtures.forEach(fixtureSrc => RawTestFileCompiler._addFixture(testFile, fixtureSrc));

            return testFile.getTests();
        } catch (err) {
            throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotParseRawFile, filename, err.toString());
        }
    }
}
exports.default = RawTestFileCompiler;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy9yYXcuanMiXSwibmFtZXMiOlsiUmF3VGVzdEZpbGVDb21waWxlciIsIlRlc3RGaWxlQ29tcGlsZXJCYXNlIiwiX2NyZWF0ZVRlc3RGbiIsImNvbW1hbmRzIiwidCIsImkiLCJsZW5ndGgiLCJjYWxsc2l0ZSIsImNvbW1hbmQiLCJ0ZXN0UnVuIiwiZXhlY3V0ZUNvbW1hbmQiLCJlcnIiLCJfYXNzaWduQ29tbW9uVGVzdGluZ1VuaXRQcm9wZXJ0aWVzIiwic3JjIiwiZGVzdCIsInBhZ2VVcmwiLCJwYWdlIiwiYXV0aENyZWRlbnRpYWxzIiwiaHR0cEF1dGgiLCJvbmx5Iiwic2tpcCIsImRpc2FibGVQYWdlUmVsb2FkcyIsImVuYWJsZVBhZ2VSZWxvYWRzIiwiX2FkZFRlc3QiLCJ0ZXN0RmlsZSIsInRlc3QiLCJUZXN0IiwibmFtZSIsImJlZm9yZUNvbW1hbmRzIiwiYmVmb3JlIiwiYWZ0ZXJDb21tYW5kcyIsImFmdGVyIiwiX2FkZEZpeHR1cmUiLCJmaXh0dXJlIiwiRml4dHVyZSIsImJlZm9yZUVhY2hDb21tYW5kcyIsImJlZm9yZUVhY2giLCJhZnRlckVhY2hDb21tYW5kcyIsImFmdGVyRWFjaCIsInRlc3RzIiwiZm9yRWFjaCIsInRlc3RTcmMiLCJfaGFzVGVzdHMiLCJnZXRTdXBwb3J0ZWRFeHRlbnNpb24iLCJjb21waWxlIiwiY29kZSIsImZpbGVuYW1lIiwiVGVzdEZpbGUiLCJkYXRhIiwiSlNPTiIsInBhcnNlIiwiZml4dHVyZXMiLCJmaXh0dXJlU3JjIiwiZ2V0VGVzdHMiLCJHZW5lcmFsRXJyb3IiLCJSVU5USU1FX0VSUk9SUyIsImNhbm5vdFBhcnNlUmF3RmlsZSIsInRvU3RyaW5nIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVlLE1BQU1BLG1CQUFOLFNBQWtDQyxjQUFs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Q3JCLGNBQU10QixXQUFXLElBQUl1QixrQkFBSixDQUFhRCxRQUFiLENBQWpCOztBQUVBLFlBQUlFLE9BQU8sSUFBWDs7QUFFQSxZQUFJO0FBQ0FBLG1CQUFPQyxLQUFLQyxLQUFMLENBQVdMLElBQVgsQ0FBUDs7QUFFQUcsaUJBQUtHLFFBQUwsQ0FBY1gsT0FBZCxDQUFzQlksY0FBY3BELG9CQUFvQmdDLFdBQXBCLENBQWdDUixRQUFoQyxFQUEwQzRCLFVBQTFDLENBQXBDOztBQUVBLG1CQUFPNUIsU0FBUzZCLFFBQVQsRUFBUDtBQUNILFNBTkQsQ0FPQSxPQUFPMUMsR0FBUCxFQUFZO0FBQ1Isa0JBQU0sSUFBSTJDLHFCQUFKLENBQWlCQyxzQkFBZUMsa0JBQWhDLEVBQW9EVixRQUFwRCxFQUE4RG5DLElBQUk4QyxRQUFKLEVBQTlELENBQU47QUFDSDtBQUNKO0FBakdpRTtrQkFBakR6RCxtQiIsImZpbGUiOiJjb21waWxlci90ZXN0LWZpbGUvZm9ybWF0cy9yYXcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVGVzdEZpbGVDb21waWxlckJhc2UgZnJvbSAnLi4vYmFzZSc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi8uLi8uLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBSVU5USU1FX0VSUk9SUyB9IGZyb20gJy4uLy4uLy4uL2Vycm9ycy90eXBlcyc7XG5pbXBvcnQgVGVzdEZpbGUgZnJvbSAnLi4vLi4vLi4vYXBpL3N0cnVjdHVyZS90ZXN0LWZpbGUnO1xuaW1wb3J0IEZpeHR1cmUgZnJvbSAnLi4vLi4vLi4vYXBpL3N0cnVjdHVyZS9maXh0dXJlJztcbmltcG9ydCBUZXN0IGZyb20gJy4uLy4uLy4uL2FwaS9zdHJ1Y3R1cmUvdGVzdCc7XG5pbXBvcnQgY3JlYXRlQ29tbWFuZEZyb21PYmplY3QgZnJvbSAnLi4vLi4vLi4vdGVzdC1ydW4vY29tbWFuZHMvZnJvbS1vYmplY3QnO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSYXdUZXN0RmlsZUNvbXBpbGVyIGV4dGVuZHMgVGVzdEZpbGVDb21waWxlckJhc2Uge1xuICAgIHN0YXRpYyBfY3JlYXRlVGVzdEZuIChjb21tYW5kcykge1xuICAgICAgICByZXR1cm4gYXN5bmMgdCA9PiB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbW1hbmRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FsbHNpdGUgPSBjb21tYW5kc1tpXSAmJiBjb21tYW5kc1tpXS5jYWxsc2l0ZTtcbiAgICAgICAgICAgICAgICBsZXQgY29tbWFuZCAgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29tbWFuZCA9IGNyZWF0ZUNvbW1hbmRGcm9tT2JqZWN0KGNvbW1hbmRzW2ldLCB0LnRlc3RSdW4pO1xuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHQudGVzdFJ1bi5leGVjdXRlQ29tbWFuZChjb21tYW5kLCBjYWxsc2l0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgZXJyLmNhbGxzaXRlID0gY2FsbHNpdGU7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgc3RhdGljIF9hc3NpZ25Db21tb25UZXN0aW5nVW5pdFByb3BlcnRpZXMgKHNyYywgZGVzdCkge1xuICAgICAgICBpZiAoc3JjLnBhZ2VVcmwpXG4gICAgICAgICAgICBkZXN0LnBhZ2Uoc3JjLnBhZ2VVcmwpO1xuXG4gICAgICAgIGlmIChzcmMuYXV0aENyZWRlbnRpYWxzKVxuICAgICAgICAgICAgZGVzdC5odHRwQXV0aChzcmMuYXV0aENyZWRlbnRpYWxzKTtcblxuICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtZXhwcmVzc2lvbnMgKi9cbiAgICAgICAgaWYgKHNyYy5vbmx5KVxuICAgICAgICAgICAgZGVzdC5vbmx5O1xuXG4gICAgICAgIGlmIChzcmMuc2tpcClcbiAgICAgICAgICAgIGRlc3Quc2tpcDtcblxuICAgICAgICBpZiAoc3JjLmRpc2FibGVQYWdlUmVsb2FkcylcbiAgICAgICAgICAgIGRlc3QuZGlzYWJsZVBhZ2VSZWxvYWRzO1xuXG4gICAgICAgIGlmIChzcmMuZW5hYmxlUGFnZVJlbG9hZHMpXG4gICAgICAgICAgICBkZXN0LmVuYWJsZVBhZ2VSZWxvYWRzO1xuICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC1leHByZXNzaW9ucyAqL1xuICAgIH1cblxuICAgIHN0YXRpYyBfYWRkVGVzdCAodGVzdEZpbGUsIHNyYykge1xuICAgICAgICBjb25zdCB0ZXN0ID0gbmV3IFRlc3QodGVzdEZpbGUpO1xuXG4gICAgICAgIHRlc3Qoc3JjLm5hbWUsIFJhd1Rlc3RGaWxlQ29tcGlsZXIuX2NyZWF0ZVRlc3RGbihzcmMuY29tbWFuZHMpKTtcblxuICAgICAgICBSYXdUZXN0RmlsZUNvbXBpbGVyLl9hc3NpZ25Db21tb25UZXN0aW5nVW5pdFByb3BlcnRpZXMoc3JjLCB0ZXN0KTtcblxuICAgICAgICBpZiAoc3JjLmJlZm9yZUNvbW1hbmRzKVxuICAgICAgICAgICAgdGVzdC5iZWZvcmUoUmF3VGVzdEZpbGVDb21waWxlci5fY3JlYXRlVGVzdEZuKHNyYy5iZWZvcmVDb21tYW5kcykpO1xuXG4gICAgICAgIGlmIChzcmMuYWZ0ZXJDb21tYW5kcylcbiAgICAgICAgICAgIHRlc3QuYWZ0ZXIoUmF3VGVzdEZpbGVDb21waWxlci5fY3JlYXRlVGVzdEZuKHNyYy5hZnRlckNvbW1hbmRzKSk7XG5cbiAgICAgICAgcmV0dXJuIHRlc3Q7XG4gICAgfVxuXG4gICAgc3RhdGljIF9hZGRGaXh0dXJlICh0ZXN0RmlsZSwgc3JjKSB7XG4gICAgICAgIGNvbnN0IGZpeHR1cmUgPSBuZXcgRml4dHVyZSh0ZXN0RmlsZSk7XG5cbiAgICAgICAgZml4dHVyZShzcmMubmFtZSk7XG5cbiAgICAgICAgUmF3VGVzdEZpbGVDb21waWxlci5fYXNzaWduQ29tbW9uVGVzdGluZ1VuaXRQcm9wZXJ0aWVzKHNyYywgZml4dHVyZSk7XG5cbiAgICAgICAgaWYgKHNyYy5iZWZvcmVFYWNoQ29tbWFuZHMpXG4gICAgICAgICAgICBmaXh0dXJlLmJlZm9yZUVhY2goUmF3VGVzdEZpbGVDb21waWxlci5fY3JlYXRlVGVzdEZuKHNyYy5iZWZvcmVFYWNoQ29tbWFuZHMpKTtcblxuICAgICAgICBpZiAoc3JjLmFmdGVyRWFjaENvbW1hbmRzKVxuICAgICAgICAgICAgZml4dHVyZS5hZnRlckVhY2goUmF3VGVzdEZpbGVDb21waWxlci5fY3JlYXRlVGVzdEZuKHNyYy5hZnRlckVhY2hDb21tYW5kcykpO1xuXG4gICAgICAgIHNyYy50ZXN0cy5mb3JFYWNoKHRlc3RTcmMgPT4gUmF3VGVzdEZpbGVDb21waWxlci5fYWRkVGVzdCh0ZXN0RmlsZSwgdGVzdFNyYykpO1xuICAgIH1cblxuICAgIF9oYXNUZXN0cyAoKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGdldFN1cHBvcnRlZEV4dGVuc2lvbiAoKSB7XG4gICAgICAgIHJldHVybiAnLnRlc3RjYWZlJztcbiAgICB9XG5cbiAgICBjb21waWxlIChjb2RlLCBmaWxlbmFtZSkge1xuICAgICAgICBjb25zdCB0ZXN0RmlsZSA9IG5ldyBUZXN0RmlsZShmaWxlbmFtZSk7XG5cbiAgICAgICAgbGV0IGRhdGEgPSBudWxsO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZShjb2RlKTtcblxuICAgICAgICAgICAgZGF0YS5maXh0dXJlcy5mb3JFYWNoKGZpeHR1cmVTcmMgPT4gUmF3VGVzdEZpbGVDb21waWxlci5fYWRkRml4dHVyZSh0ZXN0RmlsZSwgZml4dHVyZVNyYykpO1xuXG4gICAgICAgICAgICByZXR1cm4gdGVzdEZpbGUuZ2V0VGVzdHMoKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLmNhbm5vdFBhcnNlUmF3RmlsZSwgZmlsZW5hbWUsIGVyci50b1N0cmluZygpKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==
