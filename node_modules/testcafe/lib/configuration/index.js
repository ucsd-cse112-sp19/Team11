'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _entries = require('babel-runtime/core-js/object/entries');

var _entries2 = _interopRequireDefault(_entries);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _promisifiedFunctions = require('../utils/promisified-functions');

var _option = require('./option');

var _option2 = _interopRequireDefault(_option);

var _optionSource = require('./option-source');

var _optionSource2 = _interopRequireDefault(_optionSource);

var _lodash = require('lodash');

var _getOptions = require('../utils/get-options');

var _optionNames = require('./option-names');

var _optionNames2 = _interopRequireDefault(_optionNames);

var _getFilterFn = require('../utils/get-filter-fn');

var _getFilterFn2 = _interopRequireDefault(_getFilterFn);

var _resolvePathRelativelyCwd = require('../utils/resolve-path-relatively-cwd');

var _resolvePathRelativelyCwd2 = _interopRequireDefault(_resolvePathRelativelyCwd);

var _json = require('json5');

var _json2 = _interopRequireDefault(_json);

var _renderTemplate = require('../utils/render-template');

var _renderTemplate2 = _interopRequireDefault(_renderTemplate);

var _prepareReporters = require('../utils/prepare-reporters');

var _prepareReporters2 = _interopRequireDefault(_prepareReporters);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _log = require('../cli/log');

var _log2 = _interopRequireDefault(_log);

var _string = require('../utils/string');

var _defaultValues = require('./default-values');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:configuration');

const CONFIGURATION_FILENAME = '.testcaferc.json';

const OPTION_FLAG_NAMES = [_optionNames2.default.skipJsErrors, _optionNames2.default.disablePageReloads, _optionNames2.default.quarantineMode, _optionNames2.default.debugMode, _optionNames2.default.debugOnFail, _optionNames2.default.skipUncaughtErrors, _optionNames2.default.stopOnFirstFail, _optionNames2.default.takeScreenshotsOnFails];

class Configuration {
    constructor() {
        this._options = {};
        this._filePath = (0, _resolvePathRelativelyCwd2.default)(CONFIGURATION_FILENAME);
        this._overridenOptions = [];
    }

    static _fromObj(obj) {
        const result = (0, _create2.default)(null);

        (0, _entries2.default)(obj).forEach(([key, value]) => {
            const option = new _option2.default(key, value);

            result[key] = option;
        });

        return result;
    }

    static _isConfigurationFileExists(path) {
        return (0, _asyncToGenerator3.default)(function* () {
            try {
                yield (0, _promisifiedFunctions.stat)(path);

                return true;
            } catch (error) {
                DEBUG_LOGGER((0, _renderTemplate2.default)(_warningMessage2.default.cannotFindConfigurationFile, path, error.stack));

                return false;
            }
        })();
    }

    static _showConsoleWarning(message) {
        _log2.default.write(message);
    }

    static _showWarningForError(error, warningTemplate, ...args) {
        const message = (0, _renderTemplate2.default)(warningTemplate, ...args);

        Configuration._showConsoleWarning(message);

        DEBUG_LOGGER(message);
        DEBUG_LOGGER(error);
    }

    _load() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!(yield Configuration._isConfigurationFileExists(_this.filePath))) return;

            let configurationFileContent = null;

            try {
                configurationFileContent = yield (0, _promisifiedFunctions.readFile)(_this.filePath);
            } catch (error) {
                Configuration._showWarningForError(error, _warningMessage2.default.cannotReadConfigFile);

                return;
            }

            try {
                const optionsObj = _json2.default.parse(configurationFileContent);

                _this._options = Configuration._fromObj(optionsObj);
            } catch (error) {
                Configuration._showWarningForError(error, _warningMessage2.default.cannotParseConfigFile);

                return;
            }

            yield _this._normalizeOptionsAfterLoad();
        })();
    }

    _normalizeOptionsAfterLoad() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this2._prepareSslOptions();
            _this2._prepareFilterFn();
            _this2._ensureArrayOption(_optionNames2.default.src);
            _this2._ensureArrayOption(_optionNames2.default.browsers);
            _this2._prepareReporters();
        })();
    }

    _ensureArrayOption(name) {
        const options = this._options[name];

        if (!options) return;

        options.value = (0, _lodash.castArray)(options.value);
    }

    _prepareFilterFn() {
        const filterOption = this._ensureOption(_optionNames2.default.filter, null);

        if (!filterOption.value) return;

        if (filterOption.value.testGrep) filterOption.value.testGrep = (0, _getOptions.getGrepOptions)(_optionNames2.default.filterTestGrep, filterOption.value.testGrep);

        if (filterOption.value.fixtureGrep) filterOption.value.fixtureGrep = (0, _getOptions.getGrepOptions)(_optionNames2.default.filterFixtureGrep, filterOption.value.fixtureGrep);

        filterOption.value = (0, _getFilterFn2.default)(filterOption.value);
    }

    _prepareReporters() {
        const reporterOption = this._options[_optionNames2.default.reporter];

        if (!reporterOption) return;

        const optionValue = (0, _lodash.castArray)(reporterOption.value);

        reporterOption.value = (0, _prepareReporters2.default)(optionValue);
    }

    _prepareSslOptions() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const sslOptions = _this3._options[_optionNames2.default.ssl];

            if (!sslOptions) return;

            sslOptions.value = yield (0, _getOptions.getSSLOptions)(sslOptions.value);
        })();
    }

    _ensureOption(name, value, source) {
        let option = null;

        if (name in this._options) option = this._options[name];else {
            option = new _option2.default(name, value, source);

            this._options[name] = option;
        }

        return option;
    }

    _ensureOptionWithValue(name, defaultValue, source) {
        const option = this._ensureOption(name, defaultValue, source);

        if (option.value !== void 0) return;

        option.value = defaultValue;
        option.source = source;
    }

    init(options = {}) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this4._load();
            _this4.mergeOptions(options);
        })();
    }

    mergeOptions(options) {
        (0, _entries2.default)(options).map(([key, value]) => {
            const option = this._ensureOption(key, value, _optionSource2.default.input);

            if (value === void 0) return;

            if (option.value !== value && option.source === _optionSource2.default.configuration) this._overridenOptions.push(key);

            option.value = value;
            option.source = _optionSource2.default.input;
        });
    }

    _prepareFlags() {
        OPTION_FLAG_NAMES.forEach(name => {
            const option = this._ensureOption(name, void 0, _optionSource2.default.configuration);

            option.value = !!option.value;
        });
    }

    _setDefaultValues() {
        this._ensureOptionWithValue(_optionNames2.default.selectorTimeout, _defaultValues.DEFAULT_TIMEOUT.selector, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.assertionTimeout, _defaultValues.DEFAULT_TIMEOUT.assertion, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.pageLoadTimeout, _defaultValues.DEFAULT_TIMEOUT.pageLoad, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.speed, _defaultValues.DEFAULT_SPEED_VALUE, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.appInitDelay, _defaultValues.DEFAULT_APP_INIT_DELAY, _optionSource2.default.configuration);
        this._ensureOptionWithValue(_optionNames2.default.concurrency, _defaultValues.DEFAULT_CONCURRENCY_VALUE, _optionSource2.default.configuration);
    }

    prepare() {
        this._prepareFlags();
        this._setDefaultValues();
    }

    notifyAboutOverridenOptions() {
        if (!this._overridenOptions.length) return;

        const optionsStr = (0, _string.getConcatenatedValuesString)(this._overridenOptions);
        const optionsSuffix = (0, _string.getPluralSuffix)(this._overridenOptions);

        Configuration._showConsoleWarning((0, _renderTemplate2.default)(_warningMessage2.default.configOptionsWereOverriden, optionsStr, optionsSuffix));

        this._overridenOptions = [];
    }

    getOption(key) {
        if (!key) return void 0;

        const option = this._options[key];

        if (!option) return void 0;

        return option.value;
    }

    getOptions() {
        const result = (0, _create2.default)(null);

        (0, _entries2.default)(this._options).forEach(([name, option]) => {
            result[name] = option.value;
        });

        return result;
    }

    clone() {
        return (0, _lodash.cloneDeep)(this);
    }

    get startOptions() {
        const result = {
            hostname: this.getOption('hostname'),
            port1: this.getOption('port1'),
            port2: this.getOption('port2'),
            options: {
                ssl: this.getOption('ssl'),
                developmentMode: this.getOption('developmentMode'),
                retryTestPages: !!this.getOption('retryTestPages')
            }
        };

        if (result.options.retryTestPages) result.options.staticContentCaching = _defaultValues.STATIC_CONTENT_CACHING_SETTINGS;

        return result;
    }

    get filePath() {
        return this._filePath;
    }
}
exports.default = Configuration;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25maWd1cmF0aW9uL2luZGV4LmpzIl0sIm5hbWVzIjpbIkRFQlVHX0xPR0dFUiIsIkNPTkZJR1VSQVRJT05fRklMRU5BTUUiLCJPUFRJT05fRkxBR19OQU1FUyIsIk9QVElPTl9OQU1FUyIsInNraXBKc0Vycm9ycyIsImRpc2FibGVQYWdlUmVsb2FkcyIsInF1YXJhbnRpbmVNb2RlIiwiZGVidWdNb2RlIiwiZGVidWdPbkZhaWwiLCJza2lwVW5jYXVnaHRFcnJvcnMiLCJzdG9wT25GaXJzdEZhaWwiLCJ0YWtlU2NyZWVuc2hvdHNPbkZhaWxzIiwiQ29uZmlndXJhdGlvbiIsImNvbnN0cnVjdG9yIiwiX29wdGlvbnMiLCJfZmlsZVBhdGgiLCJfb3ZlcnJpZGVuT3B0aW9ucyIsIl9mcm9tT2JqIiwib2JqIiwicmVzdWx0IiwiZm9yRWFjaCIsImtleSIsInZhbHVlIiwib3B0aW9uIiwiT3B0aW9uIiwiX2lzQ29uZmlndXJhdGlvbkZpbGVFeGlzdHMiLCJwYXRoIiwiZXJyb3IiLCJXQVJOSU5HX01FU1NBR0VTIiwiY2Fubm90RmluZENvbmZpZ3VyYXRpb25GaWxlIiwic3RhY2siLCJfc2hvd0NvbnNvbGVXYXJuaW5nIiwibWVzc2FnZSIsImxvZyIsIndyaXRlIiwiX3Nob3dXYXJuaW5nRm9yRXJyb3IiLCJ3YXJuaW5nVGVtcGxhdGUiLCJhcmdzIiwiX2xvYWQiLCJmaWxlUGF0aCIsImNvbmZpZ3VyYXRpb25GaWxlQ29udGVudCIsImNhbm5vdFJlYWRDb25maWdGaWxlIiwib3B0aW9uc09iaiIsIkpTT041IiwicGFyc2UiLCJjYW5ub3RQYXJzZUNvbmZpZ0ZpbGUiLCJfbm9ybWFsaXplT3B0aW9uc0FmdGVyTG9hZCIsIl9wcmVwYXJlU3NsT3B0aW9ucyIsIl9wcmVwYXJlRmlsdGVyRm4iLCJfZW5zdXJlQXJyYXlPcHRpb24iLCJzcmMiLCJicm93c2VycyIsIl9wcmVwYXJlUmVwb3J0ZXJzIiwibmFtZSIsIm9wdGlvbnMiLCJmaWx0ZXJPcHRpb24iLCJfZW5zdXJlT3B0aW9uIiwiZmlsdGVyIiwidGVzdEdyZXAiLCJmaWx0ZXJUZXN0R3JlcCIsImZpeHR1cmVHcmVwIiwiZmlsdGVyRml4dHVyZUdyZXAiLCJyZXBvcnRlck9wdGlvbiIsInJlcG9ydGVyIiwib3B0aW9uVmFsdWUiLCJzc2xPcHRpb25zIiwic3NsIiwic291cmNlIiwiX2Vuc3VyZU9wdGlvbldpdGhWYWx1ZSIsImRlZmF1bHRWYWx1ZSIsImluaXQiLCJtZXJnZU9wdGlvbnMiLCJtYXAiLCJvcHRpb25Tb3VyY2UiLCJpbnB1dCIsImNvbmZpZ3VyYXRpb24iLCJwdXNoIiwiX3ByZXBhcmVGbGFncyIsIl9zZXREZWZhdWx0VmFsdWVzIiwic2VsZWN0b3JUaW1lb3V0IiwiREVGQVVMVF9USU1FT1VUIiwic2VsZWN0b3IiLCJhc3NlcnRpb25UaW1lb3V0IiwiYXNzZXJ0aW9uIiwicGFnZUxvYWRUaW1lb3V0IiwicGFnZUxvYWQiLCJzcGVlZCIsIkRFRkFVTFRfU1BFRURfVkFMVUUiLCJhcHBJbml0RGVsYXkiLCJERUZBVUxUX0FQUF9JTklUX0RFTEFZIiwiY29uY3VycmVuY3kiLCJERUZBVUxUX0NPTkNVUlJFTkNZX1ZBTFVFIiwicHJlcGFyZSIsIm5vdGlmeUFib3V0T3ZlcnJpZGVuT3B0aW9ucyIsImxlbmd0aCIsIm9wdGlvbnNTdHIiLCJvcHRpb25zU3VmZml4IiwiY29uZmlnT3B0aW9uc1dlcmVPdmVycmlkZW4iLCJnZXRPcHRpb24iLCJnZXRPcHRpb25zIiwiY2xvbmUiLCJzdGFydE9wdGlvbnMiLCJob3N0bmFtZSIsInBvcnQxIiwicG9ydDIiLCJkZXZlbG9wbWVudE1vZGUiLCJyZXRyeVRlc3RQYWdlcyIsInN0YXRpY0NvbnRlbnRDYWNoaW5nIiwiU1RBVElDX0NPTlRFTlRfQ0FDSElOR19TRVRUSU5HUyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztB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aUYsWUFBUztBQUNMLGVBQU8sdUJBQVUsSUFBVixDQUFQO0FBQ0g7O0FBRUQsUUFBSUMsWUFBSixHQUFvQjtBQUNoQixjQUFNbEYsU0FBUztBQUNYbUYsc0JBQVUsS0FBS0osU0FBTCxDQUFlLFVBQWYsQ0FEQztBQUVYSyxtQkFBVSxLQUFLTCxTQUFMLENBQWUsT0FBZixDQUZDO0FBR1hNLG1CQUFVLEtBQUtOLFNBQUwsQ0FBZSxPQUFmLENBSEM7QUFJWDVDLHFCQUFVO0FBQ05ZLHFCQUFpQixLQUFLZ0MsU0FBTCxDQUFlLEtBQWYsQ0FEWDtBQUVOTyxpQ0FBaUIsS0FBS1AsU0FBTCxDQUFlLGlCQUFmLENBRlg7QUFHTlEsZ0NBQWlCLENBQUMsQ0FBQyxLQUFLUixTQUFMLENBQWUsZ0JBQWY7QUFIYjtBQUpDLFNBQWY7O0FBV0EsWUFBSS9FLE9BQU9tQyxPQUFQLENBQWVvRCxjQUFuQixFQUNJdkYsT0FBT21DLE9BQVAsQ0FBZXFELG9CQUFmLEdBQXNDQyw4Q0FBdEM7O0FBRUosZUFBT3pGLE1BQVA7QUFDSDs7QUFFRCxRQUFJb0IsUUFBSixHQUFnQjtBQUNaLGVBQU8sS0FBS3hCLFNBQVo7QUFDSDtBQTNQOEI7a0JBQWRILGEiLCJmaWxlIjoiY29uZmlndXJhdGlvbi9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgeyBzdGF0LCByZWFkRmlsZSB9IGZyb20gJy4uL3V0aWxzL3Byb21pc2lmaWVkLWZ1bmN0aW9ucyc7XG5pbXBvcnQgT3B0aW9uIGZyb20gJy4vb3B0aW9uJztcbmltcG9ydCBvcHRpb25Tb3VyY2UgZnJvbSAnLi9vcHRpb24tc291cmNlJztcbmltcG9ydCB7IGNsb25lRGVlcCwgY2FzdEFycmF5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGdldFNTTE9wdGlvbnMsIGdldEdyZXBPcHRpb25zIH0gZnJvbSAnLi4vdXRpbHMvZ2V0LW9wdGlvbnMnO1xuaW1wb3J0IE9QVElPTl9OQU1FUyBmcm9tICcuL29wdGlvbi1uYW1lcyc7XG5pbXBvcnQgZ2V0RmlsdGVyRm4gZnJvbSAnLi4vdXRpbHMvZ2V0LWZpbHRlci1mbic7XG5pbXBvcnQgcmVzb2x2ZVBhdGhSZWxhdGl2ZWx5Q3dkIGZyb20gJy4uL3V0aWxzL3Jlc29sdmUtcGF0aC1yZWxhdGl2ZWx5LWN3ZCc7XG5pbXBvcnQgSlNPTjUgZnJvbSAnanNvbjUnO1xuaW1wb3J0IHJlbmRlclRlbXBsYXRlIGZyb20gJy4uL3V0aWxzL3JlbmRlci10ZW1wbGF0ZSc7XG5pbXBvcnQgcHJlcGFyZVJlcG9ydGVycyBmcm9tICcuLi91dGlscy9wcmVwYXJlLXJlcG9ydGVycyc7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2NsaS9sb2cnO1xuaW1wb3J0IHsgZ2V0Q29uY2F0ZW5hdGVkVmFsdWVzU3RyaW5nLCBnZXRQbHVyYWxTdWZmaXggfSBmcm9tICcuLi91dGlscy9zdHJpbmcnO1xuXG5pbXBvcnQge1xuICAgIERFRkFVTFRfVElNRU9VVCxcbiAgICBERUZBVUxUX1NQRUVEX1ZBTFVFLFxuICAgIFNUQVRJQ19DT05URU5UX0NBQ0hJTkdfU0VUVElOR1MsXG4gICAgREVGQVVMVF9BUFBfSU5JVF9ERUxBWSxcbiAgICBERUZBVUxUX0NPTkNVUlJFTkNZX1ZBTFVFXG59IGZyb20gJy4vZGVmYXVsdC12YWx1ZXMnO1xuXG5jb25zdCBERUJVR19MT0dHRVIgPSBkZWJ1ZygndGVzdGNhZmU6Y29uZmlndXJhdGlvbicpO1xuXG5jb25zdCBDT05GSUdVUkFUSU9OX0ZJTEVOQU1FID0gJy50ZXN0Y2FmZXJjLmpzb24nO1xuXG5jb25zdCBPUFRJT05fRkxBR19OQU1FUyA9IFtcbiAgICBPUFRJT05fTkFNRVMuc2tpcEpzRXJyb3JzLFxuICAgIE9QVElPTl9OQU1FUy5kaXNhYmxlUGFnZVJlbG9hZHMsXG4gICAgT1BUSU9OX05BTUVTLnF1YXJhbnRpbmVNb2RlLFxuICAgIE9QVElPTl9OQU1FUy5kZWJ1Z01vZGUsXG4gICAgT1BUSU9OX05BTUVTLmRlYnVnT25GYWlsLFxuICAgIE9QVElPTl9OQU1FUy5za2lwVW5jYXVnaHRFcnJvcnMsXG4gICAgT1BUSU9OX05BTUVTLnN0b3BPbkZpcnN0RmFpbCxcbiAgICBPUFRJT05fTkFNRVMudGFrZVNjcmVlbnNob3RzT25GYWlsc1xuXTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29uZmlndXJhdGlvbiB7XG4gICAgY29uc3RydWN0b3IgKCkge1xuICAgICAgICB0aGlzLl9vcHRpb25zICA9IHt9O1xuICAgICAgICB0aGlzLl9maWxlUGF0aCA9IHJlc29sdmVQYXRoUmVsYXRpdmVseUN3ZChDT05GSUdVUkFUSU9OX0ZJTEVOQU1FKTtcbiAgICAgICAgdGhpcy5fb3ZlcnJpZGVuT3B0aW9ucyA9IFtdO1xuICAgIH1cblxuICAgIHN0YXRpYyBfZnJvbU9iaiAob2JqKSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cbiAgICAgICAgT2JqZWN0LmVudHJpZXMob2JqKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IG5ldyBPcHRpb24oa2V5LCB2YWx1ZSk7XG5cbiAgICAgICAgICAgIHJlc3VsdFtrZXldID0gb3B0aW9uO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHN0YXRpYyBhc3luYyBfaXNDb25maWd1cmF0aW9uRmlsZUV4aXN0cyAocGF0aCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgc3RhdChwYXRoKTtcblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBERUJVR19MT0dHRVIocmVuZGVyVGVtcGxhdGUoV0FSTklOR19NRVNTQUdFUy5jYW5ub3RGaW5kQ29uZmlndXJhdGlvbkZpbGUsIHBhdGgsIGVycm9yLnN0YWNrKSk7XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBfc2hvd0NvbnNvbGVXYXJuaW5nIChtZXNzYWdlKSB7XG4gICAgICAgIGxvZy53cml0ZShtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgX3Nob3dXYXJuaW5nRm9yRXJyb3IgKGVycm9yLCB3YXJuaW5nVGVtcGxhdGUsIC4uLmFyZ3MpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IHJlbmRlclRlbXBsYXRlKHdhcm5pbmdUZW1wbGF0ZSwgLi4uYXJncyk7XG5cbiAgICAgICAgQ29uZmlndXJhdGlvbi5fc2hvd0NvbnNvbGVXYXJuaW5nKG1lc3NhZ2UpO1xuXG4gICAgICAgIERFQlVHX0xPR0dFUihtZXNzYWdlKTtcbiAgICAgICAgREVCVUdfTE9HR0VSKGVycm9yKTtcbiAgICB9XG5cbiAgICBhc3luYyBfbG9hZCAoKSB7XG4gICAgICAgIGlmICghYXdhaXQgQ29uZmlndXJhdGlvbi5faXNDb25maWd1cmF0aW9uRmlsZUV4aXN0cyh0aGlzLmZpbGVQYXRoKSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBsZXQgY29uZmlndXJhdGlvbkZpbGVDb250ZW50ID0gbnVsbDtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uZmlndXJhdGlvbkZpbGVDb250ZW50ID0gYXdhaXQgcmVhZEZpbGUodGhpcy5maWxlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBDb25maWd1cmF0aW9uLl9zaG93V2FybmluZ0ZvckVycm9yKGVycm9yLCBXQVJOSU5HX01FU1NBR0VTLmNhbm5vdFJlYWRDb25maWdGaWxlKTtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnNPYmogPSBKU09ONS5wYXJzZShjb25maWd1cmF0aW9uRmlsZUNvbnRlbnQpO1xuXG4gICAgICAgICAgICB0aGlzLl9vcHRpb25zID0gQ29uZmlndXJhdGlvbi5fZnJvbU9iaihvcHRpb25zT2JqKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIENvbmZpZ3VyYXRpb24uX3Nob3dXYXJuaW5nRm9yRXJyb3IoZXJyb3IsIFdBUk5JTkdfTUVTU0FHRVMuY2Fubm90UGFyc2VDb25maWdGaWxlKTtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fbm9ybWFsaXplT3B0aW9uc0FmdGVyTG9hZCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9ub3JtYWxpemVPcHRpb25zQWZ0ZXJMb2FkICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5fcHJlcGFyZVNzbE9wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5fcHJlcGFyZUZpbHRlckZuKCk7XG4gICAgICAgIHRoaXMuX2Vuc3VyZUFycmF5T3B0aW9uKE9QVElPTl9OQU1FUy5zcmMpO1xuICAgICAgICB0aGlzLl9lbnN1cmVBcnJheU9wdGlvbihPUFRJT05fTkFNRVMuYnJvd3NlcnMpO1xuICAgICAgICB0aGlzLl9wcmVwYXJlUmVwb3J0ZXJzKCk7XG4gICAgfVxuXG4gICAgX2Vuc3VyZUFycmF5T3B0aW9uIChuYW1lKSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLl9vcHRpb25zW25hbWVdO1xuXG4gICAgICAgIGlmICghb3B0aW9ucylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBvcHRpb25zLnZhbHVlID0gY2FzdEFycmF5KG9wdGlvbnMudmFsdWUpO1xuICAgIH1cblxuICAgIF9wcmVwYXJlRmlsdGVyRm4gKCkge1xuICAgICAgICBjb25zdCBmaWx0ZXJPcHRpb24gPSB0aGlzLl9lbnN1cmVPcHRpb24oT1BUSU9OX05BTUVTLmZpbHRlciwgbnVsbCk7XG5cbiAgICAgICAgaWYgKCFmaWx0ZXJPcHRpb24udmFsdWUpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgaWYgKGZpbHRlck9wdGlvbi52YWx1ZS50ZXN0R3JlcClcbiAgICAgICAgICAgIGZpbHRlck9wdGlvbi52YWx1ZS50ZXN0R3JlcCA9IGdldEdyZXBPcHRpb25zKE9QVElPTl9OQU1FUy5maWx0ZXJUZXN0R3JlcCwgZmlsdGVyT3B0aW9uLnZhbHVlLnRlc3RHcmVwKTtcblxuICAgICAgICBpZiAoZmlsdGVyT3B0aW9uLnZhbHVlLmZpeHR1cmVHcmVwKVxuICAgICAgICAgICAgZmlsdGVyT3B0aW9uLnZhbHVlLmZpeHR1cmVHcmVwID0gZ2V0R3JlcE9wdGlvbnMoT1BUSU9OX05BTUVTLmZpbHRlckZpeHR1cmVHcmVwLCBmaWx0ZXJPcHRpb24udmFsdWUuZml4dHVyZUdyZXApO1xuXG4gICAgICAgIGZpbHRlck9wdGlvbi52YWx1ZSA9IGdldEZpbHRlckZuKGZpbHRlck9wdGlvbi52YWx1ZSk7XG4gICAgfVxuXG4gICAgX3ByZXBhcmVSZXBvcnRlcnMgKCkge1xuICAgICAgICBjb25zdCByZXBvcnRlck9wdGlvbiA9IHRoaXMuX29wdGlvbnNbT1BUSU9OX05BTUVTLnJlcG9ydGVyXTtcblxuICAgICAgICBpZiAoIXJlcG9ydGVyT3B0aW9uKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvblZhbHVlID0gY2FzdEFycmF5KHJlcG9ydGVyT3B0aW9uLnZhbHVlKTtcblxuICAgICAgICByZXBvcnRlck9wdGlvbi52YWx1ZSA9IHByZXBhcmVSZXBvcnRlcnMob3B0aW9uVmFsdWUpO1xuICAgIH1cblxuICAgIGFzeW5jIF9wcmVwYXJlU3NsT3B0aW9ucyAoKSB7XG4gICAgICAgIGNvbnN0IHNzbE9wdGlvbnMgPSB0aGlzLl9vcHRpb25zW09QVElPTl9OQU1FUy5zc2xdO1xuXG4gICAgICAgIGlmICghc3NsT3B0aW9ucylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBzc2xPcHRpb25zLnZhbHVlID0gYXdhaXQgZ2V0U1NMT3B0aW9ucyhzc2xPcHRpb25zLnZhbHVlKTtcbiAgICB9XG5cbiAgICBfZW5zdXJlT3B0aW9uIChuYW1lLCB2YWx1ZSwgc291cmNlKSB7XG4gICAgICAgIGxldCBvcHRpb24gPSBudWxsO1xuXG4gICAgICAgIGlmIChuYW1lIGluIHRoaXMuX29wdGlvbnMpXG4gICAgICAgICAgICBvcHRpb24gPSB0aGlzLl9vcHRpb25zW25hbWVdO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG9wdGlvbiA9IG5ldyBPcHRpb24obmFtZSwgdmFsdWUsIHNvdXJjZSk7XG5cbiAgICAgICAgICAgIHRoaXMuX29wdGlvbnNbbmFtZV0gPSBvcHRpb247XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3B0aW9uO1xuICAgIH1cblxuICAgIF9lbnN1cmVPcHRpb25XaXRoVmFsdWUgKG5hbWUsIGRlZmF1bHRWYWx1ZSwgc291cmNlKSB7XG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IHRoaXMuX2Vuc3VyZU9wdGlvbihuYW1lLCBkZWZhdWx0VmFsdWUsIHNvdXJjZSk7XG5cbiAgICAgICAgaWYgKG9wdGlvbi52YWx1ZSAhPT0gdm9pZCAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIG9wdGlvbi52YWx1ZSAgPSBkZWZhdWx0VmFsdWU7XG4gICAgICAgIG9wdGlvbi5zb3VyY2UgPSBzb3VyY2U7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdCAob3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2xvYWQoKTtcbiAgICAgICAgdGhpcy5tZXJnZU9wdGlvbnMob3B0aW9ucyk7XG4gICAgfVxuXG4gICAgbWVyZ2VPcHRpb25zIChvcHRpb25zKSB7XG4gICAgICAgIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMpLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSB0aGlzLl9lbnN1cmVPcHRpb24oa2V5LCB2YWx1ZSwgb3B0aW9uU291cmNlLmlucHV0KTtcblxuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICBpZiAob3B0aW9uLnZhbHVlICE9PSB2YWx1ZSAmJlxuICAgICAgICAgICAgICAgIG9wdGlvbi5zb3VyY2UgPT09IG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKVxuICAgICAgICAgICAgICAgIHRoaXMuX292ZXJyaWRlbk9wdGlvbnMucHVzaChrZXkpO1xuXG4gICAgICAgICAgICBvcHRpb24udmFsdWUgID0gdmFsdWU7XG4gICAgICAgICAgICBvcHRpb24uc291cmNlID0gb3B0aW9uU291cmNlLmlucHV0O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfcHJlcGFyZUZsYWdzICgpIHtcbiAgICAgICAgT1BUSU9OX0ZMQUdfTkFNRVMuZm9yRWFjaChuYW1lID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IHRoaXMuX2Vuc3VyZU9wdGlvbihuYW1lLCB2b2lkIDAsIG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKTtcblxuICAgICAgICAgICAgb3B0aW9uLnZhbHVlID0gISFvcHRpb24udmFsdWU7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9zZXREZWZhdWx0VmFsdWVzICgpIHtcbiAgICAgICAgdGhpcy5fZW5zdXJlT3B0aW9uV2l0aFZhbHVlKE9QVElPTl9OQU1FUy5zZWxlY3RvclRpbWVvdXQsIERFRkFVTFRfVElNRU9VVC5zZWxlY3Rvciwgb3B0aW9uU291cmNlLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgICB0aGlzLl9lbnN1cmVPcHRpb25XaXRoVmFsdWUoT1BUSU9OX05BTUVTLmFzc2VydGlvblRpbWVvdXQsIERFRkFVTFRfVElNRU9VVC5hc3NlcnRpb24sIG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKTtcbiAgICAgICAgdGhpcy5fZW5zdXJlT3B0aW9uV2l0aFZhbHVlKE9QVElPTl9OQU1FUy5wYWdlTG9hZFRpbWVvdXQsIERFRkFVTFRfVElNRU9VVC5wYWdlTG9hZCwgb3B0aW9uU291cmNlLmNvbmZpZ3VyYXRpb24pO1xuICAgICAgICB0aGlzLl9lbnN1cmVPcHRpb25XaXRoVmFsdWUoT1BUSU9OX05BTUVTLnNwZWVkLCBERUZBVUxUX1NQRUVEX1ZBTFVFLCBvcHRpb25Tb3VyY2UuY29uZmlndXJhdGlvbik7XG4gICAgICAgIHRoaXMuX2Vuc3VyZU9wdGlvbldpdGhWYWx1ZShPUFRJT05fTkFNRVMuYXBwSW5pdERlbGF5LCBERUZBVUxUX0FQUF9JTklUX0RFTEFZLCBvcHRpb25Tb3VyY2UuY29uZmlndXJhdGlvbik7XG4gICAgICAgIHRoaXMuX2Vuc3VyZU9wdGlvbldpdGhWYWx1ZShPUFRJT05fTkFNRVMuY29uY3VycmVuY3ksIERFRkFVTFRfQ09OQ1VSUkVOQ1lfVkFMVUUsIG9wdGlvblNvdXJjZS5jb25maWd1cmF0aW9uKTtcbiAgICB9XG5cbiAgICBwcmVwYXJlICgpIHtcbiAgICAgICAgdGhpcy5fcHJlcGFyZUZsYWdzKCk7XG4gICAgICAgIHRoaXMuX3NldERlZmF1bHRWYWx1ZXMoKTtcbiAgICB9XG5cbiAgICBub3RpZnlBYm91dE92ZXJyaWRlbk9wdGlvbnMgKCkge1xuICAgICAgICBpZiAoIXRoaXMuX292ZXJyaWRlbk9wdGlvbnMubGVuZ3RoKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvbnNTdHIgICAgPSBnZXRDb25jYXRlbmF0ZWRWYWx1ZXNTdHJpbmcodGhpcy5fb3ZlcnJpZGVuT3B0aW9ucyk7XG4gICAgICAgIGNvbnN0IG9wdGlvbnNTdWZmaXggPSBnZXRQbHVyYWxTdWZmaXgodGhpcy5fb3ZlcnJpZGVuT3B0aW9ucyk7XG5cbiAgICAgICAgQ29uZmlndXJhdGlvbi5fc2hvd0NvbnNvbGVXYXJuaW5nKHJlbmRlclRlbXBsYXRlKFdBUk5JTkdfTUVTU0FHRVMuY29uZmlnT3B0aW9uc1dlcmVPdmVycmlkZW4sIG9wdGlvbnNTdHIsIG9wdGlvbnNTdWZmaXgpKTtcblxuICAgICAgICB0aGlzLl9vdmVycmlkZW5PcHRpb25zID0gW107XG4gICAgfVxuXG4gICAgZ2V0T3B0aW9uIChrZXkpIHtcbiAgICAgICAgaWYgKCFrZXkpXG4gICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xuXG4gICAgICAgIGNvbnN0IG9wdGlvbiA9IHRoaXMuX29wdGlvbnNba2V5XTtcblxuICAgICAgICBpZiAoIW9wdGlvbilcbiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XG5cbiAgICAgICAgcmV0dXJuIG9wdGlvbi52YWx1ZTtcbiAgICB9XG5cbiAgICBnZXRPcHRpb25zICgpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgICAgICBPYmplY3QuZW50cmllcyh0aGlzLl9vcHRpb25zKS5mb3JFYWNoKChbbmFtZSwgb3B0aW9uXSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W25hbWVdID0gb3B0aW9uLnZhbHVlO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGNsb25lICgpIHtcbiAgICAgICAgcmV0dXJuIGNsb25lRGVlcCh0aGlzKTtcbiAgICB9XG5cbiAgICBnZXQgc3RhcnRPcHRpb25zICgpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICAgICAgaG9zdG5hbWU6IHRoaXMuZ2V0T3B0aW9uKCdob3N0bmFtZScpLFxuICAgICAgICAgICAgcG9ydDE6ICAgIHRoaXMuZ2V0T3B0aW9uKCdwb3J0MScpLFxuICAgICAgICAgICAgcG9ydDI6ICAgIHRoaXMuZ2V0T3B0aW9uKCdwb3J0MicpLFxuICAgICAgICAgICAgb3B0aW9uczogIHtcbiAgICAgICAgICAgICAgICBzc2w6ICAgICAgICAgICAgIHRoaXMuZ2V0T3B0aW9uKCdzc2wnKSxcbiAgICAgICAgICAgICAgICBkZXZlbG9wbWVudE1vZGU6IHRoaXMuZ2V0T3B0aW9uKCdkZXZlbG9wbWVudE1vZGUnKSxcbiAgICAgICAgICAgICAgICByZXRyeVRlc3RQYWdlczogICEhdGhpcy5nZXRPcHRpb24oJ3JldHJ5VGVzdFBhZ2VzJylcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAocmVzdWx0Lm9wdGlvbnMucmV0cnlUZXN0UGFnZXMpXG4gICAgICAgICAgICByZXN1bHQub3B0aW9ucy5zdGF0aWNDb250ZW50Q2FjaGluZyA9IFNUQVRJQ19DT05URU5UX0NBQ0hJTkdfU0VUVElOR1M7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBnZXQgZmlsZVBhdGggKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZmlsZVBhdGg7XG4gICAgfVxufVxuIl19
