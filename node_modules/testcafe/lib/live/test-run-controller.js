'use strict';

exports.__esModule = true;

var _values = require('babel-runtime/core-js/object/values');

var _values2 = _interopRequireDefault(_values);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _testRun = require('./test-run');

var _testRunState = require('./test-run-state');

var _testRunState2 = _interopRequireDefault(_testRunState);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LiveModeTestRunController extends _events2.default {
    constructor() {
        super();

        this.testWrappers = [];
        this.expectedTestCount = 0;
        this._testRunCtor = null;

        this.testRuns = {};
        this.allTestsCompletePromise = _pinkie2.default.resolve();
        this.completeAllRunningTests = _lodash2.default;

        this.on('all-tests-complete', () => this.completeAllRunningTests());
    }

    get TestRunCtor() {
        if (!this._testRunCtor) {
            this._testRunCtor = (0, _testRun.TestRunCtorFactory)({
                created: testRun => this._onTestRunCreated(testRun),
                done: (testRun, forced) => this._onTestRunDone(testRun, forced),
                readyToNext: testRun => this._onTestRunReadyToNext(testRun)
            });
        }

        return this._testRunCtor;
    }

    setExpectedTestCount(testCount) {
        this.expectedTestCount = testCount;
    }

    _getTestRuns() {
        return [].concat(...(0, _values2.default)(this.testRuns));
    }

    run() {
        const readyToNextPromises = [];

        const testRuns = [].concat(...(0, _values2.default)(this.testRuns));

        testRuns.forEach(testRun => {
            if (testRun.finish) {
                readyToNextPromises.push(testRun.readyToNextPromise);
                testRun.finish();
            }
        });

        this.testRuns = {};

        return _pinkie2.default.all(readyToNextPromises);
    }

    stop() {
        this._getTestRuns().forEach(testRun => {
            testRun.stop();
        });
    }

    _getTestWrapper(test) {
        return this.testWrappers.find(w => w.test === test);
    }

    _onTestRunCreated(testRun) {

        this.allTestsCompletePromise = new _pinkie2.default(resolve => {
            this.completeAllRunningTests = resolve;
        });

        const connectionId = testRun.browserConnection.id;

        this.testRuns[connectionId] = this.testRuns[connectionId] || [];

        this.testRuns[connectionId].push(testRun);
    }

    _onTestRunDone(testRun) {
        testRun.state = _testRunState2.default.done;

        const hasRunningTests = this._getTestRuns().some(t => t.state !== _testRunState2.default.done);

        if (!hasRunningTests) this.emit('all-tests-complete');

        const browserTestRuns = this.testRuns[testRun.browserConnection.id];

        testRun.readyToNextPromise = new _pinkie2.default(resolve => {
            testRun.setReadyToNext = resolve;
        });

        if (browserTestRuns.length < this.expectedTestCount || browserTestRuns.some(t => t.state !== _testRunState2.default.done)) return _pinkie2.default.resolve();

        return new _pinkie2.default(resolve => {
            testRun.finish = () => {
                testRun.finish = null;
                testRun.state = _testRunState2.default.done;
                resolve();
            };
        });
    }

    _onTestRunReadyToNext(testRun) {
        testRun.setReadyToNext();
    }
}

exports.default = LiveModeTestRunController;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL3Rlc3QtcnVuLWNvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsiTGl2ZU1vZGVUZXN0UnVuQ29udHJvbGxlciIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwidGVzdFdyYXBwZXJzIiwiZXhwZWN0ZWRUZXN0Q291bnQiLCJfdGVzdFJ1bkN0b3IiLCJ0ZXN0UnVucyIsImFsbFRlc3RzQ29tcGxldGVQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjb21wbGV0ZUFsbFJ1bm5pbmdUZXN0cyIsIm5vb3AiLCJvbiIsIlRlc3RSdW5DdG9yIiwiY3JlYXRlZCIsInRlc3RSdW4iLCJfb25UZXN0UnVuQ3JlYXRlZCIsImRvbmUiLCJmb3JjZWQiLCJfb25UZXN0UnVuRG9uZSIsInJlYWR5VG9OZXh0IiwiX29uVGVzdFJ1blJlYWR5VG9OZXh0Iiwic2V0RXhwZWN0ZWRUZXN0Q291bnQiLCJ0ZXN0Q291bnQiLCJfZ2V0VGVzdFJ1bnMiLCJjb25jYXQiLCJydW4iLCJyZWFkeVRvTmV4dFByb21pc2VzIiwiZm9yRWFjaCIsImZpbmlzaCIsInB1c2giLCJyZWFkeVRvTmV4dFByb21pc2UiLCJhbGwiLCJzdG9wIiwiX2dldFRlc3RXcmFwcGVyIiwidGVzdCIsImZpbmQiLCJ3IiwiY29ubmVjdGlvbklkIiwiYnJvd3NlckNvbm5lY3Rpb24iLCJpZCIsInN0YXRlIiwiVEVTVF9SVU5fU1RBVEUiLCJoYXNSdW5uaW5nVGVzdHMiLCJzb21lIiwidCIsImVtaXQiLCJicm93c2VyVGVzdFJ1bnMiLCJzZXRSZWFkeVRvTmV4dCIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEseUJBQU4sU0FBd0NDLGdCQUF4QyxDQUFxRDtBQUNqREMsa0JBQWU7QUFDWDs7QUFFQSxhQUFLQyxZQUFMLEdBQXlCLEVBQXpCO0FBQ0EsYUFBS0MsaUJBQUwsR0FBeUIsQ0FB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QUFZQyxXQUFXO0FBQ2hETSxvQkFBUWlDLGNBQVIsR0FBeUJ2QyxPQUF6QjtBQUNILFNBRjRCLENBQTdCOztBQUtBLFlBQUlzQyxnQkFBZ0JFLE1BQWhCLEdBQXlCLEtBQUs3QyxpQkFBOUIsSUFBbUQyQyxnQkFBZ0JILElBQWhCLENBQXFCQyxLQUFLQSxFQUFFSixLQUFGLEtBQVlDLHVCQUFlekIsSUFBckQsQ0FBdkQsRUFDSSxPQUFPVCxpQkFBUUMsT0FBUixFQUFQOztBQUVKLGVBQU8sSUFBSUQsZ0JBQUosQ0FBWUMsV0FBVztBQUMxQk0sb0JBQVFjLE1BQVIsR0FBaUIsTUFBTTtBQUNuQmQsd0JBQVFjLE1BQVIsR0FBaUIsSUFBakI7QUFDQWQsd0JBQVEwQixLQUFSLEdBQWlCQyx1QkFBZXpCLElBQWhDO0FBQ0FSO0FBQ0gsYUFKRDtBQUtILFNBTk0sQ0FBUDtBQU9IOztBQUVEWSwwQkFBdUJOLE9BQXZCLEVBQWdDO0FBQzVCQSxnQkFBUWlDLGNBQVI7QUFDSDtBQXhHZ0Q7O2tCQTJHdENoRCx5QiIsImZpbGUiOiJsaXZlL3Rlc3QtcnVuLWNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdwaW5raWUnO1xuaW1wb3J0IG5vb3AgZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFRlc3RSdW5DdG9yRmFjdG9yeSB9IGZyb20gJy4vdGVzdC1ydW4nO1xuaW1wb3J0IFRFU1RfUlVOX1NUQVRFIGZyb20gJy4vdGVzdC1ydW4tc3RhdGUnO1xuXG5jbGFzcyBMaXZlTW9kZVRlc3RSdW5Db250cm9sbGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy50ZXN0V3JhcHBlcnMgICAgICA9IFtdO1xuICAgICAgICB0aGlzLmV4cGVjdGVkVGVzdENvdW50ID0gMDtcbiAgICAgICAgdGhpcy5fdGVzdFJ1bkN0b3IgICAgICA9IG51bGw7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVucyAgICAgICAgICAgICAgICA9IHt9O1xuICAgICAgICB0aGlzLmFsbFRlc3RzQ29tcGxldGVQcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgIHRoaXMuY29tcGxldGVBbGxSdW5uaW5nVGVzdHMgPSBub29wO1xuXG4gICAgICAgIHRoaXMub24oJ2FsbC10ZXN0cy1jb21wbGV0ZScsICgpID0+IHRoaXMuY29tcGxldGVBbGxSdW5uaW5nVGVzdHMoKSk7XG4gICAgfVxuXG4gICAgZ2V0IFRlc3RSdW5DdG9yICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLl90ZXN0UnVuQ3Rvcikge1xuICAgICAgICAgICAgdGhpcy5fdGVzdFJ1bkN0b3IgPSBUZXN0UnVuQ3RvckZhY3Rvcnkoe1xuICAgICAgICAgICAgICAgIGNyZWF0ZWQ6ICAgICB0ZXN0UnVuID0+IHRoaXMuX29uVGVzdFJ1bkNyZWF0ZWQodGVzdFJ1biksXG4gICAgICAgICAgICAgICAgZG9uZTogICAgICAgICh0ZXN0UnVuLCBmb3JjZWQpID0+IHRoaXMuX29uVGVzdFJ1bkRvbmUodGVzdFJ1biwgZm9yY2VkKSxcbiAgICAgICAgICAgICAgICByZWFkeVRvTmV4dDogdGVzdFJ1biA9PiB0aGlzLl9vblRlc3RSdW5SZWFkeVRvTmV4dCh0ZXN0UnVuKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fdGVzdFJ1bkN0b3I7XG4gICAgfVxuXG4gICAgc2V0RXhwZWN0ZWRUZXN0Q291bnQgKHRlc3RDb3VudCkge1xuICAgICAgICB0aGlzLmV4cGVjdGVkVGVzdENvdW50ID0gdGVzdENvdW50O1xuICAgIH1cblxuICAgIF9nZXRUZXN0UnVucyAoKSB7XG4gICAgICAgIHJldHVybiBbXS5jb25jYXQoLi4uT2JqZWN0LnZhbHVlcyh0aGlzLnRlc3RSdW5zKSk7XG4gICAgfVxuXG4gICAgcnVuICgpIHtcbiAgICAgICAgY29uc3QgcmVhZHlUb05leHRQcm9taXNlcyA9IFtdO1xuXG4gICAgICAgIGNvbnN0IHRlc3RSdW5zID0gW10uY29uY2F0KC4uLk9iamVjdC52YWx1ZXModGhpcy50ZXN0UnVucykpO1xuXG4gICAgICAgIHRlc3RSdW5zLmZvckVhY2godGVzdFJ1biA9PiB7XG4gICAgICAgICAgICBpZiAodGVzdFJ1bi5maW5pc2gpIHtcbiAgICAgICAgICAgICAgICByZWFkeVRvTmV4dFByb21pc2VzLnB1c2godGVzdFJ1bi5yZWFkeVRvTmV4dFByb21pc2UpO1xuICAgICAgICAgICAgICAgIHRlc3RSdW4uZmluaXNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bnMgPSB7fTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVhZHlUb05leHRQcm9taXNlcyk7XG4gICAgfVxuXG4gICAgc3RvcCAoKSB7XG4gICAgICAgIHRoaXMuX2dldFRlc3RSdW5zKCkuZm9yRWFjaCh0ZXN0UnVuID0+IHtcbiAgICAgICAgICAgIHRlc3RSdW4uc3RvcCgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZ2V0VGVzdFdyYXBwZXIgKHRlc3QpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVzdFdyYXBwZXJzLmZpbmQodyA9PiB3LnRlc3QgPT09IHRlc3QpO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5DcmVhdGVkICh0ZXN0UnVuKSB7XG5cbiAgICAgICAgdGhpcy5hbGxUZXN0c0NvbXBsZXRlUHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgdGhpcy5jb21wbGV0ZUFsbFJ1bm5pbmdUZXN0cyA9IHJlc29sdmU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IHRlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWQ7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuc1tjb25uZWN0aW9uSWRdID0gdGhpcy50ZXN0UnVuc1tjb25uZWN0aW9uSWRdIHx8IFtdO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bnNbY29ubmVjdGlvbklkXS5wdXNoKHRlc3RSdW4pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5Eb25lICh0ZXN0UnVuKSB7XG4gICAgICAgIHRlc3RSdW4uc3RhdGUgPSBURVNUX1JVTl9TVEFURS5kb25lO1xuXG4gICAgICAgIGNvbnN0IGhhc1J1bm5pbmdUZXN0cyA9IHRoaXMuX2dldFRlc3RSdW5zKCkuc29tZSh0ID0+IHQuc3RhdGUgIT09IFRFU1RfUlVOX1NUQVRFLmRvbmUpO1xuXG4gICAgICAgIGlmICghaGFzUnVubmluZ1Rlc3RzKVxuICAgICAgICAgICAgdGhpcy5lbWl0KCdhbGwtdGVzdHMtY29tcGxldGUnKTtcblxuICAgICAgICBjb25zdCBicm93c2VyVGVzdFJ1bnMgPSB0aGlzLnRlc3RSdW5zW3Rlc3RSdW4uYnJvd3NlckNvbm5lY3Rpb24uaWRdO1xuXG4gICAgICAgIHRlc3RSdW4ucmVhZHlUb05leHRQcm9taXNlID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0ZXN0UnVuLnNldFJlYWR5VG9OZXh0ID0gcmVzb2x2ZTtcbiAgICAgICAgfSk7XG5cblxuICAgICAgICBpZiAoYnJvd3NlclRlc3RSdW5zLmxlbmd0aCA8IHRoaXMuZXhwZWN0ZWRUZXN0Q291bnQgfHwgYnJvd3NlclRlc3RSdW5zLnNvbWUodCA9PiB0LnN0YXRlICE9PSBURVNUX1JVTl9TVEFURS5kb25lKSlcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICB0ZXN0UnVuLmZpbmlzaCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICB0ZXN0UnVuLmZpbmlzaCA9IG51bGw7XG4gICAgICAgICAgICAgICAgdGVzdFJ1bi5zdGF0ZSAgPSBURVNUX1JVTl9TVEFURS5kb25lO1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5SZWFkeVRvTmV4dCAodGVzdFJ1bikge1xuICAgICAgICB0ZXN0UnVuLnNldFJlYWR5VG9OZXh0KCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBMaXZlTW9kZVRlc3RSdW5Db250cm9sbGVyO1xuIl19
