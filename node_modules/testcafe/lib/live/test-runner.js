'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _testRunController = require('./test-run-controller');

var _testRunController2 = _interopRequireDefault(_testRunController);

var _controller = require('./controller');

var _controller2 = _interopRequireDefault(_controller);

var _runner = require('../runner');

var _runner2 = _interopRequireDefault(_runner);

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _parseFileList = require('../utils/parse-file-list');

var _parseFileList2 = _interopRequireDefault(_parseFileList);

var _runtime = require('../errors/runtime');

var _types = require('../errors/types');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class LiveModeRunner extends _runner2.default {
    constructor(proxy, browserConnectionGateway, options) {
        super(proxy, browserConnectionGateway, options);

        /* EVENTS */
        this.TEST_RUN_DONE_EVENT = 'test-run-done';
        this.REQUIRED_MODULE_FOUND_EVENT = 'require-module-found';

        this.stopping = false;
        this.tcRunnerTaskPromise = null;
        this.stopInfiniteWaiting = _lodash.noop;
        this.rejectInfiniteWaiting = _lodash.noop;
        this.preventRunCall = false;
        this.assets = null;

        this.testRunController = new _testRunController2.default();

        this.embeddingOptions({
            TestRunCtor: this.testRunController.TestRunCtor,
            assets: []
        });

        this.controller = this._createController();
    }

    runTests(isFirstRun = false) {
        let runError = null;

        return this._finishPreviousTestRuns().then(() => {
            return this._validateRunnableConfiguration(isFirstRun);
        }).then(() => {
            this.testRunController.setExpectedTestCount(this.liveConfigurationCache.tests.filter(t => !t.skip).length);
        }).then(() => {
            this.tcRunnerTaskPromise = super.run(this.opts);

            return this.tcRunnerTaskPromise;
        }).catch(err => {
            this.setBootstrappingError(null);

            runError = err;
        }).then(() => {
            this.tcRunnerTaskPromise = null;

            this.emit(this.TEST_RUN_DONE_EVENT, { err: runError });
        });
    }

    _validateRunOptions() {
        return super._validateRunOptions().catch(err => {
            this.rejectInfiniteWaiting(err);
        });
    }

    _createRunnableConfiguration() {
        if (this.liveConfigurationCache) return _pinkie2.default.resolve(this.liveConfigurationCache);

        return super._createRunnableConfiguration().then(configuration => {
            this.liveConfigurationCache = configuration;

            return configuration;
        }).catch(err => {
            this.rejectInfiniteWaiting(err);
        });
    }

    setBootstrappingError(err) {
        this.bootstrappingError = err;
    }

    run(options) {
        if (this.preventRunCall) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotRunLiveModeRunnerMultipleTimes);

        this.preventRunCall = true;

        this.opts = (0, _assign2.default)({}, this.opts, options);

        this._setBootstrapperOptions();

        const fileListPromise = (0, _parseFileList2.default)(this.bootstrapper.sources, process.cwd());

        fileListPromise.then(files => this.controller.init(files)).then(() => this._createRunnableConfiguration()).then(() => this.runTests(true));

        return this._waitUntilExit().then(() => {
            return this._dispose();
        }).then(() => {
            this.preventRunCall = false;
        });
    }

    suspend() {
        if (!this.tcRunnerTaskPromise) return _pinkie2.default.resolve();

        this.stopping = true;
        this.testRunController.stop();
        this.tcRunnerTaskPromise.cancel();

        return this.testRunController.allTestsCompletePromise.then(() => {
            this.stopping = false;

            this.emit(this.TEST_RUN_DONE_EVENT, {});
        });
    }

    exit() {
        if (this.tcRunnerTaskPromise) this.tcRunnerTaskPromise.cancel();

        return _pinkie2.default.resolve().then(() => this.stopInfiniteWaiting());
    }

    _finishPreviousTestRuns() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this.liveConfigurationCache.tests) return;

            _this.testRunController.run();
        })();
    }

    _validateRunnableConfiguration(isFirstRun) {
        if (isFirstRun) {
            if (this.bootstrappingError) return _pinkie2.default.reject(this.bootstrappingError);

            return _pinkie2.default.resolve();
        }

        return this.bootstrapper._getTests().then(tests => {
            this.liveConfigurationCache.tests = tests;

            return this.bootstrappingError ? _pinkie2.default.reject(this.bootstrappingError) : _pinkie2.default.resolve();
        });
    }

    _createTask(tests, browserConnectionGroups, proxy, opts) {
        opts.live = true;

        return super._createTask(tests, browserConnectionGroups, proxy, opts);
    }

    _createBootstrapper(browserConnectionGateway) {
        return new _bootstrapper2.default(this, browserConnectionGateway);
    }

    _createController() {
        return new _controller2.default(this);
    }

    _waitUntilExit() {
        return new _pinkie2.default((resolve, reject) => {
            this.stopInfiniteWaiting = resolve;
            this.rejectInfiniteWaiting = reject;
        });
    }

    _disposeAssets(browserSet, reporters, testedApp) {
        this.assets = { browserSet, reporters, testedApp };

        return _pinkie2.default.resolve();
    }

    _dispose() {
        this.controller.dispose();

        if (!this.assets) return _pinkie2.default.resolve();

        var _assets = this.assets;
        const browserSet = _assets.browserSet,
              reporters = _assets.reporters,
              testedApp = _assets.testedApp;


        return super._disposeAssets(browserSet, reporters, testedApp);
    }
}

exports.default = LiveModeRunner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saXZlL3Rlc3QtcnVubmVyLmpzIl0sIm5hbWVzIjpbIkxpdmVNb2RlUnVubmVyIiwiUnVubmVyIiwiY29uc3RydWN0b3IiLCJwcm94eSIsImJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsIm9wdGlvbnMiLCJURVNUX1JVTl9ET05FX0VWRU5UIiwiUkVRVUlSRURfTU9EVUxFX0ZPVU5EX0VWRU5UIiwic3RvcHBpbmciLCJ0Y1J1bm5lclRhc2tQcm9taXNlIiwic3RvcEluZmluaXRlV2FpdGluZyIsIm5vb3AiLCJyZWplY3RJbmZpbml0ZVdhaXRpbmciLCJwcmV2ZW50UnVuQ2FsbCIsImFzc2V0cyIsInRlc3RSdW5Db250cm9sbGVyIiwiTGl2ZU1vZGVUZXN0UnVuQ29udHJvbGxlciIsImVtYmVkZGluZ09wdGlvbnMiLCJUZXN0UnVuQ3RvciIsImNvbnRyb2xsZXIiLCJfY3JlYXRlQ29udHJvbGxlciIsInJ1blRlc3RzIiwiaXNGaXJzdFJ1biIsInJ1bkVycm9yIiwiX2ZpbmlzaFByZXZpb3VzVGVzdFJ1bnMiLCJ0aGVuIiwiX3ZhbGlkYXRlUnVubmFibGVDb25maWd1cmF0aW9uIiwic2V0RXhwZWN0ZWRUZXN0Q291bnQiLCJsaXZlQ29uZmlndXJhdGlvbkNhY2hlIiwidGVzdHMiLCJmaWx0ZXIiLCJ0Iiwic2tpcCIsImxlbmd0aCIsInJ1biIsIm9wdHMiLCJjYXRjaCIsImVyciIsInNldEJvb3RzdHJhcHBpbmdFcnJvciIsImVtaXQiLCJfdmFsaWRhdGVSdW5PcHRpb25zIiwiX2NyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiIsIlByb21pc2UiLCJyZXNvbHZlIiwiY29uZmlndXJhdGlvbiIsImJvb3RzdHJhcHBpbmdFcnJvciIsIkdlbmVyYWxFcnJvciIsIlJVTlRJTUVfRVJST1JTIiwiY2Fubm90UnVuTGl2ZU1vZGVSdW5uZXJNdWx0aXBsZVRpbWVzIiwiX3NldEJvb3RzdHJhcHBlck9wdGlvbnMiLCJmaWxlTGlzdFByb21pc2UiLCJib290c3RyYXBwZXIiLCJzb3VyY2VzIiwicHJvY2VzcyIsImN3ZCIsImZpbGVzIiwiaW5pdCIsIl93YWl0VW50aWxFeGl0IiwiX2Rpc3Bvc2UiLCJzdXNwZW5kIiwic3RvcCIsImNhbmNlbCIsImFsbFRlc3RzQ29tcGxldGVQcm9taXNlIiwiZXhpdCIsInJlamVjdCIsIl9nZXRUZXN0cyIsIl9jcmVhdGVUYXNrIiwiYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMiLCJsaXZlIiwiX2NyZWF0ZUJvb3RzdHJhcHBlciIsIkxpdmVNb2RlQm9vdHN0cmFwcGVyIiwiTGl2ZU1vZGVDb250cm9sbGVyIiwiX2Rpc3Bvc2VBc3NldHMiLCJicm93c2VyU2V0IiwicmVwb3J0ZXJzIiwidGVzdGVkQXBwIiwiZGlzcG9zZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxjQUFOLFNBQTZCQyxnQkFBN0IsQ0FBb0M7QUFDaENDLGdCQUFhQyxLQUFiLEVBQW9CQyx3QkFBcEIsRUFBOENDLE9BQTlDLEVBQXVEO0FBQ25ELGNBQU1GLEtBQU4sRUFBYUMsd0JBQWIsRUFBdUNDLE9BQXZDOztBQUVBO0FBQ0EsYUFBS0MsbUJBQUwsR0FBbUMsZUFBbkM7QUFDQSxhQUFLQywyQkFBTCxHQUFtQyxzQkFBbkM7O0FBRUEsYUFBS0MsUUFBTCxHQUE2QixLQUE3QjtBQUNBLGFBQUtDLG1CQUFMLEdBQTZCLElBQTdCO0FBQ0EsYUFBS0MsbUJBQUwsR0FBNkJDLFlBQTdCO0FBQ0EsYUFBS0MscUJBQUwsR0FBNkJELFlBQTdCO0FBQ0EsYUFBS0UsY0FBTCxHQUE2QixLQUE3QjtBQUNBLGFBQUtDLE1BQUwsR0FBNkIsSUFBN0I7O0FBRUEsYUFBS0MsaUJBQUwsR0FBeUIsSUFBSUMsMkJBQUosRUFBekI7O0FBRUEsYUFBS0MsZ0JBQUwsQ0FBc0I7QUFDbEJDLHlCQUFhLEtBQUtILGlCQUFMLENBQXVCRyxX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QVFSLGVBQU8sTUFBTUgsY0FBTixDQUFxQkMsVUFBckIsRUFBaUNDLFNBQWpDLEVBQTRDQyxTQUE1QyxDQUFQO0FBQ0g7QUE1TCtCOztrQkErTHJCM0UsYyIsImZpbGUiOiJsaXZlL3Rlc3QtcnVubmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCB7IG5vb3AgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IExpdmVNb2RlVGVzdFJ1bkNvbnRyb2xsZXIgZnJvbSAnLi90ZXN0LXJ1bi1jb250cm9sbGVyJztcbmltcG9ydCBMaXZlTW9kZUNvbnRyb2xsZXIgZnJvbSAnLi9jb250cm9sbGVyJztcbmltcG9ydCBSdW5uZXIgZnJvbSAnLi4vcnVubmVyJztcbmltcG9ydCBMaXZlTW9kZUJvb3RzdHJhcHBlciBmcm9tICcuL2Jvb3RzdHJhcHBlcic7XG5pbXBvcnQgcGFyc2VGaWxlTGlzdCBmcm9tICcuLi91dGlscy9wYXJzZS1maWxlLWxpc3QnO1xuaW1wb3J0IHsgR2VuZXJhbEVycm9yIH0gZnJvbSAnLi4vZXJyb3JzL3J1bnRpbWUnO1xuaW1wb3J0IHsgUlVOVElNRV9FUlJPUlMgfSBmcm9tICcuLi9lcnJvcnMvdHlwZXMnO1xuXG5jbGFzcyBMaXZlTW9kZVJ1bm5lciBleHRlbmRzIFJ1bm5lciB7XG4gICAgY29uc3RydWN0b3IgKHByb3h5LCBicm93c2VyQ29ubmVjdGlvbkdhdGV3YXksIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIocHJveHksIGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSwgb3B0aW9ucyk7XG5cbiAgICAgICAgLyogRVZFTlRTICovXG4gICAgICAgIHRoaXMuVEVTVF9SVU5fRE9ORV9FVkVOVCAgICAgICAgID0gJ3Rlc3QtcnVuLWRvbmUnO1xuICAgICAgICB0aGlzLlJFUVVJUkVEX01PRFVMRV9GT1VORF9FVkVOVCA9ICdyZXF1aXJlLW1vZHVsZS1mb3VuZCc7XG5cbiAgICAgICAgdGhpcy5zdG9wcGluZyAgICAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy50Y1J1bm5lclRhc2tQcm9taXNlICAgPSBudWxsO1xuICAgICAgICB0aGlzLnN0b3BJbmZpbml0ZVdhaXRpbmcgICA9IG5vb3A7XG4gICAgICAgIHRoaXMucmVqZWN0SW5maW5pdGVXYWl0aW5nID0gbm9vcDtcbiAgICAgICAgdGhpcy5wcmV2ZW50UnVuQ2FsbCAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hc3NldHMgICAgICAgICAgICAgICAgPSBudWxsO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bkNvbnRyb2xsZXIgPSBuZXcgTGl2ZU1vZGVUZXN0UnVuQ29udHJvbGxlcigpO1xuXG4gICAgICAgIHRoaXMuZW1iZWRkaW5nT3B0aW9ucyh7XG4gICAgICAgICAgICBUZXN0UnVuQ3RvcjogdGhpcy50ZXN0UnVuQ29udHJvbGxlci5UZXN0UnVuQ3RvcixcbiAgICAgICAgICAgIGFzc2V0czogICAgICBbXVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIgPSB0aGlzLl9jcmVhdGVDb250cm9sbGVyKCk7XG4gICAgfVxuXG4gICAgcnVuVGVzdHMgKGlzRmlyc3RSdW4gPSBmYWxzZSkge1xuICAgICAgICBsZXQgcnVuRXJyb3IgPSBudWxsO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9maW5pc2hQcmV2aW91c1Rlc3RSdW5zKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fdmFsaWRhdGVSdW5uYWJsZUNvbmZpZ3VyYXRpb24oaXNGaXJzdFJ1bik7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudGVzdFJ1bkNvbnRyb2xsZXIuc2V0RXhwZWN0ZWRUZXN0Q291bnQodGhpcy5saXZlQ29uZmlndXJhdGlvbkNhY2hlLnRlc3RzLmZpbHRlcih0ID0+ICF0LnNraXApLmxlbmd0aCk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudGNSdW5uZXJUYXNrUHJvbWlzZSA9IHN1cGVyLnJ1bih0aGlzLm9wdHMpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMudGNSdW5uZXJUYXNrUHJvbWlzZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldEJvb3RzdHJhcHBpbmdFcnJvcihudWxsKTtcblxuICAgICAgICAgICAgICAgIHJ1bkVycm9yID0gZXJyO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnRjUnVubmVyVGFza1Byb21pc2UgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KHRoaXMuVEVTVF9SVU5fRE9ORV9FVkVOVCwgeyBlcnI6IHJ1bkVycm9yIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlUnVuT3B0aW9ucyAoKSB7XG4gICAgICAgIHJldHVybiBzdXBlci5fdmFsaWRhdGVSdW5PcHRpb25zKClcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucmVqZWN0SW5maW5pdGVXYWl0aW5nKGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMubGl2ZUNvbmZpZ3VyYXRpb25DYWNoZSlcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5saXZlQ29uZmlndXJhdGlvbkNhY2hlKTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuX2NyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbigpXG4gICAgICAgICAgICAudGhlbihjb25maWd1cmF0aW9uID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmxpdmVDb25maWd1cmF0aW9uQ2FjaGUgPSBjb25maWd1cmF0aW9uO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ3VyYXRpb247XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWplY3RJbmZpbml0ZVdhaXRpbmcoZXJyKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHNldEJvb3RzdHJhcHBpbmdFcnJvciAoZXJyKSB7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGluZ0Vycm9yID0gZXJyO1xuICAgIH1cblxuICAgIHJ1biAob3B0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5wcmV2ZW50UnVuQ2FsbClcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2Fubm90UnVuTGl2ZU1vZGVSdW5uZXJNdWx0aXBsZVRpbWVzKTtcblxuICAgICAgICB0aGlzLnByZXZlbnRSdW5DYWxsID0gdHJ1ZTtcblxuICAgICAgICB0aGlzLm9wdHMgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdHMsIG9wdGlvbnMpO1xuXG4gICAgICAgIHRoaXMuX3NldEJvb3RzdHJhcHBlck9wdGlvbnMoKTtcblxuICAgICAgICBjb25zdCBmaWxlTGlzdFByb21pc2UgPSBwYXJzZUZpbGVMaXN0KHRoaXMuYm9vdHN0cmFwcGVyLnNvdXJjZXMsIHByb2Nlc3MuY3dkKCkpO1xuXG4gICAgICAgIGZpbGVMaXN0UHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oZmlsZXMgPT4gdGhpcy5jb250cm9sbGVyLmluaXQoZmlsZXMpKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uKCkpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLnJ1blRlc3RzKHRydWUpKTtcblxuXG4gICAgICAgIHJldHVybiB0aGlzLl93YWl0VW50aWxFeGl0KClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fZGlzcG9zZSgpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZlbnRSdW5DYWxsID0gZmFsc2U7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBzdXNwZW5kICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnRjUnVubmVyVGFza1Byb21pc2UpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgdGhpcy5zdG9wcGluZyA9IHRydWU7XG4gICAgICAgIHRoaXMudGVzdFJ1bkNvbnRyb2xsZXIuc3RvcCgpO1xuICAgICAgICB0aGlzLnRjUnVubmVyVGFza1Byb21pc2UuY2FuY2VsKCk7XG5cblxuICAgICAgICByZXR1cm4gdGhpcy50ZXN0UnVuQ29udHJvbGxlci5hbGxUZXN0c0NvbXBsZXRlUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RvcHBpbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCh0aGlzLlRFU1RfUlVOX0RPTkVfRVZFTlQsIHt9KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGV4aXQgKCkge1xuICAgICAgICBpZiAodGhpcy50Y1J1bm5lclRhc2tQcm9taXNlKVxuICAgICAgICAgICAgdGhpcy50Y1J1bm5lclRhc2tQcm9taXNlLmNhbmNlbCgpO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zdG9wSW5maW5pdGVXYWl0aW5nKCkpO1xuICAgIH1cblxuICAgIGFzeW5jIF9maW5pc2hQcmV2aW91c1Rlc3RSdW5zICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmxpdmVDb25maWd1cmF0aW9uQ2FjaGUudGVzdHMpIHJldHVybjtcblxuICAgICAgICB0aGlzLnRlc3RSdW5Db250cm9sbGVyLnJ1bigpO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiAoaXNGaXJzdFJ1bikge1xuICAgICAgICBpZiAoaXNGaXJzdFJ1bikge1xuICAgICAgICAgICAgaWYgKHRoaXMuYm9vdHN0cmFwcGluZ0Vycm9yKVxuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCh0aGlzLmJvb3RzdHJhcHBpbmdFcnJvcik7XG5cbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmJvb3RzdHJhcHBlci5fZ2V0VGVzdHMoKVxuICAgICAgICAgICAgLnRoZW4odGVzdHMgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubGl2ZUNvbmZpZ3VyYXRpb25DYWNoZS50ZXN0cyA9IHRlc3RzO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYm9vdHN0cmFwcGluZ0Vycm9yID8gUHJvbWlzZS5yZWplY3QodGhpcy5ib290c3RyYXBwaW5nRXJyb3IpIDogUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfY3JlYXRlVGFzayAodGVzdHMsIGJyb3dzZXJDb25uZWN0aW9uR3JvdXBzLCBwcm94eSwgb3B0cykge1xuICAgICAgICBvcHRzLmxpdmUgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiBzdXBlci5fY3JlYXRlVGFzayh0ZXN0cywgYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMsIHByb3h5LCBvcHRzKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlQm9vdHN0cmFwcGVyIChicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMaXZlTW9kZUJvb3RzdHJhcHBlcih0aGlzLCBicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkpO1xuICAgIH1cblxuICAgIF9jcmVhdGVDb250cm9sbGVyICgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMaXZlTW9kZUNvbnRyb2xsZXIodGhpcyk7XG4gICAgfVxuXG4gICAgX3dhaXRVbnRpbEV4aXQgKCkge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdG9wSW5maW5pdGVXYWl0aW5nICAgPSByZXNvbHZlO1xuICAgICAgICAgICAgdGhpcy5yZWplY3RJbmZpbml0ZVdhaXRpbmcgPSByZWplY3Q7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9kaXNwb3NlQXNzZXRzIChicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCkge1xuICAgICAgICB0aGlzLmFzc2V0cyA9IHsgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHAgfTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgX2Rpc3Bvc2UgKCkge1xuICAgICAgICB0aGlzLmNvbnRyb2xsZXIuZGlzcG9zZSgpO1xuXG4gICAgICAgIGlmICghdGhpcy5hc3NldHMpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAgICAgY29uc3QgeyBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCB9ID0gdGhpcy5hc3NldHM7XG5cbiAgICAgICAgcmV0dXJuIHN1cGVyLl9kaXNwb3NlQXNzZXRzKGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IExpdmVNb2RlUnVubmVyO1xuIl19
