'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _lodash = require('lodash');

var _asyncEventEmitter = require('../utils/async-event-emitter');

var _asyncEventEmitter2 = _interopRequireDefault(_asyncEventEmitter);

var _testRunController = require('./test-run-controller');

var _testRunController2 = _interopRequireDefault(_testRunController);

var _sessionController = require('../test-run/session-controller');

var _sessionController2 = _interopRequireDefault(_sessionController);

var _browserJobResult = require('./browser-job-result');

var _browserJobResult2 = _interopRequireDefault(_browserJobResult);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Browser job
class BrowserJob extends _asyncEventEmitter2.default {
    constructor(tests, browserConnections, proxy, screenshots, warningLog, fixtureHookController, opts) {
        super();

        this.started = false;

        this.total = 0;
        this.passed = 0;
        this.opts = opts;
        this.proxy = proxy;
        this.browserConnections = browserConnections;
        this.screenshots = screenshots;
        this.warningLog = warningLog;
        this.fixtureHookController = fixtureHookController;
        this.result = null;

        this.testRunControllerQueue = tests.map((test, index) => this._createTestRunController(test, index));

        this.completionQueue = [];

        this.connectionErrorListener = error => this._setResult(_browserJobResult2.default.errored, error);

        this.browserConnections.map(bc => bc.once('error', this.connectionErrorListener));
    }

    _createTestRunController(test, index) {
        const testRunController = new _testRunController2.default(test, index + 1, this.proxy, this.screenshots, this.warningLog, this.fixtureHookController, this.opts);

        testRunController.on('test-run-create', testRunInfo => this.emit('test-run-create', testRunInfo));
        testRunController.on('test-run-start', () => this.emit('test-run-start', testRunController.testRun));
        testRunController.on('test-run-ready', () => this.emit('test-run-ready', testRunController));
        testRunController.on('test-run-restart', () => this._onTestRunRestart(testRunController));
        testRunController.on('test-run-before-done', () => this.emit('test-run-before-done', testRunController));
        testRunController.on('test-run-done', () => this._onTestRunDone(testRunController));

        return testRunController;
    }

    _setResult(status, data) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this.result) return;

            _this.result = { status, data };

            _this.browserConnections.forEach(function (bc) {
                return bc.removeListener('error', _this.connectionErrorListener);
            });

            yield _pinkie2.default.all(_this.browserConnections.map(function (bc) {
                return bc.reportJobResult(_this.result.status, _this.result.data);
            }));
        })();
    }

    _addToCompletionQueue(testRunInfo) {
        this.completionQueue.push(testRunInfo);
    }

    _removeFromCompletionQueue(testRunInfo) {
        (0, _lodash.remove)(this.completionQueue, testRunInfo);
    }

    _onTestRunRestart(testRunController) {
        this._removeFromCompletionQueue(testRunController);
        this.testRunControllerQueue.unshift(testRunController);
    }

    _onTestRunDone(testRunController) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this2.total++;

            if (!testRunController.testRun.errs.length) _this2.passed++;

            while (_this2.completionQueue.length && _this2.completionQueue[0].done) {
                testRunController = _this2.completionQueue.shift();

                yield _this2.emit('test-run-done', testRunController.testRun);
            }

            if (!_this2.completionQueue.length && !_this2.hasQueuedTestRuns) {
                if (!_this2.opts.live) _sessionController2.default.closeSession(testRunController.testRun);

                _this2._setResult(_browserJobResult2.default.done, { total: _this2.total, passed: _this2.passed }).then(function () {
                    return _this2.emit('done');
                });
            }
        })();
    }

    // API
    get hasQueuedTestRuns() {
        return !!this.testRunControllerQueue.length;
    }

    popNextTestRunUrl(connection) {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            while (_this3.testRunControllerQueue.length) {
                // NOTE: before hook for test run fixture is currently
                // executing, so test run is temporary blocked
                const isBlocked = _this3.testRunControllerQueue[0].blocked;
                const isConcurrency = _this3.opts.concurrency > 1;
                const hasIncompleteTestRuns = _this3.completionQueue.some(function (controller) {
                    return !controller.done;
                });

                if (isBlocked || hasIncompleteTestRuns && !isConcurrency) break;

                const testRunController = _this3.testRunControllerQueue.shift();

                _this3._addToCompletionQueue(testRunController);

                if (!_this3.started) {
                    _this3.started = true;
                    yield _this3.emit('start');
                }

                const testRunUrl = yield testRunController.start(connection);

                if (testRunUrl) return testRunUrl;
            }

            return null;
        })();
    }

    abort() {
        this.clearListeners();
        this._setResult(_browserJobResult2.default.aborted);
        this.browserConnections.map(bc => bc.removeJob(this));
    }
}
exports.default = BrowserJob;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvYnJvd3Nlci1qb2IuanMiXSwibmFtZXMiOlsiQnJvd3NlckpvYiIsIkFzeW5jRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJ0ZXN0cyIsImJyb3dzZXJDb25uZWN0aW9ucyIsInByb3h5Iiwic2NyZWVuc2hvdHMiLCJ3YXJuaW5nTG9nIiwiZml4dHVyZUhvb2tDb250cm9sbGVyIiwib3B0cyIsInN0YXJ0ZWQiLCJ0b3RhbCIsInBhc3NlZCIsInJlc3VsdCIsInRlc3RSdW5Db250cm9sbGVyUXVldWUiLCJtYXAiLCJ0ZXN0IiwiaW5kZXgiLCJfY3JlYXRlVGVzdFJ1bkNvbnRyb2xsZXIiLCJjb21wbGV0aW9uUXVldWUiLCJjb25uZWN0aW9uRXJyb3JMaXN0ZW5lciIsImVycm9yIiwiX3NldFJlc3VsdCIsIlJFU1VMVCIsImVycm9yZWQiLCJiYyIsIm9uY2UiLCJ0ZXN0UnVuQ29udHJvbGxlciIsIlRlc3RSdW5Db250cm9sbGVyIiwib24iLCJ0ZXN0UnVuSW5mbyIsImVtaXQiLCJ0ZXN0UnVuIiwiX29uVGVzdFJ1blJlc3RhcnQiLCJfb25UZXN0UnVuRG9uZSIsInN0YXR1cyIsImRhdGEiLCJmb3JFYWNoIiwicmVtb3ZlTGlzdGVuZXIiLCJQcm9taXNlIiwiYWxsIiwicmVwb3J0Sm9iUmVzdWx0IiwiX2FkZFRvQ29tcGxldGlvblF1ZXVlIiwicHVzaCIsIl9yZW1vdmVGcm9tQ29tcGxldGlvblF1ZXVlIiwidW5zaGlmdCIsImVycnMiLCJsZW5ndGgiLCJkb25lIiwic2hpZnQiLCJoYXNRdWV1ZWRUZXN0UnVucyIsImxpdmUiLCJTZXNzaW9uQ29udHJvbGxlciIsImNsb3NlU2Vzc2lvbiIsInRoZW4iLCJwb3BOZXh0VGVzdFJ1blVybCIsImNvbm5lY3Rpb24iLCJpc0Jsb2NrZWQiLCJibG9ja2VkIiwiaXNDb25jdXJyZW5jeSIsImNvbmN1cnJlbmN5IiwiaGFzSW5jb21wbGV0ZVRlc3RSdW5zIiwic29tZSIsImNvbnRyb2xsZXIiLCJ0ZXN0UnVuVXJsIiwic3RhcnQiLCJhYm9ydCIsImNsZWFyTGlzdGVuZXJzIiwiYWJvcnRlZCIsInJlbW92ZUpvYiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFHQTtBQUNlLE1BQU1BLFVBQU4sU0FBeUJDLDJCQUF6QixDQUEyQztBQUN0REMsZ0JBQWFDLEtBQWIsRUFBb0JDLGtCQUFwQixFQUF3Q0MsS0FBeEMsRUFBK0NDLFdBQS9DLEVBQTREQyxVQUE1RCxFQUF3RUMscUJBQXhFLEVBQStGQyxJQUEvRixFQUFxRztBQUNqRzs7QUFFQSxhQUFLQyxPQUFMLEdBQWUsS0FBZjs7QUFFQSxhQUFLQyxLQUFMLEdBQTZCLENBQTdCO0FBQ0EsYUFBS0MsTUFBTCxHQUE2QixDQUE3QjtBQUNBLGFBQUtILElBQUwsR0FBNkJBLElBQTdCO0FBQ0EsYUFBS0osS0FBTCxHQUE2QkEsS0FBN0I7QUFDQSxhQUFLRCxrQkFBTCxHQUE2QkEsa0JBQTdCO0FBQ0EsYUFBS0UsV0FBTCxHQUE2QkEsV0FBN0I7QUFDQSxhQUFLQyxVQUFMLEdBQTZCQSxVQUE3QjtBQUNBLGFBQUtDLHFCQUFMLEdBQTZCQSxxQkFBN0I7QUFDQSxhQUFLSyxNQUFMLEdBQTZCLElBQTdCOztBQUVBLGFBQUtDLHNCQUFMLEdBQThCWCxNQUFNWSxHQUFOLENBQVUsQ0FBQ0MsSUFBRCxFQUFPQyxLQUFQLEtBQWlCLEtBQUtDLHdCQUFMLENBQThCRixJQUE5QixFQUFvQ0MsS0FBcEMsQ0FBM0IsQ0FBOUI7O0FBRUEsYUFBS0UsZUFBTCxHQUF1QixFQUF2Qjs7QUFFQSxhQUFLQyx1QkFBTCxHQUErQkMsU0FBUyxLQUFLQyxVQUFMLENBQWdCQywyQkFBT0MsT0FBdkIsRUFBZ0NILEtBQWhDLENBQXhDOztBQUVBLGFBQUtqQixrQkFBTCxDQUF3QlcsR0FBeEIsQ0FBNEJVLE1BQU1BLEdBQUdDLElBQUgsQ0FBUSxPQUFSLEVBQWlCLEtBQUtOLHVCQUF0QixDQUFs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LENBQVUsT0FBVixDQUFOO0FBQ0g7O0FBRUQsc0JBQU1pQyxhQUFhLE1BQU1yQyxrQkFBa0JzQyxLQUFsQixDQUF3QlQsVUFBeEIsQ0FBekI7O0FBRUEsb0JBQUlRLFVBQUosRUFDSSxPQUFPQSxVQUFQO0FBQ1A7O0FBRUQsbUJBQU8sSUFBUDtBQTFCaUM7QUEyQnBDOztBQUVERSxZQUFTO0FBQ0wsYUFBS0MsY0FBTDtBQUNBLGFBQUs3QyxVQUFMLENBQWdCQywyQkFBTzZDLE9BQXZCO0FBQ0EsYUFBS2hFLGtCQUFMLENBQXdCVyxHQUF4QixDQUE0QlUsTUFBTUEsR0FBRzRDLFNBQUgsQ0FBYSxJQUFiLENBQWxDO0FBQ0g7QUEzSHFEO2tCQUFyQ3JFLFUiLCJmaWxlIjoicnVubmVyL2Jyb3dzZXItam9iLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCB7IHJlbW92ZSB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQXN5bmNFdmVudEVtaXR0ZXIgZnJvbSAnLi4vdXRpbHMvYXN5bmMtZXZlbnQtZW1pdHRlcic7XG5pbXBvcnQgVGVzdFJ1bkNvbnRyb2xsZXIgZnJvbSAnLi90ZXN0LXJ1bi1jb250cm9sbGVyJztcbmltcG9ydCBTZXNzaW9uQ29udHJvbGxlciBmcm9tICcuLi90ZXN0LXJ1bi9zZXNzaW9uLWNvbnRyb2xsZXInO1xuaW1wb3J0IFJFU1VMVCBmcm9tICcuL2Jyb3dzZXItam9iLXJlc3VsdCc7XG5cblxuLy8gQnJvd3NlciBqb2JcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEJyb3dzZXJKb2IgZXh0ZW5kcyBBc3luY0V2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IgKHRlc3RzLCBicm93c2VyQ29ubmVjdGlvbnMsIHByb3h5LCBzY3JlZW5zaG90cywgd2FybmluZ0xvZywgZml4dHVyZUhvb2tDb250cm9sbGVyLCBvcHRzKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy50b3RhbCAgICAgICAgICAgICAgICAgPSAwO1xuICAgICAgICB0aGlzLnBhc3NlZCAgICAgICAgICAgICAgICA9IDA7XG4gICAgICAgIHRoaXMub3B0cyAgICAgICAgICAgICAgICAgID0gb3B0cztcbiAgICAgICAgdGhpcy5wcm94eSAgICAgICAgICAgICAgICAgPSBwcm94eTtcbiAgICAgICAgdGhpcy5icm93c2VyQ29ubmVjdGlvbnMgICAgPSBicm93c2VyQ29ubmVjdGlvbnM7XG4gICAgICAgIHRoaXMuc2NyZWVuc2hvdHMgICAgICAgICAgID0gc2NyZWVuc2hvdHM7XG4gICAgICAgIHRoaXMud2FybmluZ0xvZyAgICAgICAgICAgID0gd2FybmluZ0xvZztcbiAgICAgICAgdGhpcy5maXh0dXJlSG9va0NvbnRyb2xsZXIgPSBmaXh0dXJlSG9va0NvbnRyb2xsZXI7XG4gICAgICAgIHRoaXMucmVzdWx0ICAgICAgICAgICAgICAgID0gbnVsbDtcblxuICAgICAgICB0aGlzLnRlc3RSdW5Db250cm9sbGVyUXVldWUgPSB0ZXN0cy5tYXAoKHRlc3QsIGluZGV4KSA9PiB0aGlzLl9jcmVhdGVUZXN0UnVuQ29udHJvbGxlcih0ZXN0LCBpbmRleCkpO1xuXG4gICAgICAgIHRoaXMuY29tcGxldGlvblF1ZXVlID0gW107XG5cbiAgICAgICAgdGhpcy5jb25uZWN0aW9uRXJyb3JMaXN0ZW5lciA9IGVycm9yID0+IHRoaXMuX3NldFJlc3VsdChSRVNVTFQuZXJyb3JlZCwgZXJyb3IpO1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLm1hcChiYyA9PiBiYy5vbmNlKCdlcnJvcicsIHRoaXMuY29ubmVjdGlvbkVycm9yTGlzdGVuZXIpKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlVGVzdFJ1bkNvbnRyb2xsZXIgKHRlc3QsIGluZGV4KSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW5Db250cm9sbGVyID0gbmV3IFRlc3RSdW5Db250cm9sbGVyKHRlc3QsIGluZGV4ICsgMSwgdGhpcy5wcm94eSwgdGhpcy5zY3JlZW5zaG90cywgdGhpcy53YXJuaW5nTG9nLFxuICAgICAgICAgICAgdGhpcy5maXh0dXJlSG9va0NvbnRyb2xsZXIsIHRoaXMub3B0cyk7XG5cbiAgICAgICAgdGVzdFJ1bkNvbnRyb2xsZXIub24oJ3Rlc3QtcnVuLWNyZWF0ZScsIHRlc3RSdW5JbmZvID0+IHRoaXMuZW1pdCgndGVzdC1ydW4tY3JlYXRlJywgdGVzdFJ1bkluZm8pKTtcbiAgICAgICAgdGVzdFJ1bkNvbnRyb2xsZXIub24oJ3Rlc3QtcnVuLXN0YXJ0JywgKCkgPT4gdGhpcy5lbWl0KCd0ZXN0LXJ1bi1zdGFydCcsIHRlc3RSdW5Db250cm9sbGVyLnRlc3RSdW4pKTtcbiAgICAgICAgdGVzdFJ1bkNvbnRyb2xsZXIub24oJ3Rlc3QtcnVuLXJlYWR5JywgKCkgPT4gdGhpcy5lbWl0KCd0ZXN0LXJ1bi1yZWFkeScsIHRlc3RSdW5Db250cm9sbGVyKSk7XG4gICAgICAgIHRlc3RSdW5Db250cm9sbGVyLm9uKCd0ZXN0LXJ1bi1yZXN0YXJ0JywgKCkgPT4gdGhpcy5fb25UZXN0UnVuUmVzdGFydCh0ZXN0UnVuQ29udHJvbGxlcikpO1xuICAgICAgICB0ZXN0UnVuQ29udHJvbGxlci5vbigndGVzdC1ydW4tYmVmb3JlLWRvbmUnLCAoKSA9PiB0aGlzLmVtaXQoJ3Rlc3QtcnVuLWJlZm9yZS1kb25lJywgdGVzdFJ1bkNvbnRyb2xsZXIpKTtcbiAgICAgICAgdGVzdFJ1bkNvbnRyb2xsZXIub24oJ3Rlc3QtcnVuLWRvbmUnLCAoKSA9PiB0aGlzLl9vblRlc3RSdW5Eb25lKHRlc3RSdW5Db250cm9sbGVyKSk7XG5cbiAgICAgICAgcmV0dXJuIHRlc3RSdW5Db250cm9sbGVyO1xuICAgIH1cblxuICAgIGFzeW5jIF9zZXRSZXN1bHQgKHN0YXR1cywgZGF0YSkge1xuICAgICAgICBpZiAodGhpcy5yZXN1bHQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5yZXN1bHQgPSB7IHN0YXR1cywgZGF0YSB9O1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLmZvckVhY2goYmMgPT4gYmMucmVtb3ZlTGlzdGVuZXIoJ2Vycm9yJywgdGhpcy5jb25uZWN0aW9uRXJyb3JMaXN0ZW5lcikpO1xuXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLm1hcChiYyA9PiBiYy5yZXBvcnRKb2JSZXN1bHQodGhpcy5yZXN1bHQuc3RhdHVzLCB0aGlzLnJlc3VsdC5kYXRhKSkpO1xuICAgIH1cblxuICAgIF9hZGRUb0NvbXBsZXRpb25RdWV1ZSAodGVzdFJ1bkluZm8pIHtcbiAgICAgICAgdGhpcy5jb21wbGV0aW9uUXVldWUucHVzaCh0ZXN0UnVuSW5mbyk7XG4gICAgfVxuXG4gICAgX3JlbW92ZUZyb21Db21wbGV0aW9uUXVldWUgKHRlc3RSdW5JbmZvKSB7XG4gICAgICAgIHJlbW92ZSh0aGlzLmNvbXBsZXRpb25RdWV1ZSwgdGVzdFJ1bkluZm8pO1xuICAgIH1cblxuICAgIF9vblRlc3RSdW5SZXN0YXJ0ICh0ZXN0UnVuQ29udHJvbGxlcikge1xuICAgICAgICB0aGlzLl9yZW1vdmVGcm9tQ29tcGxldGlvblF1ZXVlKHRlc3RSdW5Db250cm9sbGVyKTtcbiAgICAgICAgdGhpcy50ZXN0UnVuQ29udHJvbGxlclF1ZXVlLnVuc2hpZnQodGVzdFJ1bkNvbnRyb2xsZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5Eb25lICh0ZXN0UnVuQ29udHJvbGxlcikge1xuICAgICAgICB0aGlzLnRvdGFsKys7XG5cbiAgICAgICAgaWYgKCF0ZXN0UnVuQ29udHJvbGxlci50ZXN0UnVuLmVycnMubGVuZ3RoKVxuICAgICAgICAgICAgdGhpcy5wYXNzZWQrKztcblxuICAgICAgICB3aGlsZSAodGhpcy5jb21wbGV0aW9uUXVldWUubGVuZ3RoICYmIHRoaXMuY29tcGxldGlvblF1ZXVlWzBdLmRvbmUpIHtcbiAgICAgICAgICAgIHRlc3RSdW5Db250cm9sbGVyID0gdGhpcy5jb21wbGV0aW9uUXVldWUuc2hpZnQoKTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0KCd0ZXN0LXJ1bi1kb25lJywgdGVzdFJ1bkNvbnRyb2xsZXIudGVzdFJ1bik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMuY29tcGxldGlvblF1ZXVlLmxlbmd0aCAmJiAhdGhpcy5oYXNRdWV1ZWRUZXN0UnVucykge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm9wdHMubGl2ZSlcbiAgICAgICAgICAgICAgICBTZXNzaW9uQ29udHJvbGxlci5jbG9zZVNlc3Npb24odGVzdFJ1bkNvbnRyb2xsZXIudGVzdFJ1bik7XG5cbiAgICAgICAgICAgIHRoaXNcbiAgICAgICAgICAgICAgICAuX3NldFJlc3VsdChSRVNVTFQuZG9uZSwgeyB0b3RhbDogdGhpcy50b3RhbCwgcGFzc2VkOiB0aGlzLnBhc3NlZCB9KVxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHRoaXMuZW1pdCgnZG9uZScpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFQSVxuICAgIGdldCBoYXNRdWV1ZWRUZXN0UnVucyAoKSB7XG4gICAgICAgIHJldHVybiAhIXRoaXMudGVzdFJ1bkNvbnRyb2xsZXJRdWV1ZS5sZW5ndGg7XG4gICAgfVxuXG4gICAgYXN5bmMgcG9wTmV4dFRlc3RSdW5VcmwgKGNvbm5lY3Rpb24pIHtcbiAgICAgICAgd2hpbGUgKHRoaXMudGVzdFJ1bkNvbnRyb2xsZXJRdWV1ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIE5PVEU6IGJlZm9yZSBob29rIGZvciB0ZXN0IHJ1biBmaXh0dXJlIGlzIGN1cnJlbnRseVxuICAgICAgICAgICAgLy8gZXhlY3V0aW5nLCBzbyB0ZXN0IHJ1biBpcyB0ZW1wb3JhcnkgYmxvY2tlZFxuICAgICAgICAgICAgY29uc3QgaXNCbG9ja2VkICAgICAgICAgICAgID0gdGhpcy50ZXN0UnVuQ29udHJvbGxlclF1ZXVlWzBdLmJsb2NrZWQ7XG4gICAgICAgICAgICBjb25zdCBpc0NvbmN1cnJlbmN5ICAgICAgICAgPSB0aGlzLm9wdHMuY29uY3VycmVuY3kgPiAxO1xuICAgICAgICAgICAgY29uc3QgaGFzSW5jb21wbGV0ZVRlc3RSdW5zID0gdGhpcy5jb21wbGV0aW9uUXVldWUuc29tZShjb250cm9sbGVyID0+ICFjb250cm9sbGVyLmRvbmUpO1xuXG4gICAgICAgICAgICBpZiAoaXNCbG9ja2VkIHx8IGhhc0luY29tcGxldGVUZXN0UnVucyAmJiAhaXNDb25jdXJyZW5jeSlcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY29uc3QgdGVzdFJ1bkNvbnRyb2xsZXIgPSB0aGlzLnRlc3RSdW5Db250cm9sbGVyUXVldWUuc2hpZnQoKTtcblxuICAgICAgICAgICAgdGhpcy5fYWRkVG9Db21wbGV0aW9uUXVldWUodGVzdFJ1bkNvbnRyb2xsZXIpO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMuc3RhcnRlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5lbWl0KCdzdGFydCcpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCB0ZXN0UnVuVXJsID0gYXdhaXQgdGVzdFJ1bkNvbnRyb2xsZXIuc3RhcnQoY29ubmVjdGlvbik7XG5cbiAgICAgICAgICAgIGlmICh0ZXN0UnVuVXJsKVxuICAgICAgICAgICAgICAgIHJldHVybiB0ZXN0UnVuVXJsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgYWJvcnQgKCkge1xuICAgICAgICB0aGlzLmNsZWFyTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuX3NldFJlc3VsdChSRVNVTFQuYWJvcnRlZCk7XG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb25zLm1hcChiYyA9PiBiYy5yZW1vdmVKb2IodGhpcykpO1xuICAgIH1cbn1cbiJdfQ==
