'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _path = require('path');

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _mapReverse = require('map-reverse');

var _mapReverse2 = _interopRequireDefault(_mapReverse);

var _events = require('events');

var _lodash = require('lodash');

var _bootstrapper = require('./bootstrapper');

var _bootstrapper2 = _interopRequireDefault(_bootstrapper);

var _reporter = require('../reporter');

var _reporter2 = _interopRequireDefault(_reporter);

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _runtime = require('../errors/runtime');

var _types = require('../errors/types');

var _typeAssertions = require('../errors/runtime/type-assertions');

var _utils = require('../errors/test-run/utils');

var _detectFfmpeg = require('../utils/detect-ffmpeg');

var _detectFfmpeg2 = _interopRequireDefault(_detectFfmpeg);

var _checkFilePath = require('../utils/check-file-path');

var _checkFilePath2 = _interopRequireDefault(_checkFilePath);

var _handleErrors = require('../utils/handle-errors');

var _optionNames = require('../configuration/option-names');

var _optionNames2 = _interopRequireDefault(_optionNames);

var _flagList = require('../utils/flag-list');

var _flagList2 = _interopRequireDefault(_flagList);

var _prepareReporters = require('../utils/prepare-reporters');

var _prepareReporters2 = _interopRequireDefault(_prepareReporters);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:runner');

class Runner extends _events.EventEmitter {
    constructor(proxy, browserConnectionGateway, configuration) {
        super();

        this.proxy = proxy;
        this.bootstrapper = this._createBootstrapper(browserConnectionGateway);
        this.pendingTaskPromises = [];
        this.configuration = configuration;
        this.isCli = false;

        // NOTE: This code is necessary only for displaying  marketing messages.
        this.reporterPlugings = [];

        this.apiMethodWasCalled = new _flagList2.default({
            initialFlagValue: false,
            flags: [_optionNames2.default.src, _optionNames2.default.browsers, _optionNames2.default.reporter]
        });
    }

    _createBootstrapper(browserConnectionGateway) {
        return new _bootstrapper2.default(browserConnectionGateway);
    }

    _disposeBrowserSet(browserSet) {
        return browserSet.dispose().catch(e => DEBUG_LOGGER(e));
    }

    _disposeReporters(reporters) {
        return _pinkie2.default.all(reporters.map(reporter => reporter.dispose().catch(e => DEBUG_LOGGER(e))));
    }

    _disposeTestedApp(testedApp) {
        return testedApp ? testedApp.kill().catch(e => DEBUG_LOGGER(e)) : _pinkie2.default.resolve();
    }

    _disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.abort();
            task.clearListeners();

            yield _this._disposeAssets(browserSet, reporters, testedApp);
        })();
    }

    _disposeAssets(browserSet, reporters, testedApp) {
        return _pinkie2.default.all([this._disposeBrowserSet(browserSet), this._disposeReporters(reporters), this._disposeTestedApp(testedApp)]);
    }

    _prepareArrayParameter(array) {
        array = (0, _lodash.flattenDeep)(array);

        if (this.isCli) return array.length === 0 ? void 0 : array;

        return array;
    }

    _createCancelablePromise(taskPromise) {
        const promise = taskPromise.then(({ completionPromise }) => completionPromise);
        const removeFromPending = () => (0, _lodash.pull)(this.pendingTaskPromises, promise);

        promise.then(removeFromPending).catch(removeFromPending);

        promise.cancel = () => taskPromise.then(({ cancelTask }) => cancelTask()).then(removeFromPending);

        this.pendingTaskPromises.push(promise);
        return promise;
    }

    // Run task
    _getFailedTestCount(task, reporter) {
        let failedTestCount = reporter.testCount - reporter.passed;

        if (task.opts.stopOnFirstFail && !!failedTestCount) failedTestCount = 1;

        return failedTestCount;
    }

    _getTaskResult(task, browserSet, reporters, testedApp) {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            task.on('browser-job-done', function (job) {
                return browserSet.releaseConnection(job.browserConnection);
            });

            const browserSetErrorPromise = (0, _promisifyEvent2.default)(browserSet, 'error');

            const taskDonePromise = task.once('done').then(function () {
                return browserSetErrorPromise.cancel();
            });

            const promises = [taskDonePromise, browserSetErrorPromise];

            if (testedApp) promises.push(testedApp.errorPromise);

            try {
                yield _pinkie2.default.race(promises);
            } catch (err) {
                yield _this2._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);

                throw err;
            }

            yield _this2._disposeAssets(browserSet, reporters, testedApp);

            return _this2._getFailedTestCount(task, reporters[0]);
        })();
    }

    _createTask(tests, browserConnectionGroups, proxy, opts) {
        return new _task2.default(tests, browserConnectionGroups, proxy, opts);
    }

    _runTask(reporterPlugins, browserSet, tests, testedApp) {
        var _this3 = this;

        let completed = false;
        const task = this._createTask(tests, browserSet.browserConnectionGroups, this.proxy, this.configuration.getOptions());
        const reporters = reporterPlugins.map(reporter => new _reporter2.default(reporter.plugin, task, reporter.outStream));
        const completionPromise = this._getTaskResult(task, browserSet, reporters, testedApp);

        task.on('start', _handleErrors.startHandlingTestErrors);

        if (!this.configuration.getOption(_optionNames2.default.skipUncaughtErrors)) {
            task.once('test-run-start', _handleErrors.addRunningTest);
            task.once('test-run-done', _handleErrors.removeRunningTest);
        }

        task.on('done', _handleErrors.stopHandlingTestErrors);

        const setCompleted = () => {
            completed = true;
        };

        completionPromise.then(setCompleted).catch(setCompleted);

        const cancelTask = (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* () {
                if (!completed) yield _this3._disposeTaskAndRelatedAssets(task, browserSet, reporters, testedApp);
            });

            return function cancelTask() {
                return _ref.apply(this, arguments);
            };
        })();

        return { completionPromise, cancelTask };
    }

    _registerAssets(assets) {
        assets.forEach(asset => this.proxy.GET(asset.path, asset.info));
    }

    _validateSpeedOption() {
        const speed = this.configuration.getOption(_optionNames2.default.speed);

        if (speed === void 0) return;

        if (typeof speed !== 'number' || isNaN(speed) || speed < 0.01 || speed > 1) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.invalidSpeedValue);
    }

    _validateConcurrencyOption() {
        const concurrency = this.configuration.getOption(_optionNames2.default.concurrency);

        if (concurrency === void 0) return;

        if (typeof concurrency !== 'number' || isNaN(concurrency) || concurrency < 1) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.invalidConcurrencyFactor);
    }

    _validateProxyBypassOption() {
        let proxyBypass = this.configuration.getOption(_optionNames2.default.proxyBypass);

        if (proxyBypass === void 0) return;

        (0, _typeAssertions.assertType)([_typeAssertions.is.string, _typeAssertions.is.array], null, '"proxyBypass" argument', proxyBypass);

        if (typeof proxyBypass === 'string') proxyBypass = [proxyBypass];

        proxyBypass = proxyBypass.reduce((arr, rules) => {
            (0, _typeAssertions.assertType)(_typeAssertions.is.string, null, '"proxyBypass" argument', rules);

            return arr.concat(rules.split(','));
        }, []);

        this.configuration.mergeOptions({ proxyBypass });
    }

    _validateScreenshotOptions() {
        const screenshotPath = this.configuration.getOption(_optionNames2.default.screenshotPath);
        const screenshotPathPattern = this.configuration.getOption(_optionNames2.default.screenshotPathPattern);

        if (screenshotPath) {
            this._validateScreenshotPath(screenshotPath, 'screenshots base directory path');

            this.configuration.mergeOptions({ [_optionNames2.default.screenshotPath]: (0, _path.resolve)(screenshotPath) });
        }

        if (screenshotPathPattern) this._validateScreenshotPath(screenshotPathPattern, 'screenshots path pattern');

        if (!screenshotPath && screenshotPathPattern) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotUseScreenshotPathPatternWithoutBaseScreenshotPathSpecified);
    }

    _validateVideoOptions() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const videoPath = _this4.configuration.getOption(_optionNames2.default.videoPath);
            const videoEncodingOptions = _this4.configuration.getOption(_optionNames2.default.videoEncodingOptions);

            let videoOptions = _this4.configuration.getOption(_optionNames2.default.videoOptions);

            if (!videoPath) {
                if (videoOptions || videoEncodingOptions) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotSetVideoOptionsWithoutBaseVideoPathSpecified);

                return;
            }

            _this4.configuration.mergeOptions({ [_optionNames2.default.videoPath]: (0, _path.resolve)(videoPath) });

            if (!videoOptions) {
                videoOptions = {};

                _this4.configuration.mergeOptions({ [_optionNames2.default.videoOptions]: videoOptions });
            }

            if (videoOptions.ffmpegPath) videoOptions.ffmpegPath = (0, _path.resolve)(videoOptions.ffmpegPath);else videoOptions.ffmpegPath = yield (0, _detectFfmpeg2.default)();

            if (!videoOptions.ffmpegPath) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.cannotFindFFMPEG);
        })();
    }

    _validateRunOptions() {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this5._validateScreenshotOptions();
            yield _this5._validateVideoOptions();
            _this5._validateSpeedOption();
            _this5._validateConcurrencyOption();
            _this5._validateProxyBypassOption();
        })();
    }

    _createRunnableConfiguration() {
        return this.bootstrapper.createRunnableConfiguration().then(runnableConfiguration => {
            this.emit('done-bootstrapping');

            return runnableConfiguration;
        });
    }

    _validateScreenshotPath(screenshotPath, pathType) {
        const forbiddenCharsList = (0, _checkFilePath2.default)(screenshotPath);

        if (forbiddenCharsList.length) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.forbiddenCharatersInScreenshotPath, screenshotPath, pathType, (0, _utils.renderForbiddenCharsList)(forbiddenCharsList));
    }

    _setBootstrapperOptions() {
        this.configuration.prepare();
        this.configuration.notifyAboutOverridenOptions();

        this.bootstrapper.sources = this.configuration.getOption(_optionNames2.default.src) || this.bootstrapper.sources;
        this.bootstrapper.browsers = this.configuration.getOption(_optionNames2.default.browsers) || this.bootstrapper.browsers;
        this.bootstrapper.concurrency = this.configuration.getOption(_optionNames2.default.concurrency);
        this.bootstrapper.appCommand = this.configuration.getOption(_optionNames2.default.appCommand) || this.bootstrapper.appCommand;
        this.bootstrapper.appInitDelay = this.configuration.getOption(_optionNames2.default.appInitDelay);
        this.bootstrapper.filter = this.configuration.getOption(_optionNames2.default.filter) || this.bootstrapper.filter;
        this.bootstrapper.reporters = this.configuration.getOption(_optionNames2.default.reporter) || this.bootstrapper.reporters;
    }

    // API
    embeddingOptions(opts) {
        const assets = opts.assets,
              TestRunCtor = opts.TestRunCtor;


        this._registerAssets(assets);
        this.configuration.mergeOptions({ TestRunCtor });

        return this;
    }

    src(...sources) {
        if (this.apiMethodWasCalled.src) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.multipleAPIMethodCallForbidden, _optionNames2.default.src);

        sources = this._prepareArrayParameter(sources);
        this.configuration.mergeOptions({ [_optionNames2.default.src]: sources });

        this.apiMethodWasCalled.src = true;

        return this;
    }

    browsers(...browsers) {
        if (this.apiMethodWasCalled.browsers) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.multipleAPIMethodCallForbidden, _optionNames2.default.browsers);

        browsers = this._prepareArrayParameter(browsers);
        this.configuration.mergeOptions({ browsers });

        this.apiMethodWasCalled.browsers = true;

        return this;
    }

    concurrency(concurrency) {
        this.configuration.mergeOptions({ concurrency });

        return this;
    }

    reporter(name, output) {
        if (this.apiMethodWasCalled.reporter) throw new _runtime.GeneralError(_types.RUNTIME_ERRORS.multipleAPIMethodCallForbidden, _optionNames2.default.reporter);

        let reporters = (0, _prepareReporters2.default)(name, output);

        reporters = this._prepareArrayParameter(reporters);

        this.configuration.mergeOptions({ [_optionNames2.default.reporter]: reporters });

        this.apiMethodWasCalled.reporter = true;

        return this;
    }

    filter(filter) {
        this.configuration.mergeOptions({ filter });

        return this;
    }

    useProxy(proxy, proxyBypass) {
        this.configuration.mergeOptions({ proxy, proxyBypass });

        return this;
    }

    screenshots(path, takeOnFails, pattern) {
        this.configuration.mergeOptions({
            [_optionNames2.default.screenshotPath]: path,
            [_optionNames2.default.takeScreenshotsOnFails]: takeOnFails,
            [_optionNames2.default.screenshotPathPattern]: pattern
        });

        return this;
    }

    video(path, options, encodingOptions) {
        this.configuration.mergeOptions({
            [_optionNames2.default.videoPath]: path,
            [_optionNames2.default.videoOptions]: options,
            [_optionNames2.default.videoEncodingOptions]: encodingOptions
        });

        return this;
    }

    startApp(command, initDelay) {
        this.configuration.mergeOptions({
            [_optionNames2.default.appCommand]: command,
            [_optionNames2.default.appInitDelay]: initDelay
        });

        return this;
    }

    run(options = {}) {
        this.apiMethodWasCalled.reset();

        const skipJsErrors = options.skipJsErrors,
              disablePageReloads = options.disablePageReloads,
              quarantineMode = options.quarantineMode,
              debugMode = options.debugMode,
              selectorTimeout = options.selectorTimeout,
              assertionTimeout = options.assertionTimeout,
              pageLoadTimeout = options.pageLoadTimeout,
              speed = options.speed,
              debugOnFail = options.debugOnFail,
              skipUncaughtErrors = options.skipUncaughtErrors,
              stopOnFirstFail = options.stopOnFirstFail;


        this.configuration.mergeOptions({
            skipJsErrors: skipJsErrors,
            disablePageReloads: disablePageReloads,
            quarantineMode: quarantineMode,
            debugMode: debugMode,
            debugOnFail: debugOnFail,
            selectorTimeout: selectorTimeout,
            assertionTimeout: assertionTimeout,
            pageLoadTimeout: pageLoadTimeout,
            speed: speed,
            skipUncaughtErrors: skipUncaughtErrors,
            stopOnFirstFail: stopOnFirstFail
        });

        this._setBootstrapperOptions();

        const runTaskPromise = _pinkie2.default.resolve().then(() => this._validateRunOptions()).then(() => this._createRunnableConfiguration()).then(({ reporterPlugins, browserSet, tests, testedApp }) => {
            this.reporterPlugings = reporterPlugins;

            return this._runTask(reporterPlugins, browserSet, tests, testedApp);
        });

        return this._createCancelablePromise(runTaskPromise);
    }

    stop() {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            // NOTE: When taskPromise is cancelled, it is removed from
            // the pendingTaskPromises array, which leads to shifting indexes
            // towards the beginning. So, we must copy the array in order to iterate it,
            // or we can perform iteration from the end to the beginning.
            const cancellationPromises = (0, _mapReverse2.default)(_this6.pendingTaskPromises, function (taskPromise) {
                return taskPromise.cancel();
            });

            yield _pinkie2.default.all(cancellationPromises);
        })();
    }
}
exports.default = Runner;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW5uZXIvaW5kZXguanMiXSwibmFtZXMiOlsiREVCVUdfTE9HR0VSIiwiUnVubmVyIiwiRXZlbnRFbWl0dGVyIiwiY29uc3RydWN0b3IiLCJwcm94eSIsImJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSIsImNvbmZpZ3VyYXRpb24iLCJib290c3RyYXBwZXIiLCJfY3JlYXRlQm9vdHN0cmFwcGVyIiwicGVuZGluZ1Rhc2tQcm9taXNlcyIsImlzQ2xpIiwicmVwb3J0ZXJQbHVnaW5ncyIsImFwaU1ldGhvZFdhc0NhbGxlZCIsIkZsYWdMaXN0IiwiaW5pdGlhbEZsYWdWYWx1ZSIsImZsYWdzIiwiT1BUSU9OX05BTUVTIiwic3JjIiwiYnJvd3NlcnMiLCJyZXBvcnRlciIsIkJvb3RzdHJhcHBlciIsIl9kaXNwb3NlQnJvd3NlclNldCIsImJyb3dzZXJTZXQiLCJkaXNwb3NlIiwiY2F0Y2giLCJlIiwiX2Rpc3Bvc2VSZXBvcnRlcnMiLCJyZXBvcnRlcnMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwiX2Rpc3Bvc2VUZXN0ZWRBcHAiLCJ0ZXN0ZWRBcHAiLCJraWxsIiwicmVzb2x2ZSIsIl9kaXNwb3NlVGFza0FuZFJlbGF0ZWRBc3NldHMiLCJ0YXNrIiwiYWJvcnQiLCJjbGVhckxpc3RlbmVycyIsIl9kaXNwb3NlQXNzZXRzIiwiX3ByZXBhcmVBcnJheVBhcmFtZXRlciIsImFycmF5IiwibGVuZ3RoIiwiX2NyZWF0ZUNhbmNlbGFibGVQcm9taXNlIiwidGFza1Byb21pc2UiLCJwcm9taXNlIiwidGhlbiIsImNvbXBsZXRpb25Qcm9taXNlIiwicmVtb3ZlRnJvbVBlbmRpbmciLCJjYW5jZWwiLCJjYW5jZWxUYXNrIiwicHVzaCIsIl9nZXRGYWlsZWRUZXN0Q291bnQiLCJmYWlsZWRUZXN0Q291bnQiLCJ0ZXN0Q291bnQiLCJwYXNzZWQiLCJvcHRzIiwic3RvcE9uRmlyc3RGYWlsIiwiX2dldFRhc2tSZXN1bHQiLCJvbiIsInJlbGVhc2VDb25uZWN0aW9uIiwiam9iIiwiYnJvd3NlckNvbm5lY3Rpb24iLCJicm93c2VyU2V0RXJyb3JQcm9taXNlIiwidGFza0RvbmVQcm9taXNlIiwib25jZSIsInByb21pc2VzIiwiZXJyb3JQcm9taXNlIiwicmFjZSIsImVyciIsIl9jcmVhdGVUYXNrIiwidGVzdHMiLCJicm93c2VyQ29ubmVjdGlvbkdyb3VwcyIsIlRhc2siLCJfcnVuVGFzayIsInJlcG9ydGVyUGx1Z2lucyIsImNvbXBsZXRlZCIsImdldE9wdGlvbnMiLCJSZXBvcnRlciIsInBsdWdpbiIsIm91dFN0cmVhbSIsInN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzIiwiZ2V0T3B0aW9uIiwic2tpcFVuY2F1Z2h0RXJyb3JzIiwiYWRkUnVubmluZ1Rlc3QiLCJyZW1vdmVSdW5uaW5nVGVzdCIsInN0b3BIYW5kbGluZ1Rlc3RFcnJvcnMiLCJzZXRDb21wbGV0ZWQiLCJfcmVnaXN0ZXJBc3NldHMiLCJhc3NldHMiLCJmb3JFYWNoIiwiYXNzZXQiLCJHRVQiLCJwYXRoIiwiaW5mbyIsIl92YWxpZGF0ZVNwZWVkT3B0aW9uIiwic3BlZWQiLCJpc05hTiIsIkdlbmVyYWxFcnJvciIsIlJVTlRJTUVfRVJST1JTIiwiaW52YWxpZFNwZWVkVmFsdWUiLCJfdmFsaWRhdGVDb25jdXJyZW5jeU9wdGlvbiIsImNvbmN1cnJlbmN5IiwiaW52YWxpZENvbmN1cnJlbmN5RmFjdG9yIiwiX3ZhbGlkYXRlUHJveHlCeXBhc3NPcHRpb24iLCJwcm94eUJ5cGFzcyIsImlzIiwic3RyaW5nIiwicmVkdWNlIiwiYXJyIiwicnVsZXMiLCJjb25jYXQiLCJzcGxpdCIsIm1lcmdlT3B0aW9ucyIsIl92YWxpZGF0ZVNjcmVlbnNob3RPcHRpb25zIiwic2NyZWVuc2hvdFBhdGgiLCJzY3JlZW5zaG90UGF0aFBhdHRlcm4iLCJfdmFsaWRhdGVTY3JlZW5zaG90UGF0aCIsImNhbm5vdFVzZVNjcmVlbnNob3RQYXRoUGF0dGVybldpdGhvdXRCYXNlU2NyZWVuc2hvdFBhdGhTcGVjaWZpZWQiLCJfdmFsaWRhdGVWaWRlb09wdGlvbnMiLCJ2aWRlb1BhdGgiLCJ2aWRlb0VuY29kaW5nT3B0aW9ucyIsInZpZGVvT3B0aW9ucyIsImNhbm5vdFNldFZpZGVvT3B0aW9uc1dpdGhvdXRCYXNlVmlkZW9QYXRoU3BlY2lmaWVkIiwiZmZtcGVnUGF0aCIsImNhbm5vdEZpbmRGRk1QRUciLCJfdmFsaWRhdGVSdW5PcHRpb25zIiwiX2NyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiIsImNyZWF0ZVJ1bm5hYmxlQ29uZmlndXJhdGlvbiIsInJ1bm5hYmxlQ29uZmlndXJhdGlvbiIsImVtaXQiLCJwYXRoVHlwZSIsImZvcmJpZGRlbkNoYXJzTGlzdCIsImZvcmJpZGRlbkNoYXJhdGVyc0luU2NyZWVuc2hvdFBhdGgiLCJfc2V0Qm9vdHN0cmFwcGVyT3B0aW9ucyIsInByZXBhcmUiLCJub3RpZnlBYm91dE92ZXJyaWRlbk9wdGlvbnMiLCJzb3VyY2VzIiwiYXBwQ29tbWFuZCIsImFwcEluaXREZWxheSIsImZpbHRlciIsImVtYmVkZGluZ09wdGlvbnMiLCJUZXN0UnVuQ3RvciIsIm11bHRpcGxlQVBJTWV0aG9kQ2FsbEZvcmJpZGRlbiIsIm5hbWUiLCJvdXRwdXQiLCJ1c2VQcm94eSIsInNjcmVlbnNob3RzIiwidGFrZU9uRmFpbHMiLCJwYXR0ZXJuIiwidGFrZVNjcmVlbnNob3RzT25GYWlscyIsInZpZGVvIiwib3B0aW9ucyIsImVuY29kaW5nT3B0aW9ucyIsInN0YXJ0QXBwIiwiY29tbWFuZCIsImluaXREZWxheSIsInJ1biIsInJlc2V0Iiwic2tpcEpzRXJyb3JzIiwiZGlzYWJsZVBhZ2VSZWxvYWRzIiwicXVhcmFudGluZU1vZGUiLCJkZWJ1Z01vZGUiLCJzZWxlY3RvclRpbWVvdXQiLCJhc3NlcnRpb25UaW1lb3V0IiwicGFnZUxvYWRUaW1lb3V0IiwiZGVidWdPbkZhaWwiLCJydW5UYXNrUHJvbWlzZSIsInN0b3AiLCJjYW5jZWxsYXRpb25Qcm9taXNlcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7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dGVudCI6WyJpbXBvcnQgeyByZXNvbHZlIGFzIHJlc29sdmVQYXRoIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAncGlua2llJztcbmltcG9ydCBwcm9taXNpZnlFdmVudCBmcm9tICdwcm9taXNpZnktZXZlbnQnO1xuaW1wb3J0IG1hcFJldmVyc2UgZnJvbSAnbWFwLXJldmVyc2UnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGZsYXR0ZW5EZWVwIGFzIGZsYXR0ZW4sIHB1bGwgYXMgcmVtb3ZlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCb290c3RyYXBwZXIgZnJvbSAnLi9ib290c3RyYXBwZXInO1xuaW1wb3J0IFJlcG9ydGVyIGZyb20gJy4uL3JlcG9ydGVyJztcbmltcG9ydCBUYXNrIGZyb20gJy4vdGFzayc7XG5pbXBvcnQgeyBHZW5lcmFsRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvcnVudGltZSc7XG5pbXBvcnQgeyBSVU5USU1FX0VSUk9SUyB9IGZyb20gJy4uL2Vycm9ycy90eXBlcyc7XG5pbXBvcnQgeyBhc3NlcnRUeXBlLCBpcyB9IGZyb20gJy4uL2Vycm9ycy9ydW50aW1lL3R5cGUtYXNzZXJ0aW9ucyc7XG5pbXBvcnQgeyByZW5kZXJGb3JiaWRkZW5DaGFyc0xpc3QgfSBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4vdXRpbHMnO1xuaW1wb3J0IGRldGVjdEZGTVBFRyBmcm9tICcuLi91dGlscy9kZXRlY3QtZmZtcGVnJztcbmltcG9ydCBjaGVja0ZpbGVQYXRoIGZyb20gJy4uL3V0aWxzL2NoZWNrLWZpbGUtcGF0aCc7XG5pbXBvcnQgeyBhZGRSdW5uaW5nVGVzdCwgcmVtb3ZlUnVubmluZ1Rlc3QsIHN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzLCBzdG9wSGFuZGxpbmdUZXN0RXJyb3JzIH0gZnJvbSAnLi4vdXRpbHMvaGFuZGxlLWVycm9ycyc7XG5pbXBvcnQgT1BUSU9OX05BTUVTIGZyb20gJy4uL2NvbmZpZ3VyYXRpb24vb3B0aW9uLW5hbWVzJztcbmltcG9ydCBGbGFnTGlzdCBmcm9tICcuLi91dGlscy9mbGFnLWxpc3QnO1xuaW1wb3J0IHByZXBhcmVSZXBvcnRlcnMgZnJvbSAnLi4vdXRpbHMvcHJlcGFyZS1yZXBvcnRlcnMnO1xuXG5jb25zdCBERUJVR19MT0dHRVIgPSBkZWJ1ZygndGVzdGNhZmU6cnVubmVyJyk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJ1bm5lciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IgKHByb3h5LCBicm93c2VyQ29ubmVjdGlvbkdhdGV3YXksIGNvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLnByb3h5ICAgICAgICAgICAgICAgPSBwcm94eTtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIgICAgICAgID0gdGhpcy5fY3JlYXRlQm9vdHN0cmFwcGVyKGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSk7XG4gICAgICAgIHRoaXMucGVuZGluZ1Rhc2tQcm9taXNlcyA9IFtdO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24gICAgICAgPSBjb25maWd1cmF0aW9uO1xuICAgICAgICB0aGlzLmlzQ2xpICAgICAgICAgICAgICAgPSBmYWxzZTtcblxuICAgICAgICAvLyBOT1RFOiBUaGlzIGNvZGUgaXMgbmVjZXNzYXJ5IG9ubHkgZm9yIGRpc3BsYXlpbmcgIG1hcmtldGluZyBtZXNzYWdlcy5cbiAgICAgICAgdGhpcy5yZXBvcnRlclBsdWdpbmdzID0gW107XG5cbiAgICAgICAgdGhpcy5hcGlNZXRob2RXYXNDYWxsZWQgPSBuZXcgRmxhZ0xpc3Qoe1xuICAgICAgICAgICAgaW5pdGlhbEZsYWdWYWx1ZTogZmFsc2UsXG4gICAgICAgICAgICBmbGFnczogICAgICAgICAgICBbT1BUSU9OX05BTUVTLnNyYywgT1BUSU9OX05BTUVTLmJyb3dzZXJzLCBPUFRJT05fTkFNRVMucmVwb3J0ZXJdXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9jcmVhdGVCb290c3RyYXBwZXIgKGJyb3dzZXJDb25uZWN0aW9uR2F0ZXdheSkge1xuICAgICAgICByZXR1cm4gbmV3IEJvb3RzdHJhcHBlcihicm93c2VyQ29ubmVjdGlvbkdhdGV3YXkpO1xuICAgIH1cblxuICAgIF9kaXNwb3NlQnJvd3NlclNldCAoYnJvd3NlclNldCkge1xuICAgICAgICByZXR1cm4gYnJvd3NlclNldC5kaXNwb3NlKCkuY2F0Y2goZSA9PiBERUJVR19MT0dHRVIoZSkpO1xuICAgIH1cblxuICAgIF9kaXNwb3NlUmVwb3J0ZXJzIChyZXBvcnRlcnMpIHtcbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHJlcG9ydGVycy5tYXAocmVwb3J0ZXIgPT4gcmVwb3J0ZXIuZGlzcG9zZSgpLmNhdGNoKGUgPT4gREVCVUdfTE9HR0VSKGUpKSkpO1xuICAgIH1cblxuICAgIF9kaXNwb3NlVGVzdGVkQXBwICh0ZXN0ZWRBcHApIHtcbiAgICAgICAgcmV0dXJuIHRlc3RlZEFwcCA/IHRlc3RlZEFwcC5raWxsKCkuY2F0Y2goZSA9PiBERUJVR19MT0dHRVIoZSkpIDogUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyAodGFzaywgYnJvd3NlclNldCwgcmVwb3J0ZXJzLCB0ZXN0ZWRBcHApIHtcbiAgICAgICAgdGFzay5hYm9ydCgpO1xuICAgICAgICB0YXNrLmNsZWFyTGlzdGVuZXJzKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fZGlzcG9zZUFzc2V0cyhicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCk7XG4gICAgfVxuXG4gICAgX2Rpc3Bvc2VBc3NldHMgKGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKSB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICB0aGlzLl9kaXNwb3NlQnJvd3NlclNldChicm93c2VyU2V0KSxcbiAgICAgICAgICAgIHRoaXMuX2Rpc3Bvc2VSZXBvcnRlcnMocmVwb3J0ZXJzKSxcbiAgICAgICAgICAgIHRoaXMuX2Rpc3Bvc2VUZXN0ZWRBcHAodGVzdGVkQXBwKVxuICAgICAgICBdKTtcbiAgICB9XG5cbiAgICBfcHJlcGFyZUFycmF5UGFyYW1ldGVyIChhcnJheSkge1xuICAgICAgICBhcnJheSA9IGZsYXR0ZW4oYXJyYXkpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzQ2xpKVxuICAgICAgICAgICAgcmV0dXJuIGFycmF5Lmxlbmd0aCA9PT0gMCA/IHZvaWQgMCA6IGFycmF5O1xuXG4gICAgICAgIHJldHVybiBhcnJheTtcbiAgICB9XG5cbiAgICBfY3JlYXRlQ2FuY2VsYWJsZVByb21pc2UgKHRhc2tQcm9taXNlKSB7XG4gICAgICAgIGNvbnN0IHByb21pc2UgICAgICAgICAgID0gdGFza1Byb21pc2UudGhlbigoeyBjb21wbGV0aW9uUHJvbWlzZSB9KSA9PiBjb21wbGV0aW9uUHJvbWlzZSk7XG4gICAgICAgIGNvbnN0IHJlbW92ZUZyb21QZW5kaW5nID0gKCkgPT4gcmVtb3ZlKHRoaXMucGVuZGluZ1Rhc2tQcm9taXNlcywgcHJvbWlzZSk7XG5cbiAgICAgICAgcHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4ocmVtb3ZlRnJvbVBlbmRpbmcpXG4gICAgICAgICAgICAuY2F0Y2gocmVtb3ZlRnJvbVBlbmRpbmcpO1xuXG4gICAgICAgIHByb21pc2UuY2FuY2VsID0gKCkgPT4gdGFza1Byb21pc2VcbiAgICAgICAgICAgIC50aGVuKCh7IGNhbmNlbFRhc2sgfSkgPT4gY2FuY2VsVGFzaygpKVxuICAgICAgICAgICAgLnRoZW4ocmVtb3ZlRnJvbVBlbmRpbmcpO1xuXG4gICAgICAgIHRoaXMucGVuZGluZ1Rhc2tQcm9taXNlcy5wdXNoKHByb21pc2UpO1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9XG5cbiAgICAvLyBSdW4gdGFza1xuICAgIF9nZXRGYWlsZWRUZXN0Q291bnQgKHRhc2ssIHJlcG9ydGVyKSB7XG4gICAgICAgIGxldCBmYWlsZWRUZXN0Q291bnQgPSByZXBvcnRlci50ZXN0Q291bnQgLSByZXBvcnRlci5wYXNzZWQ7XG5cbiAgICAgICAgaWYgKHRhc2sub3B0cy5zdG9wT25GaXJzdEZhaWwgJiYgISFmYWlsZWRUZXN0Q291bnQpXG4gICAgICAgICAgICBmYWlsZWRUZXN0Q291bnQgPSAxO1xuXG4gICAgICAgIHJldHVybiBmYWlsZWRUZXN0Q291bnQ7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldFRhc2tSZXN1bHQgKHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKSB7XG4gICAgICAgIHRhc2sub24oJ2Jyb3dzZXItam9iLWRvbmUnLCBqb2IgPT4gYnJvd3NlclNldC5yZWxlYXNlQ29ubmVjdGlvbihqb2IuYnJvd3NlckNvbm5lY3Rpb24pKTtcblxuICAgICAgICBjb25zdCBicm93c2VyU2V0RXJyb3JQcm9taXNlID0gcHJvbWlzaWZ5RXZlbnQoYnJvd3NlclNldCwgJ2Vycm9yJyk7XG5cbiAgICAgICAgY29uc3QgdGFza0RvbmVQcm9taXNlID0gdGFzay5vbmNlKCdkb25lJylcbiAgICAgICAgICAgIC50aGVuKCgpID0+IGJyb3dzZXJTZXRFcnJvclByb21pc2UuY2FuY2VsKCkpO1xuXG5cbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXG4gICAgICAgICAgICB0YXNrRG9uZVByb21pc2UsXG4gICAgICAgICAgICBicm93c2VyU2V0RXJyb3JQcm9taXNlXG4gICAgICAgIF07XG5cbiAgICAgICAgaWYgKHRlc3RlZEFwcClcbiAgICAgICAgICAgIHByb21pc2VzLnB1c2godGVzdGVkQXBwLmVycm9yUHJvbWlzZSk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IFByb21pc2UucmFjZShwcm9taXNlcyk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5fZGlzcG9zZVRhc2tBbmRSZWxhdGVkQXNzZXRzKHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcblxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgdGhpcy5fZGlzcG9zZUFzc2V0cyhicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2dldEZhaWxlZFRlc3RDb3VudCh0YXNrLCByZXBvcnRlcnNbMF0pO1xuICAgIH1cblxuICAgIF9jcmVhdGVUYXNrICh0ZXN0cywgYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMsIHByb3h5LCBvcHRzKSB7XG4gICAgICAgIHJldHVybiBuZXcgVGFzayh0ZXN0cywgYnJvd3NlckNvbm5lY3Rpb25Hcm91cHMsIHByb3h5LCBvcHRzKTtcbiAgICB9XG5cbiAgICBfcnVuVGFzayAocmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKSB7XG4gICAgICAgIGxldCBjb21wbGV0ZWQgICAgICAgICAgID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHRhc2sgICAgICAgICAgICAgID0gdGhpcy5fY3JlYXRlVGFzayh0ZXN0cywgYnJvd3NlclNldC5icm93c2VyQ29ubmVjdGlvbkdyb3VwcywgdGhpcy5wcm94eSwgdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbnMoKSk7XG4gICAgICAgIGNvbnN0IHJlcG9ydGVycyAgICAgICAgID0gcmVwb3J0ZXJQbHVnaW5zLm1hcChyZXBvcnRlciA9PiBuZXcgUmVwb3J0ZXIocmVwb3J0ZXIucGx1Z2luLCB0YXNrLCByZXBvcnRlci5vdXRTdHJlYW0pKTtcbiAgICAgICAgY29uc3QgY29tcGxldGlvblByb21pc2UgPSB0aGlzLl9nZXRUYXNrUmVzdWx0KHRhc2ssIGJyb3dzZXJTZXQsIHJlcG9ydGVycywgdGVzdGVkQXBwKTtcblxuICAgICAgICB0YXNrLm9uKCdzdGFydCcsIHN0YXJ0SGFuZGxpbmdUZXN0RXJyb3JzKTtcblxuICAgICAgICBpZiAoIXRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnNraXBVbmNhdWdodEVycm9ycykpIHtcbiAgICAgICAgICAgIHRhc2sub25jZSgndGVzdC1ydW4tc3RhcnQnLCBhZGRSdW5uaW5nVGVzdCk7XG4gICAgICAgICAgICB0YXNrLm9uY2UoJ3Rlc3QtcnVuLWRvbmUnLCByZW1vdmVSdW5uaW5nVGVzdCk7XG4gICAgICAgIH1cblxuICAgICAgICB0YXNrLm9uKCdkb25lJywgc3RvcEhhbmRsaW5nVGVzdEVycm9ycyk7XG5cbiAgICAgICAgY29uc3Qgc2V0Q29tcGxldGVkID0gKCkgPT4ge1xuICAgICAgICAgICAgY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICAgfTtcblxuICAgICAgICBjb21wbGV0aW9uUHJvbWlzZVxuICAgICAgICAgICAgLnRoZW4oc2V0Q29tcGxldGVkKVxuICAgICAgICAgICAgLmNhdGNoKHNldENvbXBsZXRlZCk7XG5cbiAgICAgICAgY29uc3QgY2FuY2VsVGFzayA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGlmICghY29tcGxldGVkKVxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2Rpc3Bvc2VUYXNrQW5kUmVsYXRlZEFzc2V0cyh0YXNrLCBicm93c2VyU2V0LCByZXBvcnRlcnMsIHRlc3RlZEFwcCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHsgY29tcGxldGlvblByb21pc2UsIGNhbmNlbFRhc2sgfTtcbiAgICB9XG5cbiAgICBfcmVnaXN0ZXJBc3NldHMgKGFzc2V0cykge1xuICAgICAgICBhc3NldHMuZm9yRWFjaChhc3NldCA9PiB0aGlzLnByb3h5LkdFVChhc3NldC5wYXRoLCBhc3NldC5pbmZvKSk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlU3BlZWRPcHRpb24gKCkge1xuICAgICAgICBjb25zdCBzcGVlZCA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnNwZWVkKTtcblxuICAgICAgICBpZiAoc3BlZWQgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBpZiAodHlwZW9mIHNwZWVkICE9PSAnbnVtYmVyJyB8fCBpc05hTihzcGVlZCkgfHwgc3BlZWQgPCAwLjAxIHx8IHNwZWVkID4gMSlcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuaW52YWxpZFNwZWVkVmFsdWUpO1xuICAgIH1cblxuICAgIF92YWxpZGF0ZUNvbmN1cnJlbmN5T3B0aW9uICgpIHtcbiAgICAgICAgY29uc3QgY29uY3VycmVuY3kgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5jb25jdXJyZW5jeSk7XG5cbiAgICAgICAgaWYgKGNvbmN1cnJlbmN5ID09PSB2b2lkIDApXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb25jdXJyZW5jeSAhPT0gJ251bWJlcicgfHwgaXNOYU4oY29uY3VycmVuY3kpIHx8IGNvbmN1cnJlbmN5IDwgMSlcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuaW52YWxpZENvbmN1cnJlbmN5RmFjdG9yKTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVQcm94eUJ5cGFzc09wdGlvbiAoKSB7XG4gICAgICAgIGxldCBwcm94eUJ5cGFzcyA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnByb3h5QnlwYXNzKTtcblxuICAgICAgICBpZiAocHJveHlCeXBhc3MgPT09IHZvaWQgMClcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhc3NlcnRUeXBlKFsgaXMuc3RyaW5nLCBpcy5hcnJheSBdLCBudWxsLCAnXCJwcm94eUJ5cGFzc1wiIGFyZ3VtZW50JywgcHJveHlCeXBhc3MpO1xuXG4gICAgICAgIGlmICh0eXBlb2YgcHJveHlCeXBhc3MgPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgcHJveHlCeXBhc3MgPSBbcHJveHlCeXBhc3NdO1xuXG4gICAgICAgIHByb3h5QnlwYXNzID0gcHJveHlCeXBhc3MucmVkdWNlKChhcnIsIHJ1bGVzKSA9PiB7XG4gICAgICAgICAgICBhc3NlcnRUeXBlKGlzLnN0cmluZywgbnVsbCwgJ1wicHJveHlCeXBhc3NcIiBhcmd1bWVudCcsIHJ1bGVzKTtcblxuICAgICAgICAgICAgcmV0dXJuIGFyci5jb25jYXQocnVsZXMuc3BsaXQoJywnKSk7XG4gICAgICAgIH0sIFtdKTtcblxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgcHJveHlCeXBhc3MgfSk7XG4gICAgfVxuXG4gICAgX3ZhbGlkYXRlU2NyZWVuc2hvdE9wdGlvbnMgKCkge1xuICAgICAgICBjb25zdCBzY3JlZW5zaG90UGF0aCAgICAgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aCk7XG4gICAgICAgIGNvbnN0IHNjcmVlbnNob3RQYXRoUGF0dGVybiA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnNjcmVlbnNob3RQYXRoUGF0dGVybik7XG5cbiAgICAgICAgaWYgKHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoKHNjcmVlbnNob3RQYXRoLCAnc2NyZWVuc2hvdHMgYmFzZSBkaXJlY3RvcnkgcGF0aCcpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgW09QVElPTl9OQU1FUy5zY3JlZW5zaG90UGF0aF06IHJlc29sdmVQYXRoKHNjcmVlbnNob3RQYXRoKSB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzY3JlZW5zaG90UGF0aFBhdHRlcm4pXG4gICAgICAgICAgICB0aGlzLl92YWxpZGF0ZVNjcmVlbnNob3RQYXRoKHNjcmVlbnNob3RQYXRoUGF0dGVybiwgJ3NjcmVlbnNob3RzIHBhdGggcGF0dGVybicpO1xuXG4gICAgICAgIGlmICghc2NyZWVuc2hvdFBhdGggJiYgc2NyZWVuc2hvdFBhdGhQYXR0ZXJuKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5jYW5ub3RVc2VTY3JlZW5zaG90UGF0aFBhdHRlcm5XaXRob3V0QmFzZVNjcmVlbnNob3RQYXRoU3BlY2lmaWVkKTtcbiAgICB9XG5cbiAgICBhc3luYyBfdmFsaWRhdGVWaWRlb09wdGlvbnMgKCkge1xuICAgICAgICBjb25zdCB2aWRlb1BhdGggICAgICAgICAgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLnZpZGVvUGF0aCk7XG4gICAgICAgIGNvbnN0IHZpZGVvRW5jb2RpbmdPcHRpb25zID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMudmlkZW9FbmNvZGluZ09wdGlvbnMpO1xuXG4gICAgICAgIGxldCB2aWRlb09wdGlvbnMgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy52aWRlb09wdGlvbnMpO1xuXG4gICAgICAgIGlmICghdmlkZW9QYXRoKSB7XG4gICAgICAgICAgICBpZiAodmlkZW9PcHRpb25zIHx8IHZpZGVvRW5jb2RpbmdPcHRpb25zKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2Fubm90U2V0VmlkZW9PcHRpb25zV2l0aG91dEJhc2VWaWRlb1BhdGhTcGVjaWZpZWQpO1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgW09QVElPTl9OQU1FUy52aWRlb1BhdGhdOiByZXNvbHZlUGF0aCh2aWRlb1BhdGgpIH0pO1xuXG4gICAgICAgIGlmICghdmlkZW9PcHRpb25zKSB7XG4gICAgICAgICAgICB2aWRlb09wdGlvbnMgPSB7fTtcblxuICAgICAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IFtPUFRJT05fTkFNRVMudmlkZW9PcHRpb25zXTogdmlkZW9PcHRpb25zIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHZpZGVvT3B0aW9ucy5mZm1wZWdQYXRoKVxuICAgICAgICAgICAgdmlkZW9PcHRpb25zLmZmbXBlZ1BhdGggPSByZXNvbHZlUGF0aCh2aWRlb09wdGlvbnMuZmZtcGVnUGF0aCk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHZpZGVvT3B0aW9ucy5mZm1wZWdQYXRoID0gYXdhaXQgZGV0ZWN0RkZNUEVHKCk7XG5cbiAgICAgICAgaWYgKCF2aWRlb09wdGlvbnMuZmZtcGVnUGF0aClcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMuY2Fubm90RmluZEZGTVBFRyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3ZhbGlkYXRlUnVuT3B0aW9ucyAoKSB7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlU2NyZWVuc2hvdE9wdGlvbnMoKTtcbiAgICAgICAgYXdhaXQgdGhpcy5fdmFsaWRhdGVWaWRlb09wdGlvbnMoKTtcbiAgICAgICAgdGhpcy5fdmFsaWRhdGVTcGVlZE9wdGlvbigpO1xuICAgICAgICB0aGlzLl92YWxpZGF0ZUNvbmN1cnJlbmN5T3B0aW9uKCk7XG4gICAgICAgIHRoaXMuX3ZhbGlkYXRlUHJveHlCeXBhc3NPcHRpb24oKTtcbiAgICB9XG5cbiAgICBfY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYm9vdHN0cmFwcGVyXG4gICAgICAgICAgICAuY3JlYXRlUnVubmFibGVDb25maWd1cmF0aW9uKClcbiAgICAgICAgICAgIC50aGVuKHJ1bm5hYmxlQ29uZmlndXJhdGlvbiA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdkb25lLWJvb3RzdHJhcHBpbmcnKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBydW5uYWJsZUNvbmZpZ3VyYXRpb247XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfdmFsaWRhdGVTY3JlZW5zaG90UGF0aCAoc2NyZWVuc2hvdFBhdGgsIHBhdGhUeXBlKSB7XG4gICAgICAgIGNvbnN0IGZvcmJpZGRlbkNoYXJzTGlzdCA9IGNoZWNrRmlsZVBhdGgoc2NyZWVuc2hvdFBhdGgpO1xuXG4gICAgICAgIGlmIChmb3JiaWRkZW5DaGFyc0xpc3QubGVuZ3RoKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEdlbmVyYWxFcnJvcihSVU5USU1FX0VSUk9SUy5mb3JiaWRkZW5DaGFyYXRlcnNJblNjcmVlbnNob3RQYXRoLCBzY3JlZW5zaG90UGF0aCwgcGF0aFR5cGUsIHJlbmRlckZvcmJpZGRlbkNoYXJzTGlzdChmb3JiaWRkZW5DaGFyc0xpc3QpKTtcbiAgICB9XG5cbiAgICBfc2V0Qm9vdHN0cmFwcGVyT3B0aW9ucyAoKSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5wcmVwYXJlKCk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5ub3RpZnlBYm91dE92ZXJyaWRlbk9wdGlvbnMoKTtcblxuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5zb3VyY2VzICAgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5zcmMpIHx8IHRoaXMuYm9vdHN0cmFwcGVyLnNvdXJjZXM7XG4gICAgICAgIHRoaXMuYm9vdHN0cmFwcGVyLmJyb3dzZXJzICAgICA9IHRoaXMuY29uZmlndXJhdGlvbi5nZXRPcHRpb24oT1BUSU9OX05BTUVTLmJyb3dzZXJzKSB8fCB0aGlzLmJvb3RzdHJhcHBlci5icm93c2VycztcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIuY29uY3VycmVuY3kgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMuY29uY3VycmVuY3kpO1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5hcHBDb21tYW5kICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5hcHBDb21tYW5kKSB8fCB0aGlzLmJvb3RzdHJhcHBlci5hcHBDb21tYW5kO1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5hcHBJbml0RGVsYXkgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5hcHBJbml0RGVsYXkpO1xuICAgICAgICB0aGlzLmJvb3RzdHJhcHBlci5maWx0ZXIgICAgICAgPSB0aGlzLmNvbmZpZ3VyYXRpb24uZ2V0T3B0aW9uKE9QVElPTl9OQU1FUy5maWx0ZXIpIHx8IHRoaXMuYm9vdHN0cmFwcGVyLmZpbHRlcjtcbiAgICAgICAgdGhpcy5ib290c3RyYXBwZXIucmVwb3J0ZXJzICAgID0gdGhpcy5jb25maWd1cmF0aW9uLmdldE9wdGlvbihPUFRJT05fTkFNRVMucmVwb3J0ZXIpIHx8IHRoaXMuYm9vdHN0cmFwcGVyLnJlcG9ydGVycztcbiAgICB9XG5cbiAgICAvLyBBUElcbiAgICBlbWJlZGRpbmdPcHRpb25zIChvcHRzKSB7XG4gICAgICAgIGNvbnN0IHsgYXNzZXRzLCBUZXN0UnVuQ3RvciB9ID0gb3B0cztcblxuICAgICAgICB0aGlzLl9yZWdpc3RlckFzc2V0cyhhc3NldHMpO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgVGVzdFJ1bkN0b3IgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc3JjICguLi5zb3VyY2VzKSB7XG4gICAgICAgIGlmICh0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5zcmMpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLm11bHRpcGxlQVBJTWV0aG9kQ2FsbEZvcmJpZGRlbiwgT1BUSU9OX05BTUVTLnNyYyk7XG5cbiAgICAgICAgc291cmNlcyA9IHRoaXMuX3ByZXBhcmVBcnJheVBhcmFtZXRlcihzb3VyY2VzKTtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IFtPUFRJT05fTkFNRVMuc3JjXTogc291cmNlcyB9KTtcblxuICAgICAgICB0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5zcmMgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGJyb3dzZXJzICguLi5icm93c2Vycykge1xuICAgICAgICBpZiAodGhpcy5hcGlNZXRob2RXYXNDYWxsZWQuYnJvd3NlcnMpXG4gICAgICAgICAgICB0aHJvdyBuZXcgR2VuZXJhbEVycm9yKFJVTlRJTUVfRVJST1JTLm11bHRpcGxlQVBJTWV0aG9kQ2FsbEZvcmJpZGRlbiwgT1BUSU9OX05BTUVTLmJyb3dzZXJzKTtcblxuICAgICAgICBicm93c2VycyA9IHRoaXMuX3ByZXBhcmVBcnJheVBhcmFtZXRlcihicm93c2Vycyk7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBicm93c2VycyB9KTtcblxuICAgICAgICB0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5icm93c2VycyA9IHRydWU7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgY29uY3VycmVuY3kgKGNvbmN1cnJlbmN5KSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBjb25jdXJyZW5jeSB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICByZXBvcnRlciAobmFtZSwgb3V0cHV0KSB7XG4gICAgICAgIGlmICh0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5yZXBvcnRlcilcbiAgICAgICAgICAgIHRocm93IG5ldyBHZW5lcmFsRXJyb3IoUlVOVElNRV9FUlJPUlMubXVsdGlwbGVBUElNZXRob2RDYWxsRm9yYmlkZGVuLCBPUFRJT05fTkFNRVMucmVwb3J0ZXIpO1xuXG4gICAgICAgIGxldCByZXBvcnRlcnMgPSBwcmVwYXJlUmVwb3J0ZXJzKG5hbWUsIG91dHB1dCk7XG5cbiAgICAgICAgcmVwb3J0ZXJzID0gdGhpcy5fcHJlcGFyZUFycmF5UGFyYW1ldGVyKHJlcG9ydGVycyk7XG5cbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7IFtPUFRJT05fTkFNRVMucmVwb3J0ZXJdOiByZXBvcnRlcnMgfSk7XG5cbiAgICAgICAgdGhpcy5hcGlNZXRob2RXYXNDYWxsZWQucmVwb3J0ZXIgPSB0cnVlO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGZpbHRlciAoZmlsdGVyKSB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5tZXJnZU9wdGlvbnMoeyBmaWx0ZXIgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdXNlUHJveHkgKHByb3h5LCBwcm94eUJ5cGFzcykge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHsgcHJveHksIHByb3h5QnlwYXNzIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNjcmVlbnNob3RzIChwYXRoLCB0YWtlT25GYWlscywgcGF0dGVybikge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHtcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMuc2NyZWVuc2hvdFBhdGhdOiAgICAgICAgIHBhdGgsXG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLnRha2VTY3JlZW5zaG90c09uRmFpbHNdOiB0YWtlT25GYWlscyxcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMuc2NyZWVuc2hvdFBhdGhQYXR0ZXJuXTogIHBhdHRlcm5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdmlkZW8gKHBhdGgsIG9wdGlvbnMsIGVuY29kaW5nT3B0aW9ucykge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ubWVyZ2VPcHRpb25zKHtcbiAgICAgICAgICAgIFtPUFRJT05fTkFNRVMudmlkZW9QYXRoXTogICAgICAgICAgICBwYXRoLFxuICAgICAgICAgICAgW09QVElPTl9OQU1FUy52aWRlb09wdGlvbnNdOiAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLnZpZGVvRW5jb2RpbmdPcHRpb25zXTogZW5jb2RpbmdPcHRpb25zXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHN0YXJ0QXBwIChjb21tYW5kLCBpbml0RGVsYXkpIHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7XG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLmFwcENvbW1hbmRdOiAgIGNvbW1hbmQsXG4gICAgICAgICAgICBbT1BUSU9OX05BTUVTLmFwcEluaXREZWxheV06IGluaXREZWxheVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBydW4gKG9wdGlvbnMgPSB7fSkge1xuICAgICAgICB0aGlzLmFwaU1ldGhvZFdhc0NhbGxlZC5yZXNldCgpO1xuXG4gICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIHNraXBKc0Vycm9ycyxcbiAgICAgICAgICAgIGRpc2FibGVQYWdlUmVsb2FkcyxcbiAgICAgICAgICAgIHF1YXJhbnRpbmVNb2RlLFxuICAgICAgICAgICAgZGVidWdNb2RlLFxuICAgICAgICAgICAgc2VsZWN0b3JUaW1lb3V0LFxuICAgICAgICAgICAgYXNzZXJ0aW9uVGltZW91dCxcbiAgICAgICAgICAgIHBhZ2VMb2FkVGltZW91dCxcbiAgICAgICAgICAgIHNwZWVkLFxuICAgICAgICAgICAgZGVidWdPbkZhaWwsXG4gICAgICAgICAgICBza2lwVW5jYXVnaHRFcnJvcnMsXG4gICAgICAgICAgICBzdG9wT25GaXJzdEZhaWxcbiAgICAgICAgfSA9IG9wdGlvbnM7XG5cbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLm1lcmdlT3B0aW9ucyh7XG4gICAgICAgICAgICBza2lwSnNFcnJvcnM6ICAgICAgIHNraXBKc0Vycm9ycyxcbiAgICAgICAgICAgIGRpc2FibGVQYWdlUmVsb2FkczogZGlzYWJsZVBhZ2VSZWxvYWRzLFxuICAgICAgICAgICAgcXVhcmFudGluZU1vZGU6ICAgICBxdWFyYW50aW5lTW9kZSxcbiAgICAgICAgICAgIGRlYnVnTW9kZTogICAgICAgICAgZGVidWdNb2RlLFxuICAgICAgICAgICAgZGVidWdPbkZhaWw6ICAgICAgICBkZWJ1Z09uRmFpbCxcbiAgICAgICAgICAgIHNlbGVjdG9yVGltZW91dDogICAgc2VsZWN0b3JUaW1lb3V0LFxuICAgICAgICAgICAgYXNzZXJ0aW9uVGltZW91dDogICBhc3NlcnRpb25UaW1lb3V0LFxuICAgICAgICAgICAgcGFnZUxvYWRUaW1lb3V0OiAgICBwYWdlTG9hZFRpbWVvdXQsXG4gICAgICAgICAgICBzcGVlZDogICAgICAgICAgICAgIHNwZWVkLFxuICAgICAgICAgICAgc2tpcFVuY2F1Z2h0RXJyb3JzOiBza2lwVW5jYXVnaHRFcnJvcnMsXG4gICAgICAgICAgICBzdG9wT25GaXJzdEZhaWw6ICAgIHN0b3BPbkZpcnN0RmFpbFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLl9zZXRCb290c3RyYXBwZXJPcHRpb25zKCk7XG5cbiAgICAgICAgY29uc3QgcnVuVGFza1Byb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5fdmFsaWRhdGVSdW5PcHRpb25zKCkpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLl9jcmVhdGVSdW5uYWJsZUNvbmZpZ3VyYXRpb24oKSlcbiAgICAgICAgICAgIC50aGVuKCh7IHJlcG9ydGVyUGx1Z2lucywgYnJvd3NlclNldCwgdGVzdHMsIHRlc3RlZEFwcCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXBvcnRlclBsdWdpbmdzID0gcmVwb3J0ZXJQbHVnaW5zO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3J1blRhc2socmVwb3J0ZXJQbHVnaW5zLCBicm93c2VyU2V0LCB0ZXN0cywgdGVzdGVkQXBwKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0aGlzLl9jcmVhdGVDYW5jZWxhYmxlUHJvbWlzZShydW5UYXNrUHJvbWlzZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RvcCAoKSB7XG4gICAgICAgIC8vIE5PVEU6IFdoZW4gdGFza1Byb21pc2UgaXMgY2FuY2VsbGVkLCBpdCBpcyByZW1vdmVkIGZyb21cbiAgICAgICAgLy8gdGhlIHBlbmRpbmdUYXNrUHJvbWlzZXMgYXJyYXksIHdoaWNoIGxlYWRzIHRvIHNoaWZ0aW5nIGluZGV4ZXNcbiAgICAgICAgLy8gdG93YXJkcyB0aGUgYmVnaW5uaW5nLiBTbywgd2UgbXVzdCBjb3B5IHRoZSBhcnJheSBpbiBvcmRlciB0byBpdGVyYXRlIGl0LFxuICAgICAgICAvLyBvciB3ZSBjYW4gcGVyZm9ybSBpdGVyYXRpb24gZnJvbSB0aGUgZW5kIHRvIHRoZSBiZWdpbm5pbmcuXG4gICAgICAgIGNvbnN0IGNhbmNlbGxhdGlvblByb21pc2VzID0gbWFwUmV2ZXJzZSh0aGlzLnBlbmRpbmdUYXNrUHJvbWlzZXMsIHRhc2tQcm9taXNlID0+IHRhc2tQcm9taXNlLmNhbmNlbCgpKTtcblxuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChjYW5jZWxsYXRpb25Qcm9taXNlcyk7XG4gICAgfVxufVxuIl19
