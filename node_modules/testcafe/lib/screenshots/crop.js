'use strict';

exports.__esModule = true;
exports.cropScreenshot = undefined;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

let cropScreenshot = exports.cropScreenshot = (() => {
    var _ref = (0, _asyncToGenerator3.default)(function* (image, { path, markSeed, clientAreaDimensions, cropDimensions }) {
        if (!markSeed && !cropDimensions) return null;

        const clip = calculateClipInfo(image, path, markSeed, clientAreaDimensions, cropDimensions);

        return (0, _utils.copyImagePart)(image, clip);
    });

    return function cropScreenshot(_x, _x2) {
        return _ref.apply(this, arguments);
    };
})();

exports.calculateMarkPosition = calculateMarkPosition;
exports.getClipInfoByMarkPosition = getClipInfoByMarkPosition;
exports.getClipInfoByCropDimensions = getClipInfoByCropDimensions;
exports.calculateClipInfo = calculateClipInfo;

var _utils = require('./utils');

var _limitNumber = require('../utils/limit-number');

var _limitNumber2 = _interopRequireDefault(_limitNumber);

var _renderTemplate = require('../utils/render-template');

var _renderTemplate2 = _interopRequireDefault(_renderTemplate);

var _testRun = require('../errors/test-run/');

var _constants = require('./constants');

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const MARK_SEED_ERROR_THRESHOLD = 10;
const WHITE_COLOR_PART = 255;
const BLACK_COLOR_PART = 0;

function markSeedToId(markSeed) {
    let id = 0;

    for (let i = 0; i < _constants.MARK_LENGTH; i++) id = id * 2 + (markSeed[i * _constants.MARK_BYTES_PER_PIXEL] ? 1 : 0);

    return id;
}

function getCorrectedColorPart(colorPart) {
    const isWhite = colorPart > WHITE_COLOR_PART - MARK_SEED_ERROR_THRESHOLD;
    const isBlack = colorPart < MARK_SEED_ERROR_THRESHOLD;

    if (isBlack) return BLACK_COLOR_PART;

    if (isWhite) return WHITE_COLOR_PART;

    return colorPart;
}

function calculateMarkPosition(pngImage, markSeed) {
    const mark = Buffer.from(markSeed);
    const filtImg = Buffer.from(pngImage.data);

    for (let i = 0; i < filtImg.length; i++) filtImg[i] = getCorrectedColorPart(filtImg[i]);

    const markIndex = filtImg.indexOf(mark);

    if (markIndex < 0) return null;

    const endPosition = markIndex / _constants.MARK_BYTES_PER_PIXEL + _constants.MARK_LENGTH + _constants.MARK_RIGHT_MARGIN;

    const x = endPosition % pngImage.width || pngImage.width;
    const y = (endPosition - x) / pngImage.width + 1;

    return { x, y };
}

function getClipInfoByMarkPosition(markPosition, { width, height }) {
    const x = markPosition.x,
          y = markPosition.y;


    const clipRight = x;
    const clipBottom = y;
    const clipLeft = clipRight - width;
    const clipTop = clipBottom - height;

    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom
    };
}

function getClipInfoByCropDimensions({ clipRight, clipLeft, clipBottom, clipTop }, cropDimensions) {
    if (cropDimensions) {
        const right = cropDimensions.right,
              top = cropDimensions.top,
              bottom = cropDimensions.bottom,
              left = cropDimensions.left;


        clipRight = (0, _limitNumber2.default)(clipLeft + right, clipLeft, clipRight);
        clipBottom = (0, _limitNumber2.default)(clipTop + bottom, clipTop, clipBottom);
        clipLeft = (0, _limitNumber2.default)(clipLeft + left, clipLeft, clipRight);
        clipTop = (0, _limitNumber2.default)(clipTop + top, clipTop, clipBottom);
    }

    return {
        clipLeft,
        clipTop,
        clipRight,
        clipBottom
    };
}

function calculateClipInfo(pngImage, path, markSeed, clientAreaDimensions, cropDimensions) {
    let clipInfo = {
        clipRight: pngImage.width,
        clipBottom: pngImage.height,
        clipLeft: 0,
        clipTop: 0
    };

    let markPosition = null;

    if (markSeed && clientAreaDimensions) {
        markPosition = calculateMarkPosition(pngImage, markSeed);

        if (!markPosition) throw new Error((0, _renderTemplate2.default)(_warningMessage2.default.screenshotMarkNotFound, path, markSeedToId(markSeed)));

        clipInfo = getClipInfoByMarkPosition(markPosition, clientAreaDimensions);
    }

    clipInfo = getClipInfoByCropDimensions(clipInfo, cropDimensions);

    if (markPosition && markPosition.y === clipInfo.clipBottom) clipInfo.clipBottom--;

    const clipWidth = clipInfo.clipRight - clipInfo.clipLeft;
    const clipHeight = clipInfo.clipBottom - clipInfo.clipTop;

    if (clipWidth <= 0 || clipHeight <= 0) throw new _testRun.InvalidElementScreenshotDimensionsError(clipWidth, clipHeight);

    return clipInfo;
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JlZW5zaG90cy9jcm9wLmpzIl0sIm5hbWVzIjpbImltYWdlIiwicGF0aCIsIm1hcmtTZWVkIiwiY2xpZW50QXJlYURpbWVuc2lvbnMiLCJjcm9wRGltZW5zaW9ucyIsImNsaXAiLCJjYWxjdWxhdGVDbGlwSW5mbyIsImNyb3BTY3JlZW5zaG90IiwiY2FsY3VsYXRlTWFya1Bvc2l0aW9uIiwiZ2V0Q2xpcEluZm9CeU1hcmtQb3NpdGlvbiIsImdldENsaXBJbmZvQnlDcm9wRGltZW5zaW9ucyIsIk1BUktfU0VFRF9FUlJPUl9USFJFU0hPTEQiLCJXSElURV9DT0xPUl9QQVJUIiwiQkxBQ0tfQ09MT1JfUEFSVCIsIm1hcmtTZWVkVG9JZCIsImlkIiwiaSIsIk1BUktfTEVOR1RIIiwiTUFSS19CWVRFU19QRVJfUElYRUwiLCJnZXRDb3JyZWN0ZWRDb2xvclBhcnQiLCJjb2xvclBhcnQiLCJpc1doaXRlIiwiaXNCbGFjayIsInBuZ0ltYWdlIiwibWFyayIsIkJ1ZmZlciIsImZyb20iLCJmaWx0SW1nIiwiZGF0YSIsImxlbmd0aCIsIm1hcmtJbmRleCIsImluZGV4T2YiLCJlbmRQb3NpdGlvbiIsIk1BUktfUklHSFRfTUFSR0lOIiwieCIsIndpZHRoIiwieSIsIm1hcmtQb3NpdGlvbiIsImhlaWdodCIsImNsaXBSaWdodCIsImNsaXBCb3R0b20iLCJjbGlwTGVmdCIsImNsaXBUb3AiLCJyaWdodCIsInRvcCIsImJvdHRvbSIsImxlZnQiLCJjbGlwSW5mbyIsIkVycm9yIiwiV0FSTklOR19NRVNTQUdFUyIsInNjcmVlbnNob3RNYXJrTm90Rm91bmQiLCJjbGlwV2lkdGgiLCJjbGlwSGVpZ2h0IiwiSW52YWxpZEVsZW1lbnRTY3JlZW5zaG90RGltZW5zaW9uc0Vycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OytDQXdITyxXQUErQkEsS0FBL0IsRUFBc0MsRUFBRUMsSUFBRixFQUFRQyxRQUFSLEVBQWtCQyxvQkFBbEIsRUFBd0NDLGNBQXhD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LENBQVUsOEJBQWVDLHlCQUFpQkMsc0JBQWhDLEVBQXdEakQsSUFBeEQsRUFBOERhLGFBQWFaLFFBQWIsQ0FBOUQsQ0FBVixDQUFOOztBQUVKNkMsbUJBQVd0QywwQkFBMEI0QixZQUExQixFQUF3Q2xDLG9CQUF4QyxDQUFYO0FBQ0g7O0FBRUQ0QyxlQUFXckMsNEJBQTRCcUMsUUFBNUIsRUFBc0MzQyxjQUF0QyxDQUFYOztBQUVBLFFBQUlpQyxnQkFBZ0JBLGFBQWFELENBQWIsS0FBbUJXLFNBQVNQLFVBQWhELEVBQ0lPLFNBQVNQLFVBQVQ7O0FBRUosVUFBTVcsWUFBYUosU0FBU1IsU0FBVCxHQUFxQlEsU0FBU04sUUFBakQ7QUFDQSxVQUFNVyxhQUFhTCxTQUFTUCxVQUFULEdBQXNCTyxTQUFTTCxPQUFsRDs7QUFFQSxRQUFJUyxhQUFhLENBQWIsSUFBa0JDLGNBQWMsQ0FBcEMsRUFDSSxNQUFNLElBQUlDLGdEQUFKLENBQTRDRixTQUE1QyxFQUF1REMsVUFBdkQsQ0FBTjs7QUFFSixXQUFPTCxRQUFQO0FBQ0giLCJmaWxlIjoic2NyZWVuc2hvdHMvY3JvcC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvcHlJbWFnZVBhcnQgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsaW1pdE51bWJlciBmcm9tICcuLi91dGlscy9saW1pdC1udW1iZXInO1xuaW1wb3J0IHJlbmRlclRlbXBsYXRlIGZyb20gJy4uL3V0aWxzL3JlbmRlci10ZW1wbGF0ZSc7XG5pbXBvcnQgeyBJbnZhbGlkRWxlbWVudFNjcmVlbnNob3REaW1lbnNpb25zRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4vJztcbmltcG9ydCB7IE1BUktfTEVOR1RILCBNQVJLX1JJR0hUX01BUkdJTiwgTUFSS19CWVRFU19QRVJfUElYRUwgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5cbmNvbnN0IE1BUktfU0VFRF9FUlJPUl9USFJFU0hPTEQgPSAxMDtcbmNvbnN0IFdISVRFX0NPTE9SX1BBUlQgICAgICAgICAgPSAyNTU7XG5jb25zdCBCTEFDS19DT0xPUl9QQVJUICAgICAgICAgID0gMDtcblxuZnVuY3Rpb24gbWFya1NlZWRUb0lkIChtYXJrU2VlZCkge1xuICAgIGxldCBpZCA9IDA7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1BUktfTEVOR1RIOyBpKyspXG4gICAgICAgIGlkID0gaWQgKiAyICsgKG1hcmtTZWVkW2kgKiBNQVJLX0JZVEVTX1BFUl9QSVhFTF0gPyAxIDogMCk7XG5cbiAgICByZXR1cm4gaWQ7XG59XG5cbmZ1bmN0aW9uIGdldENvcnJlY3RlZENvbG9yUGFydCAoY29sb3JQYXJ0KSB7XG4gICAgY29uc3QgaXNXaGl0ZSA9IGNvbG9yUGFydCA+IFdISVRFX0NPTE9SX1BBUlQgLSBNQVJLX1NFRURfRVJST1JfVEhSRVNIT0xEO1xuICAgIGNvbnN0IGlzQmxhY2sgPSBjb2xvclBhcnQgPCBNQVJLX1NFRURfRVJST1JfVEhSRVNIT0xEO1xuXG4gICAgaWYgKGlzQmxhY2spXG4gICAgICAgIHJldHVybiBCTEFDS19DT0xPUl9QQVJUO1xuXG4gICAgaWYgKGlzV2hpdGUpXG4gICAgICAgIHJldHVybiBXSElURV9DT0xPUl9QQVJUO1xuXG4gICAgcmV0dXJuIGNvbG9yUGFydDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNhbGN1bGF0ZU1hcmtQb3NpdGlvbiAocG5nSW1hZ2UsIG1hcmtTZWVkKSB7XG4gICAgY29uc3QgbWFyayAgICA9IEJ1ZmZlci5mcm9tKG1hcmtTZWVkKTtcbiAgICBjb25zdCBmaWx0SW1nID0gQnVmZmVyLmZyb20ocG5nSW1hZ2UuZGF0YSk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbHRJbWcubGVuZ3RoOyBpKyspXG4gICAgICAgIGZpbHRJbWdbaV0gPSBnZXRDb3JyZWN0ZWRDb2xvclBhcnQoZmlsdEltZ1tpXSk7XG5cbiAgICBjb25zdCBtYXJrSW5kZXggPSBmaWx0SW1nLmluZGV4T2YobWFyayk7XG5cbiAgICBpZiAobWFya0luZGV4IDwgMClcbiAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBlbmRQb3NpdGlvbiA9IG1hcmtJbmRleCAvIE1BUktfQllURVNfUEVSX1BJWEVMICsgTUFSS19MRU5HVEggKyBNQVJLX1JJR0hUX01BUkdJTjtcblxuICAgIGNvbnN0IHggPSBlbmRQb3NpdGlvbiAlIHBuZ0ltYWdlLndpZHRoIHx8IHBuZ0ltYWdlLndpZHRoO1xuICAgIGNvbnN0IHkgPSAoZW5kUG9zaXRpb24gLSB4KSAvIHBuZ0ltYWdlLndpZHRoICsgMTtcblxuICAgIHJldHVybiB7IHgsIHkgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENsaXBJbmZvQnlNYXJrUG9zaXRpb24gKG1hcmtQb3NpdGlvbiwgeyB3aWR0aCwgaGVpZ2h0IH0pIHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IG1hcmtQb3NpdGlvbjtcblxuICAgIGNvbnN0IGNsaXBSaWdodCAgPSB4O1xuICAgIGNvbnN0IGNsaXBCb3R0b20gPSB5O1xuICAgIGNvbnN0IGNsaXBMZWZ0ICAgPSBjbGlwUmlnaHQgLSB3aWR0aDtcbiAgICBjb25zdCBjbGlwVG9wICAgID0gY2xpcEJvdHRvbSAtIGhlaWdodDtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGNsaXBMZWZ0LFxuICAgICAgICBjbGlwVG9wLFxuICAgICAgICBjbGlwUmlnaHQsXG4gICAgICAgIGNsaXBCb3R0b21cbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2xpcEluZm9CeUNyb3BEaW1lbnNpb25zICh7IGNsaXBSaWdodCwgY2xpcExlZnQsIGNsaXBCb3R0b20sIGNsaXBUb3AgfSwgY3JvcERpbWVuc2lvbnMpIHtcbiAgICBpZiAoY3JvcERpbWVuc2lvbnMpIHtcbiAgICAgICAgY29uc3QgeyByaWdodCwgdG9wLCBib3R0b20sIGxlZnQgfSA9IGNyb3BEaW1lbnNpb25zO1xuXG4gICAgICAgIGNsaXBSaWdodCAgPSBsaW1pdE51bWJlcihjbGlwTGVmdCArIHJpZ2h0LCBjbGlwTGVmdCwgY2xpcFJpZ2h0KTtcbiAgICAgICAgY2xpcEJvdHRvbSA9IGxpbWl0TnVtYmVyKGNsaXBUb3AgKyBib3R0b20sIGNsaXBUb3AsIGNsaXBCb3R0b20pO1xuICAgICAgICBjbGlwTGVmdCAgID0gbGltaXROdW1iZXIoY2xpcExlZnQgKyBsZWZ0LCBjbGlwTGVmdCwgY2xpcFJpZ2h0KTtcbiAgICAgICAgY2xpcFRvcCAgICA9IGxpbWl0TnVtYmVyKGNsaXBUb3AgKyB0b3AsIGNsaXBUb3AsIGNsaXBCb3R0b20pO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAgIGNsaXBMZWZ0LFxuICAgICAgICBjbGlwVG9wLFxuICAgICAgICBjbGlwUmlnaHQsXG4gICAgICAgIGNsaXBCb3R0b21cbiAgICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlQ2xpcEluZm8gKHBuZ0ltYWdlLCBwYXRoLCBtYXJrU2VlZCwgY2xpZW50QXJlYURpbWVuc2lvbnMsIGNyb3BEaW1lbnNpb25zKSB7XG4gICAgbGV0IGNsaXBJbmZvID0ge1xuICAgICAgICBjbGlwUmlnaHQ6ICBwbmdJbWFnZS53aWR0aCxcbiAgICAgICAgY2xpcEJvdHRvbTogcG5nSW1hZ2UuaGVpZ2h0LFxuICAgICAgICBjbGlwTGVmdDogICAwLFxuICAgICAgICBjbGlwVG9wOiAgICAwXG4gICAgfTtcblxuICAgIGxldCBtYXJrUG9zaXRpb24gPSBudWxsO1xuXG4gICAgaWYgKG1hcmtTZWVkICYmIGNsaWVudEFyZWFEaW1lbnNpb25zKSB7XG4gICAgICAgIG1hcmtQb3NpdGlvbiA9IGNhbGN1bGF0ZU1hcmtQb3NpdGlvbihwbmdJbWFnZSwgbWFya1NlZWQpO1xuXG4gICAgICAgIGlmICghbWFya1Bvc2l0aW9uKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHJlbmRlclRlbXBsYXRlKFdBUk5JTkdfTUVTU0FHRVMuc2NyZWVuc2hvdE1hcmtOb3RGb3VuZCwgcGF0aCwgbWFya1NlZWRUb0lkKG1hcmtTZWVkKSkpO1xuXG4gICAgICAgIGNsaXBJbmZvID0gZ2V0Q2xpcEluZm9CeU1hcmtQb3NpdGlvbihtYXJrUG9zaXRpb24sIGNsaWVudEFyZWFEaW1lbnNpb25zKTtcbiAgICB9XG5cbiAgICBjbGlwSW5mbyA9IGdldENsaXBJbmZvQnlDcm9wRGltZW5zaW9ucyhjbGlwSW5mbywgY3JvcERpbWVuc2lvbnMpO1xuXG4gICAgaWYgKG1hcmtQb3NpdGlvbiAmJiBtYXJrUG9zaXRpb24ueSA9PT0gY2xpcEluZm8uY2xpcEJvdHRvbSlcbiAgICAgICAgY2xpcEluZm8uY2xpcEJvdHRvbS0tO1xuXG4gICAgY29uc3QgY2xpcFdpZHRoICA9IGNsaXBJbmZvLmNsaXBSaWdodCAtIGNsaXBJbmZvLmNsaXBMZWZ0O1xuICAgIGNvbnN0IGNsaXBIZWlnaHQgPSBjbGlwSW5mby5jbGlwQm90dG9tIC0gY2xpcEluZm8uY2xpcFRvcDtcblxuICAgIGlmIChjbGlwV2lkdGggPD0gMCB8fCBjbGlwSGVpZ2h0IDw9IDApXG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkRWxlbWVudFNjcmVlbnNob3REaW1lbnNpb25zRXJyb3IoY2xpcFdpZHRoLCBjbGlwSGVpZ2h0KTtcblxuICAgIHJldHVybiBjbGlwSW5mbztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyb3BTY3JlZW5zaG90IChpbWFnZSwgeyBwYXRoLCBtYXJrU2VlZCwgY2xpZW50QXJlYURpbWVuc2lvbnMsIGNyb3BEaW1lbnNpb25zIH0pIHtcbiAgICBpZiAoIW1hcmtTZWVkICYmICFjcm9wRGltZW5zaW9ucylcbiAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBjbGlwID0gY2FsY3VsYXRlQ2xpcEluZm8oaW1hZ2UsIHBhdGgsIG1hcmtTZWVkLCBjbGllbnRBcmVhRGltZW5zaW9ucywgY3JvcERpbWVuc2lvbnMpO1xuXG4gICAgcmV0dXJuIGNvcHlJbWFnZVBhcnQoaW1hZ2UsIGNsaXApO1xufVxuIl19
