'use strict';

exports.__esModule = true;

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _phase = require('../test-run/phase');

var _phase2 = _interopRequireDefault(_phase);

var _types = require('../errors/types');

var _testcafeHammerhead = require('testcafe-hammerhead');

var _actions = require('./commands/actions');

var _testRun = require('../errors/test-run');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class TestRunBookmark {
    constructor(testRun, role) {
        this.testRun = testRun;
        this.role = role;

        this.url = _testcafeHammerhead.SPECIAL_BLANK_PAGE;
        this.dialogHandler = testRun.activeDialogHandler;
        this.iframeSelector = testRun.activeIframeSelector;
        this.speed = testRun.speed;
        this.pageLoadTimeout = testRun.pageLoadTimeout;
        this.ctx = testRun.ctx;
        this.fixtureCtx = testRun.fixtureCtx;
        this.consoleMessages = testRun.consoleMessages;
    }

    init() {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this.testRun.activeIframeSelector) yield _this.testRun.executeCommand(new _actions.SwitchToMainWindowCommand());

            if (!_this.role.opts.preserveUrl) _this.url = yield _this.testRun.getCurrentUrl();
        })();
    }

    _restoreDialogHandler() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this2.testRun.activeDialogHandler !== _this2.dialogHandler) {
                const restoreDialogCommand = new _actions.SetNativeDialogHandlerCommand({ dialogHandler: { fn: _this2.dialogHandler } });

                yield _this2.testRun.executeCommand(restoreDialogCommand);
            }
        })();
    }

    _restoreSpeed() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this3.testRun.speed !== _this3.speed) {
                const restoreSpeedCommand = new _actions.SetTestSpeedCommand({ speed: _this3.speed });

                yield _this3.testRun.executeCommand(restoreSpeedCommand);
            }
        })();
    }

    _restorePageLoadTimeout() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this4.testRun.pageLoadTimeout !== _this4.pageLoadTimeout) {
                const restorePageLoadTimeoutCommand = new _actions.SetPageLoadTimeoutCommand({ duration: _this4.pageLoadTimeout });

                yield _this4.testRun.executeCommand(restorePageLoadTimeoutCommand);
            }
        })();
    }

    _restoreWorkingFrame() {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this5.testRun.activeIframeSelector !== _this5.iframeSelector) {
                const switchWorkingFrameCommand = _this5.iframeSelector ? new _actions.SwitchToIframeCommand({ selector: _this5.iframeSelector }) : new _actions.SwitchToMainWindowCommand();

                try {
                    yield _this5.testRun.executeCommand(switchWorkingFrameCommand);
                } catch (err) {
                    if (err.code === _types.TEST_RUN_ERRORS.actionElementNotFoundError) throw new _testRun.CurrentIframeNotFoundError();

                    if (err.code === _types.TEST_RUN_ERRORS.actionIframeIsNotLoadedError) throw new _testRun.CurrentIframeIsNotLoadedError();

                    throw err;
                }
            }
        })();
    }

    _restorePage(url, stateSnapshot, forceReload) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const navigateCommand = new _actions.NavigateToCommand({ url, stateSnapshot, forceReload });

            yield _this6.testRun.executeCommand(navigateCommand);
        })();
    }

    restore(callsite, stateSnapshot) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const prevPhase = _this7.testRun.phase;

            _this7.testRun.phase = _phase2.default.inBookmarkRestore;

            _this7.testRun.ctx = _this7.ctx;
            _this7.testRun.fixtureCtx = _this7.fixtureCtx;
            _this7.testRun.consoleMessages = _this7.consoleMessages;

            try {
                yield _this7._restoreSpeed();
                yield _this7._restorePageLoadTimeout();
                yield _this7._restoreDialogHandler();

                const preserveUrl = _this7.role.opts.preserveUrl;
                const url = preserveUrl ? _this7.role.url : _this7.url;

                yield _this7._restorePage(url, (0, _stringify2.default)(stateSnapshot), true);

                if (!preserveUrl) yield _this7._restoreWorkingFrame();
            } catch (err) {
                err.callsite = callsite;

                throw err;
            }

            _this7.testRun.phase = prevPhase;
        })();
    }
}
exports.default = TestRunBookmark;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXN0LXJ1bi9ib29rbWFyay5qcyJdLCJuYW1lcyI6WyJUZXN0UnVuQm9va21hcmsiLCJjb25zdHJ1Y3RvciIsInRlc3RSdW4iLCJyb2xlIiwidXJsIiwiU1BFQ0lBTF9CTEFOS19QQUdFIiwiZGlhbG9nSGFuZGxlciIsImFjdGl2ZURpYWxvZ0hhbmRsZXIiLCJpZnJhbWVTZWxlY3RvciIsImFjdGl2ZUlmcmFtZVNlbGVjdG9yIiwic3BlZWQiLCJwYWdlTG9hZFRpbWVvdXQiLCJjdHgiLCJmaXh0dXJlQ3R4IiwiY29uc29sZU1lc3NhZ2VzIiwiaW5pdCIsImV4ZWN1dGVDb21tYW5kIiwiU3dpdGNoVG9NYWluV2luZG93Q29tbWFuZCIsIm9wdHMiLCJwcmVzZXJ2ZVVybCIsImdldEN1cnJlbnRVcmwiLCJfcmVzdG9yZURpYWxvZ0hhbmRsZXIiLCJyZXN0b3JlRGlhbG9nQ29tbWFuZCIsIlNldE5hdGl2ZURpYWxvZ0hhbmRsZXJDb21tYW5kIiwiZm4iLCJfcmVzdG9yZVNwZWVkIiwicmVzdG9yZVNwZWVkQ29tbWFuZCIsIlNldFRlc3RTcGVlZENvbW1hbmQiLCJfcmVzdG9yZVBhZ2VMb2FkVGltZW91dCIsInJlc3RvcmVQYWdlTG9hZFRpbWVvdXRDb21tYW5kIiwiU2V0UGFnZUxvYWRUaW1lb3V0Q29tbWFuZCIsImR1cmF0aW9uIiwiX3Jlc3RvcmVXb3JraW5nRnJhbWUiLCJzd2l0Y2hXb3JraW5nRnJhbWVDb21tYW5kIiwiU3dpdGNoVG9JZnJhbWVDb21tYW5kIiwic2VsZWN0b3IiLCJlcnIiLCJjb2RlIiwiVEVTVF9SVU5fRVJST1JTIiwiYWN0aW9uRWxlbWVudE5vdEZvdW5kRXJyb3IiLCJDdXJyZW50SWZyYW1lTm90Rm91bmRFcnJvciIsImFjdGlvbklmcmFtZUlzTm90TG9hZGVkRXJyb3IiLCJDdXJyZW50SWZyYW1lSXNOb3RMb2FkZWRFcnJvciIsIl9yZXN0b3JlUGFnZSIsInN0YXRlU25hcHNob3QiLCJmb3JjZVJlbG9hZCIsIm5hdmlnYXRlQ29tbWFuZCIsIk5hdmlnYXRlVG9Db21tYW5kIiwicmVzdG9yZSIsImNhbGxzaXRlIiwicHJldlBoYXNlIiwicGhhc2UiLCJURVNUX1JVTl9QSEFTRSIsImluQm9va21hcmtSZXN0b3JlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOztBQUVBOztBQVNBOzs7O0FBS2UsTUFBTUEsZUFBTixDQUFzQjtBQUNqQ0MsZ0JBQWFDLE9BQWIsRUFBc0JDLElBQXRCLEVBQTRCO0FBQ3hCLGFBQUtELE9BQUwsR0FBZUEsT0FBZjtBQUNBLGFBQUtDLElBQUwsR0FBZUEsSUFBZjs7QUFFQSxhQUFLQyxHQUFMLEdBQXVCQyxzQ0FBdkI7QUFDQSxhQUFLQyxhQUFMLEdBQXVCSixRQUFRSyxtQkFBL0I7QUFDQSxhQUFLQyxjQUFMLEdBQXVCTixRQUFRTyxvQkFBL0I7QUFDQSxhQUFLQyxLQUFMLEdBQXVCUixRQUFRUSxLQUEvQjtBQUNBLGFBQUtDLGVBQUwsR0FBdUJULFFBQVFTLGVBQS9CO0FBQ0EsYUFBS0MsR0FBTCxHQUF1QlYsUUFBUVUsR0FBL0I7QUFDQSxhQUFLQyxVQUFMLEdBQXVCWCxRQUFRVyxVQUEvQjtBQUNBLGFBQUtDLGVBQUwsR0FBdUJaLFFBQVFZLGVBQS9CO0FBQ0g7O0FBRUtDLFFBQU4sR0FBYztBQUFBOztBQUFBO0FBQ1YsZ0JBQUksTUFBS2IsT0FBTCxDQUFhTyxvQkFBakIsRUFDSSxNQUFNLE1BQUtQLE9BQUwsQ0FBYWMsY0FBYixDQUE0QixJQUFJQyxrQ0FBSixFQUE1QixDQUFOOztBQUVKLGdCQUFJLENBQUMsTUFBS2QsSUFBTCxDQUFVZSxJQUFWLENBQWVDLFdBQXBCLEVBQ0ksTUFBS2YsR0FBTCxHQUFXLE1BQU0sTUFBS0YsT0FBTCxDQUFha0IsYUFBYixFQUFqQjtBQUxNO0FBTWI7O0FBRUtDLHlCQUFOLEdBQStCO0FBQUE7O0FBQUE7QUFDM0IsZ0JBQUksT0FBS25CLE9BQUwsQ0FBYUssbUJBQWIsS0FBcUMsT0FBS0QsYUFBOUMsRUFBNkQ7QUFDekQsc0JBQU1nQix1QkFBdUIsSUFBSUMsc0NBQUosQ0FBa0MsRUFBRWpCLGVBQWUsRUFBRWtCLElBQUksT0FBS2xCLGFBQVgsRUFBakIsRUFBbEMsQ0FBN0I7O0FBRUEsc0JBQU0sT0FBS0osT0FBTCxDQUFhYyxjQUFiLENBQTRCTSxvQkFBNUIsQ0FBTjtBQUNIO0FBTDBCO0FBTTlCOztBQUVLRyxpQkFBTixHQUF1QjtBQUFBOztBQUFBO0FBQ25CLGdCQUFJLE9BQUt2QixPQUFMLENBQWFRLEtBQWIsS0FBdUIsT0FBS0EsS0FBaEMsRUFBdUM7QUFDbkMsc0JBQU1nQixzQkFBc0IsSUFBSUMsNEJBQUosQ0FBd0IsRUFBRWpCLE9BQU8sT0FBS0EsS0FBZCxFQUF4QixDQUE1Qjs7QUFFQSxzQkFBTSxPQUFLUixPQUFMLENBQWFjLGNBQWIsQ0FBNEJVLG1CQUE1QixDQUFOO0FBQ0g7QUFMa0I7QUFNdEI7O0FBRUtFLDJCQUFOLEdBQWlDO0FBQUE7O0FBQUE7QUFDN0IsZ0JBQUksT0FBSzFCLE9BQUwsQ0FBYVMsZUFBYixLQUFpQyxPQUFLQSxlQUExQyxFQUEyRDtBQUN2RCxzQkFBTWtCLGdDQUFnQyxJQUFJQyxrQ0FBSixDQUE4QixFQUFFQyxVQUFVLE9BQUtwQixlQUFqQixFQUE5QixDQUF0Qzs7QUFFQSxzQkFBTSxPQUFLVCxPQUFMLENBQWFjLGNBQWIsQ0FBNEJhLDZCQUE1QixDQUFOO0FBQ0g7QUFMNEI7QUFNaEM7O0FBRUtHLHdCQUFOLEdBQThCO0FBQUE7O0FBQUE7QUFDMUIsZ0JBQUksT0FBSzlCLE9BQUwsQ0FBYU8sb0JBQWIsS0FBc0MsT0FBS0QsY0FBL0MsRUFBK0Q7QUFDM0Qsc0JBQU15Qiw0QkFBNEIsT0FBS3pCLGNBQUwsR0FDOUIsSUFBSTBCLDhCQUFKLENBQTBCLEVBQUVDLFVBQVUsT0FBSzNCLGNBQWpCLEVBQTFCLENBRDhCLEdBRTlCLElBQUlTLGtDQUFKLEVBRko7O0FBSUEsb0JBQUk7QUFDQSwwQkFBTSxPQUFLZixPQUFMLENBQWFjLGNBQWIsQ0FBNEJpQix5QkFBNUIsQ0FBTjtBQUNILGlCQUZELENBR0EsT0FBT0csR0FBUCxFQUFZO0FBQ1Isd0JBQUlBLElBQUlDLElBQUosS0FBYUMsdUJBQWdCQywwQkFBakMsRUFDSSxNQUFNLElBQUlDLG1DQUFKLEVBQU47O0FBRUosd0JBQUlKLElBQUlDLElBQUosS0FBYUMsdUJBQWdCRyw0QkFBakMsRUFDSSxNQUFNLElBQUlDLHNDQUFKLEVBQU47O0FBRUosMEJBQU1OLEdBQU47QUFDSDtBQUNKO0FBbEJ5QjtBQW1CN0I7O0FBRUtPLGdCQUFOLENBQW9CdkMsR0FBcEIsRUFBeUJ3QyxhQUF6QixFQUF3Q0MsV0FBeEMsRUFBcUQ7QUFBQTs7QUFBQTtBQUNqRCxrQkFBTUMsa0JBQWtCLElBQUlDLDBCQUFKLENBQXNCLEVBQUUzQyxHQUFGLEVBQU93QyxhQUFQLEVBQXNCQyxXQUF0QixFQUF0QixDQUF4Qjs7QUFFQSxrQkFBTSxPQUFLM0MsT0FBTCxDQUFhYyxjQUFiLENBQTRCOEIsZUFBNUIsQ0FBTjtBQUhpRDtBQUlwRDs7QUFFS0UsV0FBTixDQUFlQyxRQUFmLEVBQXlCTCxhQUF6QixFQUF3QztBQUFBOztBQUFBO0FBQ3BDLGtCQUFNTSxZQUFZLE9BQUtoRCxPQUFMLENBQWFpRCxLQUEvQjs7QUFFQSxtQkFBS2pELE9BQUwsQ0FBYWlELEtBQWIsR0FBcUJDLGdCQUFlQyxpQkFBcEM7O0FBRUEsbUJBQUtuRCxPQUFMLENBQWFVLEdBQWIsR0FBK0IsT0FBS0EsR0FBcEM7QUFDQSxtQkFBS1YsT0FBTCxDQUFhVyxVQUFiLEdBQStCLE9BQUtBLFVBQXBDO0FBQ0EsbUJBQUtYLE9BQUwsQ0FBYVksZUFBYixHQUErQixPQUFLQSxlQUFwQzs7QUFFQSxnQkFBSTtBQUNBLHNCQUFNLE9BQUtXLGFBQUwsRUFBTjtBQUNBLHNCQUFNLE9BQUtHLHVCQUFMLEVBQU47QUFDQSxzQkFBTSxPQUFLUCxxQkFBTCxFQUFOOztBQUVBLHNCQUFNRixjQUFjLE9BQUtoQixJQUFMLENBQVVlLElBQVYsQ0FBZUMsV0FBbkM7QUFDQSxzQkFBTWYsTUFBY2UsY0FBYyxPQUFLaEIsSUFBTCxDQUFVQyxHQUF4QixHQUE4QixPQUFLQSxHQUF2RDs7QUFFQSxzQkFBTSxPQUFLdUMsWUFBTCxDQUFrQnZDLEdBQWxCLEVBQXVCLHlCQUFld0MsYUFBZixDQUF2QixFQUFzRCxJQUF0RCxDQUFOOztBQUVBLG9CQUFJLENBQUN6QixXQUFMLEVBQ0ksTUFBTSxPQUFLYSxvQkFBTCxFQUFOO0FBQ1AsYUFaRCxDQWFBLE9BQU9JLEdBQVAsRUFBWTtBQUNSQSxvQkFBSWEsUUFBSixHQUFlQSxRQUFmOztBQUVBLHNCQUFNYixHQUFOO0FBQ0g7O0FBRUQsbUJBQUtsQyxPQUFMLENBQWFpRCxLQUFiLEdBQXFCRCxTQUFyQjtBQTVCb0M7QUE2QnZDO0FBdkdnQztrQkFBaEJsRCxlIiwiZmlsZSI6InRlc3QtcnVuL2Jvb2ttYXJrLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFRFU1RfUlVOX1BIQVNFIGZyb20gJy4uL3Rlc3QtcnVuL3BoYXNlJztcbmltcG9ydCB7IFRFU1RfUlVOX0VSUk9SUyB9IGZyb20gJy4uL2Vycm9ycy90eXBlcyc7XG5pbXBvcnQgeyBTUEVDSUFMX0JMQU5LX1BBR0UgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcblxuaW1wb3J0IHtcbiAgICBTd2l0Y2hUb01haW5XaW5kb3dDb21tYW5kLFxuICAgIFN3aXRjaFRvSWZyYW1lQ29tbWFuZCxcbiAgICBTZXROYXRpdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCxcbiAgICBTZXRUZXN0U3BlZWRDb21tYW5kLFxuICAgIFNldFBhZ2VMb2FkVGltZW91dENvbW1hbmQsXG4gICAgTmF2aWdhdGVUb0NvbW1hbmRcbn0gZnJvbSAnLi9jb21tYW5kcy9hY3Rpb25zJztcblxuaW1wb3J0IHtcbiAgICBDdXJyZW50SWZyYW1lTm90Rm91bmRFcnJvcixcbiAgICBDdXJyZW50SWZyYW1lSXNOb3RMb2FkZWRFcnJvclxufSBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUZXN0UnVuQm9va21hcmsge1xuICAgIGNvbnN0cnVjdG9yICh0ZXN0UnVuLCByb2xlKSB7XG4gICAgICAgIHRoaXMudGVzdFJ1biA9IHRlc3RSdW47XG4gICAgICAgIHRoaXMucm9sZSAgICA9IHJvbGU7XG5cbiAgICAgICAgdGhpcy51cmwgICAgICAgICAgICAgPSBTUEVDSUFMX0JMQU5LX1BBR0U7XG4gICAgICAgIHRoaXMuZGlhbG9nSGFuZGxlciAgID0gdGVzdFJ1bi5hY3RpdmVEaWFsb2dIYW5kbGVyO1xuICAgICAgICB0aGlzLmlmcmFtZVNlbGVjdG9yICA9IHRlc3RSdW4uYWN0aXZlSWZyYW1lU2VsZWN0b3I7XG4gICAgICAgIHRoaXMuc3BlZWQgICAgICAgICAgID0gdGVzdFJ1bi5zcGVlZDtcbiAgICAgICAgdGhpcy5wYWdlTG9hZFRpbWVvdXQgPSB0ZXN0UnVuLnBhZ2VMb2FkVGltZW91dDtcbiAgICAgICAgdGhpcy5jdHggICAgICAgICAgICAgPSB0ZXN0UnVuLmN0eDtcbiAgICAgICAgdGhpcy5maXh0dXJlQ3R4ICAgICAgPSB0ZXN0UnVuLmZpeHR1cmVDdHg7XG4gICAgICAgIHRoaXMuY29uc29sZU1lc3NhZ2VzID0gdGVzdFJ1bi5jb25zb2xlTWVzc2FnZXM7XG4gICAgfVxuXG4gICAgYXN5bmMgaW5pdCAoKSB7XG4gICAgICAgIGlmICh0aGlzLnRlc3RSdW4uYWN0aXZlSWZyYW1lU2VsZWN0b3IpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLnRlc3RSdW4uZXhlY3V0ZUNvbW1hbmQobmV3IFN3aXRjaFRvTWFpbldpbmRvd0NvbW1hbmQoKSk7XG5cbiAgICAgICAgaWYgKCF0aGlzLnJvbGUub3B0cy5wcmVzZXJ2ZVVybClcbiAgICAgICAgICAgIHRoaXMudXJsID0gYXdhaXQgdGhpcy50ZXN0UnVuLmdldEN1cnJlbnRVcmwoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfcmVzdG9yZURpYWxvZ0hhbmRsZXIgKCkge1xuICAgICAgICBpZiAodGhpcy50ZXN0UnVuLmFjdGl2ZURpYWxvZ0hhbmRsZXIgIT09IHRoaXMuZGlhbG9nSGFuZGxlcikge1xuICAgICAgICAgICAgY29uc3QgcmVzdG9yZURpYWxvZ0NvbW1hbmQgPSBuZXcgU2V0TmF0aXZlRGlhbG9nSGFuZGxlckNvbW1hbmQoeyBkaWFsb2dIYW5kbGVyOiB7IGZuOiB0aGlzLmRpYWxvZ0hhbmRsZXIgfSB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy50ZXN0UnVuLmV4ZWN1dGVDb21tYW5kKHJlc3RvcmVEaWFsb2dDb21tYW5kKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9yZXN0b3JlU3BlZWQgKCkge1xuICAgICAgICBpZiAodGhpcy50ZXN0UnVuLnNwZWVkICE9PSB0aGlzLnNwZWVkKSB7XG4gICAgICAgICAgICBjb25zdCByZXN0b3JlU3BlZWRDb21tYW5kID0gbmV3IFNldFRlc3RTcGVlZENvbW1hbmQoeyBzcGVlZDogdGhpcy5zcGVlZCB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy50ZXN0UnVuLmV4ZWN1dGVDb21tYW5kKHJlc3RvcmVTcGVlZENvbW1hbmQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX3Jlc3RvcmVQYWdlTG9hZFRpbWVvdXQgKCkge1xuICAgICAgICBpZiAodGhpcy50ZXN0UnVuLnBhZ2VMb2FkVGltZW91dCAhPT0gdGhpcy5wYWdlTG9hZFRpbWVvdXQpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3RvcmVQYWdlTG9hZFRpbWVvdXRDb21tYW5kID0gbmV3IFNldFBhZ2VMb2FkVGltZW91dENvbW1hbmQoeyBkdXJhdGlvbjogdGhpcy5wYWdlTG9hZFRpbWVvdXQgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMudGVzdFJ1bi5leGVjdXRlQ29tbWFuZChyZXN0b3JlUGFnZUxvYWRUaW1lb3V0Q29tbWFuZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfcmVzdG9yZVdvcmtpbmdGcmFtZSAoKSB7XG4gICAgICAgIGlmICh0aGlzLnRlc3RSdW4uYWN0aXZlSWZyYW1lU2VsZWN0b3IgIT09IHRoaXMuaWZyYW1lU2VsZWN0b3IpIHtcbiAgICAgICAgICAgIGNvbnN0IHN3aXRjaFdvcmtpbmdGcmFtZUNvbW1hbmQgPSB0aGlzLmlmcmFtZVNlbGVjdG9yID9cbiAgICAgICAgICAgICAgICBuZXcgU3dpdGNoVG9JZnJhbWVDb21tYW5kKHsgc2VsZWN0b3I6IHRoaXMuaWZyYW1lU2VsZWN0b3IgfSkgOlxuICAgICAgICAgICAgICAgIG5ldyBTd2l0Y2hUb01haW5XaW5kb3dDb21tYW5kKCk7XG5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy50ZXN0UnVuLmV4ZWN1dGVDb21tYW5kKHN3aXRjaFdvcmtpbmdGcmFtZUNvbW1hbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gVEVTVF9SVU5fRVJST1JTLmFjdGlvbkVsZW1lbnROb3RGb3VuZEVycm9yKVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgQ3VycmVudElmcmFtZU5vdEZvdW5kRXJyb3IoKTtcblxuICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gVEVTVF9SVU5fRVJST1JTLmFjdGlvbklmcmFtZUlzTm90TG9hZGVkRXJyb3IpXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBDdXJyZW50SWZyYW1lSXNOb3RMb2FkZWRFcnJvcigpO1xuXG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX3Jlc3RvcmVQYWdlICh1cmwsIHN0YXRlU25hcHNob3QsIGZvcmNlUmVsb2FkKSB7XG4gICAgICAgIGNvbnN0IG5hdmlnYXRlQ29tbWFuZCA9IG5ldyBOYXZpZ2F0ZVRvQ29tbWFuZCh7IHVybCwgc3RhdGVTbmFwc2hvdCwgZm9yY2VSZWxvYWQgfSk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy50ZXN0UnVuLmV4ZWN1dGVDb21tYW5kKG5hdmlnYXRlQ29tbWFuZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVzdG9yZSAoY2FsbHNpdGUsIHN0YXRlU25hcHNob3QpIHtcbiAgICAgICAgY29uc3QgcHJldlBoYXNlID0gdGhpcy50ZXN0UnVuLnBoYXNlO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bi5waGFzZSA9IFRFU1RfUlVOX1BIQVNFLmluQm9va21hcmtSZXN0b3JlO1xuXG4gICAgICAgIHRoaXMudGVzdFJ1bi5jdHggICAgICAgICAgICAgPSB0aGlzLmN0eDtcbiAgICAgICAgdGhpcy50ZXN0UnVuLmZpeHR1cmVDdHggICAgICA9IHRoaXMuZml4dHVyZUN0eDtcbiAgICAgICAgdGhpcy50ZXN0UnVuLmNvbnNvbGVNZXNzYWdlcyA9IHRoaXMuY29uc29sZU1lc3NhZ2VzO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9yZXN0b3JlU3BlZWQoKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3RvcmVQYWdlTG9hZFRpbWVvdXQoKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3Jlc3RvcmVEaWFsb2dIYW5kbGVyKCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHByZXNlcnZlVXJsID0gdGhpcy5yb2xlLm9wdHMucHJlc2VydmVVcmw7XG4gICAgICAgICAgICBjb25zdCB1cmwgICAgICAgICA9IHByZXNlcnZlVXJsID8gdGhpcy5yb2xlLnVybCA6IHRoaXMudXJsO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9yZXN0b3JlUGFnZSh1cmwsIEpTT04uc3RyaW5naWZ5KHN0YXRlU25hcHNob3QpLCB0cnVlKTtcblxuICAgICAgICAgICAgaWYgKCFwcmVzZXJ2ZVVybClcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9yZXN0b3JlV29ya2luZ0ZyYW1lKCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgZXJyLmNhbGxzaXRlID0gY2FsbHNpdGU7XG5cbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGVzdFJ1bi5waGFzZSA9IHByZXZQaGFzZTtcbiAgICB9XG59XG4iXX0=
