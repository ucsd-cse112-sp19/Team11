'use strict';

exports.__esModule = true;

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _from = require('babel-runtime/core-js/array/from');

var _from2 = _interopRequireDefault(_from);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _lodash = require('lodash');

var _readFileRelative = require('read-file-relative');

var _promisifyEvent = require('promisify-event');

var _promisifyEvent2 = _interopRequireDefault(_promisifyEvent);

var _pinkie = require('pinkie');

var _pinkie2 = _interopRequireDefault(_pinkie);

var _mustache = require('mustache');

var _mustache2 = _interopRequireDefault(_mustache);

var _asyncEventEmitter = require('../utils/async-event-emitter');

var _asyncEventEmitter2 = _interopRequireDefault(_asyncEventEmitter);

var _debugLogger = require('../notifications/debug-logger');

var _debugLogger2 = _interopRequireDefault(_debugLogger);

var _debugLog = require('./debug-log');

var _debugLog2 = _interopRequireDefault(_debugLog);

var _formattableAdapter = require('../errors/test-run/formattable-adapter');

var _formattableAdapter2 = _interopRequireDefault(_formattableAdapter);

var _errorList = require('../errors/error-list');

var _errorList2 = _interopRequireDefault(_errorList);

var _testRun = require('../errors/test-run/');

var _phase = require('./phase');

var _phase2 = _interopRequireDefault(_phase);

var _clientMessages = require('./client-messages');

var _clientMessages2 = _interopRequireDefault(_clientMessages);

var _type = require('./commands/type');

var _type2 = _interopRequireDefault(_type);

var _delay = require('../utils/delay');

var _delay2 = _interopRequireDefault(_delay);

var _markerSymbol = require('./marker-symbol');

var _markerSymbol2 = _interopRequireDefault(_markerSymbol);

var _testRunTracker = require('../api/test-run-tracker');

var _testRunTracker2 = _interopRequireDefault(_testRunTracker);

var _phase3 = require('../role/phase');

var _phase4 = _interopRequireDefault(_phase3);

var _pluginHost = require('../reporter/plugin-host');

var _pluginHost2 = _interopRequireDefault(_pluginHost);

var _browserConsoleMessages = require('./browser-console-messages');

var _browserConsoleMessages2 = _interopRequireDefault(_browserConsoleMessages);

var _unstableNetworkMode = require('../browser/connection/unstable-network-mode');

var _warningLog = require('../notifications/warning-log');

var _warningLog2 = _interopRequireDefault(_warningLog);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _testcafeHammerhead = require('testcafe-hammerhead');

var _utils = require('./commands/utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const lazyRequire = require('import-lazy')(require);
const SessionController = lazyRequire('./session-controller');
const ClientFunctionBuilder = lazyRequire('../client-functions/client-function-builder');
const executeJsExpression = lazyRequire('./execute-js-expression');
const BrowserManipulationQueue = lazyRequire('./browser-manipulation-queue');
const TestRunBookmark = lazyRequire('./bookmark');
const AssertionExecutor = lazyRequire('../assertions/executor');
const actionCommands = lazyRequire('./commands/actions');
const browserManipulationCommands = lazyRequire('./commands/browser-manipulation');
const serviceCommands = lazyRequire('./commands/service');

const TEST_RUN_TEMPLATE = (0, _readFileRelative.readSync)('../client/test-run/index.js.mustache');
const IFRAME_TEST_RUN_TEMPLATE = (0, _readFileRelative.readSync)('../client/test-run/iframe.js.mustache');
const TEST_DONE_CONFIRMATION_RESPONSE = 'test-done-confirmation';
const MAX_RESPONSE_DELAY = 3000;

const ALL_DRIVER_TASKS_ADDED_TO_QUEUE_EVENT = 'all-driver-tasks-added-to-queue';

class TestRun extends _asyncEventEmitter2.default {
    constructor(test, browserConnection, screenshotCapturer, globalWarningLog, opts) {
        super();

        this[_markerSymbol2.default] = true;

        this.warningLog = new _warningLog2.default(globalWarningLog);

        this.opts = opts;
        this.test = test;
        this.browserConnection = browserConnection;

        this.phase = _phase2.default.initial;

        this.driverTaskQueue = [];
        this.testDoneCommandQueued = false;

        this.activeDialogHandler = null;
        this.activeIframeSelector = null;
        this.speed = this.opts.speed;
        this.pageLoadTimeout = this.opts.pageLoadTimeout;

        this.disablePageReloads = test.disablePageReloads || opts.disablePageReloads && test.disablePageReloads !== false;

        this.session = SessionController.getSession(this);

        this.consoleMessages = new _browserConsoleMessages2.default();

        this.pendingRequest = null;
        this.pendingPageError = null;

        this.controller = null;
        this.ctx = (0, _create2.default)(null);
        this.fixtureCtx = null;

        this.currentRoleId = null;
        this.usedRoleStates = (0, _create2.default)(null);

        this.errs = [];

        this.lastDriverStatusId = null;
        this.lastDriverStatusResponse = null;

        this.fileDownloadingHandled = false;
        this.resolveWaitForFileDownloadingPromise = null;

        this.addingDriverTasksCount = 0;

        this.debugging = this.opts.debugMode;
        this.debugOnFail = this.opts.debugOnFail;
        this.disableDebugBreakpoints = false;
        this.debugReporterPluginHost = new _pluginHost2.default({ noColors: false });

        this.browserManipulationQueue = new BrowserManipulationQueue(browserConnection, screenshotCapturer, this.warningLog);

        this.debugLog = new _debugLog2.default(this.browserConnection.userAgent);

        this.quarantine = null;

        this.injectable.scripts.push('/testcafe-core.js');
        this.injectable.scripts.push('/testcafe-ui.js');
        this.injectable.scripts.push('/testcafe-automation.js');
        this.injectable.scripts.push('/testcafe-driver.js');
        this.injectable.styles.push('/testcafe-ui-styles.css');

        this.requestHooks = (0, _from2.default)(this.test.requestHooks);

        this._initRequestHooks();
    }

    get id() {
        return this.session.id;
    }

    get injectable() {
        return this.session.injectable;
    }

    addQuarantineInfo(quarantine) {
        this.quarantine = quarantine;
    }

    addRequestHook(hook) {
        if (this.requestHooks.indexOf(hook) !== -1) return;

        this.requestHooks.push(hook);
        this._initRequestHook(hook);
    }

    removeRequestHook(hook) {
        if (this.requestHooks.indexOf(hook) === -1) return;

        (0, _lodash.pull)(this.requestHooks, hook);
        this._disposeRequestHook(hook);
    }

    _initRequestHook(hook) {
        hook.warningLog = this.warningLog;

        hook._instantiateRequestFilterRules();
        hook._instantiatedRequestFilterRules.forEach(rule => {
            this.session.addRequestEventListeners(rule, {
                onRequest: hook.onRequest.bind(hook),
                onConfigureResponse: hook._onConfigureResponse.bind(hook),
                onResponse: hook.onResponse.bind(hook)
            });
        });
    }

    _disposeRequestHook(hook) {
        hook.warningLog = null;

        hook._instantiatedRequestFilterRules.forEach(rule => {
            this.session.removeRequestEventListeners(rule);
        });
    }

    _initRequestHooks() {
        this.requestHooks.forEach(hook => this._initRequestHook(hook));
    }

    // Hammerhead payload
    _getPayloadScript() {
        this.fileDownloadingHandled = false;
        this.resolveWaitForFileDownloadingPromise = null;

        return _mustache2.default.render(TEST_RUN_TEMPLATE, {
            testRunId: (0, _stringify2.default)(this.session.id),
            browserId: (0, _stringify2.default)(this.browserConnection.id),
            browserHeartbeatRelativeUrl: (0, _stringify2.default)(this.browserConnection.heartbeatRelativeUrl),
            browserStatusRelativeUrl: (0, _stringify2.default)(this.browserConnection.statusRelativeUrl),
            browserStatusDoneRelativeUrl: (0, _stringify2.default)(this.browserConnection.statusDoneRelativeUrl),
            userAgent: (0, _stringify2.default)(this.browserConnection.userAgent),
            testName: (0, _stringify2.default)(this.test.name),
            fixtureName: (0, _stringify2.default)(this.test.fixture.name),
            selectorTimeout: this.opts.selectorTimeout,
            pageLoadTimeout: this.pageLoadTimeout,
            skipJsErrors: this.opts.skipJsErrors,
            retryTestPages: !!this.opts.retryTestPages,
            speed: this.speed,
            dialogHandler: (0, _stringify2.default)(this.activeDialogHandler)
        });
    }

    _getIframePayloadScript() {
        return _mustache2.default.render(IFRAME_TEST_RUN_TEMPLATE, {
            testRunId: (0, _stringify2.default)(this.session.id),
            selectorTimeout: this.opts.selectorTimeout,
            pageLoadTimeout: this.pageLoadTimeout,
            retryTestPages: !!this.opts.retryTestPages,
            speed: this.speed,
            dialogHandler: (0, _stringify2.default)(this.activeDialogHandler)
        });
    }

    // Hammerhead handlers
    getAuthCredentials() {
        return this.test.authCredentials;
    }

    handleFileDownload() {
        if (this.resolveWaitForFileDownloadingPromise) {
            this.resolveWaitForFileDownloadingPromise(true);
            this.resolveWaitForFileDownloadingPromise = null;
        } else this.fileDownloadingHandled = true;
    }

    handlePageError(ctx, err) {
        if (ctx.req.headers[_unstableNetworkMode.UNSTABLE_NETWORK_MODE_HEADER]) {
            ctx.closeWithError(500, err.toString());
            return;
        }

        this.pendingPageError = new _testRun.PageLoadError(err, ctx.reqOpts.url);

        ctx.redirect(ctx.toProxyUrl(_testcafeHammerhead.SPECIAL_ERROR_PAGE));
    }

    // Test function execution
    _executeTestFn(phase, fn) {
        var _this = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this.phase = phase;

            try {
                yield fn(_this);
            } catch (err) {
                let screenshotPath = null;

                if (_this.opts.takeScreenshotsOnFails) screenshotPath = yield _this.executeCommand(new browserManipulationCommands.TakeScreenshotOnFailCommand());

                _this.addError(err, screenshotPath);
                return false;
            }

            return !_this._addPendingPageErrorIfAny();
        })();
    }

    _runBeforeHook() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this2.test.beforeFn) return yield _this2._executeTestFn(_phase2.default.inTestBeforeHook, _this2.test.beforeFn);

            if (_this2.test.fixture.beforeEachFn) return yield _this2._executeTestFn(_phase2.default.inFixtureBeforeEachHook, _this2.test.fixture.beforeEachFn);

            return true;
        })();
    }

    _runAfterHook() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this3.test.afterFn) return yield _this3._executeTestFn(_phase2.default.inTestAfterHook, _this3.test.afterFn);

            if (_this3.test.fixture.afterEachFn) return yield _this3._executeTestFn(_phase2.default.inFixtureAfterEachHook, _this3.test.fixture.afterEachFn);

            return true;
        })();
    }

    start() {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _testRunTracker2.default.activeTestRuns[_this4.session.id] = _this4;

            yield _this4.emit('start');

            const onDisconnected = function onDisconnected(err) {
                return _this4._disconnect(err);
            };

            _this4.browserConnection.once('disconnected', onDisconnected);

            yield _this4.once('connected');

            yield _this4.emit('ready');

            if (yield _this4._runBeforeHook()) {
                yield _this4._executeTestFn(_phase2.default.inTest, _this4.test.fn);
                yield _this4._runAfterHook();
            }

            if (_this4.disconnected) return;

            _this4.browserConnection.removeListener('disconnected', onDisconnected);

            if (_this4.errs.length && _this4.debugOnFail) yield _this4._enqueueSetBreakpointCommand(null, _this4.debugReporterPluginHost.formatError(_this4.errs[0]));

            yield _this4.emit('before-done');

            yield _this4.executeCommand(new serviceCommands.TestDoneCommand());

            _this4._addPendingPageErrorIfAny();

            delete _testRunTracker2.default.activeTestRuns[_this4.session.id];

            yield _this4.emit('done');
        })();
    }

    // Errors
    _addPendingPageErrorIfAny() {
        if (this.pendingPageError) {
            this.addError(this.pendingPageError);
            this.pendingPageError = null;
            return true;
        }

        return false;
    }

    _createErrorAdapter(err, screenshotPath) {
        return new _formattableAdapter2.default(err, {
            userAgent: this.browserConnection.userAgent,
            screenshotPath: screenshotPath || '',
            testRunPhase: this.phase
        });
    }

    addError(err, screenshotPath) {
        const errList = err instanceof _errorList2.default ? err.items : [err];

        errList.forEach(item => {
            const adapter = this._createErrorAdapter(item, screenshotPath);

            this.errs.push(adapter);
        });
    }

    // Task queue
    _enqueueCommand(command, callsite) {
        var _this5 = this;

        if (this.pendingRequest) this._resolvePendingRequest(command);

        return new _pinkie2.default((() => {
            var _ref = (0, _asyncToGenerator3.default)(function* (resolve, reject) {
                _this5.addingDriverTasksCount--;
                _this5.driverTaskQueue.push({ command, resolve, reject, callsite });

                if (!_this5.addingDriverTasksCount) yield _this5.emit(ALL_DRIVER_TASKS_ADDED_TO_QUEUE_EVENT, _this5.driverTaskQueue.length);
            });

            return function (_x, _x2) {
                return _ref.apply(this, arguments);
            };
        })());
    }

    get driverTaskQueueLength() {
        return this.addingDriverTasksCount ? (0, _promisifyEvent2.default)(this, ALL_DRIVER_TASKS_ADDED_TO_QUEUE_EVENT) : _pinkie2.default.resolve(this.driverTaskQueue.length);
    }

    _enqueueBrowserConsoleMessagesCommand(command, callsite) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this6._enqueueCommand(command, callsite);

            return _this6.consoleMessages.getCopy();
        })();
    }

    _enqueueSetBreakpointCommand(callsite, error) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this7.browserConnection.isHeadlessBrowser()) {
                _this7.warningLog.addWarning(_warningMessage2.default.debugInHeadlessError);
                return;
            }

            _debugLogger2.default.showBreakpoint(_this7.session.id, _this7.browserConnection.userAgent, callsite, error);

            _this7.debugging = yield _this7.executeCommand(new serviceCommands.SetBreakpointCommand(!!error), callsite);
        })();
    }

    _removeAllNonServiceTasks() {
        this.driverTaskQueue = this.driverTaskQueue.filter(driverTask => (0, _utils.isServiceCommand)(driverTask.command));

        this.browserManipulationQueue.removeAllNonServiceManipulations();
    }

    // Current driver task
    get currentDriverTask() {
        return this.driverTaskQueue[0];
    }

    _resolveCurrentDriverTask(result) {
        this.currentDriverTask.resolve(result);
        this.driverTaskQueue.shift();

        if (this.testDoneCommandQueued) this._removeAllNonServiceTasks();
    }

    _rejectCurrentDriverTask(err) {
        err.callsite = err.callsite || this.currentDriverTask.callsite;

        this.currentDriverTask.reject(err);
        this._removeAllNonServiceTasks();
    }

    // Pending request
    _clearPendingRequest() {
        if (this.pendingRequest) {
            clearTimeout(this.pendingRequest.responseTimeout);
            this.pendingRequest = null;
        }
    }

    _resolvePendingRequest(command) {
        this.lastDriverStatusResponse = command;
        this.pendingRequest.resolve(command);
        this._clearPendingRequest();
    }

    // Handle driver request
    _fulfillCurrentDriverTask(driverStatus) {
        if (driverStatus.executionError) this._rejectCurrentDriverTask(driverStatus.executionError);else this._resolveCurrentDriverTask(driverStatus.result);
    }

    _handlePageErrorStatus(pageError) {
        if (this.currentDriverTask && (0, _utils.isCommandRejectableByPageError)(this.currentDriverTask.command)) {
            this._rejectCurrentDriverTask(pageError);
            this.pendingPageError = null;

            return true;
        }

        this.pendingPageError = this.pendingPageError || pageError;

        return false;
    }

    _handleDriverRequest(driverStatus) {
        const isTestDone = this.currentDriverTask && this.currentDriverTask.command.type === _type2.default.testDone;
        const pageError = this.pendingPageError || driverStatus.pageError;
        const currentTaskRejectedByError = pageError && this._handlePageErrorStatus(pageError);

        if (this.disconnected) return new _pinkie2.default((_, reject) => reject());

        this.consoleMessages.concat(driverStatus.consoleMessages);

        if (!currentTaskRejectedByError && driverStatus.isCommandResult) {
            if (isTestDone) {
                this._resolveCurrentDriverTask();

                return TEST_DONE_CONFIRMATION_RESPONSE;
            }

            this._fulfillCurrentDriverTask(driverStatus);
        }

        return this._getCurrentDriverTaskCommand();
    }

    _getCurrentDriverTaskCommand() {
        if (!this.currentDriverTask) return null;

        const command = this.currentDriverTask.command;

        if (command.type === _type2.default.navigateTo && command.stateSnapshot) this.session.useStateSnapshot(JSON.parse(command.stateSnapshot));

        return command;
    }

    // Execute command
    _executeExpression(command) {
        var _this8 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const resultVariableName = command.resultVariableName,
                  isAsyncExpression = command.isAsyncExpression;


            let expression = command.expression;

            if (isAsyncExpression) expression = `await ${expression}`;

            if (resultVariableName) expression = `${resultVariableName} = ${expression}, ${resultVariableName}`;

            if (isAsyncExpression) expression = `(async () => { return ${expression}; }).apply(this);`;

            const result = executeJsExpression(expression, _this8, { skipVisibilityCheck: false });

            return isAsyncExpression ? yield result : result;
        })();
    }

    _executeAssertion(command, callsite) {
        var _this9 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const assertionTimeout = command.options.timeout === void 0 ? _this9.opts.assertionTimeout : command.options.timeout;
            const executor = new AssertionExecutor(command, assertionTimeout, callsite);

            executor.once('start-assertion-retries', function (timeout) {
                return _this9.executeCommand(new serviceCommands.ShowAssertionRetriesStatusCommand(timeout));
            });
            executor.once('end-assertion-retries', function (success) {
                return _this9.executeCommand(new serviceCommands.HideAssertionRetriesStatusCommand(success));
            });

            return executor.run();
        })();
    }

    _adjustConfigurationWithCommand(command) {
        if (command.type === _type2.default.testDone) {
            this.testDoneCommandQueued = true;
            _debugLogger2.default.hideBreakpoint(this.session.id);
        } else if (command.type === _type2.default.setNativeDialogHandler) this.activeDialogHandler = command.dialogHandler;else if (command.type === _type2.default.switchToIframe) this.activeIframeSelector = command.selector;else if (command.type === _type2.default.switchToMainWindow) this.activeIframeSelector = null;else if (command.type === _type2.default.setTestSpeed) this.speed = command.speed;else if (command.type === _type2.default.setPageLoadTimeout) this.pageLoadTimeout = command.duration;else if (command.type === _type2.default.debug) this.debugging = true;
    }

    _adjustScreenshotCommand(command) {
        var _this10 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const browserId = _this10.browserConnection.id;

            var _ref2 = yield _this10.browserConnection.provider.hasCustomActionForBrowser(browserId);

            const hasChromelessScreenshots = _ref2.hasChromelessScreenshots;


            if (!hasChromelessScreenshots) command.generateScreenshotMark();
        })();
    }

    _setBreakpointIfNecessary(command, callsite) {
        var _this11 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (!_this11.disableDebugBreakpoints && _this11.debugging && (0, _utils.canSetDebuggerBreakpointBeforeCommand)(command)) yield _this11._enqueueSetBreakpointCommand(callsite);
        })();
    }

    executeCommand(command, callsite) {
        var _this12 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this12.debugLog.command(command);

            if (_this12.pendingPageError && (0, _utils.isCommandRejectableByPageError)(command)) return _this12._rejectCommandWithPageError(callsite);

            if ((0, _utils.isExecutableOnClientCommand)(command)) _this12.addingDriverTasksCount++;

            _this12._adjustConfigurationWithCommand(command);

            yield _this12._setBreakpointIfNecessary(command, callsite);

            if ((0, _utils.isScreenshotCommand)(command)) yield _this12._adjustScreenshotCommand(command);

            if ((0, _utils.isBrowserManipulationCommand)(command)) {
                _this12.browserManipulationQueue.push(command);

                if ((0, _utils.isResizeWindowCommand)(command) && _this12.opts.videoPath) _this12.warningLog.addWarning(_warningMessage2.default.videoBrowserResizing, _this12.test.name);
            }

            if (command.type === _type2.default.wait) return (0, _delay2.default)(command.timeout);

            if (command.type === _type2.default.setPageLoadTimeout) return null;

            if (command.type === _type2.default.debug) return yield _this12._enqueueSetBreakpointCommand(callsite);

            if (command.type === _type2.default.useRole) return yield _this12._useRole(command.role, callsite);

            if (command.type === _type2.default.assertion) return _this12._executeAssertion(command, callsite);

            if (command.type === _type2.default.executeExpression) return yield _this12._executeExpression(command, callsite);

            if (command.type === _type2.default.getBrowserConsoleMessages) return yield _this12._enqueueBrowserConsoleMessagesCommand(command, callsite);

            return _this12._enqueueCommand(command, callsite);
        })();
    }

    _rejectCommandWithPageError(callsite) {
        const err = this.pendingPageError;

        err.callsite = callsite;
        this.pendingPageError = null;

        return _pinkie2.default.reject(err);
    }

    // Role management
    getStateSnapshot() {
        var _this13 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const state = _this13.session.getStateSnapshot();

            state.storages = yield _this13.executeCommand(new serviceCommands.BackupStoragesCommand());

            return state;
        })();
    }

    switchToCleanRun() {
        var _this14 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            _this14.ctx = (0, _create2.default)(null);
            _this14.fixtureCtx = (0, _create2.default)(null);
            _this14.consoleMessages = new _browserConsoleMessages2.default();

            _this14.session.useStateSnapshot(_testcafeHammerhead.StateSnapshot.empty());

            if (_this14.activeDialogHandler) {
                const removeDialogHandlerCommand = new actionCommands.SetNativeDialogHandlerCommand({ dialogHandler: { fn: null } });

                yield _this14.executeCommand(removeDialogHandlerCommand);
            }

            if (_this14.speed !== _this14.opts.speed) {
                const setSpeedCommand = new actionCommands.SetTestSpeedCommand({ speed: _this14.opts.speed });

                yield _this14.executeCommand(setSpeedCommand);
            }

            if (_this14.pageLoadTimeout !== _this14.opts.pageLoadTimeout) {
                const setPageLoadTimeoutCommand = new actionCommands.SetPageLoadTimeoutCommand({ duration: _this14.opts.pageLoadTimeout });

                yield _this14.executeCommand(setPageLoadTimeoutCommand);
            }
        })();
    }

    _getStateSnapshotFromRole(role) {
        var _this15 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const prevPhase = _this15.phase;

            _this15.phase = _phase2.default.inRoleInitializer;

            if (role.phase === _phase4.default.uninitialized) yield role.initialize(_this15);else if (role.phase === _phase4.default.pendingInitialization) yield (0, _promisifyEvent2.default)(role, 'initialized');

            if (role.initErr) throw role.initErr;

            _this15.phase = prevPhase;

            return role.stateSnapshot;
        })();
    }

    _useRole(role, callsite) {
        var _this16 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (_this16.phase === _phase2.default.inRoleInitializer) throw new _testRun.RoleSwitchInRoleInitializerError(callsite);

            _this16.disableDebugBreakpoints = true;

            const bookmark = new TestRunBookmark(_this16, role);

            yield bookmark.init();

            if (_this16.currentRoleId) _this16.usedRoleStates[_this16.currentRoleId] = yield _this16.getStateSnapshot();

            const stateSnapshot = _this16.usedRoleStates[role.id] || (yield _this16._getStateSnapshotFromRole(role));

            _this16.session.useStateSnapshot(stateSnapshot);

            _this16.currentRoleId = role.id;

            yield bookmark.restore(callsite, stateSnapshot);

            _this16.disableDebugBreakpoints = false;
        })();
    }

    // Get current URL
    getCurrentUrl() {
        var _this17 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const builder = new ClientFunctionBuilder(function () {
                /* eslint-disable no-undef */
                return window.location.href;
                /* eslint-enable no-undef */
            }, { boundTestRun: _this17 });

            const getLocation = builder.getFunction();

            return yield getLocation();
        })();
    }

    _disconnect(err) {
        this.disconnected = true;

        if (this.currentDriverTask) this._rejectCurrentDriverTask(err);

        this.emit('disconnected', err);

        delete _testRunTracker2.default.activeTestRuns[this.session.id];
    }
}

exports.default = TestRun; // Service message handlers

const ServiceMessages = TestRun.prototype;

// NOTE: this function is time-critical and must return ASAP to avoid client disconnection
ServiceMessages[_clientMessages2.default.ready] = function (msg) {
    this.debugLog.driverMessage(msg);

    this.emit('connected');

    this._clearPendingRequest();

    // NOTE: the driver sends the status for the second time if it didn't get a response at the
    // first try. This is possible when the page was unloaded after the driver sent the status.
    if (msg.status.id === this.lastDriverStatusId) return this.lastDriverStatusResponse;

    this.lastDriverStatusId = msg.status.id;
    this.lastDriverStatusResponse = this._handleDriverRequest(msg.status);

    if (this.lastDriverStatusResponse) return this.lastDriverStatusResponse;

    // NOTE: we send an empty response after the MAX_RESPONSE_DELAY timeout is exceeded to keep connection
    // with the client and prevent the response timeout exception on the client side
    const responseTimeout = setTimeout(() => this._resolvePendingRequest(null), MAX_RESPONSE_DELAY);

    return new _pinkie2.default((resolve, reject) => {
        this.pendingRequest = { resolve, reject, responseTimeout };
    });
};

ServiceMessages[_clientMessages2.default.readyForBrowserManipulation] = (() => {
    var _ref3 = (0, _asyncToGenerator3.default)(function* (msg) {
        this.debugLog.driverMessage(msg);

        let result = null;
        let error = null;

        try {
            result = yield this.browserManipulationQueue.executePendingManipulation(msg);
        } catch (err) {
            error = err;
        }

        return { result, error };
    });

    return function (_x3) {
        return _ref3.apply(this, arguments);
    };
})();

ServiceMessages[_clientMessages2.default.waitForFileDownload] = function (msg) {
    this.debugLog.driverMessage(msg);

    return new _pinkie2.default(resolve => {
        if (this.fileDownloadingHandled) {
            this.fileDownloadingHandled = false;
            resolve(true);
        } else this.resolveWaitForFileDownloadingPromise = resolve;
    });
};
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy90ZXN0LXJ1bi9pbmRleC5qcyJdLCJuYW1lcyI6WyJsYXp5UmVxdWlyZSIsInJlcXVpcmUiLCJTZXNzaW9uQ29udHJvbGxlciIsIkNsaWVudEZ1bmN0aW9uQnVpbGRlciIsImV4ZWN1dGVKc0V4cHJlc3Npb24iLCJCcm93c2VyTWFuaXB1bGF0aW9uUXVldWUiLCJUZXN0UnVuQm9va21hcmsiLCJBc3NlcnRpb25FeGVjdXRvciIsImFjdGlvbkNvbW1hbmRzIiwiYnJvd3Nlck1hbmlwdWxhdGlvbkNvbW1hbmRzIiwic2VydmljZUNvbW1hbmRzIiwiVEVTVF9SVU5fVEVNUExBVEUiLCJJRlJBTUVfVEVTVF9SVU5fVEVNUExBVEUiLCJURVNUX0RPTkVfQ09ORklSTUFUSU9OX1JFU1BPTlNFIiwiTUFYX1JFU1BPTlNFX0RFTEFZIiwiQUxMX0RSSVZFUl9UQVNLU19BRERFRF9UT19RVUVVRV9FVkVOVCIsIlRlc3RSdW4iLCJBc3luY0V2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwidGVzdCIsImJyb3dzZXJDb25uZWN0aW9uIiwic2NyZWVuc2hvdENhcHR1cmVyIiwiZ2xvYmFsV2FybmluZ0xvZyIsIm9wdHMiLCJ0ZXN0UnVuTWFya2VyIiwid2FybmluZ0xvZyIsIldhcm5pbmdMb2ciLCJwaGFzZSIsIlBIQVNFIiwiaW5pdGlhbCIsImRyaXZlclRhc2tRdWV1ZSIsInRlc3REb25lQ29tbWFuZFF1ZXVlZCIsImFjdGl2ZURpYWxvZ0hhbmRsZXIiLCJhY3RpdmVJZnJhbWVTZWxlY3RvciIsInNwZWVkIiwicGFnZUxvYWRUaW1lb3V0IiwiZGlzYWJsZVBhZ2VSZWxvYWRzIiwic2Vzc2lvbiIsImdldFNlc3Npb24iLCJjb25zb2xlTWVzc2FnZXMiLCJCcm93c2VyQ29uc29sZU1lc3NhZ2VzIiwicGVuZGluZ1JlcXVlc3QiLCJwZW5kaW5nUGFnZUVycm9yIiwiY29udHJvbGxlciIsImN0eCIsImZpeHR1cmVDdHgiLCJjdXJyZW50Um9sZUlkIiwidXNlZFJvbGVTdGF0ZXMiLCJlcnJzIiwibGFzdERyaXZlclN0YXR1c0lkIiwibGFzdERyaXZlclN0YXR1c1Jlc3BvbnNlIiwiZmlsZURvd25sb2FkaW5nSGFuZGxlZCIsInJlc29sdmVXYWl0Rm9yRmlsZURvd25sb2FkaW5nUHJvbWlzZSIsImFkZGluZ0RyaXZlclRhc2tzQ291bnQiLCJkZWJ1Z2dpbmciLCJkZWJ1Z01vZGUiLCJkZWJ1Z09uRmFpbCIsImRpc2FibGVEZWJ1Z0JyZWFrcG9pbnRzIiwiZGVidWdSZXBvcnRlclBsdWdpbkhvc3QiLCJSZXBvcnRlclBsdWdpbkhvc3QiLCJub0NvbG9ycyIsImJyb3dzZXJNYW5pcHVsYXRpb25RdWV1ZSIsImRlYnVnTG9nIiwiVGVzdFJ1bkRlYnVnTG9nIiwidXNlckFnZW50IiwicXVhcmFudGluZSIsImluamVjdGFibGUiLCJzY3JpcHRzIiwicHVzaCIsInN0eWxlcyIsInJlcXVlc3RIb29rcyIsIl9pbml0UmVxdWVzdEhvb2tzIiwiaWQiLCJhZGRRdWFyYW50aW5lSW5mbyIsImFkZFJlcXVlc3RIb29rIiwiaG9vayIsImluZGV4T2YiLCJfaW5pdFJlcXVlc3RIb29rIiwicmVtb3ZlUmVxdWVzdEhvb2siLCJfZGlzcG9zZVJlcXVlc3RIb29rIiwiX2luc3RhbnRpYXRlUmVxdWVzdEZpbHRlclJ1bGVzIiwiX2luc3RhbnRpYXRlZFJlcXVlc3RGaWx0ZXJSdWxlcyIsImZvckVhY2giLCJydWxlIiwiYWRkUmVxdWVzdEV2ZW50TGlzdGVuZXJzIiwib25SZXF1ZXN0IiwiYmluZCIsIm9uQ29uZmlndXJlUmVzcG9uc2UiLCJfb25Db25maWd1cmVSZXNwb25zZSIsIm9uUmVzcG9uc2UiLCJyZW1vdmVSZXF1ZXN0RXZlbnRMaXN0ZW5lcnMiLCJfZ2V0UGF5bG9hZFNjcmlwdCIsIk11c3RhY2hlIiwicmVuZGVyIiwidGVzdFJ1bklkIiwiYnJvd3NlcklkIiwiYnJvd3NlckhlYXJ0YmVhdFJlbGF0aXZlVXJsIiwiaGVhcnRiZWF0UmVsYXRpdmVVcmwiLCJicm93c2VyU3RhdHVzUmVsYXRpdmVVcmwiLCJzdGF0dXNSZWxhdGl2ZVVybCIsImJyb3dzZXJTdGF0dXNEb25lUmVsYXRpdmVVcmwiLCJzdGF0dXNEb25lUmVsYXRpdmVVcmwiLCJ0ZXN0TmFtZSIsIm5hbWUiLCJmaXh0dXJlTmFtZSIsImZpeHR1cmUiLCJzZWxlY3RvclRpbWVvdXQiLCJza2lwSnNFcnJvcnMiLCJyZXRyeVRlc3RQYWdlcyIsImRpYWxvZ0hhbmRsZXIiLCJfZ2V0SWZyYW1lUGF5bG9hZFNjcmlwdCIsImdldEF1dGhDcmVkZW50aWFscyIsImF1dGhDcmVkZW50aWFscyIsImhhbmRsZUZpbGVEb3dubG9hZCIsImhhbmRsZVBhZ2VFcnJvciIsImVyciIsInJlcSIsImhlYWRlcnMiLCJVTlNUQUJMRV9ORVRXT1JLX01PREVfSEVBREVSIiwiY2xvc2VXaXRoRXJyb3IiLCJ0b1N0cmluZyIsIlBhZ2VMb2FkRXJyb3IiLCJyZXFPcHRzIiwidXJsIiwicmVkaXJlY3QiLCJ0b1Byb3h5VXJsIiwiU1BFQ0lBTF9FUlJPUl9QQUdFIiwiX2V4ZWN1dGVUZXN0Rm4iLCJmbiIsInNjcmVlbnNob3RQYXRoIiwidGFrZVNjcmVlbnNob3RzT25GYWlscyIsImV4ZWN1dGVDb21tYW5kIiwiVGFrZVNjcmVlbnNob3RPbkZhaWxDb21tYW5kIiwiYWRkRXJyb3IiLCJfYWRkUGVuZGluZ1BhZ2VFcnJvcklmQW55IiwiX3J1bkJlZm9yZUhvb2siLCJiZWZvcmVGbiIsImluVGVzdEJlZm9yZUhvb2siLCJiZWZvcmVFYWNoRm4iLCJpbkZpeHR1cmVCZWZvcmVFYWNoSG9vayIsIl9ydW5BZnRlckhvb2siLCJhZnRlckZuIiwiaW5UZXN0QWZ0ZXJIb29rIiwiYWZ0ZXJFYWNoRm4iLCJpbkZpeHR1cmVBZnRlckVhY2hIb29rIiwic3RhcnQiLCJ0ZXN0UnVuVHJhY2tlciIsImFjdGl2ZVRlc3RSdW5zIiwiZW1pdCIsIm9uRGlzY29ubmVjdGVkIiwiX2Rpc2Nvbm5lY3QiLCJvbmNlIiwiaW5UZXN0IiwiZGlzY29ubmVjdGVkIiwicmVtb3ZlTGlzdGVuZXIiLCJsZW5ndGgiLCJfZW5xdWV1ZVNldEJyZWFrcG9pbnRDb21tYW5kIiwiZm9ybWF0RXJyb3IiLCJUZXN0RG9uZUNvbW1hbmQiLCJfY3JlYXRlRXJyb3JBZGFwdGVyIiwiVGVzdFJ1bkVycm9yRm9ybWF0dGFibGVBZGFwdGVyIiwidGVzdFJ1blBoYXNlIiwiZXJyTGlzdCIsIlRlc3RDYWZlRXJyb3JMaXN0IiwiaXRlbXMiLCJpdGVtIiwiYWRhcHRlciIsIl9lbnF1ZXVlQ29tbWFuZCIsImNvbW1hbmQiLCJjYWxsc2l0ZSIsIl9yZXNvbHZlUGVuZGluZ1JlcXVlc3QiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImRyaXZlclRhc2tRdWV1ZUxlbmd0aCIsIl9lbnF1ZXVlQnJvd3NlckNvbnNvbGVNZXNzYWdlc0NvbW1hbmQiLCJnZXRDb3B5IiwiZXJyb3IiLCJpc0hlYWRsZXNzQnJvd3NlciIsImFkZFdhcm5pbmciLCJXQVJOSU5HX01FU1NBR0UiLCJkZWJ1Z0luSGVhZGxlc3NFcnJvciIsImRlYnVnTG9nZ2VyIiwic2hvd0JyZWFrcG9pbnQiLCJTZXRCcmVha3BvaW50Q29tbWFuZCIsIl9yZW1vdmVBbGxOb25TZXJ2aWNlVGFza3MiLCJmaWx0ZXIiLCJkcml2ZXJUYXNrIiwicmVtb3ZlQWxsTm9uU2VydmljZU1hbmlwdWxhdGlvbnMiLCJjdXJyZW50RHJpdmVyVGFzayIsIl9yZXNvbHZlQ3VycmVudERyaXZlclRhc2siLCJyZXN1bHQiLCJzaGlmdCIsIl9yZWplY3RDdXJyZW50RHJpdmVyVGFzayIsIl9jbGVhclBlbmRpbmdSZXF1ZXN0IiwiY2xlYXJUaW1lb3V0IiwicmVzcG9uc2VUaW1lb3V0IiwiX2Z1bGZpbGxDdXJyZW50RHJpdmVyVGFzayIsImRyaXZlclN0YXR1cyIsImV4ZWN1dGlvbkVycm9yIiwiX2hhbmRsZVBhZ2VFcnJvclN0YXR1cyIsInBhZ2VFcnJvciIsIl9oYW5kbGVEcml2ZXJSZXF1ZXN0IiwiaXNUZXN0RG9uZSIsInR5cGUiLCJDT01NQU5EX1RZUEUiLCJ0ZXN0RG9uZSIsImN1cnJlbnRUYXNrUmVqZWN0ZWRCeUVycm9yIiwiXyIsImNvbmNhdCIsImlzQ29tbWFuZFJlc3VsdCIsIl9nZXRDdXJyZW50RHJpdmVyVGFza0NvbW1hbmQiLCJuYXZpZ2F0ZVRvIiwic3RhdGVTbmFwc2hvdCIsInVzZVN0YXRlU25hcHNob3QiLCJKU09OIiwicGFyc2UiLCJfZXhlY3V0ZUV4cHJlc3Npb24iLCJyZXN1bHRWYXJpYWJsZU5hbWUiLCJpc0FzeW5jRXhwcmVzc2lvbiIsImV4cHJlc3Npb24iLCJza2lwVmlzaWJpbGl0eUNoZWNrIiwiX2V4ZWN1dGVBc3NlcnRpb24iLCJhc3NlcnRpb25UaW1lb3V0Iiwib3B0aW9ucyIsInRpbWVvdXQiLCJleGVjdXRvciIsIlNob3dBc3NlcnRpb25SZXRyaWVzU3RhdHVzQ29tbWFuZCIsIkhpZGVBc3NlcnRpb25SZXRyaWVzU3RhdHVzQ29tbWFuZCIsInN1Y2Nlc3MiLCJydW4iLCJfYWRqdXN0Q29uZmlndXJhdGlvbldpdGhDb21tYW5kIiwiaGlkZUJyZWFrcG9pbnQiLCJzZXROYXRpdmVEaWFsb2dIYW5kbGVyIiwic3dpdGNoVG9JZnJhbWUiLCJzZWxlY3RvciIsInN3aXRjaFRvTWFpbldpbmRvdyIsInNldFRlc3RTcGVlZCIsInNldFBhZ2VMb2FkVGltZW91dCIsImR1cmF0aW9uIiwiZGVidWciLCJfYWRqdXN0U2NyZWVuc2hvdENvbW1hbmQiLCJwcm92aWRlciIsImhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIiLCJoYXNDaHJvbWVsZXNzU2NyZWVuc2hvdHMiLCJnZW5lcmF0ZVNjcmVlbnNob3RNYXJrIiwiX3NldEJyZWFrcG9pbnRJZk5lY2Vzc2FyeSIsIl9yZWplY3RDb21tYW5kV2l0aFBhZ2VFcnJvciIsInZpZGVvUGF0aCIsInZpZGVvQnJvd3NlclJlc2l6aW5nIiwid2FpdCIsInVzZVJvbGUiLCJfdXNlUm9sZSIsInJvbGUiLCJhc3NlcnRpb24iLCJleGVjdXRlRXhwcmVzc2lvbiIsImdldEJyb3dzZXJDb25zb2xlTWVzc2FnZXMiLCJnZXRTdGF0ZVNuYXBzaG90Iiwic3RhdGUiLCJzdG9yYWdlcyIsIkJhY2t1cFN0b3JhZ2VzQ29tbWFuZCIsInN3aXRjaFRvQ2xlYW5SdW4iLCJTdGF0ZVNuYXBzaG90IiwiZW1wdHkiLCJyZW1vdmVEaWFsb2dIYW5kbGVyQ29tbWFuZCIsIlNldE5hdGl2ZURpYWxvZ0hhbmRsZXJDb21tYW5kIiwic2V0U3BlZWRDb21tYW5kIiwiU2V0VGVzdFNwZWVkQ29tbWFuZCIsInNldFBhZ2VMb2FkVGltZW91dENvbW1hbmQiLCJTZXRQYWdlTG9hZFRpbWVvdXRDb21tYW5kIiwiX2dldFN0YXRlU25hcHNob3RGcm9tUm9sZSIsInByZXZQaGFzZSIsImluUm9sZUluaXRpYWxpemVyIiwiUk9MRV9QSEFTRSIsInVuaW5pdGlhbGl6ZWQiLCJpbml0aWFsaXplIiwicGVuZGluZ0luaXRpYWxpemF0aW9uIiwiaW5pdEVyciIsIlJvbGVTd2l0Y2hJblJvbGVJbml0aWFsaXplckVycm9yIiwiYm9va21hcmsiLCJpbml0IiwicmVzdG9yZSIsImdldEN1cnJlbnRVcmwiLCJidWlsZGVyIiwid2luZG93IiwibG9jYXRpb24iLCJocmVmIiwiYm91bmRUZXN0UnVuIiwiZ2V0TG9jYXRpb24iLCJnZXRGdW5jdGlvbiIsIlNlcnZpY2VNZXNzYWdlcyIsInByb3RvdHlwZSIsIkNMSUVOVF9NRVNTQUdFUyIsInJlYWR5IiwibXNnIiwiZHJpdmVyTWVzc2FnZSIsInN0YXR1cyIsInNldFRpbWVvdXQiLCJyZWFkeUZvckJyb3dzZXJNYW5pcHVsYXRpb24iLCJleGVjdXRlUGVuZGluZ01hbmlwdWxhdGlvbiIsIndhaXRGb3JGaWxlRG93bmxvYWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFD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dEI7QUFDSCxLQUZNLENBQVA7QUFHSCxDQXpCRDs7QUEyQkE4RixnQkFBZ0JFLHlCQUFnQk0sMkJBQWhDO0FBQUEsZ0RBQStELFdBQWdCSixHQUFoQixFQUFxQjtBQUNoRixhQUFLeE8sUUFBTCxDQUFjeU8sYUFBZCxDQUE0QkQsR0FBNUI7O0FBRUEsWUFBSXZHLFNBQVMsSUFBYjtBQUNBLFlBQUlkLFFBQVMsSUFBYjs7QUFFQSxZQUFJO0FBQ0FjLHFCQUFTLE1BQU0sS0FBS2xJLHdCQUFMLENBQThCOE8sMEJBQTlCLENBQXlETCxHQUF6RCxDQUFmO0FBQ0gsU0FGRCxDQUdBLE9BQU9uTCxHQUFQLEVBQVk7QUFDUjhELG9CQUFROUQsR0FBUjtBQUNIOztBQUVELGVBQU8sRUFBRTRFLE1BQUYsRUFBVWQsS0FBVixFQUFQO0FBQ0gsS0FkRDs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFnQkFpSCxnQkFBZ0JFLHlCQUFnQlEsbUJBQWhDLElBQXVELFVBQVVOLEdBQVYsRUFBZTtBQUNsRSxTQUFLeE8sUUFBTCxDQUFjeU8sYUFBZCxDQUE0QkQsR0FBNUI7O0FBRUEsV0FBTyxJQUFJM0gsZ0JBQUosQ0FBWUMsV0FBVztBQUMxQixZQUFJLEtBQUt6SCxzQkFBVCxFQUFpQztBQUM3QixpQkFBS0Esc0JBQUwsR0FBOEIsS0FBOUI7QUFDQXlILG9CQUFRLElBQVI7QUFDSCxTQUhELE1BS0ksS0FBS3hILG9DQUFMLEdBQTRDd0gsT0FBNUM7QUFDUCxLQVBNLENBQVA7QUFRSCxDQVhEIiwiZmlsZSI6InRlc3QtcnVuL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHVsbCBhcyByZW1vdmUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgcmVhZFN5bmMgYXMgcmVhZCB9IGZyb20gJ3JlYWQtZmlsZS1yZWxhdGl2ZSc7XG5pbXBvcnQgcHJvbWlzaWZ5RXZlbnQgZnJvbSAncHJvbWlzaWZ5LWV2ZW50JztcbmltcG9ydCBQcm9taXNlIGZyb20gJ3BpbmtpZSc7XG5pbXBvcnQgTXVzdGFjaGUgZnJvbSAnbXVzdGFjaGUnO1xuaW1wb3J0IEFzeW5jRXZlbnRFbWl0dGVyIGZyb20gJy4uL3V0aWxzL2FzeW5jLWV2ZW50LWVtaXR0ZXInO1xuaW1wb3J0IGRlYnVnTG9nZ2VyIGZyb20gJy4uL25vdGlmaWNhdGlvbnMvZGVidWctbG9nZ2VyJztcbmltcG9ydCBUZXN0UnVuRGVidWdMb2cgZnJvbSAnLi9kZWJ1Zy1sb2cnO1xuaW1wb3J0IFRlc3RSdW5FcnJvckZvcm1hdHRhYmxlQWRhcHRlciBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4vZm9ybWF0dGFibGUtYWRhcHRlcic7XG5pbXBvcnQgVGVzdENhZmVFcnJvckxpc3QgZnJvbSAnLi4vZXJyb3JzL2Vycm9yLWxpc3QnO1xuaW1wb3J0IHsgUGFnZUxvYWRFcnJvciwgUm9sZVN3aXRjaEluUm9sZUluaXRpYWxpemVyRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvdGVzdC1ydW4vJztcbmltcG9ydCBQSEFTRSBmcm9tICcuL3BoYXNlJztcbmltcG9ydCBDTElFTlRfTUVTU0FHRVMgZnJvbSAnLi9jbGllbnQtbWVzc2FnZXMnO1xuaW1wb3J0IENPTU1BTkRfVFlQRSBmcm9tICcuL2NvbW1hbmRzL3R5cGUnO1xuaW1wb3J0IGRlbGF5IGZyb20gJy4uL3V0aWxzL2RlbGF5JztcbmltcG9ydCB0ZXN0UnVuTWFya2VyIGZyb20gJy4vbWFya2VyLXN5bWJvbCc7XG5pbXBvcnQgdGVzdFJ1blRyYWNrZXIgZnJvbSAnLi4vYXBpL3Rlc3QtcnVuLXRyYWNrZXInO1xuaW1wb3J0IFJPTEVfUEhBU0UgZnJvbSAnLi4vcm9sZS9waGFzZSc7XG5pbXBvcnQgUmVwb3J0ZXJQbHVnaW5Ib3N0IGZyb20gJy4uL3JlcG9ydGVyL3BsdWdpbi1ob3N0JztcbmltcG9ydCBCcm93c2VyQ29uc29sZU1lc3NhZ2VzIGZyb20gJy4vYnJvd3Nlci1jb25zb2xlLW1lc3NhZ2VzJztcbmltcG9ydCB7IFVOU1RBQkxFX05FVFdPUktfTU9ERV9IRUFERVIgfSBmcm9tICcuLi9icm93c2VyL2Nvbm5lY3Rpb24vdW5zdGFibGUtbmV0d29yay1tb2RlJztcbmltcG9ydCBXYXJuaW5nTG9nIGZyb20gJy4uL25vdGlmaWNhdGlvbnMvd2FybmluZy1sb2cnO1xuaW1wb3J0IFdBUk5JTkdfTUVTU0FHRSBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5pbXBvcnQgeyBTdGF0ZVNuYXBzaG90LCBTUEVDSUFMX0VSUk9SX1BBR0UgfSBmcm9tICd0ZXN0Y2FmZS1oYW1tZXJoZWFkJztcblxuaW1wb3J0IHtcbiAgICBpc0NvbW1hbmRSZWplY3RhYmxlQnlQYWdlRXJyb3IsXG4gICAgaXNCcm93c2VyTWFuaXB1bGF0aW9uQ29tbWFuZCxcbiAgICBpc1NjcmVlbnNob3RDb21tYW5kLFxuICAgIGlzU2VydmljZUNvbW1hbmQsXG4gICAgY2FuU2V0RGVidWdnZXJCcmVha3BvaW50QmVmb3JlQ29tbWFuZCxcbiAgICBpc0V4ZWN1dGFibGVPbkNsaWVudENvbW1hbmQsXG4gICAgaXNSZXNpemVXaW5kb3dDb21tYW5kXG59IGZyb20gJy4vY29tbWFuZHMvdXRpbHMnO1xuXG5jb25zdCBsYXp5UmVxdWlyZSAgICAgICAgICAgICAgICAgPSByZXF1aXJlKCdpbXBvcnQtbGF6eScpKHJlcXVpcmUpO1xuY29uc3QgU2Vzc2lvbkNvbnRyb2xsZXIgICAgICAgICAgID0gbGF6eVJlcXVpcmUoJy4vc2Vzc2lvbi1jb250cm9sbGVyJyk7XG5jb25zdCBDbGllbnRGdW5jdGlvbkJ1aWxkZXIgICAgICAgPSBsYXp5UmVxdWlyZSgnLi4vY2xpZW50LWZ1bmN0aW9ucy9jbGllbnQtZnVuY3Rpb24tYnVpbGRlcicpO1xuY29uc3QgZXhlY3V0ZUpzRXhwcmVzc2lvbiAgICAgICAgID0gbGF6eVJlcXVpcmUoJy4vZXhlY3V0ZS1qcy1leHByZXNzaW9uJyk7XG5jb25zdCBCcm93c2VyTWFuaXB1bGF0aW9uUXVldWUgICAgPSBsYXp5UmVxdWlyZSgnLi9icm93c2VyLW1hbmlwdWxhdGlvbi1xdWV1ZScpO1xuY29uc3QgVGVzdFJ1bkJvb2ttYXJrICAgICAgICAgICAgID0gbGF6eVJlcXVpcmUoJy4vYm9va21hcmsnKTtcbmNvbnN0IEFzc2VydGlvbkV4ZWN1dG9yICAgICAgICAgICA9IGxhenlSZXF1aXJlKCcuLi9hc3NlcnRpb25zL2V4ZWN1dG9yJyk7XG5jb25zdCBhY3Rpb25Db21tYW5kcyAgICAgICAgICAgICAgPSBsYXp5UmVxdWlyZSgnLi9jb21tYW5kcy9hY3Rpb25zJyk7XG5jb25zdCBicm93c2VyTWFuaXB1bGF0aW9uQ29tbWFuZHMgPSBsYXp5UmVxdWlyZSgnLi9jb21tYW5kcy9icm93c2VyLW1hbmlwdWxhdGlvbicpO1xuY29uc3Qgc2VydmljZUNvbW1hbmRzICAgICAgICAgICAgID0gbGF6eVJlcXVpcmUoJy4vY29tbWFuZHMvc2VydmljZScpO1xuXG5cbmNvbnN0IFRFU1RfUlVOX1RFTVBMQVRFICAgICAgICAgICAgICAgPSByZWFkKCcuLi9jbGllbnQvdGVzdC1ydW4vaW5kZXguanMubXVzdGFjaGUnKTtcbmNvbnN0IElGUkFNRV9URVNUX1JVTl9URU1QTEFURSAgICAgICAgPSByZWFkKCcuLi9jbGllbnQvdGVzdC1ydW4vaWZyYW1lLmpzLm11c3RhY2hlJyk7XG5jb25zdCBURVNUX0RPTkVfQ09ORklSTUFUSU9OX1JFU1BPTlNFID0gJ3Rlc3QtZG9uZS1jb25maXJtYXRpb24nO1xuY29uc3QgTUFYX1JFU1BPTlNFX0RFTEFZICAgICAgICAgICAgICA9IDMwMDA7XG5cbmNvbnN0IEFMTF9EUklWRVJfVEFTS1NfQURERURfVE9fUVVFVUVfRVZFTlQgPSAnYWxsLWRyaXZlci10YXNrcy1hZGRlZC10by1xdWV1ZSc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlc3RSdW4gZXh0ZW5kcyBBc3luY0V2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IgKHRlc3QsIGJyb3dzZXJDb25uZWN0aW9uLCBzY3JlZW5zaG90Q2FwdHVyZXIsIGdsb2JhbFdhcm5pbmdMb2csIG9wdHMpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzW3Rlc3RSdW5NYXJrZXJdID0gdHJ1ZTtcblxuICAgICAgICB0aGlzLndhcm5pbmdMb2cgPSBuZXcgV2FybmluZ0xvZyhnbG9iYWxXYXJuaW5nTG9nKTtcblxuICAgICAgICB0aGlzLm9wdHMgICAgICAgICAgICAgID0gb3B0cztcbiAgICAgICAgdGhpcy50ZXN0ICAgICAgICAgICAgICA9IHRlc3Q7XG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb24gPSBicm93c2VyQ29ubmVjdGlvbjtcblxuICAgICAgICB0aGlzLnBoYXNlID0gUEhBU0UuaW5pdGlhbDtcblxuICAgICAgICB0aGlzLmRyaXZlclRhc2tRdWV1ZSAgICAgICA9IFtdO1xuICAgICAgICB0aGlzLnRlc3REb25lQ29tbWFuZFF1ZXVlZCA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMuYWN0aXZlRGlhbG9nSGFuZGxlciAgPSBudWxsO1xuICAgICAgICB0aGlzLmFjdGl2ZUlmcmFtZVNlbGVjdG9yID0gbnVsbDtcbiAgICAgICAgdGhpcy5zcGVlZCAgICAgICAgICAgICAgICA9IHRoaXMub3B0cy5zcGVlZDtcbiAgICAgICAgdGhpcy5wYWdlTG9hZFRpbWVvdXQgICAgICA9IHRoaXMub3B0cy5wYWdlTG9hZFRpbWVvdXQ7XG5cbiAgICAgICAgdGhpcy5kaXNhYmxlUGFnZVJlbG9hZHMgPSB0ZXN0LmRpc2FibGVQYWdlUmVsb2FkcyB8fCBvcHRzLmRpc2FibGVQYWdlUmVsb2FkcyAmJiB0ZXN0LmRpc2FibGVQYWdlUmVsb2FkcyAhPT0gZmFsc2U7XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uID0gU2Vzc2lvbkNvbnRyb2xsZXIuZ2V0U2Vzc2lvbih0aGlzKTtcblxuICAgICAgICB0aGlzLmNvbnNvbGVNZXNzYWdlcyA9IG5ldyBCcm93c2VyQ29uc29sZU1lc3NhZ2VzKCk7XG5cbiAgICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdCAgID0gbnVsbDtcbiAgICAgICAgdGhpcy5wZW5kaW5nUGFnZUVycm9yID0gbnVsbDtcblxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIgPSBudWxsO1xuICAgICAgICB0aGlzLmN0eCAgICAgICAgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICB0aGlzLmZpeHR1cmVDdHggPSBudWxsO1xuXG4gICAgICAgIHRoaXMuY3VycmVudFJvbGVJZCAgPSBudWxsO1xuICAgICAgICB0aGlzLnVzZWRSb2xlU3RhdGVzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgICAgICB0aGlzLmVycnMgPSBbXTtcblxuICAgICAgICB0aGlzLmxhc3REcml2ZXJTdGF0dXNJZCAgICAgICA9IG51bGw7XG4gICAgICAgIHRoaXMubGFzdERyaXZlclN0YXR1c1Jlc3BvbnNlID0gbnVsbDtcblxuICAgICAgICB0aGlzLmZpbGVEb3dubG9hZGluZ0hhbmRsZWQgICAgICAgICAgICAgICA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlc29sdmVXYWl0Rm9yRmlsZURvd25sb2FkaW5nUHJvbWlzZSA9IG51bGw7XG5cbiAgICAgICAgdGhpcy5hZGRpbmdEcml2ZXJUYXNrc0NvdW50ID0gMDtcblxuICAgICAgICB0aGlzLmRlYnVnZ2luZyAgICAgICAgICAgICAgID0gdGhpcy5vcHRzLmRlYnVnTW9kZTtcbiAgICAgICAgdGhpcy5kZWJ1Z09uRmFpbCAgICAgICAgICAgICA9IHRoaXMub3B0cy5kZWJ1Z09uRmFpbDtcbiAgICAgICAgdGhpcy5kaXNhYmxlRGVidWdCcmVha3BvaW50cyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmRlYnVnUmVwb3J0ZXJQbHVnaW5Ib3N0ID0gbmV3IFJlcG9ydGVyUGx1Z2luSG9zdCh7IG5vQ29sb3JzOiBmYWxzZSB9KTtcblxuICAgICAgICB0aGlzLmJyb3dzZXJNYW5pcHVsYXRpb25RdWV1ZSA9IG5ldyBCcm93c2VyTWFuaXB1bGF0aW9uUXVldWUoYnJvd3NlckNvbm5lY3Rpb24sIHNjcmVlbnNob3RDYXB0dXJlciwgdGhpcy53YXJuaW5nTG9nKTtcblxuICAgICAgICB0aGlzLmRlYnVnTG9nID0gbmV3IFRlc3RSdW5EZWJ1Z0xvZyh0aGlzLmJyb3dzZXJDb25uZWN0aW9uLnVzZXJBZ2VudCk7XG5cbiAgICAgICAgdGhpcy5xdWFyYW50aW5lID0gbnVsbDtcblxuICAgICAgICB0aGlzLmluamVjdGFibGUuc2NyaXB0cy5wdXNoKCcvdGVzdGNhZmUtY29yZS5qcycpO1xuICAgICAgICB0aGlzLmluamVjdGFibGUuc2NyaXB0cy5wdXNoKCcvdGVzdGNhZmUtdWkuanMnKTtcbiAgICAgICAgdGhpcy5pbmplY3RhYmxlLnNjcmlwdHMucHVzaCgnL3Rlc3RjYWZlLWF1dG9tYXRpb24uanMnKTtcbiAgICAgICAgdGhpcy5pbmplY3RhYmxlLnNjcmlwdHMucHVzaCgnL3Rlc3RjYWZlLWRyaXZlci5qcycpO1xuICAgICAgICB0aGlzLmluamVjdGFibGUuc3R5bGVzLnB1c2goJy90ZXN0Y2FmZS11aS1zdHlsZXMuY3NzJyk7XG5cbiAgICAgICAgdGhpcy5yZXF1ZXN0SG9va3MgPSBBcnJheS5mcm9tKHRoaXMudGVzdC5yZXF1ZXN0SG9va3MpO1xuXG4gICAgICAgIHRoaXMuX2luaXRSZXF1ZXN0SG9va3MoKTtcbiAgICB9XG5cbiAgICBnZXQgaWQgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5zZXNzaW9uLmlkO1xuICAgIH1cblxuICAgIGdldCBpbmplY3RhYmxlICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2Vzc2lvbi5pbmplY3RhYmxlO1xuICAgIH1cblxuICAgIGFkZFF1YXJhbnRpbmVJbmZvIChxdWFyYW50aW5lKSB7XG4gICAgICAgIHRoaXMucXVhcmFudGluZSA9IHF1YXJhbnRpbmU7XG4gICAgfVxuXG4gICAgYWRkUmVxdWVzdEhvb2sgKGhvb2spIHtcbiAgICAgICAgaWYgKHRoaXMucmVxdWVzdEhvb2tzLmluZGV4T2YoaG9vaykgIT09IC0xKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMucmVxdWVzdEhvb2tzLnB1c2goaG9vayk7XG4gICAgICAgIHRoaXMuX2luaXRSZXF1ZXN0SG9vayhob29rKTtcbiAgICB9XG5cbiAgICByZW1vdmVSZXF1ZXN0SG9vayAoaG9vaykge1xuICAgICAgICBpZiAodGhpcy5yZXF1ZXN0SG9va3MuaW5kZXhPZihob29rKSA9PT0gLTEpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgcmVtb3ZlKHRoaXMucmVxdWVzdEhvb2tzLCBob29rKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zZVJlcXVlc3RIb29rKGhvb2spO1xuICAgIH1cblxuICAgIF9pbml0UmVxdWVzdEhvb2sgKGhvb2spIHtcbiAgICAgICAgaG9vay53YXJuaW5nTG9nID0gdGhpcy53YXJuaW5nTG9nO1xuXG4gICAgICAgIGhvb2suX2luc3RhbnRpYXRlUmVxdWVzdEZpbHRlclJ1bGVzKCk7XG4gICAgICAgIGhvb2suX2luc3RhbnRpYXRlZFJlcXVlc3RGaWx0ZXJSdWxlcy5mb3JFYWNoKHJ1bGUgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXNzaW9uLmFkZFJlcXVlc3RFdmVudExpc3RlbmVycyhydWxlLCB7XG4gICAgICAgICAgICAgICAgb25SZXF1ZXN0OiAgICAgICAgICAgaG9vay5vblJlcXVlc3QuYmluZChob29rKSxcbiAgICAgICAgICAgICAgICBvbkNvbmZpZ3VyZVJlc3BvbnNlOiBob29rLl9vbkNvbmZpZ3VyZVJlc3BvbnNlLmJpbmQoaG9vayksXG4gICAgICAgICAgICAgICAgb25SZXNwb25zZTogICAgICAgICAgaG9vay5vblJlc3BvbnNlLmJpbmQoaG9vaylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZGlzcG9zZVJlcXVlc3RIb29rIChob29rKSB7XG4gICAgICAgIGhvb2sud2FybmluZ0xvZyA9IG51bGw7XG5cbiAgICAgICAgaG9vay5faW5zdGFudGlhdGVkUmVxdWVzdEZpbHRlclJ1bGVzLmZvckVhY2gocnVsZSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlc3Npb24ucmVtb3ZlUmVxdWVzdEV2ZW50TGlzdGVuZXJzKHJ1bGUpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfaW5pdFJlcXVlc3RIb29rcyAoKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdEhvb2tzLmZvckVhY2goaG9vayA9PiB0aGlzLl9pbml0UmVxdWVzdEhvb2soaG9vaykpO1xuICAgIH1cblxuICAgIC8vIEhhbW1lcmhlYWQgcGF5bG9hZFxuICAgIF9nZXRQYXlsb2FkU2NyaXB0ICgpIHtcbiAgICAgICAgdGhpcy5maWxlRG93bmxvYWRpbmdIYW5kbGVkICAgICAgICAgICAgICAgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZXNvbHZlV2FpdEZvckZpbGVEb3dubG9hZGluZ1Byb21pc2UgPSBudWxsO1xuXG4gICAgICAgIHJldHVybiBNdXN0YWNoZS5yZW5kZXIoVEVTVF9SVU5fVEVNUExBVEUsIHtcbiAgICAgICAgICAgIHRlc3RSdW5JZDogICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KHRoaXMuc2Vzc2lvbi5pZCksXG4gICAgICAgICAgICBicm93c2VySWQ6ICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLmJyb3dzZXJDb25uZWN0aW9uLmlkKSxcbiAgICAgICAgICAgIGJyb3dzZXJIZWFydGJlYXRSZWxhdGl2ZVVybDogIEpTT04uc3RyaW5naWZ5KHRoaXMuYnJvd3NlckNvbm5lY3Rpb24uaGVhcnRiZWF0UmVsYXRpdmVVcmwpLFxuICAgICAgICAgICAgYnJvd3NlclN0YXR1c1JlbGF0aXZlVXJsOiAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5icm93c2VyQ29ubmVjdGlvbi5zdGF0dXNSZWxhdGl2ZVVybCksXG4gICAgICAgICAgICBicm93c2VyU3RhdHVzRG9uZVJlbGF0aXZlVXJsOiBKU09OLnN0cmluZ2lmeSh0aGlzLmJyb3dzZXJDb25uZWN0aW9uLnN0YXR1c0RvbmVSZWxhdGl2ZVVybCksXG4gICAgICAgICAgICB1c2VyQWdlbnQ6ICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLmJyb3dzZXJDb25uZWN0aW9uLnVzZXJBZ2VudCksXG4gICAgICAgICAgICB0ZXN0TmFtZTogICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLnRlc3QubmFtZSksXG4gICAgICAgICAgICBmaXh0dXJlTmFtZTogICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLnRlc3QuZml4dHVyZS5uYW1lKSxcbiAgICAgICAgICAgIHNlbGVjdG9yVGltZW91dDogICAgICAgICAgICAgIHRoaXMub3B0cy5zZWxlY3RvclRpbWVvdXQsXG4gICAgICAgICAgICBwYWdlTG9hZFRpbWVvdXQ6ICAgICAgICAgICAgICB0aGlzLnBhZ2VMb2FkVGltZW91dCxcbiAgICAgICAgICAgIHNraXBKc0Vycm9yczogICAgICAgICAgICAgICAgIHRoaXMub3B0cy5za2lwSnNFcnJvcnMsXG4gICAgICAgICAgICByZXRyeVRlc3RQYWdlczogICAgICAgICAgICAgICAhIXRoaXMub3B0cy5yZXRyeVRlc3RQYWdlcyxcbiAgICAgICAgICAgIHNwZWVkOiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3BlZWQsXG4gICAgICAgICAgICBkaWFsb2dIYW5kbGVyOiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLmFjdGl2ZURpYWxvZ0hhbmRsZXIpXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIF9nZXRJZnJhbWVQYXlsb2FkU2NyaXB0ICgpIHtcbiAgICAgICAgcmV0dXJuIE11c3RhY2hlLnJlbmRlcihJRlJBTUVfVEVTVF9SVU5fVEVNUExBVEUsIHtcbiAgICAgICAgICAgIHRlc3RSdW5JZDogICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXNzaW9uLmlkKSxcbiAgICAgICAgICAgIHNlbGVjdG9yVGltZW91dDogdGhpcy5vcHRzLnNlbGVjdG9yVGltZW91dCxcbiAgICAgICAgICAgIHBhZ2VMb2FkVGltZW91dDogdGhpcy5wYWdlTG9hZFRpbWVvdXQsXG4gICAgICAgICAgICByZXRyeVRlc3RQYWdlczogICEhdGhpcy5vcHRzLnJldHJ5VGVzdFBhZ2VzLFxuICAgICAgICAgICAgc3BlZWQ6ICAgICAgICAgICB0aGlzLnNwZWVkLFxuICAgICAgICAgICAgZGlhbG9nSGFuZGxlcjogICBKU09OLnN0cmluZ2lmeSh0aGlzLmFjdGl2ZURpYWxvZ0hhbmRsZXIpXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEhhbW1lcmhlYWQgaGFuZGxlcnNcbiAgICBnZXRBdXRoQ3JlZGVudGlhbHMgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50ZXN0LmF1dGhDcmVkZW50aWFscztcbiAgICB9XG5cbiAgICBoYW5kbGVGaWxlRG93bmxvYWQgKCkge1xuICAgICAgICBpZiAodGhpcy5yZXNvbHZlV2FpdEZvckZpbGVEb3dubG9hZGluZ1Byb21pc2UpIHtcbiAgICAgICAgICAgIHRoaXMucmVzb2x2ZVdhaXRGb3JGaWxlRG93bmxvYWRpbmdQcm9taXNlKHRydWUpO1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlV2FpdEZvckZpbGVEb3dubG9hZGluZ1Byb21pc2UgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIHRoaXMuZmlsZURvd25sb2FkaW5nSGFuZGxlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgaGFuZGxlUGFnZUVycm9yIChjdHgsIGVycikge1xuICAgICAgICBpZiAoY3R4LnJlcS5oZWFkZXJzW1VOU1RBQkxFX05FVFdPUktfTU9ERV9IRUFERVJdKSB7XG4gICAgICAgICAgICBjdHguY2xvc2VXaXRoRXJyb3IoNTAwLCBlcnIudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBlbmRpbmdQYWdlRXJyb3IgPSBuZXcgUGFnZUxvYWRFcnJvcihlcnIsIGN0eC5yZXFPcHRzLnVybCk7XG5cbiAgICAgICAgY3R4LnJlZGlyZWN0KGN0eC50b1Byb3h5VXJsKFNQRUNJQUxfRVJST1JfUEFHRSkpO1xuICAgIH1cblxuICAgIC8vIFRlc3QgZnVuY3Rpb24gZXhlY3V0aW9uXG4gICAgYXN5bmMgX2V4ZWN1dGVUZXN0Rm4gKHBoYXNlLCBmbikge1xuICAgICAgICB0aGlzLnBoYXNlID0gcGhhc2U7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGZuKHRoaXMpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGxldCBzY3JlZW5zaG90UGF0aCA9IG51bGw7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdHMudGFrZVNjcmVlbnNob3RzT25GYWlscylcbiAgICAgICAgICAgICAgICBzY3JlZW5zaG90UGF0aCA9IGF3YWl0IHRoaXMuZXhlY3V0ZUNvbW1hbmQobmV3IGJyb3dzZXJNYW5pcHVsYXRpb25Db21tYW5kcy5UYWtlU2NyZWVuc2hvdE9uRmFpbENvbW1hbmQoKSk7XG5cbiAgICAgICAgICAgIHRoaXMuYWRkRXJyb3IoZXJyLCBzY3JlZW5zaG90UGF0aCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gIXRoaXMuX2FkZFBlbmRpbmdQYWdlRXJyb3JJZkFueSgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9ydW5CZWZvcmVIb29rICgpIHtcbiAgICAgICAgaWYgKHRoaXMudGVzdC5iZWZvcmVGbilcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9leGVjdXRlVGVzdEZuKFBIQVNFLmluVGVzdEJlZm9yZUhvb2ssIHRoaXMudGVzdC5iZWZvcmVGbik7XG5cbiAgICAgICAgaWYgKHRoaXMudGVzdC5maXh0dXJlLmJlZm9yZUVhY2hGbilcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9leGVjdXRlVGVzdEZuKFBIQVNFLmluRml4dHVyZUJlZm9yZUVhY2hIb29rLCB0aGlzLnRlc3QuZml4dHVyZS5iZWZvcmVFYWNoRm4pO1xuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGFzeW5jIF9ydW5BZnRlckhvb2sgKCkge1xuICAgICAgICBpZiAodGhpcy50ZXN0LmFmdGVyRm4pXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZXhlY3V0ZVRlc3RGbihQSEFTRS5pblRlc3RBZnRlckhvb2ssIHRoaXMudGVzdC5hZnRlckZuKTtcblxuICAgICAgICBpZiAodGhpcy50ZXN0LmZpeHR1cmUuYWZ0ZXJFYWNoRm4pXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZXhlY3V0ZVRlc3RGbihQSEFTRS5pbkZpeHR1cmVBZnRlckVhY2hIb29rLCB0aGlzLnRlc3QuZml4dHVyZS5hZnRlckVhY2hGbik7XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RhcnQgKCkge1xuICAgICAgICB0ZXN0UnVuVHJhY2tlci5hY3RpdmVUZXN0UnVuc1t0aGlzLnNlc3Npb24uaWRdID0gdGhpcztcblxuICAgICAgICBhd2FpdCB0aGlzLmVtaXQoJ3N0YXJ0Jyk7XG5cbiAgICAgICAgY29uc3Qgb25EaXNjb25uZWN0ZWQgPSBlcnIgPT4gdGhpcy5fZGlzY29ubmVjdChlcnIpO1xuXG4gICAgICAgIHRoaXMuYnJvd3NlckNvbm5lY3Rpb24ub25jZSgnZGlzY29ubmVjdGVkJywgb25EaXNjb25uZWN0ZWQpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMub25jZSgnY29ubmVjdGVkJyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5lbWl0KCdyZWFkeScpO1xuXG4gICAgICAgIGlmIChhd2FpdCB0aGlzLl9ydW5CZWZvcmVIb29rKCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX2V4ZWN1dGVUZXN0Rm4oUEhBU0UuaW5UZXN0LCB0aGlzLnRlc3QuZm4pO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5fcnVuQWZ0ZXJIb29rKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5kaXNjb25uZWN0ZWQpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgdGhpcy5icm93c2VyQ29ubmVjdGlvbi5yZW1vdmVMaXN0ZW5lcignZGlzY29ubmVjdGVkJywgb25EaXNjb25uZWN0ZWQpO1xuXG4gICAgICAgIGlmICh0aGlzLmVycnMubGVuZ3RoICYmIHRoaXMuZGVidWdPbkZhaWwpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9lbnF1ZXVlU2V0QnJlYWtwb2ludENvbW1hbmQobnVsbCwgdGhpcy5kZWJ1Z1JlcG9ydGVyUGx1Z2luSG9zdC5mb3JtYXRFcnJvcih0aGlzLmVycnNbMF0pKTtcblxuICAgICAgICBhd2FpdCB0aGlzLmVtaXQoJ2JlZm9yZS1kb25lJyk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlQ29tbWFuZChuZXcgc2VydmljZUNvbW1hbmRzLlRlc3REb25lQ29tbWFuZCgpKTtcblxuICAgICAgICB0aGlzLl9hZGRQZW5kaW5nUGFnZUVycm9ySWZBbnkoKTtcblxuICAgICAgICBkZWxldGUgdGVzdFJ1blRyYWNrZXIuYWN0aXZlVGVzdFJ1bnNbdGhpcy5zZXNzaW9uLmlkXTtcblxuICAgICAgICBhd2FpdCB0aGlzLmVtaXQoJ2RvbmUnKTtcbiAgICB9XG5cbiAgICAvLyBFcnJvcnNcbiAgICBfYWRkUGVuZGluZ1BhZ2VFcnJvcklmQW55ICgpIHtcbiAgICAgICAgaWYgKHRoaXMucGVuZGluZ1BhZ2VFcnJvcikge1xuICAgICAgICAgICAgdGhpcy5hZGRFcnJvcih0aGlzLnBlbmRpbmdQYWdlRXJyb3IpO1xuICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGFnZUVycm9yID0gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIF9jcmVhdGVFcnJvckFkYXB0ZXIgKGVyciwgc2NyZWVuc2hvdFBhdGgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBUZXN0UnVuRXJyb3JGb3JtYXR0YWJsZUFkYXB0ZXIoZXJyLCB7XG4gICAgICAgICAgICB1c2VyQWdlbnQ6ICAgICAgdGhpcy5icm93c2VyQ29ubmVjdGlvbi51c2VyQWdlbnQsXG4gICAgICAgICAgICBzY3JlZW5zaG90UGF0aDogc2NyZWVuc2hvdFBhdGggfHwgJycsXG4gICAgICAgICAgICB0ZXN0UnVuUGhhc2U6ICAgdGhpcy5waGFzZVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhZGRFcnJvciAoZXJyLCBzY3JlZW5zaG90UGF0aCkge1xuICAgICAgICBjb25zdCBlcnJMaXN0ID0gZXJyIGluc3RhbmNlb2YgVGVzdENhZmVFcnJvckxpc3QgPyBlcnIuaXRlbXMgOiBbZXJyXTtcblxuICAgICAgICBlcnJMaXN0LmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICBjb25zdCBhZGFwdGVyID0gdGhpcy5fY3JlYXRlRXJyb3JBZGFwdGVyKGl0ZW0sIHNjcmVlbnNob3RQYXRoKTtcblxuICAgICAgICAgICAgdGhpcy5lcnJzLnB1c2goYWRhcHRlcik7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFRhc2sgcXVldWVcbiAgICBfZW5xdWV1ZUNvbW1hbmQgKGNvbW1hbmQsIGNhbGxzaXRlKSB7XG4gICAgICAgIGlmICh0aGlzLnBlbmRpbmdSZXF1ZXN0KVxuICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZVBlbmRpbmdSZXF1ZXN0KGNvbW1hbmQpO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmFkZGluZ0RyaXZlclRhc2tzQ291bnQtLTtcbiAgICAgICAgICAgIHRoaXMuZHJpdmVyVGFza1F1ZXVlLnB1c2goeyBjb21tYW5kLCByZXNvbHZlLCByZWplY3QsIGNhbGxzaXRlIH0pO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMuYWRkaW5nRHJpdmVyVGFza3NDb3VudClcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmVtaXQoQUxMX0RSSVZFUl9UQVNLU19BRERFRF9UT19RVUVVRV9FVkVOVCwgdGhpcy5kcml2ZXJUYXNrUXVldWUubGVuZ3RoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0IGRyaXZlclRhc2tRdWV1ZUxlbmd0aCAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmFkZGluZ0RyaXZlclRhc2tzQ291bnQgPyBwcm9taXNpZnlFdmVudCh0aGlzLCBBTExfRFJJVkVSX1RBU0tTX0FEREVEX1RPX1FVRVVFX0VWRU5UKSA6IFByb21pc2UucmVzb2x2ZSh0aGlzLmRyaXZlclRhc2tRdWV1ZS5sZW5ndGgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9lbnF1ZXVlQnJvd3NlckNvbnNvbGVNZXNzYWdlc0NvbW1hbmQgKGNvbW1hbmQsIGNhbGxzaXRlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2VucXVldWVDb21tYW5kKGNvbW1hbmQsIGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5jb25zb2xlTWVzc2FnZXMuZ2V0Q29weSgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9lbnF1ZXVlU2V0QnJlYWtwb2ludENvbW1hbmQgKGNhbGxzaXRlLCBlcnJvcikge1xuICAgICAgICBpZiAodGhpcy5icm93c2VyQ29ubmVjdGlvbi5pc0hlYWRsZXNzQnJvd3NlcigpKSB7XG4gICAgICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0UuZGVidWdJbkhlYWRsZXNzRXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVidWdMb2dnZXIuc2hvd0JyZWFrcG9pbnQodGhpcy5zZXNzaW9uLmlkLCB0aGlzLmJyb3dzZXJDb25uZWN0aW9uLnVzZXJBZ2VudCwgY2FsbHNpdGUsIGVycm9yKTtcblxuICAgICAgICB0aGlzLmRlYnVnZ2luZyA9IGF3YWl0IHRoaXMuZXhlY3V0ZUNvbW1hbmQobmV3IHNlcnZpY2VDb21tYW5kcy5TZXRCcmVha3BvaW50Q29tbWFuZCghIWVycm9yKSwgY2FsbHNpdGUpO1xuICAgIH1cblxuICAgIF9yZW1vdmVBbGxOb25TZXJ2aWNlVGFza3MgKCkge1xuICAgICAgICB0aGlzLmRyaXZlclRhc2tRdWV1ZSA9IHRoaXMuZHJpdmVyVGFza1F1ZXVlLmZpbHRlcihkcml2ZXJUYXNrID0+IGlzU2VydmljZUNvbW1hbmQoZHJpdmVyVGFzay5jb21tYW5kKSk7XG5cbiAgICAgICAgdGhpcy5icm93c2VyTWFuaXB1bGF0aW9uUXVldWUucmVtb3ZlQWxsTm9uU2VydmljZU1hbmlwdWxhdGlvbnMoKTtcbiAgICB9XG5cbiAgICAvLyBDdXJyZW50IGRyaXZlciB0YXNrXG4gICAgZ2V0IGN1cnJlbnREcml2ZXJUYXNrICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZHJpdmVyVGFza1F1ZXVlWzBdO1xuICAgIH1cblxuICAgIF9yZXNvbHZlQ3VycmVudERyaXZlclRhc2sgKHJlc3VsdCkge1xuICAgICAgICB0aGlzLmN1cnJlbnREcml2ZXJUYXNrLnJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgdGhpcy5kcml2ZXJUYXNrUXVldWUuc2hpZnQoKTtcblxuICAgICAgICBpZiAodGhpcy50ZXN0RG9uZUNvbW1hbmRRdWV1ZWQpXG4gICAgICAgICAgICB0aGlzLl9yZW1vdmVBbGxOb25TZXJ2aWNlVGFza3MoKTtcbiAgICB9XG5cbiAgICBfcmVqZWN0Q3VycmVudERyaXZlclRhc2sgKGVycikge1xuICAgICAgICBlcnIuY2FsbHNpdGUgPSBlcnIuY2FsbHNpdGUgfHwgdGhpcy5jdXJyZW50RHJpdmVyVGFzay5jYWxsc2l0ZTtcblxuICAgICAgICB0aGlzLmN1cnJlbnREcml2ZXJUYXNrLnJlamVjdChlcnIpO1xuICAgICAgICB0aGlzLl9yZW1vdmVBbGxOb25TZXJ2aWNlVGFza3MoKTtcbiAgICB9XG5cbiAgICAvLyBQZW5kaW5nIHJlcXVlc3RcbiAgICBfY2xlYXJQZW5kaW5nUmVxdWVzdCAoKSB7XG4gICAgICAgIGlmICh0aGlzLnBlbmRpbmdSZXF1ZXN0KSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5wZW5kaW5nUmVxdWVzdC5yZXNwb25zZVRpbWVvdXQpO1xuICAgICAgICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdCA9IG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBfcmVzb2x2ZVBlbmRpbmdSZXF1ZXN0IChjb21tYW5kKSB7XG4gICAgICAgIHRoaXMubGFzdERyaXZlclN0YXR1c1Jlc3BvbnNlID0gY29tbWFuZDtcbiAgICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdC5yZXNvbHZlKGNvbW1hbmQpO1xuICAgICAgICB0aGlzLl9jbGVhclBlbmRpbmdSZXF1ZXN0KCk7XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGRyaXZlciByZXF1ZXN0XG4gICAgX2Z1bGZpbGxDdXJyZW50RHJpdmVyVGFzayAoZHJpdmVyU3RhdHVzKSB7XG4gICAgICAgIGlmIChkcml2ZXJTdGF0dXMuZXhlY3V0aW9uRXJyb3IpXG4gICAgICAgICAgICB0aGlzLl9yZWplY3RDdXJyZW50RHJpdmVyVGFzayhkcml2ZXJTdGF0dXMuZXhlY3V0aW9uRXJyb3IpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLl9yZXNvbHZlQ3VycmVudERyaXZlclRhc2soZHJpdmVyU3RhdHVzLnJlc3VsdCk7XG4gICAgfVxuXG4gICAgX2hhbmRsZVBhZ2VFcnJvclN0YXR1cyAocGFnZUVycm9yKSB7XG4gICAgICAgIGlmICh0aGlzLmN1cnJlbnREcml2ZXJUYXNrICYmIGlzQ29tbWFuZFJlamVjdGFibGVCeVBhZ2VFcnJvcih0aGlzLmN1cnJlbnREcml2ZXJUYXNrLmNvbW1hbmQpKSB7XG4gICAgICAgICAgICB0aGlzLl9yZWplY3RDdXJyZW50RHJpdmVyVGFzayhwYWdlRXJyb3IpO1xuICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGFnZUVycm9yID0gbnVsbDtcblxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBlbmRpbmdQYWdlRXJyb3IgPSB0aGlzLnBlbmRpbmdQYWdlRXJyb3IgfHwgcGFnZUVycm9yO1xuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBfaGFuZGxlRHJpdmVyUmVxdWVzdCAoZHJpdmVyU3RhdHVzKSB7XG4gICAgICAgIGNvbnN0IGlzVGVzdERvbmUgICAgICAgICAgICAgICAgID0gdGhpcy5jdXJyZW50RHJpdmVyVGFzayAmJiB0aGlzLmN1cnJlbnREcml2ZXJUYXNrLmNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnRlc3REb25lO1xuICAgICAgICBjb25zdCBwYWdlRXJyb3IgICAgICAgICAgICAgICAgICA9IHRoaXMucGVuZGluZ1BhZ2VFcnJvciB8fCBkcml2ZXJTdGF0dXMucGFnZUVycm9yO1xuICAgICAgICBjb25zdCBjdXJyZW50VGFza1JlamVjdGVkQnlFcnJvciA9IHBhZ2VFcnJvciAmJiB0aGlzLl9oYW5kbGVQYWdlRXJyb3JTdGF0dXMocGFnZUVycm9yKTtcblxuICAgICAgICBpZiAodGhpcy5kaXNjb25uZWN0ZWQpXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4gcmVqZWN0KCkpO1xuXG4gICAgICAgIHRoaXMuY29uc29sZU1lc3NhZ2VzLmNvbmNhdChkcml2ZXJTdGF0dXMuY29uc29sZU1lc3NhZ2VzKTtcblxuICAgICAgICBpZiAoIWN1cnJlbnRUYXNrUmVqZWN0ZWRCeUVycm9yICYmIGRyaXZlclN0YXR1cy5pc0NvbW1hbmRSZXN1bHQpIHtcbiAgICAgICAgICAgIGlmIChpc1Rlc3REb25lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZUN1cnJlbnREcml2ZXJUYXNrKCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gVEVTVF9ET05FX0NPTkZJUk1BVElPTl9SRVNQT05TRTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5fZnVsZmlsbEN1cnJlbnREcml2ZXJUYXNrKGRyaXZlclN0YXR1cyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q3VycmVudERyaXZlclRhc2tDb21tYW5kKCk7XG4gICAgfVxuXG4gICAgX2dldEN1cnJlbnREcml2ZXJUYXNrQ29tbWFuZCAoKSB7XG4gICAgICAgIGlmICghdGhpcy5jdXJyZW50RHJpdmVyVGFzaylcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmN1cnJlbnREcml2ZXJUYXNrLmNvbW1hbmQ7XG5cbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLm5hdmlnYXRlVG8gJiYgY29tbWFuZC5zdGF0ZVNuYXBzaG90KVxuICAgICAgICAgICAgdGhpcy5zZXNzaW9uLnVzZVN0YXRlU25hcHNob3QoSlNPTi5wYXJzZShjb21tYW5kLnN0YXRlU25hcHNob3QpKTtcblxuICAgICAgICByZXR1cm4gY29tbWFuZDtcbiAgICB9XG5cbiAgICAvLyBFeGVjdXRlIGNvbW1hbmRcbiAgICBhc3luYyBfZXhlY3V0ZUV4cHJlc3Npb24gKGNvbW1hbmQpIHtcbiAgICAgICAgY29uc3QgeyByZXN1bHRWYXJpYWJsZU5hbWUsIGlzQXN5bmNFeHByZXNzaW9uIH0gPSBjb21tYW5kO1xuXG4gICAgICAgIGxldCBleHByZXNzaW9uID0gY29tbWFuZC5leHByZXNzaW9uO1xuXG4gICAgICAgIGlmIChpc0FzeW5jRXhwcmVzc2lvbilcbiAgICAgICAgICAgIGV4cHJlc3Npb24gPSBgYXdhaXQgJHtleHByZXNzaW9ufWA7XG5cbiAgICAgICAgaWYgKHJlc3VsdFZhcmlhYmxlTmFtZSlcbiAgICAgICAgICAgIGV4cHJlc3Npb24gPSBgJHtyZXN1bHRWYXJpYWJsZU5hbWV9ID0gJHtleHByZXNzaW9ufSwgJHtyZXN1bHRWYXJpYWJsZU5hbWV9YDtcblxuICAgICAgICBpZiAoaXNBc3luY0V4cHJlc3Npb24pXG4gICAgICAgICAgICBleHByZXNzaW9uID0gYChhc3luYyAoKSA9PiB7IHJldHVybiAke2V4cHJlc3Npb259OyB9KS5hcHBseSh0aGlzKTtgO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGV4ZWN1dGVKc0V4cHJlc3Npb24oZXhwcmVzc2lvbiwgdGhpcywgeyBza2lwVmlzaWJpbGl0eUNoZWNrOiBmYWxzZSB9KTtcblxuICAgICAgICByZXR1cm4gaXNBc3luY0V4cHJlc3Npb24gPyBhd2FpdCByZXN1bHQgOiByZXN1bHQ7XG4gICAgfVxuXG4gICAgYXN5bmMgX2V4ZWN1dGVBc3NlcnRpb24gKGNvbW1hbmQsIGNhbGxzaXRlKSB7XG4gICAgICAgIGNvbnN0IGFzc2VydGlvblRpbWVvdXQgPSBjb21tYW5kLm9wdGlvbnMudGltZW91dCA9PT0gdm9pZCAwID8gdGhpcy5vcHRzLmFzc2VydGlvblRpbWVvdXQgOiBjb21tYW5kLm9wdGlvbnMudGltZW91dDtcbiAgICAgICAgY29uc3QgZXhlY3V0b3IgICAgICAgICA9IG5ldyBBc3NlcnRpb25FeGVjdXRvcihjb21tYW5kLCBhc3NlcnRpb25UaW1lb3V0LCBjYWxsc2l0ZSk7XG5cbiAgICAgICAgZXhlY3V0b3Iub25jZSgnc3RhcnQtYXNzZXJ0aW9uLXJldHJpZXMnLCB0aW1lb3V0ID0+IHRoaXMuZXhlY3V0ZUNvbW1hbmQobmV3IHNlcnZpY2VDb21tYW5kcy5TaG93QXNzZXJ0aW9uUmV0cmllc1N0YXR1c0NvbW1hbmQodGltZW91dCkpKTtcbiAgICAgICAgZXhlY3V0b3Iub25jZSgnZW5kLWFzc2VydGlvbi1yZXRyaWVzJywgc3VjY2VzcyA9PiB0aGlzLmV4ZWN1dGVDb21tYW5kKG5ldyBzZXJ2aWNlQ29tbWFuZHMuSGlkZUFzc2VydGlvblJldHJpZXNTdGF0dXNDb21tYW5kKHN1Y2Nlc3MpKSk7XG5cbiAgICAgICAgcmV0dXJuIGV4ZWN1dG9yLnJ1bigpO1xuICAgIH1cblxuICAgIF9hZGp1c3RDb25maWd1cmF0aW9uV2l0aENvbW1hbmQgKGNvbW1hbmQpIHtcbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnRlc3REb25lKSB7XG4gICAgICAgICAgICB0aGlzLnRlc3REb25lQ29tbWFuZFF1ZXVlZCA9IHRydWU7XG4gICAgICAgICAgICBkZWJ1Z0xvZ2dlci5oaWRlQnJlYWtwb2ludCh0aGlzLnNlc3Npb24uaWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgZWxzZSBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuc2V0TmF0aXZlRGlhbG9nSGFuZGxlcilcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlRGlhbG9nSGFuZGxlciA9IGNvbW1hbmQuZGlhbG9nSGFuZGxlcjtcblxuICAgICAgICBlbHNlIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5zd2l0Y2hUb0lmcmFtZSlcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlSWZyYW1lU2VsZWN0b3IgPSBjb21tYW5kLnNlbGVjdG9yO1xuXG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnN3aXRjaFRvTWFpbldpbmRvdylcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlSWZyYW1lU2VsZWN0b3IgPSBudWxsO1xuXG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnNldFRlc3RTcGVlZClcbiAgICAgICAgICAgIHRoaXMuc3BlZWQgPSBjb21tYW5kLnNwZWVkO1xuXG4gICAgICAgIGVsc2UgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnNldFBhZ2VMb2FkVGltZW91dClcbiAgICAgICAgICAgIHRoaXMucGFnZUxvYWRUaW1lb3V0ID0gY29tbWFuZC5kdXJhdGlvbjtcblxuICAgICAgICBlbHNlIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5kZWJ1ZylcbiAgICAgICAgICAgIHRoaXMuZGVidWdnaW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBhc3luYyBfYWRqdXN0U2NyZWVuc2hvdENvbW1hbmQgKGNvbW1hbmQpIHtcbiAgICAgICAgY29uc3QgYnJvd3NlcklkICAgICAgICAgICAgICAgICAgICA9IHRoaXMuYnJvd3NlckNvbm5lY3Rpb24uaWQ7XG4gICAgICAgIGNvbnN0IHsgaGFzQ2hyb21lbGVzc1NjcmVlbnNob3RzIH0gPSBhd2FpdCB0aGlzLmJyb3dzZXJDb25uZWN0aW9uLnByb3ZpZGVyLmhhc0N1c3RvbUFjdGlvbkZvckJyb3dzZXIoYnJvd3NlcklkKTtcblxuICAgICAgICBpZiAoIWhhc0Nocm9tZWxlc3NTY3JlZW5zaG90cylcbiAgICAgICAgICAgIGNvbW1hbmQuZ2VuZXJhdGVTY3JlZW5zaG90TWFyaygpO1xuICAgIH1cblxuICAgIGFzeW5jIF9zZXRCcmVha3BvaW50SWZOZWNlc3NhcnkgKGNvbW1hbmQsIGNhbGxzaXRlKSB7XG4gICAgICAgIGlmICghdGhpcy5kaXNhYmxlRGVidWdCcmVha3BvaW50cyAmJiB0aGlzLmRlYnVnZ2luZyAmJiBjYW5TZXREZWJ1Z2dlckJyZWFrcG9pbnRCZWZvcmVDb21tYW5kKGNvbW1hbmQpKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5fZW5xdWV1ZVNldEJyZWFrcG9pbnRDb21tYW5kKGNhbGxzaXRlKTtcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlQ29tbWFuZCAoY29tbWFuZCwgY2FsbHNpdGUpIHtcbiAgICAgICAgdGhpcy5kZWJ1Z0xvZy5jb21tYW5kKGNvbW1hbmQpO1xuXG4gICAgICAgIGlmICh0aGlzLnBlbmRpbmdQYWdlRXJyb3IgJiYgaXNDb21tYW5kUmVqZWN0YWJsZUJ5UGFnZUVycm9yKGNvbW1hbmQpKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlamVjdENvbW1hbmRXaXRoUGFnZUVycm9yKGNhbGxzaXRlKTtcblxuICAgICAgICBpZiAoaXNFeGVjdXRhYmxlT25DbGllbnRDb21tYW5kKGNvbW1hbmQpKVxuICAgICAgICAgICAgdGhpcy5hZGRpbmdEcml2ZXJUYXNrc0NvdW50Kys7XG5cbiAgICAgICAgdGhpcy5fYWRqdXN0Q29uZmlndXJhdGlvbldpdGhDb21tYW5kKGNvbW1hbmQpO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX3NldEJyZWFrcG9pbnRJZk5lY2Vzc2FyeShjb21tYW5kLCBjYWxsc2l0ZSk7XG5cbiAgICAgICAgaWYgKGlzU2NyZWVuc2hvdENvbW1hbmQoY29tbWFuZCkpXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9hZGp1c3RTY3JlZW5zaG90Q29tbWFuZChjb21tYW5kKTtcblxuICAgICAgICBpZiAoaXNCcm93c2VyTWFuaXB1bGF0aW9uQ29tbWFuZChjb21tYW5kKSkge1xuICAgICAgICAgICAgdGhpcy5icm93c2VyTWFuaXB1bGF0aW9uUXVldWUucHVzaChjb21tYW5kKTtcblxuICAgICAgICAgICAgaWYgKGlzUmVzaXplV2luZG93Q29tbWFuZChjb21tYW5kKSAmJiB0aGlzLm9wdHMudmlkZW9QYXRoKVxuICAgICAgICAgICAgICAgIHRoaXMud2FybmluZ0xvZy5hZGRXYXJuaW5nKFdBUk5JTkdfTUVTU0FHRS52aWRlb0Jyb3dzZXJSZXNpemluZywgdGhpcy50ZXN0Lm5hbWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLndhaXQpXG4gICAgICAgICAgICByZXR1cm4gZGVsYXkoY29tbWFuZC50aW1lb3V0KTtcblxuICAgICAgICBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuc2V0UGFnZUxvYWRUaW1lb3V0KVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLmRlYnVnKVxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2VucXVldWVTZXRCcmVha3BvaW50Q29tbWFuZChjYWxsc2l0ZSk7XG5cbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLnVzZVJvbGUpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlUm9sZShjb21tYW5kLnJvbGUsIGNhbGxzaXRlKTtcblxuICAgICAgICBpZiAoY29tbWFuZC50eXBlID09PSBDT01NQU5EX1RZUEUuYXNzZXJ0aW9uKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVBc3NlcnRpb24oY29tbWFuZCwgY2FsbHNpdGUpO1xuXG4gICAgICAgIGlmIChjb21tYW5kLnR5cGUgPT09IENPTU1BTkRfVFlQRS5leGVjdXRlRXhwcmVzc2lvbilcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9leGVjdXRlRXhwcmVzc2lvbihjb21tYW5kLCBjYWxsc2l0ZSk7XG5cbiAgICAgICAgaWYgKGNvbW1hbmQudHlwZSA9PT0gQ09NTUFORF9UWVBFLmdldEJyb3dzZXJDb25zb2xlTWVzc2FnZXMpXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZW5xdWV1ZUJyb3dzZXJDb25zb2xlTWVzc2FnZXNDb21tYW5kKGNvbW1hbmQsIGNhbGxzaXRlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5fZW5xdWV1ZUNvbW1hbmQoY29tbWFuZCwgY2FsbHNpdGUpO1xuICAgIH1cblxuICAgIF9yZWplY3RDb21tYW5kV2l0aFBhZ2VFcnJvciAoY2FsbHNpdGUpIHtcbiAgICAgICAgY29uc3QgZXJyID0gdGhpcy5wZW5kaW5nUGFnZUVycm9yO1xuXG4gICAgICAgIGVyci5jYWxsc2l0ZSAgICAgICAgICA9IGNhbGxzaXRlO1xuICAgICAgICB0aGlzLnBlbmRpbmdQYWdlRXJyb3IgPSBudWxsO1xuXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xuICAgIH1cblxuICAgIC8vIFJvbGUgbWFuYWdlbWVudFxuICAgIGFzeW5jIGdldFN0YXRlU25hcHNob3QgKCkge1xuICAgICAgICBjb25zdCBzdGF0ZSA9IHRoaXMuc2Vzc2lvbi5nZXRTdGF0ZVNuYXBzaG90KCk7XG5cbiAgICAgICAgc3RhdGUuc3RvcmFnZXMgPSBhd2FpdCB0aGlzLmV4ZWN1dGVDb21tYW5kKG5ldyBzZXJ2aWNlQ29tbWFuZHMuQmFja3VwU3RvcmFnZXNDb21tYW5kKCkpO1xuXG4gICAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9XG5cbiAgICBhc3luYyBzd2l0Y2hUb0NsZWFuUnVuICgpIHtcbiAgICAgICAgdGhpcy5jdHggICAgICAgICAgICAgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICB0aGlzLmZpeHR1cmVDdHggICAgICA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgIHRoaXMuY29uc29sZU1lc3NhZ2VzID0gbmV3IEJyb3dzZXJDb25zb2xlTWVzc2FnZXMoKTtcblxuICAgICAgICB0aGlzLnNlc3Npb24udXNlU3RhdGVTbmFwc2hvdChTdGF0ZVNuYXBzaG90LmVtcHR5KCkpO1xuXG4gICAgICAgIGlmICh0aGlzLmFjdGl2ZURpYWxvZ0hhbmRsZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZURpYWxvZ0hhbmRsZXJDb21tYW5kID0gbmV3IGFjdGlvbkNvbW1hbmRzLlNldE5hdGl2ZURpYWxvZ0hhbmRsZXJDb21tYW5kKHsgZGlhbG9nSGFuZGxlcjogeyBmbjogbnVsbCB9IH0pO1xuXG4gICAgICAgICAgICBhd2FpdCB0aGlzLmV4ZWN1dGVDb21tYW5kKHJlbW92ZURpYWxvZ0hhbmRsZXJDb21tYW5kKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnNwZWVkICE9PSB0aGlzLm9wdHMuc3BlZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHNldFNwZWVkQ29tbWFuZCA9IG5ldyBhY3Rpb25Db21tYW5kcy5TZXRUZXN0U3BlZWRDb21tYW5kKHsgc3BlZWQ6IHRoaXMub3B0cy5zcGVlZCB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlQ29tbWFuZChzZXRTcGVlZENvbW1hbmQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMucGFnZUxvYWRUaW1lb3V0ICE9PSB0aGlzLm9wdHMucGFnZUxvYWRUaW1lb3V0KSB7XG4gICAgICAgICAgICBjb25zdCBzZXRQYWdlTG9hZFRpbWVvdXRDb21tYW5kID0gbmV3IGFjdGlvbkNvbW1hbmRzLlNldFBhZ2VMb2FkVGltZW91dENvbW1hbmQoeyBkdXJhdGlvbjogdGhpcy5vcHRzLnBhZ2VMb2FkVGltZW91dCB9KTtcblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5leGVjdXRlQ29tbWFuZChzZXRQYWdlTG9hZFRpbWVvdXRDb21tYW5kKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIF9nZXRTdGF0ZVNuYXBzaG90RnJvbVJvbGUgKHJvbGUpIHtcbiAgICAgICAgY29uc3QgcHJldlBoYXNlID0gdGhpcy5waGFzZTtcblxuICAgICAgICB0aGlzLnBoYXNlID0gUEhBU0UuaW5Sb2xlSW5pdGlhbGl6ZXI7XG5cbiAgICAgICAgaWYgKHJvbGUucGhhc2UgPT09IFJPTEVfUEhBU0UudW5pbml0aWFsaXplZClcbiAgICAgICAgICAgIGF3YWl0IHJvbGUuaW5pdGlhbGl6ZSh0aGlzKTtcblxuICAgICAgICBlbHNlIGlmIChyb2xlLnBoYXNlID09PSBST0xFX1BIQVNFLnBlbmRpbmdJbml0aWFsaXphdGlvbilcbiAgICAgICAgICAgIGF3YWl0IHByb21pc2lmeUV2ZW50KHJvbGUsICdpbml0aWFsaXplZCcpO1xuXG4gICAgICAgIGlmIChyb2xlLmluaXRFcnIpXG4gICAgICAgICAgICB0aHJvdyByb2xlLmluaXRFcnI7XG5cbiAgICAgICAgdGhpcy5waGFzZSA9IHByZXZQaGFzZTtcblxuICAgICAgICByZXR1cm4gcm9sZS5zdGF0ZVNuYXBzaG90O1xuICAgIH1cblxuICAgIGFzeW5jIF91c2VSb2xlIChyb2xlLCBjYWxsc2l0ZSkge1xuICAgICAgICBpZiAodGhpcy5waGFzZSA9PT0gUEhBU0UuaW5Sb2xlSW5pdGlhbGl6ZXIpXG4gICAgICAgICAgICB0aHJvdyBuZXcgUm9sZVN3aXRjaEluUm9sZUluaXRpYWxpemVyRXJyb3IoY2FsbHNpdGUpO1xuXG4gICAgICAgIHRoaXMuZGlzYWJsZURlYnVnQnJlYWtwb2ludHMgPSB0cnVlO1xuXG4gICAgICAgIGNvbnN0IGJvb2ttYXJrID0gbmV3IFRlc3RSdW5Cb29rbWFyayh0aGlzLCByb2xlKTtcblxuICAgICAgICBhd2FpdCBib29rbWFyay5pbml0KCk7XG5cbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFJvbGVJZClcbiAgICAgICAgICAgIHRoaXMudXNlZFJvbGVTdGF0ZXNbdGhpcy5jdXJyZW50Um9sZUlkXSA9IGF3YWl0IHRoaXMuZ2V0U3RhdGVTbmFwc2hvdCgpO1xuXG4gICAgICAgIGNvbnN0IHN0YXRlU25hcHNob3QgPSB0aGlzLnVzZWRSb2xlU3RhdGVzW3JvbGUuaWRdIHx8IGF3YWl0IHRoaXMuX2dldFN0YXRlU25hcHNob3RGcm9tUm9sZShyb2xlKTtcblxuICAgICAgICB0aGlzLnNlc3Npb24udXNlU3RhdGVTbmFwc2hvdChzdGF0ZVNuYXBzaG90KTtcblxuICAgICAgICB0aGlzLmN1cnJlbnRSb2xlSWQgPSByb2xlLmlkO1xuXG4gICAgICAgIGF3YWl0IGJvb2ttYXJrLnJlc3RvcmUoY2FsbHNpdGUsIHN0YXRlU25hcHNob3QpO1xuXG4gICAgICAgIHRoaXMuZGlzYWJsZURlYnVnQnJlYWtwb2ludHMgPSBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBHZXQgY3VycmVudCBVUkxcbiAgICBhc3luYyBnZXRDdXJyZW50VXJsICgpIHtcbiAgICAgICAgY29uc3QgYnVpbGRlciA9IG5ldyBDbGllbnRGdW5jdGlvbkJ1aWxkZXIoKCkgPT4ge1xuICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbm8tdW5kZWYgKi9cbiAgICAgICAgICAgIHJldHVybiB3aW5kb3cubG9jYXRpb24uaHJlZjtcbiAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tdW5kZWYgKi9cbiAgICAgICAgfSwgeyBib3VuZFRlc3RSdW46IHRoaXMgfSk7XG5cbiAgICAgICAgY29uc3QgZ2V0TG9jYXRpb24gPSBidWlsZGVyLmdldEZ1bmN0aW9uKCk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IGdldExvY2F0aW9uKCk7XG4gICAgfVxuXG4gICAgX2Rpc2Nvbm5lY3QgKGVycikge1xuICAgICAgICB0aGlzLmRpc2Nvbm5lY3RlZCA9IHRydWU7XG5cbiAgICAgICAgaWYgKHRoaXMuY3VycmVudERyaXZlclRhc2spXG4gICAgICAgICAgICB0aGlzLl9yZWplY3RDdXJyZW50RHJpdmVyVGFzayhlcnIpO1xuXG4gICAgICAgIHRoaXMuZW1pdCgnZGlzY29ubmVjdGVkJywgZXJyKTtcblxuICAgICAgICBkZWxldGUgdGVzdFJ1blRyYWNrZXIuYWN0aXZlVGVzdFJ1bnNbdGhpcy5zZXNzaW9uLmlkXTtcbiAgICB9XG59XG5cbi8vIFNlcnZpY2UgbWVzc2FnZSBoYW5kbGVyc1xuY29uc3QgU2VydmljZU1lc3NhZ2VzID0gVGVzdFJ1bi5wcm90b3R5cGU7XG5cbi8vIE5PVEU6IHRoaXMgZnVuY3Rpb24gaXMgdGltZS1jcml0aWNhbCBhbmQgbXVzdCByZXR1cm4gQVNBUCB0byBhdm9pZCBjbGllbnQgZGlzY29ubmVjdGlvblxuU2VydmljZU1lc3NhZ2VzW0NMSUVOVF9NRVNTQUdFUy5yZWFkeV0gPSBmdW5jdGlvbiAobXNnKSB7XG4gICAgdGhpcy5kZWJ1Z0xvZy5kcml2ZXJNZXNzYWdlKG1zZyk7XG5cbiAgICB0aGlzLmVtaXQoJ2Nvbm5lY3RlZCcpO1xuXG4gICAgdGhpcy5fY2xlYXJQZW5kaW5nUmVxdWVzdCgpO1xuXG4gICAgLy8gTk9URTogdGhlIGRyaXZlciBzZW5kcyB0aGUgc3RhdHVzIGZvciB0aGUgc2Vjb25kIHRpbWUgaWYgaXQgZGlkbid0IGdldCBhIHJlc3BvbnNlIGF0IHRoZVxuICAgIC8vIGZpcnN0IHRyeS4gVGhpcyBpcyBwb3NzaWJsZSB3aGVuIHRoZSBwYWdlIHdhcyB1bmxvYWRlZCBhZnRlciB0aGUgZHJpdmVyIHNlbnQgdGhlIHN0YXR1cy5cbiAgICBpZiAobXNnLnN0YXR1cy5pZCA9PT0gdGhpcy5sYXN0RHJpdmVyU3RhdHVzSWQpXG4gICAgICAgIHJldHVybiB0aGlzLmxhc3REcml2ZXJTdGF0dXNSZXNwb25zZTtcblxuICAgIHRoaXMubGFzdERyaXZlclN0YXR1c0lkICAgICAgID0gbXNnLnN0YXR1cy5pZDtcbiAgICB0aGlzLmxhc3REcml2ZXJTdGF0dXNSZXNwb25zZSA9IHRoaXMuX2hhbmRsZURyaXZlclJlcXVlc3QobXNnLnN0YXR1cyk7XG5cbiAgICBpZiAodGhpcy5sYXN0RHJpdmVyU3RhdHVzUmVzcG9uc2UpXG4gICAgICAgIHJldHVybiB0aGlzLmxhc3REcml2ZXJTdGF0dXNSZXNwb25zZTtcblxuICAgIC8vIE5PVEU6IHdlIHNlbmQgYW4gZW1wdHkgcmVzcG9uc2UgYWZ0ZXIgdGhlIE1BWF9SRVNQT05TRV9ERUxBWSB0aW1lb3V0IGlzIGV4Y2VlZGVkIHRvIGtlZXAgY29ubmVjdGlvblxuICAgIC8vIHdpdGggdGhlIGNsaWVudCBhbmQgcHJldmVudCB0aGUgcmVzcG9uc2UgdGltZW91dCBleGNlcHRpb24gb24gdGhlIGNsaWVudCBzaWRlXG4gICAgY29uc3QgcmVzcG9uc2VUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLl9yZXNvbHZlUGVuZGluZ1JlcXVlc3QobnVsbCksIE1BWF9SRVNQT05TRV9ERUxBWSk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0ID0geyByZXNvbHZlLCByZWplY3QsIHJlc3BvbnNlVGltZW91dCB9O1xuICAgIH0pO1xufTtcblxuU2VydmljZU1lc3NhZ2VzW0NMSUVOVF9NRVNTQUdFUy5yZWFkeUZvckJyb3dzZXJNYW5pcHVsYXRpb25dID0gYXN5bmMgZnVuY3Rpb24gKG1zZykge1xuICAgIHRoaXMuZGVidWdMb2cuZHJpdmVyTWVzc2FnZShtc2cpO1xuXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XG4gICAgbGV0IGVycm9yICA9IG51bGw7XG5cbiAgICB0cnkge1xuICAgICAgICByZXN1bHQgPSBhd2FpdCB0aGlzLmJyb3dzZXJNYW5pcHVsYXRpb25RdWV1ZS5leGVjdXRlUGVuZGluZ01hbmlwdWxhdGlvbihtc2cpO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGVycm9yID0gZXJyO1xuICAgIH1cblxuICAgIHJldHVybiB7IHJlc3VsdCwgZXJyb3IgfTtcbn07XG5cblNlcnZpY2VNZXNzYWdlc1tDTElFTlRfTUVTU0FHRVMud2FpdEZvckZpbGVEb3dubG9hZF0gPSBmdW5jdGlvbiAobXNnKSB7XG4gICAgdGhpcy5kZWJ1Z0xvZy5kcml2ZXJNZXNzYWdlKG1zZyk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmZpbGVEb3dubG9hZGluZ0hhbmRsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZmlsZURvd25sb2FkaW5nSGFuZGxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLnJlc29sdmVXYWl0Rm9yRmlsZURvd25sb2FkaW5nUHJvbWlzZSA9IHJlc29sdmU7XG4gICAgfSk7XG59O1xuIl19
