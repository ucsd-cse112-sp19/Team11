'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _lodash = require('lodash');

var _correctFilePath = require('../utils/correct-file-path');

var _correctFilePath2 = _interopRequireDefault(_correctFilePath);

var _escapeUserAgent = require('../utils/escape-user-agent');

var _escapeUserAgent2 = _interopRequireDefault(_escapeUserAgent);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DATE_FORMAT = 'YYYY-MM-DD';
const TIME_FORMAT = 'HH-mm-ss';

const ERRORS_FOLDER = 'errors';

const PROBLEMATIC_PLACEHOLDER_VALUE = '';

const PLACEHOLDERS = {
    DATE: '${DATE}',
    TIME: '${TIME}',
    TEST_INDEX: '${TEST_INDEX}',
    FILE_INDEX: '${FILE_INDEX}',
    QUARANTINE_ATTEMPT: '${QUARANTINE_ATTEMPT}',
    FIXTURE: '${FIXTURE}',
    TEST: '${TEST}',
    USERAGENT: '${USERAGENT}',
    BROWSER: '${BROWSER}',
    BROWSER_VERSION: '${BROWSER_VERSION}',
    OS: '${OS}',
    OS_VERSION: '${OS_VERSION}',
    TEST_ID: '${TEST_ID}',
    RUN_ID: '${RUN_ID}'
};

const DEFAULT_PATH_PATTERN_FOR_REPORT = `${PLACEHOLDERS.DATE}_${PLACEHOLDERS.TIME}\\${PLACEHOLDERS.TEST_ID}\\` + `${PLACEHOLDERS.RUN_ID}\\${PLACEHOLDERS.USERAGENT}\\${PLACEHOLDERS.FILE_INDEX}`;

const TEST_ID_TEMPLATE = data => data.testIndex ? `test-${data.testIndex}` : '';
const RUN_ID_TEMPLATE = data => data.quarantineAttempt ? `run-${data.quarantineAttempt}` : '';

class PathPattern extends _events2.default {
    constructor(pattern, fileExtension, data) {
        super();

        this.pattern = this._ensurePattern(pattern);
        this.data = this._addDefaultFields(data);
        this.placeholderToDataMap = this._createPlaceholderToDataMap();
        this.fileExtension = fileExtension;
    }

    _ensurePattern(pattern) {
        if (pattern) return pattern;

        return DEFAULT_PATH_PATTERN_FOR_REPORT;
    }

    _addDefaultFields(data) {
        const defaultFields = {
            testId: TEST_ID_TEMPLATE(data),
            runId: RUN_ID_TEMPLATE(data),
            formattedDate: data.now.format(DATE_FORMAT),
            formattedTime: data.now.format(TIME_FORMAT),
            fileIndex: 1,
            errorFileIndex: 1
        };

        return (0, _assign2.default)({}, defaultFields, data);
    }

    _createPlaceholderToDataMap() {
        return {
            [PLACEHOLDERS.TEST_ID]: this.data.testId,
            [PLACEHOLDERS.RUN_ID]: this.data.runId,
            [PLACEHOLDERS.DATE]: this.data.formattedDate,
            [PLACEHOLDERS.TIME]: this.data.formattedTime,
            [PLACEHOLDERS.TEST_INDEX]: this.data.testIndex,
            [PLACEHOLDERS.QUARANTINE_ATTEMPT]: this.data.quarantineAttempt || 1,
            [PLACEHOLDERS.FIXTURE]: this.data.fixture,
            [PLACEHOLDERS.TEST]: this.data.test,
            [PLACEHOLDERS.FILE_INDEX]: forError => forError ? this.data.errorFileIndex : this.data.fileIndex,
            [PLACEHOLDERS.USERAGENT]: this.data.parsedUserAgent.toString(),
            [PLACEHOLDERS.BROWSER]: this.data.parsedUserAgent.family,
            [PLACEHOLDERS.BROWSER_VERSION]: this.data.parsedUserAgent.toVersion(),
            [PLACEHOLDERS.OS]: this.data.parsedUserAgent.os.family,
            [PLACEHOLDERS.OS_VERSION]: this.data.parsedUserAgent.os.toVersion()
        };
    }

    _buildPath(pattern, placeholderToDataMap, forError) {
        let resultFilePath = pattern;
        const problematicPlaceholders = [];

        for (const placeholder in placeholderToDataMap) {
            const findPlaceholderRegExp = new RegExp((0, _lodash.escapeRegExp)(placeholder), 'g');

            resultFilePath = resultFilePath.replace(findPlaceholderRegExp, () => {
                if (placeholder === PLACEHOLDERS.FILE_INDEX) {
                    const getFileIndexFn = placeholderToDataMap[placeholder];
                    let result = getFileIndexFn(forError);

                    if (forError) result = `${ERRORS_FOLDER}\\${result}`;

                    return result;
                } else if (placeholder === PLACEHOLDERS.USERAGENT) {
                    const userAgent = placeholderToDataMap[placeholder];

                    return (0, _escapeUserAgent2.default)(userAgent);
                }

                let calculatedValue = placeholderToDataMap[placeholder];

                if (calculatedValue === null || calculatedValue === void 0) {
                    problematicPlaceholders.push(placeholder);

                    calculatedValue = PROBLEMATIC_PLACEHOLDER_VALUE;
                }

                return calculatedValue;
            });
        }

        if (problematicPlaceholders.length) this.emit('problematic-placeholders-found', { placeholders: problematicPlaceholders });

        return resultFilePath;
    }

    getPath(forError) {
        const path = this._buildPath(this.pattern, this.placeholderToDataMap, forError);

        return (0, _correctFilePath2.default)(path, this.fileExtension);
    }

    // For testing purposes
    static get PLACEHOLDERS() {
        return PLACEHOLDERS;
    }
}
exports.default = PathPattern;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9wYXRoLXBhdHRlcm4uanMiXSwibmFtZXMiOlsiREFURV9GT1JNQVQiLCJUSU1FX0ZPUk1BVCIsIkVSUk9SU19GT0xERVIiLCJQUk9CTEVNQVRJQ19QTEFDRUhPTERFUl9WQUxVRSIsIlBMQUNFSE9MREVSUyIsIkRBVEUiLCJUSU1FIiwiVEVTVF9JTkRFWCIsIkZJTEVfSU5ERVgiLCJRVUFSQU5USU5FX0FUVEVNUFQiLCJGSVhUVVJFIiwiVEVTVCIsIlVTRVJBR0VOVCIsIkJST1dTRVIiLCJCUk9XU0VSX1ZFUlNJT04iLCJPUyIsIk9TX1ZFUlNJT04iLCJURVNUX0lEIiwiUlVOX0lEIiwiREVGQVVMVF9QQVRIX1BBVFRFUk5fRk9SX1JFUE9SVCIsIlRFU1RfSURfVEVNUExBVEUiLCJkYXRhIiwidGVzdEluZGV4IiwiUlVOX0lEX1RFTVBMQVRFIiwicXVhcmFudGluZUF0dGVtcHQiLCJQYXRoUGF0dGVybiIsIkV2ZW50RW1pdHRlciIsImNvbnN0cnVjdG9yIiwicGF0dGVybiIsImZpbGVFeHRlbnNpb24iLCJfZW5zdXJlUGF0dGVybiIsIl9hZGREZWZhdWx0RmllbGRzIiwicGxhY2Vob2xkZXJUb0RhdGFNYXAiLCJfY3JlYXRlUGxhY2Vob2xkZXJUb0RhdGFNYXAiLCJkZWZhdWx0RmllbGRzIiwidGVzdElkIiwicnVuSWQiLCJmb3JtYXR0ZWREYXRlIiwibm93IiwiZm9ybWF0IiwiZm9ybWF0dGVkVGltZSIsImZpbGVJbmRleCIsImVycm9yRmlsZUluZGV4IiwiZml4dHVyZSIsInRlc3QiLCJmb3JFcnJvciIsInBhcnNlZFVzZXJBZ2VudCIsInRvU3RyaW5nIiwiZmFtaWx5IiwidG9WZXJzaW9uIiwib3MiLCJfYnVpbGRQYXRoIiwicmVzdWx0RmlsZVBhdGgiLCJwcm9ibGVtYXRpY1BsYWNlaG9sZGVycyIsInBsYWNlaG9sZGVyIiwiZmluZFBsYWNlaG9sZGVyUmVnRXhwIiwiUmVnRXhwIiwicmVwbGFjZSIsImdldEZpbGVJbmRleEZuIiwicmVzdWx0IiwidXNlckFnZW50IiwiY2FsY3VsYXRlZFZhbHVlIiwicHVzaCIsImxlbmd0aCIsImVtaXQiLCJwbGFjZWhvbGRlcnMiLCJnZXRQYXRoIiwicGF0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLGNBQWMsWUFBcEI7QUFDQSxNQUFNQyxjQUFjLFVBQXBCOztBQUVBLE1BQU1DLGdCQUFnQixRQUF0Qjs7QUFFQSxNQUFNQyxnQ0FBZ0MsRUFBdEM7O0FBRUEsTUFBTUMsZUFBZTtBQUNqQkMsVUFBb0IsU0FESDtBQUVqQkMsVUFBb0IsU0FGSDtBQUdqQkMsZ0JBQW9CLGVBSEg7QUFJakJDLGdCQUFvQixlQUpIO0FBS2pCQyx3QkFBb0IsdUJBTEg7QUFNakJDLGFBQW9CLFlBTkg7QUFPakJDLFVBQW9CLFNBUEg7QUFRakJDLGVBQW9CLGNBUkg7QUFTakJDLGFBQW9CLFlBVEg7QUFVakJDLHFCQUFvQixvQkFWSDtBQVdqQkMsUUFBb0IsT0FYSDtBQVlqQkMsZ0JBQW9CLGVBWkg7QUFhakJDLGFBQW9CLFlBYkg7QUFjakJDLFlBQW9CO0FBZEgsQ0FBckI7O0FBaUJBLE1BQU1DLGtDQUFtQyxHQUFFZixhQUFhQyxJQUFLLElBQUdELGFBQWFFLElBQUssS0FBSUYsYUFBYWEsT0FBUSxJQUFuRSxHQUNDLEdBQUViLGFBQWFjLE1BQU8sS0FBSWQsYUFBYVEsU0FBVSxLQUFJUixhQUFhSSxVQUFXLEVBRHRIOztBQUdBLE1BQU1ZLG1CQUFtQkMsUUFBUUEsS0FBS0MsU0FBTCxHQUFrQixRQUFPRCxLQUFLQyxTQUFVLEVBQXhDLEdBQTRDLEVBQTdFO0FBQ0EsTUFBTUMsa0JBQW1CRixRQUFRQSxLQUFLRyxpQkFBTCxHQUEwQixPQUFNSCxLQUFLRyxpQkFBa0IsRUFBdkQsR0FBMkQsRUFBNUY7O0FBRWUsTUFBTUMsV0FBTixTQUEwQkMsZ0JBQTFCLENBQXVDO0FBQ2xEQyxnQkFBYUMsT0FBYixFQUFzQkMsYUFBdEIsRUFBcUNS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IjoidXRpbHMvcGF0aC1wYXR0ZXJuLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXNjYXBlUmVnRXhwIGFzIGVzY2FwZVJlIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBjb3JyZWN0RmlsZVBhdGggZnJvbSAnLi4vdXRpbHMvY29ycmVjdC1maWxlLXBhdGgnO1xuaW1wb3J0IGVzY2FwZVVzZXJBZ2VudCBmcm9tICcuLi91dGlscy9lc2NhcGUtdXNlci1hZ2VudCc7XG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gJ2V2ZW50cyc7XG5cbmNvbnN0IERBVEVfRk9STUFUID0gJ1lZWVktTU0tREQnO1xuY29uc3QgVElNRV9GT1JNQVQgPSAnSEgtbW0tc3MnO1xuXG5jb25zdCBFUlJPUlNfRk9MREVSID0gJ2Vycm9ycyc7XG5cbmNvbnN0IFBST0JMRU1BVElDX1BMQUNFSE9MREVSX1ZBTFVFID0gJyc7XG5cbmNvbnN0IFBMQUNFSE9MREVSUyA9IHtcbiAgICBEQVRFOiAgICAgICAgICAgICAgICcke0RBVEV9JyxcbiAgICBUSU1FOiAgICAgICAgICAgICAgICcke1RJTUV9JyxcbiAgICBURVNUX0lOREVYOiAgICAgICAgICcke1RFU1RfSU5ERVh9JyxcbiAgICBGSUxFX0lOREVYOiAgICAgICAgICcke0ZJTEVfSU5ERVh9JyxcbiAgICBRVUFSQU5USU5FX0FUVEVNUFQ6ICcke1FVQVJBTlRJTkVfQVRURU1QVH0nLFxuICAgIEZJWFRVUkU6ICAgICAgICAgICAgJyR7RklYVFVSRX0nLFxuICAgIFRFU1Q6ICAgICAgICAgICAgICAgJyR7VEVTVH0nLFxuICAgIFVTRVJBR0VOVDogICAgICAgICAgJyR7VVNFUkFHRU5UfScsXG4gICAgQlJPV1NFUjogICAgICAgICAgICAnJHtCUk9XU0VSfScsXG4gICAgQlJPV1NFUl9WRVJTSU9OOiAgICAnJHtCUk9XU0VSX1ZFUlNJT059JyxcbiAgICBPUzogICAgICAgICAgICAgICAgICcke09TfScsXG4gICAgT1NfVkVSU0lPTjogICAgICAgICAnJHtPU19WRVJTSU9OfScsXG4gICAgVEVTVF9JRDogICAgICAgICAgICAnJHtURVNUX0lEfScsXG4gICAgUlVOX0lEOiAgICAgICAgICAgICAnJHtSVU5fSUR9J1xufTtcblxuY29uc3QgREVGQVVMVF9QQVRIX1BBVFRFUk5fRk9SX1JFUE9SVCA9IGAke1BMQUNFSE9MREVSUy5EQVRFfV8ke1BMQUNFSE9MREVSUy5USU1FfVxcXFwke1BMQUNFSE9MREVSUy5URVNUX0lEfVxcXFxgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtQTEFDRUhPTERFUlMuUlVOX0lEfVxcXFwke1BMQUNFSE9MREVSUy5VU0VSQUdFTlR9XFxcXCR7UExBQ0VIT0xERVJTLkZJTEVfSU5ERVh9YDtcblxuY29uc3QgVEVTVF9JRF9URU1QTEFURSA9IGRhdGEgPT4gZGF0YS50ZXN0SW5kZXggPyBgdGVzdC0ke2RhdGEudGVzdEluZGV4fWAgOiAnJztcbmNvbnN0IFJVTl9JRF9URU1QTEFURSAgPSBkYXRhID0+IGRhdGEucXVhcmFudGluZUF0dGVtcHQgPyBgcnVuLSR7ZGF0YS5xdWFyYW50aW5lQXR0ZW1wdH1gIDogJyc7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBhdGhQYXR0ZXJuIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBjb25zdHJ1Y3RvciAocGF0dGVybiwgZmlsZUV4dGVuc2lvbiwgZGF0YSkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMucGF0dGVybiAgICAgICAgICAgICAgPSB0aGlzLl9lbnN1cmVQYXR0ZXJuKHBhdHRlcm4pO1xuICAgICAgICB0aGlzLmRhdGEgICAgICAgICAgICAgICAgID0gdGhpcy5fYWRkRGVmYXVsdEZpZWxkcyhkYXRhKTtcbiAgICAgICAgdGhpcy5wbGFjZWhvbGRlclRvRGF0YU1hcCA9IHRoaXMuX2NyZWF0ZVBsYWNlaG9sZGVyVG9EYXRhTWFwKCk7XG4gICAgICAgIHRoaXMuZmlsZUV4dGVuc2lvbiAgICAgICAgPSBmaWxlRXh0ZW5zaW9uO1xuICAgIH1cblxuICAgIF9lbnN1cmVQYXR0ZXJuIChwYXR0ZXJuKSB7XG4gICAgICAgIGlmIChwYXR0ZXJuKVxuICAgICAgICAgICAgcmV0dXJuIHBhdHRlcm47XG5cbiAgICAgICAgcmV0dXJuIERFRkFVTFRfUEFUSF9QQVRURVJOX0ZPUl9SRVBPUlQ7XG4gICAgfVxuXG4gICAgX2FkZERlZmF1bHRGaWVsZHMgKGRhdGEpIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEZpZWxkcyA9IHtcbiAgICAgICAgICAgIHRlc3RJZDogICAgICAgICBURVNUX0lEX1RFTVBMQVRFKGRhdGEpLFxuICAgICAgICAgICAgcnVuSWQ6ICAgICAgICAgIFJVTl9JRF9URU1QTEFURShkYXRhKSxcbiAgICAgICAgICAgIGZvcm1hdHRlZERhdGU6ICBkYXRhLm5vdy5mb3JtYXQoREFURV9GT1JNQVQpLFxuICAgICAgICAgICAgZm9ybWF0dGVkVGltZTogIGRhdGEubm93LmZvcm1hdChUSU1FX0ZPUk1BVCksXG4gICAgICAgICAgICBmaWxlSW5kZXg6ICAgICAgMSxcbiAgICAgICAgICAgIGVycm9yRmlsZUluZGV4OiAxXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRGaWVsZHMsIGRhdGEpO1xuICAgIH1cblxuICAgIF9jcmVhdGVQbGFjZWhvbGRlclRvRGF0YU1hcCAoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlRFU1RfSURdOiAgICAgICAgICAgIHRoaXMuZGF0YS50ZXN0SWQsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlJVTl9JRF06ICAgICAgICAgICAgIHRoaXMuZGF0YS5ydW5JZCxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuREFURV06ICAgICAgICAgICAgICAgdGhpcy5kYXRhLmZvcm1hdHRlZERhdGUsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlRJTUVdOiAgICAgICAgICAgICAgIHRoaXMuZGF0YS5mb3JtYXR0ZWRUaW1lLFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5URVNUX0lOREVYXTogICAgICAgICB0aGlzLmRhdGEudGVzdEluZGV4LFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5RVUFSQU5USU5FX0FUVEVNUFRdOiB0aGlzLmRhdGEucXVhcmFudGluZUF0dGVtcHQgfHwgMSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuRklYVFVSRV06ICAgICAgICAgICAgdGhpcy5kYXRhLmZpeHR1cmUsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlRFU1RdOiAgICAgICAgICAgICAgIHRoaXMuZGF0YS50ZXN0LFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5GSUxFX0lOREVYXTogICAgICAgICBmb3JFcnJvciA9PiBmb3JFcnJvciA/IHRoaXMuZGF0YS5lcnJvckZpbGVJbmRleCA6IHRoaXMuZGF0YS5maWxlSW5kZXgsXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLlVTRVJBR0VOVF06ICAgICAgICAgIHRoaXMuZGF0YS5wYXJzZWRVc2VyQWdlbnQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIFtQTEFDRUhPTERFUlMuQlJPV1NFUl06ICAgICAgICAgICAgdGhpcy5kYXRhLnBhcnNlZFVzZXJBZ2VudC5mYW1pbHksXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLkJST1dTRVJfVkVSU0lPTl06ICAgIHRoaXMuZGF0YS5wYXJzZWRVc2VyQWdlbnQudG9WZXJzaW9uKCksXG4gICAgICAgICAgICBbUExBQ0VIT0xERVJTLk9TXTogICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5wYXJzZWRVc2VyQWdlbnQub3MuZmFtaWx5LFxuICAgICAgICAgICAgW1BMQUNFSE9MREVSUy5PU19WRVJTSU9OXTogICAgICAgICB0aGlzLmRhdGEucGFyc2VkVXNlckFnZW50Lm9zLnRvVmVyc2lvbigpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgX2J1aWxkUGF0aCAocGF0dGVybiwgcGxhY2Vob2xkZXJUb0RhdGFNYXAsIGZvckVycm9yKSB7XG4gICAgICAgIGxldCByZXN1bHRGaWxlUGF0aCAgICAgICAgICAgID0gcGF0dGVybjtcbiAgICAgICAgY29uc3QgcHJvYmxlbWF0aWNQbGFjZWhvbGRlcnMgPSBbXTtcblxuICAgICAgICBmb3IgKGNvbnN0IHBsYWNlaG9sZGVyIGluIHBsYWNlaG9sZGVyVG9EYXRhTWFwKSB7XG4gICAgICAgICAgICBjb25zdCBmaW5kUGxhY2Vob2xkZXJSZWdFeHAgPSBuZXcgUmVnRXhwKGVzY2FwZVJlKHBsYWNlaG9sZGVyKSwgJ2cnKTtcblxuICAgICAgICAgICAgcmVzdWx0RmlsZVBhdGggPSByZXN1bHRGaWxlUGF0aC5yZXBsYWNlKGZpbmRQbGFjZWhvbGRlclJlZ0V4cCwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwbGFjZWhvbGRlciA9PT0gUExBQ0VIT0xERVJTLkZJTEVfSU5ERVgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZ2V0RmlsZUluZGV4Rm4gPSBwbGFjZWhvbGRlclRvRGF0YU1hcFtwbGFjZWhvbGRlcl07XG4gICAgICAgICAgICAgICAgICAgIGxldCByZXN1bHQgICAgICAgICAgID0gZ2V0RmlsZUluZGV4Rm4oZm9yRXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JFcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdCA9IGAke0VSUk9SU19GT0xERVJ9XFxcXCR7cmVzdWx0fWA7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwbGFjZWhvbGRlciA9PT0gUExBQ0VIT0xERVJTLlVTRVJBR0VOVCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyQWdlbnQgPSBwbGFjZWhvbGRlclRvRGF0YU1hcFtwbGFjZWhvbGRlcl07XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzY2FwZVVzZXJBZ2VudCh1c2VyQWdlbnQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBjYWxjdWxhdGVkVmFsdWUgPSBwbGFjZWhvbGRlclRvRGF0YU1hcFtwbGFjZWhvbGRlcl07XG5cbiAgICAgICAgICAgICAgICBpZiAoY2FsY3VsYXRlZFZhbHVlID09PSBudWxsIHx8IGNhbGN1bGF0ZWRWYWx1ZSA9PT0gdm9pZCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2JsZW1hdGljUGxhY2Vob2xkZXJzLnB1c2gocGxhY2Vob2xkZXIpO1xuXG4gICAgICAgICAgICAgICAgICAgIGNhbGN1bGF0ZWRWYWx1ZSA9IFBST0JMRU1BVElDX1BMQUNFSE9MREVSX1ZBTFVFO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBjYWxjdWxhdGVkVmFsdWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9ibGVtYXRpY1BsYWNlaG9sZGVycy5sZW5ndGgpXG4gICAgICAgICAgICB0aGlzLmVtaXQoJ3Byb2JsZW1hdGljLXBsYWNlaG9sZGVycy1mb3VuZCcsIHsgcGxhY2Vob2xkZXJzOiBwcm9ibGVtYXRpY1BsYWNlaG9sZGVycyB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0RmlsZVBhdGg7XG4gICAgfVxuXG4gICAgZ2V0UGF0aCAoZm9yRXJyb3IpIHtcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuX2J1aWxkUGF0aCh0aGlzLnBhdHRlcm4sIHRoaXMucGxhY2Vob2xkZXJUb0RhdGFNYXAsIGZvckVycm9yKTtcblxuICAgICAgICByZXR1cm4gY29ycmVjdEZpbGVQYXRoKHBhdGgsIHRoaXMuZmlsZUV4dGVuc2lvbik7XG4gICAgfVxuXG4gICAgLy8gRm9yIHRlc3RpbmcgcHVycG9zZXNcbiAgICBzdGF0aWMgZ2V0IFBMQUNFSE9MREVSUyAoKSB7XG4gICAgICAgIHJldHVybiBQTEFDRUhPTERFUlM7XG4gICAgfVxufVxuIl19
