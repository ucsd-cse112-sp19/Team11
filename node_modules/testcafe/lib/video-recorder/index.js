'use strict';

exports.__esModule = true;

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _path = require('path');

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _child_process = require('child_process');

var _makeDir = require('make-dir');

var _makeDir2 = _interopRequireDefault(_makeDir);

var _tempDirectory = require('../utils/temp-directory');

var _tempDirectory2 = _interopRequireDefault(_tempDirectory);

var _pathPattern = require('../utils/path-pattern');

var _pathPattern2 = _interopRequireDefault(_pathPattern);

var _warningMessage = require('../notifications/warning-message');

var _warningMessage2 = _interopRequireDefault(_warningMessage);

var _string = require('../utils/string');

var _testRunVideoRecorder = require('./test-run-video-recorder');

var _testRunVideoRecorder2 = _interopRequireDefault(_testRunVideoRecorder);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DEBUG_LOGGER = (0, _debug2.default)('testcafe:video-recorder');

const VIDEO_EXTENSION = 'mp4';
const TEMP_DIR_PREFIX = 'video';

class VideoRecorder {
    constructor(browserJob, basePath, opts, encodingOpts, warningLog) {
        this.browserJob = browserJob;
        this.basePath = basePath;
        this.failedOnly = opts.failedOnly;
        this.singleFile = opts.singleFile;
        this.ffmpegPath = opts.ffmpegPath;
        this.customPathPattern = opts.pathPattern;
        this.timeStamp = opts.timeStamp;
        this.encodingOptions = encodingOpts;

        this.warningLog = warningLog;

        this.tempDirectory = new _tempDirectory2.default(TEMP_DIR_PREFIX);

        this.firstFile = true;

        this.testRunVideoRecorders = {};

        this._assignEventHandlers(browserJob);
    }

    _createSafeListener(listener) {
        var _this = this;

        return (() => {
            var _ref = (0, _asyncToGenerator3.default)(function* (...args) {
                try {
                    return yield listener.apply(_this, args);
                } catch (error) {
                    DEBUG_LOGGER(listener && listener.name, error);

                    return void 0;
                }
            });

            return function () {
                return _ref.apply(this, arguments);
            };
        })();
    }

    _assignEventHandlers(browserJob) {
        browserJob.once('start', this._createSafeListener(() => {
            this.tempDirectoryInitializedPromise = this._onBrowserJobStart();

            return this.tempDirectoryInitializedPromise;
        }));

        browserJob.once('done', this._createSafeListener(this._onBrowserJobDone));
        browserJob.on('test-run-create', this._createSafeListener(this._onTestRunCreate));
        browserJob.on('test-run-ready', this._createSafeListener(this._onTestRunReady));
        browserJob.on('test-run-before-done', this._createSafeListener(this._onTestRunBeforeDone));
    }

    _addProblematicPlaceholdersWarning(placeholders) {
        const problematicPlaceholderListStr = (0, _string.getConcatenatedValuesString)(placeholders);
        const suffix = (0, _string.getPluralSuffix)(placeholders);
        const verb = (0, _string.getToBeInPastTense)(placeholders);

        this.warningLog.addWarning(_warningMessage2.default.problematicPathPatternPlaceholderForVideoRecording, problematicPlaceholderListStr, suffix, suffix, verb);
    }

    _getTargetVideoPath(testRunRecorder) {
        const data = (0, _assign2.default)(testRunRecorder.testRunInfo, { now: this.timeStamp });

        if (this.singleFile) {
            data.testIndex = null;
            data.fixture = null;
            data.test = null;
        }

        const pathPattern = new _pathPattern2.default(this.customPathPattern, VIDEO_EXTENSION, data);

        pathPattern.on('problematic-placeholders-found', ({ placeholders }) => this._addProblematicPlaceholdersWarning(placeholders));

        return (0, _path.join)(this.basePath, pathPattern.getPath());
    }

    _concatVideo(targetVideoPath, { tempVideoPath, tempMergeConfigPath, tmpMergeName }) {
        if (this.firstFile) {
            this.firstFile = false;
            return;
        }

        _fs2.default.writeFileSync(tempMergeConfigPath, `
            file '${targetVideoPath}'
            file '${tempVideoPath}'
        `);

        (0, _child_process.spawnSync)(this.ffmpegPath, ['-y', '-f', 'concat', '-safe', '0', '-i', tempMergeConfigPath, '-c', 'copy', tmpMergeName], { stdio: 'ignore' });
        _fs2.default.copyFileSync(tmpMergeName, tempVideoPath);
    }

    _onBrowserJobStart() {
        var _this2 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this2.tempDirectory.init();
        })();
    }

    _onBrowserJobDone() {
        var _this3 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            yield _this3.tempDirectory.dispose();
        })();
    }

    _onTestRunCreate(testRunInfo) {
        var _this4 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            if (testRunInfo.legacy) return;

            yield _this4.tempDirectoryInitializedPromise;

            const recordingOptions = {
                path: _this4.tempDirectory.path,
                ffmpegPath: _this4.ffmpegPath,
                encodingOptions: _this4.encodingOptions
            };

            const testRunVideoRecorder = _this4._createTestRunVideoRecorder(testRunInfo, recordingOptions);
            const isVideoSupported = yield testRunVideoRecorder.isVideoSupported();

            if (isVideoSupported) {
                yield testRunVideoRecorder.init();

                _this4.testRunVideoRecorders[testRunVideoRecorder.index] = testRunVideoRecorder;
            } else _this4.warningLog.addWarning(_warningMessage2.default.videoNotSupportedByBrowser, testRunVideoRecorder.testRunInfo.alias);
        })();
    }

    _createTestRunVideoRecorder(testRunInfo, recordingOptions) {
        return new _testRunVideoRecorder2.default(testRunInfo, recordingOptions, this.warningLog);
    }

    _onTestRunReady({ index }) {
        var _this5 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunRecorder = _this5.testRunVideoRecorders[index];

            if (!testRunRecorder) return;

            yield testRunRecorder.startCapturing();
        })();
    }

    _onTestRunBeforeDone({ index }) {
        var _this6 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const testRunRecorder = _this6.testRunVideoRecorders[index];

            if (!testRunRecorder) return;

            delete _this6.testRunVideoRecorders[index];

            yield testRunRecorder.finishCapturing();

            if (_this6.failedOnly && !testRunRecorder.hasErrors) return;

            yield _this6._saveFiles(testRunRecorder);
        })();
    }

    _saveFiles(testRunRecorder) {
        var _this7 = this;

        return (0, _asyncToGenerator3.default)(function* () {
            const videoPath = _this7._getTargetVideoPath(testRunRecorder);

            yield (0, _makeDir2.default)((0, _path.dirname)(videoPath));

            if (_this7.singleFile) _this7._concatVideo(videoPath, testRunRecorder.tempFiles);

            _fs2.default.copyFileSync(testRunRecorder.tempFiles.tempVideoPath, videoPath);
        })();
    }
}
exports.default = VideoRecorder;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy92aWRlby1yZWNvcmRlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJERUJVR19MT0dHRVIiLCJWSURFT19FWFRFTlNJT04iLCJURU1QX0RJUl9QUkVGSVgiLCJWaWRlb1JlY29yZGVyIiwiY29uc3RydWN0b3IiLCJicm93c2VySm9iIiwiYmFzZVBhdGgiLCJvcHRzIiwiZW5jb2RpbmdPcHRzIiwid2FybmluZ0xvZyIsImZhaWxlZE9ubHkiLCJzaW5nbGVGaWxlIiwiZmZtcGVnUGF0aCIsImN1c3RvbVBhdGhQYXR0ZXJuIiwicGF0aFBhdHRlcm4iLCJ0aW1lU3RhbXAiLCJlbmNvZGluZ09wdGlvbnMiLCJ0ZW1wRGlyZWN0b3J5IiwiVGVtcERpcmVjdG9yeSIsImZpcnN0RmlsZSIsInRlc3RSdW5WaWRlb1JlY29yZGVycyIsIl9hc3NpZ25FdmVudEhhbmRsZXJzIiwiX2NyZWF0ZVNhZmVMaXN0ZW5lciIsImxpc3RlbmVyIiwiYXJncyIsImFwcGx5IiwiZXJyb3IiLCJuYW1lIiwib25jZSIsInRlbXBEaXJlY3RvcnlJbml0aWFsaXplZFByb21pc2UiLCJfb25Ccm93c2VySm9iU3RhcnQiLCJfb25Ccm93c2VySm9iRG9uZSIsIm9uIiwiX29uVGVzdFJ1bkNyZWF0ZSIsIl9vblRlc3RSdW5SZWFkeSIsIl9vblRlc3RSdW5CZWZvcmVEb25lIiwiX2FkZFByb2JsZW1hdGljUGxhY2Vob2xkZXJzV2FybmluZyIsInBsYWNlaG9sZGVycyIsInByb2JsZW1hdGljUGxhY2Vob2xkZXJMaXN0U3RyIiwic3VmZml4IiwidmVyYiIsImFkZFdhcm5pbmciLCJXQVJOSU5HX01FU1NBR0VTIiwicHJvYmxlbWF0aWNQYXRoUGF0dGVyblBsYWNlaG9sZGVyRm9yVmlkZW9SZWNvcmRpbmciLCJfZ2V0VGFyZ2V0VmlkZW9QYXRoIiwidGVzdFJ1blJlY29yZGVyIiwiZGF0YSIsInRlc3RSdW5JbmZvIiwibm93IiwidGVzdEluZGV4IiwiZml4dHVyZSIsInRlc3QiLCJQYXRoUGF0dGVybiIsImdldFBhdGgiLCJfY29uY2F0VmlkZW8iLCJ0YXJnZXRWaWRlb1BhdGgiLCJ0ZW1wVmlkZW9QYXRoIiwidGVtcE1lcmdlQ29uZmlnUGF0aCIsInRtcE1lcmdlTmFtZSIsImZzIiwid3JpdGVGaWxlU3luYyIsInN0ZGlvIiwiY29weUZpbGVTeW5jIiwiaW5pdCIsImRpc3Bvc2UiLCJsZWdhY3kiLCJyZWNvcmRpbmdPcHRpb25zIiwicGF0aCIsInRlc3RSdW5WaWRlb1JlY29yZGVyIiwiX2NyZWF0ZVRlc3RSdW5WaWRlb1JlY29yZGVyIiwiaXNWaWRlb1N1cHBvcnRlZCIsImluZGV4IiwidmlkZW9Ob3RTdXBwb3J0ZWRCeUJyb3dzZXIiLCJhbGlhcyIsIlRlc3RSdW5WaWRlb1JlY29yZGVyIiwic3RhcnRDYXB0dXJpbmciLCJmaW5pc2hDYXB0dXJpbmciLCJoYXNFcnJvcnMiLCJfc2F2ZUZpbGVzIiwidmlkZW9QYXRoIiwidGVtcEZpbGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFFQTs7Ozs7O0FBRUEsTUFBTUEsZUFBZSxxQkFBTSx5QkFBTixDQUFyQjs7QUFFQSxNQUFNQyxrQkFBa0IsS0FBeEI7QUFDQSxNQUFNQyxrQkFBa0IsT0FBeEI7O0FBRWUsTUFBTUMsYUFBTixDQUFvQjtBQUMvQkMsZ0JBQWFDLFVBQWIsRUFBeUJDLFFBQXpCLEVBQW1DQyxJQUFuQyxFQUF5Q0MsWUFBekMsRUFBdURDLFVBQXZELEVBQW1FO0FBQy9ELGFBQUtKLFVBQUwsR0FBeUJBLFVBQXpCO0FBQ0EsYUFBS0MsUUFBTCxHQUF5QkEsUUFBekI7QUFDQSxhQUFLSSxVQUFMLEdBQXlCSCxLQUFLRyxVQUE5QjtBQUNBLGFBQUtDLFVBQUwsR0FBeUJKLEtBQUtJLFVBQTlCO0FBQ0EsYUFBS0MsVUFBTCxHQUF5QkwsS0FBS0ssVUFBOUI7QUFDQSxhQUFLQyxpQkFBTCxHQUF5Qk4sS0FB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QyxZQUFZLE9BQUtuQyxtQkFBTCxDQUF5QkMsZUFBekIsQ0FBbEI7O0FBRUEsa0JBQU0sdUJBQVEsbUJBQVFrQyxTQUFSLENBQVIsQ0FBTjs7QUFFQSxnQkFBSSxPQUFLcEUsVUFBVCxFQUNJLE9BQUsyQyxZQUFMLENBQWtCeUIsU0FBbEIsRUFBNkJsQyxnQkFBZ0JtQyxTQUE3Qzs7QUFFSnJCLHlCQUFHRyxZQUFILENBQWdCakIsZ0JBQWdCbUMsU0FBaEIsQ0FBMEJ4QixhQUExQyxFQUF5RHVCLFNBQXpEO0FBUitCO0FBU2xDO0FBN0o4QjtrQkFBZDVFLGEiLCJmaWxlIjoidmlkZW8tcmVjb3JkZXIvaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHsgam9pbiwgZGlybmFtZSB9IGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCB7IHNwYXduU3luYyB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IG1ha2VEaXIgZnJvbSAnbWFrZS1kaXInO1xuaW1wb3J0IFRlbXBEaXJlY3RvcnkgZnJvbSAnLi4vdXRpbHMvdGVtcC1kaXJlY3RvcnknO1xuaW1wb3J0IFBhdGhQYXR0ZXJuIGZyb20gJy4uL3V0aWxzL3BhdGgtcGF0dGVybic7XG5pbXBvcnQgV0FSTklOR19NRVNTQUdFUyBmcm9tICcuLi9ub3RpZmljYXRpb25zL3dhcm5pbmctbWVzc2FnZSc7XG5pbXBvcnQgeyBnZXRQbHVyYWxTdWZmaXgsIGdldENvbmNhdGVuYXRlZFZhbHVlc1N0cmluZywgZ2V0VG9CZUluUGFzdFRlbnNlIH0gZnJvbSAnLi4vdXRpbHMvc3RyaW5nJztcblxuaW1wb3J0IFRlc3RSdW5WaWRlb1JlY29yZGVyIGZyb20gJy4vdGVzdC1ydW4tdmlkZW8tcmVjb3JkZXInO1xuXG5jb25zdCBERUJVR19MT0dHRVIgPSBkZWJ1ZygndGVzdGNhZmU6dmlkZW8tcmVjb3JkZXInKTtcblxuY29uc3QgVklERU9fRVhURU5TSU9OID0gJ21wNCc7XG5jb25zdCBURU1QX0RJUl9QUkVGSVggPSAndmlkZW8nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBWaWRlb1JlY29yZGVyIHtcbiAgICBjb25zdHJ1Y3RvciAoYnJvd3NlckpvYiwgYmFzZVBhdGgsIG9wdHMsIGVuY29kaW5nT3B0cywgd2FybmluZ0xvZykge1xuICAgICAgICB0aGlzLmJyb3dzZXJKb2IgICAgICAgID0gYnJvd3NlckpvYjtcbiAgICAgICAgdGhpcy5iYXNlUGF0aCAgICAgICAgICA9IGJhc2VQYXRoO1xuICAgICAgICB0aGlzLmZhaWxlZE9ubHkgICAgICAgID0gb3B0cy5mYWlsZWRPbmx5O1xuICAgICAgICB0aGlzLnNpbmdsZUZpbGUgICAgICAgID0gb3B0cy5zaW5nbGVGaWxlO1xuICAgICAgICB0aGlzLmZmbXBlZ1BhdGggICAgICAgID0gb3B0cy5mZm1wZWdQYXRoO1xuICAgICAgICB0aGlzLmN1c3RvbVBhdGhQYXR0ZXJuID0gb3B0cy5wYXRoUGF0dGVybjtcbiAgICAgICAgdGhpcy50aW1lU3RhbXAgICAgICAgICA9IG9wdHMudGltZVN0YW1wO1xuICAgICAgICB0aGlzLmVuY29kaW5nT3B0aW9ucyAgID0gZW5jb2RpbmdPcHRzO1xuXG4gICAgICAgIHRoaXMud2FybmluZ0xvZyA9IHdhcm5pbmdMb2c7XG5cbiAgICAgICAgdGhpcy50ZW1wRGlyZWN0b3J5ID0gbmV3IFRlbXBEaXJlY3RvcnkoVEVNUF9ESVJfUFJFRklYKTtcblxuICAgICAgICB0aGlzLmZpcnN0RmlsZSA9IHRydWU7XG5cbiAgICAgICAgdGhpcy50ZXN0UnVuVmlkZW9SZWNvcmRlcnMgPSB7fTtcblxuICAgICAgICB0aGlzLl9hc3NpZ25FdmVudEhhbmRsZXJzKGJyb3dzZXJKb2IpO1xuICAgIH1cblxuICAgIF9jcmVhdGVTYWZlTGlzdGVuZXIgKGxpc3RlbmVyKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJncyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBERUJVR19MT0dHRVIobGlzdGVuZXIgJiYgbGlzdGVuZXIubmFtZSwgZXJyb3IpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBfYXNzaWduRXZlbnRIYW5kbGVycyAoYnJvd3NlckpvYikge1xuICAgICAgICBicm93c2VySm9iLm9uY2UoJ3N0YXJ0JywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMudGVtcERpcmVjdG9yeUluaXRpYWxpemVkUHJvbWlzZSA9IHRoaXMuX29uQnJvd3NlckpvYlN0YXJ0KCk7XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRlbXBEaXJlY3RvcnlJbml0aWFsaXplZFByb21pc2U7XG4gICAgICAgIH0pKTtcblxuICAgICAgICBicm93c2VySm9iLm9uY2UoJ2RvbmUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25Ccm93c2VySm9iRG9uZSkpO1xuICAgICAgICBicm93c2VySm9iLm9uKCd0ZXN0LXJ1bi1jcmVhdGUnLCB0aGlzLl9jcmVhdGVTYWZlTGlzdGVuZXIodGhpcy5fb25UZXN0UnVuQ3JlYXRlKSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLXJlYWR5JywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1blJlYWR5KSk7XG4gICAgICAgIGJyb3dzZXJKb2Iub24oJ3Rlc3QtcnVuLWJlZm9yZS1kb25lJywgdGhpcy5fY3JlYXRlU2FmZUxpc3RlbmVyKHRoaXMuX29uVGVzdFJ1bkJlZm9yZURvbmUpKTtcbiAgICB9XG5cbiAgICBfYWRkUHJvYmxlbWF0aWNQbGFjZWhvbGRlcnNXYXJuaW5nIChwbGFjZWhvbGRlcnMpIHtcbiAgICAgICAgY29uc3QgcHJvYmxlbWF0aWNQbGFjZWhvbGRlckxpc3RTdHIgPSBnZXRDb25jYXRlbmF0ZWRWYWx1ZXNTdHJpbmcocGxhY2Vob2xkZXJzKTtcbiAgICAgICAgY29uc3Qgc3VmZml4ICAgICAgICAgICAgICAgICAgICAgICAgPSBnZXRQbHVyYWxTdWZmaXgocGxhY2Vob2xkZXJzKTtcbiAgICAgICAgY29uc3QgdmVyYiAgICAgICAgICAgICAgICAgICAgICAgICAgPSBnZXRUb0JlSW5QYXN0VGVuc2UocGxhY2Vob2xkZXJzKTtcblxuICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0VTLnByb2JsZW1hdGljUGF0aFBhdHRlcm5QbGFjZWhvbGRlckZvclZpZGVvUmVjb3JkaW5nLCBwcm9ibGVtYXRpY1BsYWNlaG9sZGVyTGlzdFN0ciwgc3VmZml4LCBzdWZmaXgsIHZlcmIpO1xuICAgIH1cblxuICAgIF9nZXRUYXJnZXRWaWRlb1BhdGggKHRlc3RSdW5SZWNvcmRlcikge1xuICAgICAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih0ZXN0UnVuUmVjb3JkZXIudGVzdFJ1bkluZm8sIHsgbm93OiB0aGlzLnRpbWVTdGFtcCB9KTtcblxuICAgICAgICBpZiAodGhpcy5zaW5nbGVGaWxlKSB7XG4gICAgICAgICAgICBkYXRhLnRlc3RJbmRleCA9IG51bGw7XG4gICAgICAgICAgICBkYXRhLmZpeHR1cmUgPSBudWxsO1xuICAgICAgICAgICAgZGF0YS50ZXN0ID0gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHBhdGhQYXR0ZXJuID0gbmV3IFBhdGhQYXR0ZXJuKHRoaXMuY3VzdG9tUGF0aFBhdHRlcm4sIFZJREVPX0VYVEVOU0lPTiwgZGF0YSk7XG5cbiAgICAgICAgcGF0aFBhdHRlcm4ub24oJ3Byb2JsZW1hdGljLXBsYWNlaG9sZGVycy1mb3VuZCcsICh7IHBsYWNlaG9sZGVycyB9KSA9PiB0aGlzLl9hZGRQcm9ibGVtYXRpY1BsYWNlaG9sZGVyc1dhcm5pbmcocGxhY2Vob2xkZXJzKSk7XG5cbiAgICAgICAgcmV0dXJuIGpvaW4odGhpcy5iYXNlUGF0aCwgcGF0aFBhdHRlcm4uZ2V0UGF0aCgpKTtcbiAgICB9XG5cbiAgICBfY29uY2F0VmlkZW8gKHRhcmdldFZpZGVvUGF0aCwgeyB0ZW1wVmlkZW9QYXRoLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCB0bXBNZXJnZU5hbWUgfSkge1xuICAgICAgICBpZiAodGhpcy5maXJzdEZpbGUpIHtcbiAgICAgICAgICAgIHRoaXMuZmlyc3RGaWxlID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKHRlbXBNZXJnZUNvbmZpZ1BhdGgsIGBcbiAgICAgICAgICAgIGZpbGUgJyR7dGFyZ2V0VmlkZW9QYXRofSdcbiAgICAgICAgICAgIGZpbGUgJyR7dGVtcFZpZGVvUGF0aH0nXG4gICAgICAgIGApO1xuXG4gICAgICAgIHNwYXduU3luYyh0aGlzLmZmbXBlZ1BhdGgsIFsnLXknLCAnLWYnLCAnY29uY2F0JywgJy1zYWZlJywgJzAnLCAnLWknLCB0ZW1wTWVyZ2VDb25maWdQYXRoLCAnLWMnLCAnY29weScsIHRtcE1lcmdlTmFtZV0sIHsgc3RkaW86ICdpZ25vcmUnIH0pO1xuICAgICAgICBmcy5jb3B5RmlsZVN5bmModG1wTWVyZ2VOYW1lLCB0ZW1wVmlkZW9QYXRoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25Ccm93c2VySm9iU3RhcnQgKCkge1xuICAgICAgICBhd2FpdCB0aGlzLnRlbXBEaXJlY3RvcnkuaW5pdCgpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vbkJyb3dzZXJKb2JEb25lICgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy50ZW1wRGlyZWN0b3J5LmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQ3JlYXRlICh0ZXN0UnVuSW5mbykge1xuICAgICAgICBpZiAodGVzdFJ1bkluZm8ubGVnYWN5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRoaXMudGVtcERpcmVjdG9yeUluaXRpYWxpemVkUHJvbWlzZTtcblxuICAgICAgICBjb25zdCByZWNvcmRpbmdPcHRpb25zID0ge1xuICAgICAgICAgICAgcGF0aDogICAgICAgICAgICB0aGlzLnRlbXBEaXJlY3RvcnkucGF0aCxcbiAgICAgICAgICAgIGZmbXBlZ1BhdGg6ICAgICAgdGhpcy5mZm1wZWdQYXRoLFxuICAgICAgICAgICAgZW5jb2RpbmdPcHRpb25zOiB0aGlzLmVuY29kaW5nT3B0aW9uc1xuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHRlc3RSdW5WaWRlb1JlY29yZGVyID0gdGhpcy5fY3JlYXRlVGVzdFJ1blZpZGVvUmVjb3JkZXIodGVzdFJ1bkluZm8sIHJlY29yZGluZ09wdGlvbnMpO1xuICAgICAgICBjb25zdCBpc1ZpZGVvU3VwcG9ydGVkICAgICA9IGF3YWl0IHRlc3RSdW5WaWRlb1JlY29yZGVyLmlzVmlkZW9TdXBwb3J0ZWQoKTtcblxuICAgICAgICBpZiAoaXNWaWRlb1N1cHBvcnRlZCkge1xuICAgICAgICAgICAgYXdhaXQgdGVzdFJ1blZpZGVvUmVjb3JkZXIuaW5pdCgpO1xuXG4gICAgICAgICAgICB0aGlzLnRlc3RSdW5WaWRlb1JlY29yZGVyc1t0ZXN0UnVuVmlkZW9SZWNvcmRlci5pbmRleF0gPSB0ZXN0UnVuVmlkZW9SZWNvcmRlcjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLndhcm5pbmdMb2cuYWRkV2FybmluZyhXQVJOSU5HX01FU1NBR0VTLnZpZGVvTm90U3VwcG9ydGVkQnlCcm93c2VyLCB0ZXN0UnVuVmlkZW9SZWNvcmRlci50ZXN0UnVuSW5mby5hbGlhcyk7XG4gICAgfVxuXG4gICAgX2NyZWF0ZVRlc3RSdW5WaWRlb1JlY29yZGVyICh0ZXN0UnVuSW5mbywgcmVjb3JkaW5nT3B0aW9ucykge1xuICAgICAgICByZXR1cm4gbmV3IFRlc3RSdW5WaWRlb1JlY29yZGVyKHRlc3RSdW5JbmZvLCByZWNvcmRpbmdPcHRpb25zLCB0aGlzLndhcm5pbmdMb2cpO1xuICAgIH1cblxuICAgIGFzeW5jIF9vblRlc3RSdW5SZWFkeSAoeyBpbmRleCB9KSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW5SZWNvcmRlciA9IHRoaXMudGVzdFJ1blZpZGVvUmVjb3JkZXJzW2luZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5SZWNvcmRlcilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhd2FpdCB0ZXN0UnVuUmVjb3JkZXIuc3RhcnRDYXB0dXJpbmcoKTtcbiAgICB9XG5cbiAgICBhc3luYyBfb25UZXN0UnVuQmVmb3JlRG9uZSAoeyBpbmRleCB9KSB7XG4gICAgICAgIGNvbnN0IHRlc3RSdW5SZWNvcmRlciA9IHRoaXMudGVzdFJ1blZpZGVvUmVjb3JkZXJzW2luZGV4XTtcblxuICAgICAgICBpZiAoIXRlc3RSdW5SZWNvcmRlcilcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBkZWxldGUgdGhpcy50ZXN0UnVuVmlkZW9SZWNvcmRlcnNbaW5kZXhdO1xuXG4gICAgICAgIGF3YWl0IHRlc3RSdW5SZWNvcmRlci5maW5pc2hDYXB0dXJpbmcoKTtcblxuICAgICAgICBpZiAodGhpcy5mYWlsZWRPbmx5ICYmICF0ZXN0UnVuUmVjb3JkZXIuaGFzRXJyb3JzKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuX3NhdmVGaWxlcyh0ZXN0UnVuUmVjb3JkZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIF9zYXZlRmlsZXMgKHRlc3RSdW5SZWNvcmRlcikge1xuICAgICAgICBjb25zdCB2aWRlb1BhdGggPSB0aGlzLl9nZXRUYXJnZXRWaWRlb1BhdGgodGVzdFJ1blJlY29yZGVyKTtcblxuICAgICAgICBhd2FpdCBtYWtlRGlyKGRpcm5hbWUodmlkZW9QYXRoKSk7XG5cbiAgICAgICAgaWYgKHRoaXMuc2luZ2xlRmlsZSlcbiAgICAgICAgICAgIHRoaXMuX2NvbmNhdFZpZGVvKHZpZGVvUGF0aCwgdGVzdFJ1blJlY29yZGVyLnRlbXBGaWxlcyk7XG5cbiAgICAgICAgZnMuY29weUZpbGVTeW5jKHRlc3RSdW5SZWNvcmRlci50ZW1wRmlsZXMudGVtcFZpZGVvUGF0aCwgdmlkZW9QYXRoKTtcbiAgICB9XG59XG4iXX0=
